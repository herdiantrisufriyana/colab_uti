---
title: "Predicting urinary tract infection (UTI)"
output: html_document
date: "2022-11-26"
---

# Programming environment

```{r Determine settings, include=FALSE}
seed=2022-11-26
bioc_version='3.16'
```

```{r Determine computing requirements, include=FALSE}
# 1 == file size >=25MB
# 2 == considerably-long computation
# 3 == RAM >=8 GB
# 4 == require GPU
comp_req=c()#c(1,2,3,4)
```

```{r Load packages, include=FALSE}
library(tidyverse)
library(pbapply)
library(haven)
library(parallel)
library(doParallel)
library(lubridate)
library(ggpubr)
library(survival)
library(survminer)
library(mice)
filter=dplyr::filter
library(caret)
library(glmnet)
library(xgboost)
slice=dplyr::slice
library(pROC)
library(preprocessCore)
library(limma)
library(WGCNA)
library(matrixStats)
library(Rtsne)
library(clixo)
library(divnn)
library(Biobase)
library(igraph)
library(ggnetwork)
```

```{r Set theme, include=FALSE}
dslabs::ds_theme_set()
```

# Load raw data

```{r Obtain raw data file information, include=FALSE}
raw_data_info=
  list.files('raw_data',full.names=T) %>%
  data.frame(filename=.) %>%
  mutate(
    filesize=file.size(filename)
    ,code=
      filename %>%
      str_sub(
        start=
          sapply(.,\(x){
            str_locate_all(x,'/v_')[[1]][1,1]+3}
          )
        ,end=
          sapply(.,\(x){
            str_locate_all(x,'\\.sas7bdat')[[1]][1,1]-1
          })
      )
    ,type=str_sub(code,str_length(code),str_length(code))
    ,type=ifelse(type%in%c('s','t','w'),type,'')
    ,code=str_remove_all(code,'_s$|_t$|_w$')
  ) %>%
  group_by(code) %>%
  mutate(
    n=n()
    ,codesize=sum(filesize)
  ) %>%
  ungroup() %>%
  arrange(desc(n),codesize,code,type)
```

```{r Scrape raw data description from SAS-report PDF, include=FALSE}
raw_data_desc_sas=
  suppressWarnings(suppressMessages(
    read_csv('data/++«+ñjñp_A202206008.csv')
  )) %>%
  slice(7:nrow(.)) %>%
  filter(str_detect(pdf,'[:alpha:]')) %>%
  filter(
    !pdf%in%c(
      'A202206008: 2008-01-01 ~ 2020-12-31 ??????????'
      ,'? 59.09 GB'
      ,'???? (GB)'
      ,'TOTAL'
    )
  ) %>%
  mutate(pdf=str_to_lower(pdf)) %>%
  rename(code=pdf) %>%
  mutate(code=factor(code,unique(code)))
```

```{r Read raw data in SAS, include=FALSE}
if(all(c(1,2,3)%in%comp_req)){ # 50m 21s
  cl=detectCores()-2
  start=T; source('R/parallel_computing-codes.R')
  
  raw_data=
    raw_data_info %>%
    pull(filename) %>%
    pblapply(
      cl=cl
      ,read_sas=read_sas
      ,\(x,read_sas){
        if(str_detect(x,'v_mtrl_basic_s')){
          x %>%
            read_sas(encoding='UTF-8')
        }else{
          x %>%
            read_sas()
        }
    }) %>%
    `names<-`(
      raw_data_info %>%
        pull(filename) %>%
        str_remove_all('raw_data/|\\.sas7bdat')
    )
  
  saveRDS(raw_data,'data/raw_data.rds')
  start=F; source('R/parallel_computing-codes.R')
}else{
  raw_data=readRDS('data/raw_data.rds')
}
```

```{r Sanity check of data file completeness, eval=FALSE, include=FALSE}
# The numbers of rows are the same,
# while the numbers of fields are different.
# But, manual check by SAS EG shows the same numbers of fields.
raw_data %>%
  lapply(dim) %>%
  lapply(t) %>%
  lapply(data.frame) %>%
  lapply(`colnames<-`,c('nrow','ncol')) %>%
  lapply(X=names(.),Y=.,\(X,Y)mutate(Y[[X]],code=X)) %>%
  do.call(rbind,.) %>%
  mutate(
    type=str_sub(code,str_length(code),str_length(code))
    ,type=ifelse(type%in%c('s','t','w'),type,'z')
    ,code=str_remove_all(code,'^v_|_s$|_t$|_w$')
  ) %>%
  left_join(
    raw_data_info %>%
      select(code,type,filesize)
    ,by=c('code','type')
  ) %>%
  mutate(filesize=round(filesize/10^9,2)) %>%
  rbind(
    group_by(.,ncol,code) %>%
      summarize(
        type='all'
        ,nrow=sum(nrow)
        ,filesize=sum(filesize)
        ,.groups='drop'
      )
  ) %>%
  pivot_wider(
    names_from='type'
    ,values_from=c('nrow','filesize')
    ,values_fill=0
  ) %>%
  mutate(code=factor(code,levels(raw_data_desc_sas$code))) %>%
  right_join(
    raw_data_desc_sas
    ,by='code'
  ) %>%
  mutate_all(\(x){
    if(is.factor(x)){
      x
    }else{
      ifelse(is.na(x),0,x)
    }
  }) %>%
  arrange(code)
```

```{r Determine FEE_CODE for urine cath, include=FALSE}
uri_cath=
  raw_data %>%
  .[str_detect(names(.),'^v_fee_basic')] %>%
  lapply(select,FEE_CODE,FEE_DESC) %>%
  lapply(
    X=names(.)
    ,Y=.
    ,\(X,Y)
    Y[[X]] %>%
      mutate(
        HOSP=
          str_sub(X,str_count(X),str_count(X))
      )
  ) %>%
  do.call(rbind,.) %>%
  filter(
    str_detect(
      str_to_lower(FEE_CODE)
      ,filter(.,str_detect(str_to_lower(FEE_DESC),'cath|導|foley')) %>%
        filter(str_detect(str_to_lower(FEE_DESC),'uri|尿|icp')) %>%
        filter(str_detect(str_to_lower(FEE_DESC),'dwel|留置|icp')) %>%
        pull(FEE_CODE) %>%
        str_sub(1,str_count(.)-1) %>%
        str_to_lower() %>%
        unique() %>%
        paste0(collapse='|')
    )
  ) %>%
  mutate(exist='yes') %>%
  spread(HOSP,exist,fill='no') %>%
  arrange(FEE_CODE,w,t,s) %>%
  filter(str_detect(str_to_lower(FEE_CODE),'f470130|f47013c|f470140|f47014c'))

uri_cath %>%
  knitr::kable()
```

```{r Re-check FEE_CODE for urine cath, eval=FALSE, include=FALSE}
raw_data %>%
  .[str_detect(names(.),'^v_fee_ins')] %>%
  lapply(select,FEE_CODE) %>%
  lapply(
    X=names(.)
    ,Y=.
    ,\(X,Y)
    Y[[X]] %>%
      mutate(
        HOSP=
          str_sub(X,str_count(X),str_count(X))
      )
  ) %>%
  do.call(rbind,.) %>%
  filter(FEE_CODE%in%uri_cath$FEE_CODE) %>%
  filter(!duplicated(.)) %>%
  left_join(
    raw_data %>%
      .[str_detect(names(.),'^v_fee_basic')] %>%
      lapply(select,FEE_CODE,FEE_DESC) %>%
      lapply(
        X=names(.)
        ,Y=.
        ,\(X,Y)
        Y[[X]] %>%
          mutate(
            HOSP=
              str_sub(X,str_count(X),str_count(X))
          )
      ) %>%
      do.call(rbind,.)
    ,by=c('FEE_CODE','HOSP')
  ) %>%
  arrange(FEE_CODE,HOSP)
```

```{r FEE_CODE distribution per hospital and type, eval=FALSE, include=FALSE}
raw_data %>%
  .[str_detect(names(.),'^v_opd_fee|^v_ipd_fee')] %>%
  lapply(filter,FEE_CODE%in%uri_cath$FEE_CODE) %>%
  lapply(select_at,c(
    'FEE_NO'
    ,'FEE_CODE'
    ,colnames(.) %>%
      .[str_detect(str_to_lower(.),'date|time')]
  )) %>%
  lapply(
    X=names(.)
    ,Y=.
    ,\(X,Y)
    Y[[X]] %>%
      mutate(
        HOSP=
          str_sub(X,str_count(X),str_count(X))
        ,TYPE=
          str_sub(X,3,5)
      )
  ) %>%
  do.call(rbind,.) %>%
  group_by(HOSP,TYPE,FEE_CODE) %>%
  summarize(n=n()) %>%
  pivot_wider(names_from=c('HOSP','TYPE'),values_from='n',values_fill=0)
```

```{r Urine cath offsets, eval=FALSE, fig.height=15, fig.width=5, include=FALSE}
raw_data %>%
  .[str_detect(names(.),'^v_opd_fee|^v_ipd_fee')] %>%
  lapply(filter,FEE_CODE%in%uri_cath$FEE_CODE) %>%
  lapply(
    \(x)
    select_at(
        x
        ,c(
          'FEE_NO'
          ,'FEE_CODE'
          ,colnames(x) %>%
            .[str_detect(str_to_lower(.),'date|time')]
        )
      ) %>%
      mutate_all(as.character) %>%
      mutate_all(\(x)ifelse(x=='',NA,x)) %>%
      mutate(seq=seq(nrow(.))) %>%
      gather(key,value,-seq,-FEE_NO,-FEE_CODE) %>%
      filter(!is.na(value)) %>%
      mutate(
        key2=
          case_when(
            str_detect(str_to_lower(key),'date$')~'DATE'
            ,str_detect(str_to_lower(key),'time$')~'TIME'
            ,TRUE~''
          )
        ,key=
          str_remove_all(key,paste0('_',key2))
      ) %>%
      spread(key2,value) %>%
      mutate(
        TIME=
          ifelse(
            !is.na(DATE) & is.na(TIME)
            ,'0000'
            ,TIME
          )
      ) %>%
      mutate(
        DATE=
          as.numeric(DATE)
        ,DATE=
          DATE+(2023-112)*10000
        ,DATE=
          paste0(
            str_sub(DATE,1,4)
            ,'-'
            ,str_sub(DATE,5,6)
            ,'-'
            ,str_sub(DATE,7,8)
          )
        ,TIME=
          paste0(
            str_sub(TIME,1,2)
            ,':'
            ,str_sub(TIME,3,4)
          )
      ) %>%
      unite(DATETIME,DATE,TIME,sep=' ') %>%
      mutate(DATETIME=ymd_hm(DATETIME))
  ) %>%
  lapply(
    X=names(.)
    ,Y=.
    ,\(X,Y)
    Y[[X]] %>%
      mutate(
        HOSP=
          str_sub(X,str_count(X),str_count(X))
        ,TYPE=
          str_sub(X,3,5)
      )
  ) %>%
  do.call(rbind,.) %>%
  left_join(
    filter(.,key%in%c('OPD','IPD')) %>%
      mutate(key='APD_DATETIME') %>%
      spread(key,DATETIME)
    ,by=c('seq','HOSP','TYPE','FEE_CODE','FEE_NO')
  ) %>%
  filter(!key%in%c('OPD','IPD')) %>%
  group_by(seq,HOSP,TYPE,FEE_CODE,FEE_NO) %>%
  mutate(DATETIME=as.duration(DATETIME-APD_DATETIME)/ddays(1)) %>%
  ungroup() %>%
  group_by(HOSP,TYPE,FEE_CODE,key) %>%
  summarize(
    avg=mean(DATETIME)
    ,std=sd(DATETIME)
    ,q1=quantile(DATETIME,0.25)
    ,q2=quantile(DATETIME,0.5)
    ,q3=quantile(DATETIME,0.75)
    ,.groups='drop'
  ) %>%
  arrange(HOSP,TYPE,FEE_CODE,q2) %>%
  left_join(
    raw_data %>%
      .[str_detect(names(.),'^v_fee_basic')] %>%
      lapply(select,FEE_CODE,FEE_DESC) %>%
      lapply(
        X=names(.)
        ,Y=.
        ,\(X,Y)
        Y[[X]] %>%
          mutate(
            HOSP=
              str_sub(X,str_count(X),str_count(X))
          )
      ) %>%
      do.call(rbind,.)
    ,by=c('FEE_CODE','HOSP')
  ) %>%
  unite(FEE_CODE,FEE_CODE,FEE_DESC,sep=':') %>%
  lapply(
    X=unique(.$FEE_CODE)
    ,Y=.
    ,\(X,Y)
    Y %>%
      filter(FEE_CODE==X) %>%
      mutate(key=reorder(key,desc(q2))) %>%
      ggplot(aes(key,q2)) +
      geom_errorbar(aes(ymin=q1,ymax=q3),width=0.1,size=1) +
      geom_point(size=3) +
      facet_wrap(HOSP~TYPE,scales='free') +
      coord_flip() +
      ggtitle(label='',subtitle=X)
  ) %>%
  lapply(X=1,Y=.,\(X,Y)
    ggarrange(
      Y[[1]]
      ,Y[[2]]
      ,Y[[3]]
      ,Y[[4]]
      ,ggarrange(
        Y[[5]],Y[[6]]
        ,ncol=2
      )
      ,Y[[7]]
      ,Y[[8]]
      ,nrow=7
    )
  ) %>%
  .[[1]]
```

```{r Identify the most optimal offsets, eval=FALSE, include=FALSE}
raw_data %>%
  .[str_detect(names(.),'^v_opd_fee|^v_ipd_fee')] %>%
  lapply(filter,FEE_CODE%in%uri_cath$FEE_CODE) %>%
  lapply(
    \(x)
    select_at(
        x
        ,c(
          'FEE_NO'
          ,'FEE_CODE'
          ,colnames(x) %>%
            .[str_detect(str_to_lower(.),'date|time')]
        )
      ) %>%
      mutate_all(as.character) %>%
      mutate_all(\(x)ifelse(x=='',NA,x)) %>%
      mutate(seq=seq(nrow(.))) %>%
      gather(key,value,-seq,-FEE_NO,-FEE_CODE) %>%
      filter(!is.na(value)) %>%
      mutate(
        key2=
          case_when(
            str_detect(str_to_lower(key),'date$')~'DATE'
            ,str_detect(str_to_lower(key),'time$')~'TIME'
            ,TRUE~''
          )
        ,key=
          str_remove_all(key,paste0('_',key2))
      ) %>%
      spread(key2,value) %>%
      mutate(
        TIME=
          ifelse(
            !is.na(DATE) & is.na(TIME)
            ,'0000'
            ,TIME
          )
      ) %>%
      mutate(
        DATE=
          as.numeric(DATE)
        ,DATE=
          DATE+(2023-112)*10000
        ,DATE=
          paste0(
            str_sub(DATE,1,4)
            ,'-'
            ,str_sub(DATE,5,6)
            ,'-'
            ,str_sub(DATE,7,8)
          )
        ,TIME=
          paste0(
            str_sub(TIME,1,2)
            ,':'
            ,str_sub(TIME,3,4)
          )
      ) %>%
      unite(DATETIME,DATE,TIME,sep=' ') %>%
      mutate(DATETIME=ymd_hm(DATETIME))
  ) %>%
  lapply(
    X=names(.)
    ,Y=.
    ,\(X,Y)
    Y[[X]] %>%
      mutate(
        HOSP=
          str_sub(X,str_count(X),str_count(X))
        ,TYPE=
          str_sub(X,3,5)
      )
  ) %>%
  do.call(rbind,.) %>%
  left_join(
    spread(.,key,DATETIME)
    ,by=c('FEE_NO','FEE_CODE','seq','HOSP','TYPE')
  ) %>%
  gather(key2,DATETIME2,-FEE_NO,-FEE_CODE,-seq,-key,-DATETIME,-HOSP,-TYPE) %>%
  filter(!is.na(DATETIME2)) %>%
  filter(key2!=key) %>%
  unite(keys,key2,key,sep='-') %>%
  mutate(duration=as.duration(DATETIME2-DATETIME)/ddays(1)) %>%
  group_by(HOSP,TYPE,FEE_CODE,keys) %>%
  summarize(
    neg_d=sum(duration<0,na.rm=T)
    ,pos_d012=sum(duration>=0 & duration<3,na.rm=T)
    ,pos_d3=sum(duration>=3,na.rm=T)
    ,n=n()
    ,m=sum(is.na(duration),na.rm=T)
    ,min=min(duration,na.rm=T)
    ,q1=quantile(duration,0.25,na.rm=T)
    ,q2=quantile(duration,0.5,na.rm=T)
    ,q3=quantile(duration,0.75,na.rm=T)
    ,max=max(duration,na.rm=T)
    ,o=sum(
      duration<(
        quantile(duration,0.25,na.rm=T)
        -1.5*(quantile(duration,0.75,na.rm=T)-quantile(duration,0.25,na.rm=T))
      )
      | duration>(
        quantile(duration,0.75,na.rm=T)
        +1.5*(quantile(duration,0.75,na.rm=T)-quantile(duration,0.25,na.rm=T))
      )
      ,na.rm=T
    )
    ,avg=mean(ifelse(
      duration<(
        quantile(duration,0.25,na.rm=T)
        -1.5*(quantile(duration,0.75,na.rm=T)-quantile(duration,0.25,na.rm=T))
      )
      | duration>(
        quantile(duration,0.75,na.rm=T)
        +1.5*(quantile(duration,0.75,na.rm=T)-quantile(duration,0.25,na.rm=T))
      )
      ,NA
      ,duration
    ),na.rm=T)
    ,std=sd(ifelse(
      duration<(
        quantile(duration,0.25,na.rm=T)
        -1.5*(quantile(duration,0.75,na.rm=T)-quantile(duration,0.25,na.rm=T))
      )
      | duration>(
        quantile(duration,0.75,na.rm=T)
        +1.5*(quantile(duration,0.75,na.rm=T)-quantile(duration,0.25,na.rm=T))
      )
      ,NA
      ,duration
    ),na.rm=T)
    ,.groups='drop'
  ) %>%
  arrange(FEE_CODE,keys)
```

```{r Create selector of urine cath at order level, include=FALSE}
if(all(c(2)%in%comp_req)){ # 01m 00s
  uri_cath_d_order_selector0=
    raw_data %>%
    .[str_detect(names(.),'^v_ipd_fee')] %>%
    lapply(filter,FEE_CODE%in%uri_cath$FEE_CODE) %>%
    lapply(\(x)
      x %>%
        select_at(
          colnames(.) %>%
            .[str_detect(
              .
              ,paste0(
                c(
                  '^CHR_NO'
                  ,'^FEE_NO'
                  ,'^FEE_DATE'
                  ,'^FEE_TIME'
                  ,'^FEE_CODE'
                  ,'^SEQ_NO'
                  ,'^START'
                  ,'^DC'
                )
                ,collapse='|'
              )
            )]
        )
    ) %>%
    lapply(
      X=names(.)
      ,Y=.
      ,\(X,Y)
      Y[[X]] %>%
        mutate(
          HOSP=
            str_sub(X,str_count(X),str_count(X))
          ,TYPE=
            str_sub(X,3,5)
        )
    ) %>%
    do.call(rbind,.) %>%
    mutate(
      START_TIME=
        ifelse(
          !is.na(START_DATE) & is.na(START_TIME)
          ,'0000'
          ,START_TIME
        )
      ,DC_TIME=
        ifelse(
          !is.na(DC_DATE) & is.na(DC_TIME)
          ,'0000'
          ,DC_TIME
        )
    ) %>%
    mutate_at(
      c('START_DATE','DC_DATE')
      ,\(x)
      as.numeric(x)+(2023-112)*10000
    ) %>%
    mutate_at(
      c('START_DATE','DC_DATE')
      ,\(x)
      paste0(
        str_sub(x,1,4)
        ,'-'
        ,str_sub(x,5,6)
        ,'-'
        ,str_sub(x,7,8)
      )
    ) %>%
    mutate_at(
      c('START_TIME','DC_TIME')
      ,\(x)
      paste0(
        str_sub(x,1,2)
        ,':'
        ,str_sub(x,3,4)
      )
    ) %>%
    unite(START,START_DATE,START_TIME,sep=' ') %>%
    unite(DC,DC_DATE,DC_TIME,sep=' ') %>%
    mutate_at(
      c('START','DC')
      ,\(x)
      ifelse(
        str_count(x)==16
        & str_count(x,'-')==2
        & str_count(x,' ')==1
        & str_count(x,'\\:')==1
        ,x
        ,NA
      )
    ) %>%
    mutate_at(c('START','DC'),ymd_hm) %>%
    arrange(HOSP,CHR_NO,TYPE,FEE_NO,START,DC) %>%
    mutate(merged=1)
  
  uri_cath_d_order_selector=
    uri_cath_d_order_selector0
  
  # %>%
  #   filter(FEE_CODE=='F47014C')
  
  uri_cath_d_order_selector_nrow=
    uri_cath_d_order_selector %>%
    nrow()
  
  iter=0
  
  while(iter<1){
    cat('iter',iter,'nrow',uri_cath_d_order_selector_nrow,'\n')
  
    uri_cath_d_order_selector=
      uri_cath_d_order_selector %>%
      group_by(HOSP,CHR_NO,TYPE,FEE_NO) %>%
      mutate(seq=seq(n())) %>%
      ungroup() %>%
      left_join(
        select(.,HOSP,CHR_NO,TYPE,FEE_NO,seq,DC) %>%
          mutate(seq=seq+1) %>%
          rename(prev_DC=DC)
        ,by=c('HOSP','CHR_NO','TYPE','FEE_NO','seq')
      ) %>%
      mutate(dist=as.duration(START-prev_DC)/ddays(1)) %>%
      mutate(dist=ifelse(is.na(dist),0,dist)) %>%
      group_by(HOSP,CHR_NO,TYPE,FEE_NO) %>%
      mutate(unmerged=dist>1) %>%
      mutate(seq2=cumsum(unmerged)+1) %>%
      ungroup() %>%
      select(-seq,-prev_DC,-dist,-unmerged) %>%
      rename(seq=seq2) %>%
      group_by(HOSP,CHR_NO,TYPE,FEE_NO,seq) %>%
      mutate(
        FEE_CODE=paste0(sort(unique(FEE_CODE)),collapse=' & ')
        ,START=min(START)
        ,DC=max(DC)
        ,merged=sum(merged)
      ) %>%
      slice(1) %>%
      ungroup() %>%
      select(-seq)
  
    if(uri_cath_d_order_selector_nrow>nrow(uri_cath_d_order_selector)){
      iter=0
    }else{
      iter=iter+1
    }
  
    uri_cath_d_order_selector_nrow=
      uri_cath_d_order_selector %>%
      nrow()
  }
  
  rm(iter,uri_cath_d_order_selector_nrow)
  
  uri_cath_d_order_selector=
    uri_cath_d_order_selector %>%
    mutate(duration=as.duration(DC-START)/ddays(1)) %>%
    # filter(duration>2) %>%
    select(
      HOSP,CHR_NO
      ,TYPE,FEE_NO
      ,FEE_DATE,FEE_TIME,FEE_CODE,SEQ_NO,SEQ_NO2
      ,START,DC,duration
      ,merged
    )
  
  uri_cath_d_order_selector0=
    uri_cath_d_order_selector0 %>%
    mutate(duration=as.duration(DC-START)/ddays(1)) %>%
    select(
      HOSP,CHR_NO
      ,TYPE,FEE_NO
      ,FEE_DATE,FEE_TIME,FEE_CODE,SEQ_NO,SEQ_NO2
      ,START,DC,duration
    )
  
  uri_cath_d_order_selector0 %>%
    saveRDS('data/uri_cath_d_order_selector0.rds')
  
  uri_cath_d_order_selector %>%
    saveRDS('data/uri_cath_d_order_selector.rds')
}else{
  uri_cath_d_order_selector0=
    readRDS('data/uri_cath_d_order_selector0.rds')
  
  uri_cath_d_order_selector=
    readRDS('data/uri_cath_d_order_selector.rds')
}
```

```{r Create selector of urine cath at prediction level, include=FALSE}
if(all(c(2)%in%comp_req)){ # 06m 03s
  uri_cath_d_pred_selector=
    uri_cath_d_order_selector %>%
    pblapply(X=seq(nrow(.)),Y=.,\(X,Y){
      Y %>%
        slice(X) %>%
        lapply(
          X=seq(0,ceiling(ifelse(is.na(.$duration),0,.$duration))+2)
          ,Y=.
          ,\(X,Y)Y
        ) %>%
        do.call(rbind,.) %>%
        mutate(pred_day=seq(0,n()-1))
    }) %>%
    do.call(rbind,.) %>%
    mutate(pred_day=START+ddays(pred_day))
  
  saveRDS(uri_cath_d_pred_selector,'data/uri_cath_d_pred_selector.rds')
}else{
  uri_cath_d_pred_selector=readRDS('data/uri_cath_d_pred_selector.rds')
}
```

```{r Create selector of urine cath at visit level, include=FALSE}
if(all(c(2)%in%comp_req)){ # 01m 00s
  uri_cath_d_visit_selector=
    raw_data %>%
    .[str_detect(names(.),'^v_ipd_basic')] %>%
    lapply(\(x)
      x %>%
        select_at(
          colnames(.) %>%
            .[str_detect(.,'^CHR_NO|^FEE_NO')]
        )
    ) %>%
    lapply(
      X=names(.)
      ,Y=.
      ,\(X,Y)
      Y[[X]] %>%
        mutate(
          HOSP=
            str_sub(X,str_count(X),str_count(X))
          ,TYPE=
            str_sub(X,3,5)
        )
    ) %>%
    do.call(rbind,.) %>%
    filter(
      paste0(HOSP,'_',CHR_NO,'_',TYPE,'_',FEE_NO)
      %in%paste0(
        uri_cath_d_order_selector$HOSP
        ,'_'
        ,uri_cath_d_order_selector$CHR_NO
        ,'_'
        ,uri_cath_d_order_selector$TYPE
        ,'_'
        ,uri_cath_d_order_selector$FEE_NO
      )
    ) %>%
    select(
      HOSP,CHR_NO
      ,TYPE,FEE_NO
    )
  
  saveRDS(uri_cath_d_visit_selector,'data/uri_cath_d_visit_selector.rds')
}else{
  uri_cath_d_visit_selector=readRDS('data/uri_cath_d_visit_selector.rds')
}
```

```{r Create selector of urine cath at patient level, include=FALSE}
if(all(c(2)%in%comp_req)){ # 01m 00s
  uri_cath_d_patient_selector=
    raw_data %>%
    .[str_detect(names(.),'^v_chr_basic')] %>%
    lapply(\(x)
      x %>%
        select_at(
          colnames(.) %>%
            .[str_detect(.,'^CHR_NO')]
        )
    ) %>%
    lapply(
      X=names(.)
      ,Y=.
      ,\(X,Y)
      Y[[X]] %>%
        mutate(
          HOSP=
            str_sub(X,str_count(X),str_count(X))
        )
    ) %>%
    do.call(rbind,.) %>%
    filter(
      paste0(HOSP,'_',CHR_NO)
      %in%paste0(
        uri_cath_d_visit_selector$HOSP
        ,'_'
        ,uri_cath_d_visit_selector$CHR_NO
      )
    ) %>%
    select(HOSP,CHR_NO)
  
  uri_cath_d_patient_selector %>%
    saveRDS('data/uri_cath_d_patient_selector.rds')
}else{
  uri_cath_d_patient_selector=
    readRDS('data/uri_cath_d_patient_selector.rds')
}
```

```{r Find an example in merging of Foley duration, include=FALSE}
seq_example=
  uri_cath_d_order_selector %>%
  group_by(HOSP,CHR_NO,TYPE,FEE_NO,FEE_CODE) %>%
  mutate(earliest=min(START,na.rm=T)) %>%
  ungroup() %>%
  arrange(earliest) %>%
  left_join(
    select(.,HOSP,CHR_NO,TYPE,FEE_NO) %>%
      filter(!duplicated(.)) %>%
      mutate(ID=seq(nrow(.)))
    ,by=c('HOSP','CHR_NO','TYPE','FEE_NO')
  ) %>%
  filter(
    ID
    %in%pull(
      group_by(.,ID) %>%
        summarize(n=n(),.groups='drop') %>%
        filter(n==4)
      ,ID
    )
  ) %>%
  arrange(ID,START) %>%
  group_by(HOSP,CHR_NO,TYPE,FEE_NO) %>%
  summarize(type=length(unique(FEE_CODE)),.groups='drop') %>%
  filter(type>1) %>%
  select(CHR_NO,FEE_NO) %>%
  slice(1:4)
```

```{r Merging examples, eval=FALSE, fig.height=5, fig.width=7, include=FALSE}
uri_cath_d_order_selector0 %>%
  group_by(HOSP,CHR_NO,TYPE,FEE_NO) %>%
  mutate(earliest=min(START,na.rm=T)) %>%
  ungroup() %>%
  arrange(earliest) %>%
  filter(
    paste0(CHR_NO,FEE_NO)%in%paste0(seq_example$CHR_NO,seq_example$FEE_NO)
  ) %>%
  mutate(status='Before merging') %>%
  rbind(
    uri_cath_d_order_selector %>%
      select(-merged) %>%
      group_by(HOSP,CHR_NO,TYPE,FEE_NO) %>%
      mutate(earliest=min(START,na.rm=T)) %>%
      ungroup() %>%
      arrange(earliest) %>%
      filter(
        paste0(CHR_NO,FEE_NO)%in%paste0(seq_example$CHR_NO,seq_example$FEE_NO)
      ) %>%
      mutate(status='After merging')
  ) %>%
  left_join(
    uri_cath_d_order_selector0 %>%
      select(HOSP,CHR_NO,TYPE,FEE_NO) %>%
      rbind(
        uri_cath_d_order_selector %>%
          select(HOSP,CHR_NO,TYPE,FEE_NO)
      ) %>%
      filter(!duplicated(.)) %>%
      mutate(ID=seq(nrow(.)))
    ,by=c('HOSP','CHR_NO','TYPE','FEE_NO')
  ) %>%
  ggplot(aes(status,START+duration/2,color=FEE_CODE)) +
  geom_linerange(aes(ymin=START,ymax=DC),size=0.5,alpha=0.75) +
  geom_point(size=1.5,alpha=0.75) +
  facet_wrap(ID~.,scales='free',ncol=1) +
  coord_flip() +
  scale_x_discrete('') +
  scale_y_datetime(
    ''
    ,date_breaks='1 month'
    ,date_labels='%Y-%m'
    ,date_minor_breaks='1 day'
  )
```

```{r List variable to save results of selection, eval=FALSE, include=FALSE}
# selection=list()
# selection %>% saveRDS('data/selection.rds')
selection=readRDS('data/selection.rds')
```

```{r Save results of every selection scenario, eval=FALSE, include=FALSE}
# selection$start_upd_gt2_idw=
#   rbind(
#     uri_cath_d_pred_selector %>%
#       mutate(level='prediction') %>%
#       group_by(HOSP,TYPE,level) %>%
#       summarize(n=n(),.groups='drop') %>%
#       spread(HOSP,n)
#     ,uri_cath_d_order_selector %>%
#       mutate(level='order') %>%
#       group_by(HOSP,TYPE,level) %>%
#       summarize(n=n(),.groups='drop') %>%
#       spread(HOSP,n)
#     ,uri_cath_d_visit_selector %>%
#       mutate(level='visit') %>%
#       group_by(HOSP,TYPE,level) %>%
#       summarize(n=n(),.groups='drop') %>%
#       spread(HOSP,n)
#     ,uri_cath_d_patient_selector %>%
#       mutate(TYPE=NA,level='patient') %>%
#       group_by(HOSP,TYPE,level) %>%
#       summarize(n=n(),.groups='drop') %>%
#       spread(HOSP,n)
#   ) %>%
#   mutate(dataset='start_upd_gt2_idw')
```

```{r Results of several selection scenarios, eval=FALSE, include=FALSE}
selection %>%
  lapply(
    X=seq(length(.))
    ,Y=.
    ,\(X,Y)mutate(Y[[X]],seq=X,seq2=seq(nrow(Y[[X]])))
  ) %>%
  lapply(gather,HOSP,n,-TYPE,-level,-dataset,-seq,-seq2) %>%
  do.call(rbind,.) %>%
  spread(HOSP,n,fill=0) %>%
  mutate(
    dataset=
      ifelse(
        !str_detect(dataset,'_idw')
        ,paste0(dataset,'_all')
        ,dataset
      )
  ) %>%
  separate(dataset,c('start','end','min_duration','cath_type'),sep='_') %>%
  mutate(
    min_duration=
      case_when(
        min_duration=='all'~'any duration (inc. missing value)'
        ,min_duration=='gt0'~'greater than 0 day (exc. missing value)'
        ,min_duration=='gt1'~'greater than 1 day'
        ,min_duration=='gt2'~'greater than 2 days'
      )
    ,cath_type=
      case_when(
        cath_type=='all'~'indwelling + intermittent'
        ,cath_type=='idw'~'indwelling'
      )
  ) %>%
  group_by(start,end,min_duration,cath_type) %>%
  mutate(
    s_epv_cp20_p10=round(max(ifelse(level=='prediction',s,NA),na.rm=T)*0.1/20,2)
    ,s_epv_cp28_p10=round(max(ifelse(level=='prediction',s,NA),na.rm=T)*0.1/28,2)
  ) %>%
  arrange(desc(min_duration),cath_type,end,desc(seq),seq2) %>%
  select(-seq,-seq2) %>%
  # write_csv('selection.csv')
  knitr::kable()
```

```{r Chosen selection scenarios, include=FALSE}
uri_cath_d3=
  list(
    prediction=
      uri_cath_d_pred_selector %>%
      filter(duration>2)
    ,order=
      uri_cath_d_order_selector %>%
      filter(duration>2)
    ,visit=
      uri_cath_d_visit_selector %>%
      filter(
        paste0(HOSP,CHR_NO,TYPE,FEE_NO)
        %in%pull(
          uri_cath_d_order_selector %>%
            filter(duration>2) %>%
            mutate(selector=paste0(HOSP,CHR_NO,TYPE,FEE_NO))
          ,selector
        )
      )
    ,patient=
      uri_cath_d_patient_selector %>%
      filter(
        paste0(HOSP,CHR_NO)
        %in%pull(
          uri_cath_d_order_selector %>%
            filter(duration>2) %>%
            mutate(selector=paste0(HOSP,CHR_NO))
          ,selector
        )
      )
  )

uri_cath_d=
  list(
    prediction=uri_cath_d_pred_selector
    ,order=uri_cath_d_order_selector
    ,visit=uri_cath_d_visit_selector
    ,patient=uri_cath_d_patient_selector
  )
```

```{r Sanity check the number of selected samples, eval=FALSE, include=FALSE}
uri_cath_d3 %>%
  lapply(group_by,HOSP) %>%
  lapply(summarize,n=n()) %>%
  lapply(X=names(.),Y=.,\(X,Y)mutate(Y[[X]],level=X)) %>%
  lapply(spread,HOSP,n) %>%
  do.call(rbind,.)

uri_cath_d %>%
  lapply(group_by,HOSP) %>%
  lapply(summarize,n=n()) %>%
  lapply(X=names(.),Y=.,\(X,Y)mutate(Y[[X]],level=X)) %>%
  lapply(spread,HOSP,n) %>%
  do.call(rbind,.)
```

```{r Only takes the latest cath. per visit, eval=FALSE, include=FALSE}
uri_cath_d3[c('prediction','order')] %>%
  lapply(group_by,HOSP,CHR_NO,TYPE,FEE_NO) %>%
  lapply(filter,START==max(START)) %>%
  lapply(group_by,HOSP) %>%
  lapply(summarize,n=n()) %>%
  lapply(X=names(.),Y=.,\(X,Y)mutate(Y[[X]],level=X)) %>%
  lapply(spread,HOSP,n) %>%
  do.call(rbind,.)

uri_cath_d[c('prediction','order')] %>%
  lapply(group_by,HOSP,CHR_NO,TYPE,FEE_NO) %>%
  lapply(filter,START==max(START)) %>%
  lapply(group_by,HOSP) %>%
  lapply(summarize,n=n()) %>%
  lapply(X=names(.),Y=.,\(X,Y)mutate(Y[[X]],level=X)) %>%
  lapply(spread,HOSP,n) %>%
  do.call(rbind,.)
```

```{r Show CHR_NO overlaps among hospitals, eval=FALSE, include=FALSE}
raw_data %>%
  .[str_detect(names(.),'^v_chr_basic')] %>%
  lapply(\(x)
    x %>%
      select_at(
        colnames(.) %>%
          .[str_detect(.,'^CHR_NO')]
      )
  ) %>%
  lapply(
    X=names(.)
    ,Y=.
    ,\(X,Y)
    Y[[X]] %>%
      mutate(
        HOSP=
          str_sub(X,str_count(X),str_count(X))
      )
  ) %>%
  do.call(rbind,.) %>%
  group_by(CHR_NO) %>%
  summarize(HOSP=paste0(HOSP,collapse=',')) %>%
  group_by(HOSP) %>%
  summarize(n=n(),.groups='drop')
```

```{r Required table per variable, include=FALSE}
tab_req=read_csv('data/tab_req.csv')
```

```{r Table connection, include=FALSE}
tab_conn=
  read_csv('data/tab_conn.csv') %>%
  filter(
    str_detect(parent,paste0(paste0('^',tab_req$table,'$'),collapse='|'))
    | str_detect(child,paste0(paste0('^',tab_req$table,'$'),collapse='|'))
  )

```

```{r Check table availability, include=FALSE}
tab_avail=
  tab_req %>%
  group_by(table) %>%
  summarize(n=n()) %>%
  pull(table) %>%
  .[!is.na(.)] %>%
  lapply(X=1:2,Y=.,\(X,Y){
    if(X==1){
      Y
    }else{
      raw_data %>%
        names() %>%
        str_remove_all('^v_|_s$|_t$|_w$') %>%
        str_to_upper()
    }
  }) %>%
  sapply(X=1:3,Y=.,\(X,Y){
    if(X==1){
      Y[[1]] %>%
        setdiff(Y[[2]])
    }else if(X==2){
      Y[[1]] %>%
        intersect(Y[[2]])
    }else{
      Y[[2]] %>%
        setdiff(Y[[1]])
    }
  }) %>%
  `names<-`(c(
    'Unavailable required tables'
    ,'Available required tables'
    ,'Available unrequired tables'
  ))
```

```{r Variables requiring unavailable tables, eval=FALSE, include=FALSE}
tab_req %>%
  mutate(unavail=table%in%tab_avail$`Unavailable required tables`) %>%
  filter(
    variable
    %in%filter(.,unavail)$variable
  )
```

```{r Select subject and table of interests, include=FALSE}
if(all(c(1,2)%in%comp_req)){
  raw_data1a=
    raw_data %>%
    .[str_to_upper(str_remove_all(names(.),'^v_|_s$|_t$|_w$'))
      %in%tab_req$table] %>%
    lapply(X=names(.),Y=.,\(X,Y){
      if('CHR_NO'%in%colnames(Y[[X]])){
        Y[[X]] %>%
          filter(
            CHR_NO
            %in%pull(
              uri_cath_d3$patient %>%
                filter(HOSP==str_sub(X,str_count(X),str_count(X)))
              ,CHR_NO
            )
          )
      }else{
        Y[[X]]
      }
    }) %>%
    `names<-`(
      raw_data %>%
        .[str_to_upper(str_remove_all(names(.),'^v_|_s$|_t$|_w$'))
          %in%tab_req$table] %>%
        names()
    )
  
  saveRDS(raw_data1a,'data/raw_data1a.rds')
  
  raw_data1b=
    raw_data %>%
    .[str_to_upper(str_remove_all(names(.),'^v_|_s$|_t$|_w$'))
      %in%tab_req$table] %>%
    lapply(X=names(.),Y=.,\(X,Y){
      if('CHR_NO'%in%colnames(Y[[X]])){
        Y[[X]] %>%
          filter(
            CHR_NO
            %in%pull(
              uri_cath_d$patient %>%
                filter(HOSP==str_sub(X,str_count(X),str_count(X)))
              ,CHR_NO
            )
          )
      }else{
        Y[[X]]
      }
    }) %>%
    `names<-`(
      raw_data %>%
        .[str_to_upper(str_remove_all(names(.),'^v_|_s$|_t$|_w$'))
          %in%tab_req$table] %>%
        names()
    )
  
  saveRDS(raw_data1b,'data/raw_data1b.rds')
}else{
  raw_data1a=readRDS('data/raw_data1a.rds')
  raw_data1b=readRDS('data/raw_data1b.rds')
}
```

```{r Check row reduction, eval=FALSE, include=FALSE}
raw_data %>%
  sapply(dim) %>%
  t() %>%
  as.data.frame() %>%
  rownames_to_column(var='table') %>%
  left_join(
    raw_data1a %>%
      sapply(dim) %>%
      t() %>%
      as.data.frame() %>%
      rownames_to_column(var='table')
    ,by='table'
  ) %>%
  mutate(
    row_reduction=V1.x-V1.y
    ,row_reduction_p=round(row_reduction/V1.x*100,3)
  ) %>%
  filter(!is.na(row_reduction) & row_reduction>0) %>%
  arrange(desc(row_reduction))

raw_data %>%
  sapply(dim) %>%
  t() %>%
  as.data.frame() %>%
  rownames_to_column(var='table') %>%
  left_join(
    raw_data1b %>%
      sapply(dim) %>%
      t() %>%
      as.data.frame() %>%
      rownames_to_column(var='table')
    ,by='table'
  ) %>%
  mutate(
    row_reduction=V1.x-V1.y
    ,row_reduction_p=round(row_reduction/V1.x*100,3)
  ) %>%
  filter(!is.na(row_reduction) & row_reduction>0) %>%
  arrange(desc(row_reduction))
```

```{r Find unique identifiers in CHR_ICD, eval=FALSE, include=FALSE}
raw_data1a %>%
  .[str_detect(names(.),'^v_chr_icd')] %>%
  lapply(\(x)
    x %>%
      select_at(
        colnames(.) %>%
          .[str_detect(.,'^CHR_NO|^FEE_NO|^HOSPIN_DATE|^HIA_DATE')]
      )
  ) %>%
  lapply(
    X=names(.)
    ,Y=.
    ,\(X,Y)
    Y[[X]] %>%
      mutate(
        HOSP=
          str_sub(X,str_count(X),str_count(X))
      )
  ) %>%
  do.call(rbind,.) %>%
  group_by_all() %>%
  summarize(n=n(),.groups='drop') %>%
  arrange(desc(n))
```

```{r Extract tables of diagnosis updates, include=FALSE}
diag_upd=
  raw_data1b %>%
  .[str_detect(names(.),'^v_chr_icd')] %>%
  lapply(
    X=names(.)
    ,Y=.
    ,\(X,Y)
    Y[[X]] %>%
      mutate(
        HOSP=
          str_sub(X,str_count(X),str_count(X))
      )
  ) %>%
  do.call(rbind,.) %>%
  select_at(
    c('HOSP','CHR_NO','FEE_NO','HOSPIN_DATE','HIA_DATE'
      ,select_at(.,colnames(.) %>% .[str_detect(.,'CODE')]) %>%
        sapply(\(x)any(str_detect(x,'[:alpha:]') & str_detect(x,'\\.'))) %>%
        .[.] %>%
        names()
      )
  ) %>%
  left_join(
    raw_data1b %>%
      .[str_detect(names(.),'^v_chr_diag')] %>%
      lapply(
        X=names(.)
        ,Y=.
        ,\(X,Y)
        Y[[X]] %>%
          mutate(
            HOSP=
              str_sub(X,str_count(X),str_count(X))
          )
      ) %>%
      do.call(rbind,.) %>%
      select_at(
        c('HOSP','CHR_NO','HIA_DATE'
          ,colnames(.)[str_detect(
            colnames(.)
            ,colnames(.) %>%
              .[str_detect(.,'_ORD')] %>%
              str_remove_all('_ORD')
          )]
        )
      )
    ,by=c('HOSP','CHR_NO','HIA_DATE')
  ) %>%
  select(HOSP,CHR_NO,FEE_NO,HOSPIN_DATE,SDIAG_ORD,SDIAG_CODE) %>%
  arrange(HOSPIN_DATE,SDIAG_ORD) %>%
  mutate(HOSPIN_TIME='0000') %>%
  mutate(HOSPIN_DATE=as.numeric(HOSPIN_DATE)+(2023-112)*10000) %>%
  mutate(
    HOSPIN_DATE=
      paste0(
        str_sub(HOSPIN_DATE,1,4)
        ,'-'
        ,str_sub(HOSPIN_DATE,5,6)
        ,'-'
        ,str_sub(HOSPIN_DATE,7,8)
      )
  ) %>%
  mutate(
    HOSPIN_TIME=
      paste0(
        str_sub(HOSPIN_TIME,1,2)
        ,':'
        ,str_sub(HOSPIN_TIME,3,4)
      )
  ) %>%
  unite(HOSPIN,HOSPIN_DATE,HOSPIN_TIME,sep=' ') %>%
  mutate(
    HOSPIN=
      ifelse(
        str_count(HOSPIN)==16
        & str_count(HOSPIN,'-')==2
        & str_count(HOSPIN,' ')==1
        & str_count(HOSPIN,'\\:')==1
        ,HOSPIN
        ,NA
      )
  ) %>%
  mutate(HOSPIN=ymd_hm(HOSPIN))
```

```{r Extract tables of discharge diagnosis, include=FALSE}
diag_discharge=
  raw_data1b %>%
  .[str_detect(names(.),'^v_ipd_basic')] %>%
  lapply(\(x)
    x %>%
      select_at(
        colnames(.) %>%
          .[str_detect(.,'^CHR_NO|^FEE_NO|^MDIAG|^SDIAG')
            | (str_detect(.,'^ICD') & str_detect(.,'OUT$'))
            ]
      )
  ) %>%
  lapply(
    X=names(.)
    ,Y=.
    ,\(X,Y)
    Y[[X]] %>%
      mutate(
        HOSP=
          str_sub(X,str_count(X),str_count(X))
        ,TYPE=
          str_sub(X,3,5)
      )
  ) %>%
  do.call(rbind,.) %>%
  select(HOSP,everything()) %>%
  mutate_all(as.character) %>%
  gather(KEY,CODE,-HOSP,-CHR_NO,-TYPE,-FEE_NO)
```

```{r Find an example in multiple diagnosis updates, include=FALSE}
seq_example2=
  raw_data1b %>%
  .[str_detect(names(.),'^v_chr_icd')] %>%
  lapply(
    X=names(.)
    ,Y=.
    ,\(X,Y)
    Y[[X]] %>%
      mutate(
        HOSP=
          str_sub(X,str_count(X),str_count(X))
      )
  ) %>%
  do.call(rbind,.) %>%
  filter(
    paste0(HOSP,'_',CHR_NO,'_',FEE_NO)
    %in%paste0(
      uri_cath_d$prediction$HOSP
      ,'_'
      ,uri_cath_d$prediction$CHR_NO
      ,'_'
      ,uri_cath_d$prediction$FEE_NO
    )
  ) %>%
  group_by(HOSP,CHR_NO,FEE_NO) %>%
  summarize(n=n(),.groups='drop') %>%
  arrange(desc(n)) %>%
  slice(1)

seq_example2=
  diag_upd %>%
  filter(
    paste0(HOSP,'_',CHR_NO,'_',FEE_NO)
    %in%paste0(
      seq_example2$HOSP
      ,'_'
      ,seq_example2$CHR_NO
      ,'_'
      ,seq_example2$FEE_NO
    )
  )

seq_example2=
  uri_cath_d$prediction %>%
  filter(
    paste0(HOSP,'_',CHR_NO,'_',FEE_NO)
    %in%paste0(
      seq_example2$HOSP
      ,'_'
      ,seq_example2$CHR_NO
      ,'_'
      ,seq_example2$FEE_NO
    )
  ) %>%
  lapply(X=seq(nrow(.)),Y=.,Z=seq_example2,\(X,Y,Z){
    K=Y %>%
      slice(X)
    
    K %>%
      left_join(
        Z %>%
          filter(HOSPIN>=K$START & HOSPIN<=K$pred_day)
        ,by=c('HOSP','CHR_NO','FEE_NO')
      )
  }) %>%
  do.call(rbind,.)
```

```{r An example of multiple diagnosis updates, eval=FALSE, include=FALSE}
seq_example2 %>%
  mutate(ID='1. Prediction interval') %>%
  ggplot(aes(ID,START+duration/2,color=paste0(START,DC))) +
  geom_linerange(aes(ymin=START,ymax=DC),size=0.5,alpha=0.75,show.legend=F) +
  geom_point(size=1.5,alpha=0.75,show.legend=F) +
  geom_point(
    data=
      seq_example2 %>%
      mutate(ID='2. Diagnoses')
    ,aes(ID,HOSPIN)
    ,show.legend=F
    ,na.rm=T
  ) +
  facet_wrap(~SDIAG_CODE) +
  coord_flip() +
  scale_x_discrete('') +
  scale_y_datetime(
    ''
    ,date_breaks='1 month'
    ,date_labels='%Y-%m'
    ,date_minor_breaks='1 day'
  ) +
  theme(
    axis.text.x=element_text(angle=90,hjust=1,vjust=0.5)
  )
```

```{r Create diagnosis identifier, include=FALSE}
if(all(c(1,2,3)%in%comp_req)){
  diag_identifier=
    uri_cath_d$prediction %>%
    left_join(
      group_by(.,HOSP,CHR_NO,TYPE,FEE_NO) %>%
        mutate(latest_pred_day=max(pred_day)) %>%
        ungroup() %>%
        left_join(
          diag_upd
          ,by=c('HOSP','CHR_NO','FEE_NO')
        ) %>%
        filter(HOSPIN>pred_day & HOSPIN<=latest_pred_day)
      ,by=colnames(uri_cath_d$prediction)
    ) %>%
    left_join(
      diag_discharge
      ,by=c('HOSP','CHR_NO','TYPE','FEE_NO')
    ) %>%
    mutate(
      ALL_CODE=
        ifelse(
          is.na(SDIAG_CODE) | SDIAG_CODE==''
          ,ifelse(CODE=='',NA,CODE)
          ,SDIAG_CODE
        )
    )
  
  saveRDS(diag_identifier,'data/diag_identifier.rds')
}else{
  diag_identifier=readRDS('data/diag_identifier.rds')
}
```

```{r Create UTI identifier, include=FALSE}
if(all(c(1,2,3)%in%comp_req)){
  uti_identifier=
    diag_identifier %>%
    group_by_at(colnames(uri_cath_d$prediction)) %>%
    summarize(
      all_UTI_na=
        all(is.na(ALL_CODE))
      ,UTI=
        any(str_sub(ALL_CODE,1,3)%in%c('N39','599'))
      ,.groups='drop'
    ) %>%
    mutate(UTI=ifelse(all_UTI_na,NA,UTI)) %>%
    select(-all_UTI_na)
  
  saveRDS(uti_identifier,'data/uti_identifier.rds')
}else{
  uti_identifier=readRDS('data/uti_identifier.rds')
}
```

```{r Create UTI onset identifier, include=FALSE}
if(all(c(1,2,3)%in%comp_req)){
  uti_onset_identifier=
    diag_identifier %>%
    left_join(
      los_upd
      ,by=c('HOSP','CHR_NO','FEE_NO')
    ) %>%
    mutate(
      UTI_onset_HOSPIN=as.duration(HOSPIN-START)/ddays(1)
      ,UTI_onset_CPD=as.duration(CPD-START)/ddays(1)
    ) %>%
    group_by_at(colnames(uri_cath_d$prediction)) %>%
    summarize(
      UTI_onset=
        ifelse(
          any(str_sub(ALL_CODE,1,3)%in%c('N39','599'))
          ,ifelse(
            all(is.na(HOSPIN))
            ,min(UTI_onset_CPD,na.rm=T)
            ,min(UTI_onset_HOSPIN,na.rm=T)
          )
          ,ifelse(
            all(is.na(CPD))
            ,as.Date(NA)
            ,min(UTI_onset_CPD,na.rm=T)
          )
        )
      ,.groups='drop'
    )
  
  saveRDS(uti_onset_identifier,'data/uti_onset_identifier.rds')
}else{
  uti_onset_identifier=readRDS('data/uti_onset_identifier.rds')
}
```

```{r UTI prev. selection 1 by discharge diagnosis, eval=FALSE, include=FALSE}
raw_data1a %>%
  .[str_detect(names(.),'^v_ipd_basic')] %>%
  lapply(\(x)
    x %>%
      select_at(
        colnames(.) %>%
          .[str_detect(.,'^CHR_NO|^FEE_NO|^MDIAG|^SDIAG')
            | (str_detect(.,'^ICD') & str_detect(.,'OUT$'))
            ]
      )
  ) %>%
  lapply(
    X=names(.)
    ,Y=.
    ,\(X,Y)
    Y[[X]] %>%
      mutate(
        HOSP=
          str_sub(X,str_count(X),str_count(X))
        ,TYPE=
          str_sub(X,3,5)
      )
  ) %>%
  do.call(rbind,.) %>%
  gather(KEY,CODE,-HOSP,-CHR_NO,-FEE_NO) %>%
  group_by(HOSP,CHR_NO,FEE_NO) %>%
  summarize(UTI=any(str_sub(CODE,1,3)%in%c('N39','599')),.groups='drop') %>%
  right_join(
    uri_cath_d3$prediction %>%
      group_by(HOSP,CHR_NO,TYPE,FEE_NO) %>%
      filter(START==max(START)) %>%
      ungroup()
    ,by=c('HOSP','CHR_NO','FEE_NO')
  ) %>%
  filter(HOSP=='t') %>%
  group_by(HOSP,UTI) %>%
  summarize(n=n(),.groups='drop') %>%
  group_by(HOSP) %>%
  mutate(
    total=sum(n)
    ,p=round(n/total*100,2)
  ) %>%
  ungroup()

raw_data1a %>%
  .[str_detect(names(.),'^v_ipd_basic')] %>%
  lapply(\(x)
    x %>%
      select_at(
        colnames(.) %>%
          .[str_detect(.,'^CHR_NO|^FEE_NO|^MDIAG|^SDIAG')
            | (str_detect(.,'^ICD') & str_detect(.,'OUT$'))
            ]
      )
  ) %>%
  lapply(
    X=names(.)
    ,Y=.
    ,\(X,Y)
    Y[[X]] %>%
      mutate(
        HOSP=
          str_sub(X,str_count(X),str_count(X))
        ,TYPE=
          str_sub(X,3,5)
      )
  ) %>%
  do.call(rbind,.) %>%
  gather(KEY,CODE,-HOSP,-CHR_NO,-FEE_NO) %>%
  group_by(HOSP,CHR_NO,FEE_NO) %>%
  summarize(UTI=any(str_sub(CODE,1,3)%in%c('N39','599')),.groups='drop') %>%
  right_join(
    uri_cath_d3$prediction
    ,by=c('HOSP','CHR_NO','FEE_NO')
  ) %>%
  mutate(HOSP=ifelse(HOSP%in%c('s','w'),'sw',HOSP)) %>%
  filter(HOSP=='sw') %>%
  group_by(HOSP,UTI) %>%
  summarize(n=n(),.groups='drop') %>%
  group_by(HOSP) %>%
  mutate(
    total=sum(n)
    ,p=round(n/total*100,2)
  ) %>%
  ungroup()
```

```{r UTI prev. selection 1 by dis. & upd. diagnosis, eval=FALSE, include=FALSE}
uti_identifier %>%
  filter(duration>2) %>%
  filter(HOSP=='t') %>%
  group_by(HOSP,UTI) %>%
  summarize(n=n(),.groups='drop') %>%
  group_by(HOSP) %>%
  mutate(
    total=sum(n)
    ,p=round(n/total*100,2)
  ) %>%
  ungroup()

uti_identifier %>%
  filter(duration>2) %>%
  mutate(HOSP=ifelse(HOSP%in%c('s','w'),'sw',HOSP)) %>%
  filter(HOSP=='sw') %>%
  group_by(HOSP,UTI) %>%
  summarize(n=n(),.groups='drop') %>%
  group_by(HOSP) %>%
  mutate(
    total=sum(n)
    ,p=round(n/total*100,2)
  ) %>%
  ungroup()
```

```{r UTI prev. selection 2 by discharge diagnosis, eval=FALSE, include=FALSE}
raw_data1b %>%
  .[str_detect(names(.),'^v_ipd_basic')] %>%
  lapply(\(x)
    x %>%
      select_at(
        colnames(.) %>%
          .[str_detect(.,'^CHR_NO|^FEE_NO|^MDIAG|^SDIAG')
            | (str_detect(.,'^ICD') & str_detect(.,'OUT$'))
            ]
      )
  ) %>%
  lapply(
    X=names(.)
    ,Y=.
    ,\(X,Y)
    Y[[X]] %>%
      mutate(
        HOSP=
          str_sub(X,str_count(X),str_count(X))
        ,TYPE=
          str_sub(X,3,5)
      )
  ) %>%
  do.call(rbind,.) %>%
  gather(KEY,CODE,-HOSP,-CHR_NO,-FEE_NO) %>%
  group_by(HOSP,CHR_NO,FEE_NO) %>%
  summarize(UTI=any(str_sub(CODE,1,3)%in%c('N39','599')),.groups='drop') %>%
  right_join(
    uri_cath_d$prediction %>%
      group_by(HOSP,CHR_NO,TYPE,FEE_NO) %>%
      filter(START==max(START)) %>%
      ungroup()
    ,by=c('HOSP','CHR_NO','FEE_NO')
  ) %>%
  mutate(HOSP=ifelse(HOSP%in%c('s','t'),'st',HOSP)) %>%
  filter(HOSP=='st') %>%
  group_by(HOSP,UTI) %>%
  summarize(n=n(),.groups='drop') %>%
  group_by(HOSP) %>%
  mutate(
    total=sum(n)
    ,p=round(n/total*100,2)
  ) %>%
  ungroup()

raw_data1b %>%
  .[str_detect(names(.),'^v_ipd_basic')] %>%
  lapply(\(x)
    x %>%
      select_at(
        colnames(.) %>%
          .[str_detect(.,'^CHR_NO|^FEE_NO|^MDIAG|^SDIAG')
            | (str_detect(.,'^ICD') & str_detect(.,'OUT$'))
            ]
      )
  ) %>%
  lapply(
    X=names(.)
    ,Y=.
    ,\(X,Y)
    Y[[X]] %>%
      mutate(
        HOSP=
          str_sub(X,str_count(X),str_count(X))
        ,TYPE=
          str_sub(X,3,5)
      )
  ) %>%
  do.call(rbind,.) %>%
  gather(KEY,CODE,-HOSP,-CHR_NO,-FEE_NO) %>%
  group_by(HOSP,CHR_NO,FEE_NO) %>%
  summarize(UTI=any(str_sub(CODE,1,3)%in%c('N39','599')),.groups='drop') %>%
  right_join(
    uri_cath_d$prediction
    ,by=c('HOSP','CHR_NO','FEE_NO')
  ) %>%
  filter(HOSP=='w') %>%
  group_by(HOSP,UTI) %>%
  summarize(n=n(),.groups='drop') %>%
  group_by(HOSP) %>%
  mutate(
    total=sum(n)
    ,p=round(n/total*100,2)
  ) %>%
  ungroup()
```

```{r UTI prev. selection 2 by dis. & upd. diagnosis, eval=FALSE, include=FALSE}
uti_identifier %>%
  mutate(HOSP=ifelse(HOSP%in%c('s','t'),'st',HOSP)) %>%
  filter(HOSP=='st') %>%
  group_by(HOSP,UTI) %>%
  summarize(n=n(),.groups='drop') %>%
  group_by(HOSP) %>%
  mutate(
    total=sum(n)
    ,p=round(n/total*100,2)
  ) %>%
  ungroup()

uti_identifier %>%
  filter(HOSP=='w') %>%
  group_by(HOSP,UTI) %>%
  summarize(n=n(),.groups='drop') %>%
  group_by(HOSP) %>%
  mutate(
    total=sum(n)
    ,p=round(n/total*100,2)
  ) %>%
  ungroup()
```

```{r TTE analysis of UTI by dis. & upd diagnosis, eval=FALSE, include=FALSE}
uti_identifier %>%
  filter(duration>2) %>%
  group_by_at(colnames(uri_cath_d3$prediction) %>% .[.!='pred_day']) %>%
  arrange_at(colnames(uri_cath_d3$prediction)) %>%
  mutate(pred_day=seq(n())+2) %>%
  ungroup() %>%
  mutate(UTI=ifelse(is.na(UTI),F,UTI)) %>%
  group_by(HOSP,pred_day) %>%
  summarize(
    `log(n)`=log(n())
    ,p=mean(UTI)
    ,.groups='drop'
  ) %>%
  gather(key,value,-HOSP,-pred_day) %>%
  ggplot(aes(pred_day,value)) +
  geom_col() +
  facet_grid(key~HOSP,scales='free',space='free_x') +
  scale_x_continuous(breaks=seq(1,100,1))

uti_identifier %>%
  group_by_at(colnames(uri_cath_d$prediction) %>% .[.!='pred_day']) %>%
  arrange_at(colnames(uri_cath_d$prediction)) %>%
  mutate(pred_day=seq(n())) %>%
  ungroup() %>%
  mutate(UTI=ifelse(is.na(UTI),F,UTI)) %>%
  group_by(HOSP,pred_day) %>%
  summarize(
    `log(n)`=log(n())
    ,p=mean(UTI)
    ,.groups='drop'
  ) %>%
  gather(key,value,-HOSP,-pred_day) %>%
  ggplot(aes(pred_day,value)) +
  geom_col() +
  facet_grid(key~HOSP,scales='free',space='free_x') +
  scale_x_continuous(breaks=seq(1,100,1))
```

```{r Check FEE_CODE for ordering urine culture, eval=FALSE, include=FALSE}
raw_data %>%
  .[str_detect(names(.),'^v_fee_basic')] %>%
  lapply(select,FEE_CODE,FEE_DESC) %>%
  lapply(
    X=names(.)
    ,Y=.
    ,\(X,Y)
    Y[[X]] %>%
      mutate(
        HOSP=
          str_sub(X,str_count(X),str_count(X))
      )
  ) %>%
  do.call(rbind,.) %>%
  filter(FEE_CODE=='F13008B')
```

```{r Find table connection for urine culture order, eval=FALSE, include=FALSE}
raw_data1b$v_opd_exper_s %>%
  filter(
    FEE_NO
    %in%pull(
      raw_data1b$v_ipd_fee_s %>%
        filter(FEE_CODE=='F13008B')
      ,FEE_NO
    )
  ) %>%
  select(
    CHR_NO,FEE_NO
    ,SEQ_NO,OPD_DATE,CODE_NO,ITEM_NO,LAB_NO
  )

raw_data1b$v_opd_exper_t %>%
  filter(
    FEE_NO
    %in%pull(
      raw_data1b$v_ipd_fee_t %>%
        filter(FEE_CODE=='F13008B')
      ,FEE_NO
    )
  ) %>%
  select(
    CHR_NO,FEE_NO
    ,SEQ_NO,OPD_DATE,CODE_NO,ITEM_NO,LAB_NO
  )

raw_data$v_exper_order_w %>%
  filter(
    FEE_NO
    %in%pull(
      raw_data1b$v_ipd_fee_w %>%
        filter(FEE_CODE=='F13008B')
      ,FEE_NO
    )
  ) %>%
  select(
    CHR_NO,FEE_NO
    ,FEE_CODE,GROUP_CODE,ITEM_NO1,LAB_NO,SOUR_FLAG,EXPER_CLASS,EXPER_TYPE
  )
```


```{r Extract tables of diagnosis updates, include=FALSE}
uricult_upd=
  raw_data1b %>%
  .[str_detect(names(.),'^v_opd_exper|^v_exper_order')] %>%
  lapply(
    X=names(.)
    ,Y=.
    ,\(X,Y){
    Z=Y[[X]] %>%
      left_join(
        raw_data1b[[paste0(
            'v_ipd_fee_'
            ,str_sub(X,str_count(X),str_count(X))
          )]] %>%
          filter(FEE_CODE=='F13008B') %>%
          select(FEE_NO,FEE_CODE,START_DATE,START_TIME) %>%
          rename(URICULT=FEE_CODE)
        ,by='FEE_NO'
      ) %>%
      filter(!(is.na(START_DATE) & is.na(START_TIME)))
    
    if(str_detect(X,'_s$|_t$')){
      Z=Z %>%
        select(
          CHR_NO,FEE_NO
          ,URICULT,START_DATE,START_TIME
          # ,SEQ_NO,OPD_DATE,CODE_NO,ITEM_NO,LAB_NO
        )
    }else{
      Z=Z %>%
        select(
          CHR_NO,FEE_NO
          ,URICULT,START_DATE,START_TIME
          # ,FEE_CODE,GROUP_CODE,ITEM_NO1,LAB_NO,SOUR_FLAG,EXPER_CLASS,EXPER_TYPE
        )
    }
    
    Z %>%
      mutate(
        HOSP=
          str_sub(X,str_count(X),str_count(X))
      )
  }) %>%
  do.call(rbind,.) %>%
  select(HOSP,everything()) %>%
  mutate(
    START_TIME=
      ifelse(
        !is.na(START_DATE) & is.na(START_TIME)
        ,'0000'
        ,START_TIME
      )
  ) %>%
  mutate(START_DATE=as.numeric(START_DATE)+(2023-112)*10000) %>%
  mutate(
    START_DATE=
      paste0(
        str_sub(START_DATE,1,4)
        ,'-'
        ,str_sub(START_DATE,5,6)
        ,'-'
        ,str_sub(START_DATE,7,8)
      )
  ) %>%
  mutate(
    START_TIME=
      paste0(
        str_sub(START_TIME,1,2)
        ,':'
        ,str_sub(START_TIME,3,4)
      )
  ) %>%
  unite(START,START_DATE,START_TIME,sep=' ') %>%
  mutate(
    START=
      ifelse(
        str_count(START)==16
        & str_count(START,'-')==2
        & str_count(START,' ')==1
        & str_count(START,'\\:')==1
        ,START
        ,NA
      )
  ) %>%
  mutate(START=ymd_hm(START))
```

```{r Create urine culture identifier, include=FALSE}
if(all(c(1,2,3)%in%comp_req)){
  uricult_identifier=
    uri_cath_d$prediction %>%
    left_join(
      group_by(.,HOSP,CHR_NO,TYPE,FEE_NO) %>%
        mutate(latest_pred_day=max(pred_day)) %>%
        ungroup() %>%
        left_join(
          uricult_upd %>%
            rename(START_URICULT=START)
          ,by=c('HOSP','CHR_NO','FEE_NO')
        ) %>%
        filter(START_URICULT>pred_day & START_URICULT<=latest_pred_day) %>%
        select(-START_URICULT)
      ,by=colnames(uri_cath_d$prediction)
    ) %>%
    mutate(URICULT=!is.na(URICULT)) %>%
    group_by_at(colnames(uri_cath_d$prediction)) %>%
    summarize(URICULT=any(URICULT),.groups='drop')
  
  saveRDS(uricult_identifier,'data/uricult_identifier.rds')
}else{
  uricult_identifier=readRDS('data/uricult_identifier.rds')
}
```

```{r Create urine culture onset identifier, include=FALSE}
if(all(c(1,2,3)%in%comp_req)){
  uricult_onset_identifier=
    uri_cath_d$prediction %>%
    left_join(
      group_by(.,HOSP,CHR_NO,TYPE,FEE_NO) %>%
        mutate(latest_pred_day=max(pred_day)) %>%
        ungroup() %>%
        left_join(
          uricult_upd %>%
            rename(START_URICULT=START)
          ,by=c('HOSP','CHR_NO','FEE_NO')
        ) %>%
        filter(START_URICULT>pred_day & START_URICULT<=latest_pred_day)
      ,by=colnames(uri_cath_d$prediction)
    ) %>%
    left_join(
      los_upd
      ,by=c('HOSP','CHR_NO','FEE_NO')
    ) %>%
    mutate(
      URICULT=!is.na(URICULT)
      ,URICULT_onset_START=as.duration(START_URICULT-START)/ddays(1)
      ,URICULT_onset_CPD=as.duration(CPD-START)/ddays(1)
    ) %>%
    group_by_at(colnames(uri_cath_d$prediction)) %>%
    summarize(
      URICULT_onset=
        ifelse(
          any(URICULT)
          ,ifelse(
            all(is.na(START_URICULT))
            ,min(URICULT_onset_CPD,na.rm=T)
            ,min(URICULT_onset_START,na.rm=T)
          )
          ,ifelse(
            all(is.na(CPD))
            ,as.Date(NA)
            ,min(URICULT_onset_CPD,na.rm=T)
          )
        )
      ,.groups='drop'
    )
  
  saveRDS(uricult_onset_identifier,'data/uricult_onset_identifier.rds')
}else{
  uricult_onset_identifier=readRDS('data/uricult_onset_identifier.rds')
}
```

```{r UTI prev. selection 1 by diag. & urine culture, eval=FALSE, include=FALSE}
uti_identifier %>%
  filter(duration>2) %>%
  left_join(
    uricult_identifier
    ,by=colnames(uri_cath_d$prediction)
  ) %>%
  mutate(outcome=ifelse(UTI==T | URICULT==T,T,F)) %>%
  filter(HOSP=='t') %>%
  group_by(HOSP,outcome) %>%
  summarize(n=n(),.groups='drop') %>%
  group_by(HOSP) %>%
  mutate(
    total=sum(n)
    ,p=round(n/total*100,2)
  ) %>%
  ungroup()

uti_identifier %>%
  filter(duration>2) %>%
  left_join(
    uricult_identifier
    ,by=colnames(uri_cath_d$prediction)
  ) %>%
  mutate(outcome=ifelse(UTI==T | URICULT==T,T,F)) %>%
  mutate(HOSP=ifelse(HOSP%in%c('s','w'),'sw',HOSP)) %>%
  filter(HOSP=='sw') %>%
  group_by(HOSP,outcome) %>%
  summarize(n=n(),.groups='drop') %>%
  group_by(HOSP) %>%
  mutate(
    total=sum(n)
    ,p=round(n/total*100,2)
  ) %>%
  ungroup()
```

```{r UTI prev. selection 2 by diag. & urine culture, eval=FALSE, include=FALSE}
uti_identifier %>%
  left_join(
    uricult_identifier
    ,by=colnames(uri_cath_d$prediction)
  ) %>%
  mutate(outcome=ifelse(UTI==T | URICULT==T,T,F)) %>%
  mutate(HOSP=ifelse(HOSP%in%c('s','t'),'st',HOSP)) %>%
  filter(HOSP=='st') %>%
  group_by(HOSP,outcome) %>%
  summarize(n=n(),.groups='drop') %>%
  group_by(HOSP) %>%
  mutate(
    total=sum(n)
    ,p=round(n/total*100,2)
  ) %>%
  ungroup()

uti_identifier %>%
  left_join(
    uricult_identifier
    ,by=colnames(uri_cath_d$prediction)
  ) %>%
  mutate(outcome=ifelse(UTI==T | URICULT==T,T,F)) %>%
  filter(HOSP=='w') %>%
  group_by(HOSP,outcome) %>%
  summarize(n=n(),.groups='drop') %>%
  group_by(HOSP) %>%
  mutate(
    total=sum(n)
    ,p=round(n/total*100,2)
  ) %>%
  ungroup()
```

```{r Create pneumonia identifier, include=FALSE}
if(all(c(1,2,3)%in%comp_req)){
  pneu_identifier=
    diag_identifier %>%
    group_by_at(colnames(uri_cath_d$prediction)) %>%
    summarize(
      all_PNEU_na=
        all(is.na(ALL_CODE))
      ,PNEU=
        any(str_sub(ALL_CODE,1,3)%in%c(paste0('J',12:18),440:448))
      ,.groups='drop'
    ) %>%
    mutate(PNEU=ifelse(all_PNEU_na,NA,PNEU)) %>%
    select(-all_PNEU_na)
  
  saveRDS(pneu_identifier,'data/pneu_identifier.rds')
}else{
  pneu_identifier=readRDS('data/pneu_identifier.rds')
}
```

```{r UTI prev. selection 1 by UTI-urine culture-PNEU, eval=FALSE, include=FALSE}
uti_identifier %>%
  filter(duration>2) %>%
  left_join(
    uricult_identifier
    ,by=colnames(uri_cath_d$prediction)
  ) %>%
  left_join(
    pneu_identifier
    ,by=colnames(uri_cath_d$prediction)
  ) %>%
  mutate(outcome=ifelse((UTI==T | URICULT==T) & PNEU==F,T,F)) %>%
  filter(HOSP=='t') %>%
  group_by(HOSP,outcome) %>%
  summarize(n=n(),.groups='drop') %>%
  group_by(HOSP) %>%
  mutate(
    total=sum(n)
    ,p=round(n/total*100,2)
  ) %>%
  ungroup()

uti_identifier %>%
  filter(duration>2) %>%
  left_join(
    uricult_identifier
    ,by=colnames(uri_cath_d$prediction)
  ) %>%
  left_join(
    pneu_identifier
    ,by=colnames(uri_cath_d$prediction)
  ) %>%
  mutate(outcome=ifelse((UTI==T | URICULT==T) & PNEU==F,T,F)) %>%
  mutate(HOSP=ifelse(HOSP%in%c('s','w'),'sw',HOSP)) %>%
  filter(HOSP=='sw') %>%
  group_by(HOSP,outcome) %>%
  summarize(n=n(),.groups='drop') %>%
  group_by(HOSP) %>%
  mutate(
    total=sum(n)
    ,p=round(n/total*100,2)
  ) %>%
  ungroup()
```

```{r UTI prev. selection 2 by UTI-urine culture-PNEU, eval=FALSE, include=FALSE}
uti_identifier %>%
  left_join(
    uricult_identifier
    ,by=colnames(uri_cath_d$prediction)
  ) %>%
  left_join(
    pneu_identifier
    ,by=colnames(uri_cath_d$prediction)
  ) %>%
  mutate(outcome=ifelse((UTI==T | URICULT==T) & PNEU==F,T,F)) %>%
  mutate(HOSP=ifelse(HOSP%in%c('s','t'),'st',HOSP)) %>%
  filter(HOSP=='st') %>%
  group_by(HOSP,outcome) %>%
  summarize(n=n(),.groups='drop') %>%
  group_by(HOSP) %>%
  mutate(
    total=sum(n)
    ,p=round(n/total*100,2)
  ) %>%
  ungroup()

uti_identifier %>%
  left_join(
    uricult_identifier
    ,by=colnames(uri_cath_d$prediction)
  ) %>%
  left_join(
    pneu_identifier
    ,by=colnames(uri_cath_d$prediction)
  ) %>%
  mutate(outcome=ifelse((UTI==T | URICULT==T) & PNEU==F,T,F)) %>%
  filter(HOSP=='w') %>%
  group_by(HOSP,outcome) %>%
  summarize(n=n(),.groups='drop') %>%
  group_by(HOSP) %>%
  mutate(
    total=sum(n)
    ,p=round(n/total*100,2)
  ) %>%
  ungroup()
```

```{r Ensure UTI/urine culture/PNEU have + & -, eval=FALSE, include=FALSE}
uti_identifier %>%
  group_by(HOSP,UTI) %>%
  summarize(n=n(),.groups='drop')

uricult_identifier %>%
  group_by(HOSP,URICULT) %>%
  summarize(n=n(),.groups='drop')

pneu_identifier %>%
  group_by(HOSP,PNEU) %>%
  summarize(n=n(),.groups='drop')
```

```{r Create outcome identifier, include=FALSE}
outcome_identifier=
  uti_identifier %>%
  left_join(
    uricult_identifier
    ,by=colnames(uri_cath_d$prediction)
  ) %>%
  left_join(
    pneu_identifier
    ,by=colnames(uri_cath_d$prediction)
  ) %>%
  mutate(outcome=ifelse((UTI==T | URICULT==T) & PNEU==F,T,F))
```

```{r Extract tables of hospital stay updates, include=FALSE}
los_upd=
  raw_data1b %>%
  .[str_detect(names(.),'^v_ipd_basic')] %>%
  lapply(\(x)
    x %>%
      select_at(
        colnames(.) %>%
          .[str_detect(
            .
            ,c('^CHR_NO'
               ,'^FEE_NO'
               ,'^IPD_DATE$'
               ,'^IPD_TIME$'
               ,'^CPD_DATE$'
               ,'^CPD_TIME$'
               ) %>%
              paste0(collapse='|')
          )]
      )
  ) %>%
  lapply(
    X=names(.)
    ,Y=.
    ,\(X,Y)
    Y[[X]] %>%
      mutate(
        HOSP=
          str_sub(X,str_count(X),str_count(X))
      )
  ) %>%
  do.call(rbind,.) %>%
  mutate(
    IPD_TIME=
      ifelse(
        !is.na(IPD_DATE) & is.na(IPD_TIME)
        ,'0000'
        ,IPD_TIME
      )
    ,CPD_TIME=
      ifelse(
        !is.na(CPD_DATE) & is.na(CPD_TIME)
        ,'0000'
        ,IPD_TIME
      )
  ) %>%
  mutate_at(
    c('IPD_DATE','CPD_DATE')
    ,\(x)as.numeric(x)+(2023-112)*10000
  ) %>%
  mutate_at(
    c('IPD_DATE','CPD_DATE')
    ,\(x)
      paste0(
        str_sub(x,1,4)
        ,'-'
        ,str_sub(x,5,6)
        ,'-'
        ,str_sub(x,7,8)
      )
  ) %>%
  mutate_at(
    c('IPD_TIME','CPD_TIME')
    ,\(x)
      paste0(
        str_sub(x,1,2)
        ,':'
        ,str_sub(x,3,4)
      )
  ) %>%
  unite(IPD,IPD_DATE,IPD_TIME,sep=' ') %>%
  unite(CPD,CPD_DATE,CPD_TIME,sep=' ') %>%
  mutate_at(
    c('IPD','CPD')
    ,\(x)
      ifelse(
        str_count(x)==16
        & str_count(x,'-')==2
        & str_count(x,' ')==1
        & str_count(x,'\\:')==1
        ,x
        ,NA
      )
  ) %>%
  mutate_at(c('IPD','CPD'),ymd_hm) %>%
  select(HOSP,everything())
```

```{r Create outcome onset identifier, include=FALSE}
outcome_onset_identifier=
  uti_identifier %>%
  left_join(
    uti_onset_identifier
    ,by=colnames(uri_cath_d$prediction)
  ) %>%
  left_join(
    uricult_identifier
    ,by=colnames(uri_cath_d$prediction)
  ) %>%
  left_join(
    uricult_onset_identifier
    ,by=colnames(uri_cath_d$prediction)
  ) %>%
  left_join(
    pneu_identifier
    ,by=colnames(uri_cath_d$prediction)
  ) %>%
  left_join(
    los_upd %>%
      select(-IPD)
    ,by=c('HOSP','CHR_NO','FEE_NO')
  ) %>%
  mutate(CPD_onset=as.duration(CPD-START)/ddays(1)) %>%
  mutate(
    outcome_onset=
      ifelse(
        ifelse((UTI==T | URICULT==T) & PNEU==F,T,F)
        ,ifelse(
          UTI==T & URICULT==T
          ,ifelse(
            UTI_onset<=URICULT_onset
            ,UTI_onset
            ,URICULT_onset
          )
          ,ifelse(
            UTI==T
            ,UTI_onset
            ,URICULT_onset
          )
        )
        ,CPD_onset
      )
  ) %>%
  select(-UTI,-URICULT,-PNEU,-UTI_onset,-URICULT_onset,-CPD,-CPD_onset)
```

```{r Extract tables of birthdate for computing age, include=FALSE}
age_birthdate=
  raw_data1b %>%
  .[str_detect(names(.),'^v_chr_basic')] %>%
  lapply(\(x)
    x %>%
      select_at(
        colnames(.) %>%
          .[str_detect(.,'^CHR_NO|^BIRTH_DATE')]
      )
  ) %>%
  lapply(
    X=names(.)
    ,Y=.
    ,\(X,Y)
    Y[[X]] %>%
      mutate(
        HOSP=
          str_sub(X,str_count(X),str_count(X))
      )
  ) %>%
  do.call(rbind,.) %>%
  mutate(BIRTH_TIME='0000') %>%
  mutate(BIRTH_DATE=as.numeric(BIRTH_DATE)+(2023-112)*10000) %>%
  mutate(
    BIRTH_DATE=
      paste0(
        str_sub(BIRTH_DATE,1,4)
        ,'-'
        ,str_sub(BIRTH_DATE,5,6)
        ,'-'
        ,str_sub(BIRTH_DATE,7,8)
      )
  ) %>%
  mutate(
    BIRTH_TIME=
      paste0(
        str_sub(BIRTH_TIME,1,2)
        ,':'
        ,str_sub(BIRTH_TIME,3,4)
      )
  ) %>%
  unite(BIRTH,BIRTH_DATE,BIRTH_TIME,sep=' ') %>%
  mutate(
    BIRTH=
      ifelse(
        str_count(BIRTH)==16
        & str_count(BIRTH,'-')==2
        & str_count(BIRTH,' ')==1
        & str_count(BIRTH,'\\:')==1
        ,BIRTH
        ,NA
      )
  ) %>%
  mutate(BIRTH=ymd_hm(BIRTH))
```

```{r Create age identifier, include=FALSE}
age_identifier=
  uri_cath_d$prediction %>%
  left_join(
    age_birthdate
    ,by=c('HOSP','CHR_NO')
  ) %>%
  mutate(AGE=as.duration(pred_day-BIRTH)/dyears(1)) %>%
  mutate(pred_day2=as_datetime(ifelse(AGE>200,pred_day-years(200),pred_day))) %>%
  mutate(AGE=as.duration(pred_day2-BIRTH)/dyears(1)) %>%
  select(-BIRTH,-pred_day2)
```

```{r Check age missingness and outliers, eval=FALSE, include=FALSE}
age_identifier %>%
  group_by(HOSP) %>%
  mutate(
    min=min(AGE,na.rm=T)
    ,q1=quantile(AGE,0.25,na.rm=T)
    ,q2=quantile(AGE,0.5,na.rm=T)
    ,q3=quantile(AGE,0.75,na.rm=T)
    ,max=max(AGE,na.rm=T)
    ,n=n()
    ,missing=sum(is.na(AGE))
  ) %>%
  ungroup() %>%
  mutate(
    outlier=
      AGE<(q1-1.5*(q3-q1))
      | AGE>(q3+1.5*(q3-q1))
  ) %>%
  group_by(HOSP,min,q1,q2,q3,max,n,missing) %>%
  summarize(outliers=sum(outlier,na.rm=T),.groups='drop')
```

```{r Create age group identifier, include=FALSE}
age_group_identifier=
  age_identifier %>%
  mutate(
    AGE=
      case_when(
        AGE<=50~'<=50'
        ,AGE>50 & AGE<=65~'>50 to 65'
        ,AGE>65~'>65'
      ) %>%
      factor(c('<=50','>50 to 65','>65'))
  ) %>%
  rename(AGE_GROUP=AGE)
```

```{r Check age group distribution, eval=FALSE, include=FALSE}
age_group_identifier %>%
  group_by(HOSP,AGE_GROUP) %>%
  summarize(n=n(),.groups='drop') %>%
  group_by(HOSP) %>%
  mutate(
    total=sum(n)
    ,p=round(n/total*100,2)
  ) %>%
  ungroup()
```

```{r Check BED_KIND for ICU, eval=FALSE, include=FALSE}
raw_data1b %>%
  .[str_detect(names(.),'^v_bed_basic')] %>%
  lapply(
    X=names(.)
    ,Y=.
    ,\(X,Y)
    Y[[X]] %>%
      mutate(
        HOSP=
          str_sub(X,str_count(X),str_count(X))
      )
  ) %>%
  do.call(rbind,.)  %>%
  filter(
    paste0(HOSP,BED_KIND)
    %in%pull(
      filter(.,str_detect(str_to_lower(BED_DESC),'加護病')) %>%
        unite(HOSP_BED_KIND,HOSP,BED_KIND,sep='')
      ,HOSP_BED_KIND
    )
  ) %>%
  mutate(
    BED_DESC=
      BED_DESC %>%
      str_replace_all('[:digit:]+','[num]')
  ) %>%
  group_by(HOSP,BED_DESC,BED_KIND) %>%
  summarize(n=n(),.groups='drop') %>%
  spread(BED_KIND,n,fill=0)
```

```{r Extract tables of ICU stay updates, include=FALSE}
icu_upd=
  raw_data1b %>%
  .[str_detect(names(.),'^v_ipd_basic')] %>%
  lapply(\(x)
    x %>%
      select_at(
        colnames(.) %>%
          .[str_detect(
            .
            ,c('^CHR_NO'
               ,'^FEE_NO'
               ,'^BED_NO'
               ,'^IPD_DATE$'
               ,'^IPD_TIME$'
               ,'^CPD_DATE$'
               ,'^CPD_TIME$'
               ) %>%
              paste0(collapse='|')
          )]
      )
  ) %>%
  lapply(
    X=names(.)
    ,Y=.
    ,\(X,Y)
    Y[[X]] %>%
      mutate(
        HOSP=
          str_sub(X,str_count(X),str_count(X))
      )
  ) %>%
  do.call(rbind,.) %>%
  left_join(
    raw_data1b %>%
      .[str_detect(names(.),'^v_bed_basic')] %>%
      lapply(\(x)
        x %>%
          select_at(
            colnames(.) %>%
              .[str_detect(.,'^BED_NO|^BED_KIND|^BED_DESC')]
          )
      ) %>%
      lapply(
        X=names(.)
        ,Y=.
        ,\(X,Y)
        Y[[X]] %>%
          mutate(
            HOSP=
              str_sub(X,str_count(X),str_count(X))
          )
      ) %>%
      do.call(rbind,.)  %>%
      filter(
        paste0(HOSP,BED_KIND)
        %in%pull(
          filter(.,str_detect(str_to_lower(BED_DESC),'加護病')) %>%
            unite(HOSP_BED_KIND,HOSP,BED_KIND,sep='')
          ,HOSP_BED_KIND
        )
      ) %>%
      mutate(BED_DESC='加護病') %>%
      select(HOSP,BED_NO,BED_DESC) %>%
      filter(!duplicated(.))
    ,by=c('HOSP','BED_NO')
  ) %>%
  filter(!is.na(BED_DESC)) %>%
  lapply(X=1,Y=.,\(X,Y){
    Z=raw_data1b %>%
      .[str_detect(names(.),'^v_ipd_trans')] %>%
      lapply(\(x)
        x %>%
          select_at(
            colnames(.) %>%
              .[str_detect(.,'^CHR_NO|^FEE_NO|BED_NO$|^TRANS_DATE|^TRANS_TIME')]
          )
      ) %>%
      lapply(
        X=names(.)
        ,Y=.
        ,\(X,Y)
        Y[[X]] %>%
          mutate(
            HOSP=
              str_sub(X,str_count(X),str_count(X))
          )
      ) %>%
      do.call(rbind,.)
    
    Y %>%
      left_join(
        Z %>%
          rename(BED_NO=NEW_BED_NO) %>%
          `colnames<-`(
            colnames(.) %>%
              str_replace_all('TRANS','BED_ADM')
          ) %>%
          select(-ORI_BED_NO)
        ,by=c('HOSP','CHR_NO','FEE_NO','BED_NO')
      ) %>%
      mutate(
        BED_ADM_DATE=
          ifelse(
            is.na(BED_ADM_DATE)
            ,IPD_DATE
            ,BED_ADM_DATE
          )
        ,BED_ADM_TIME=
          ifelse(
            is.na(BED_ADM_TIME)
            ,IPD_TIME
            ,BED_ADM_TIME
          )
      ) %>%
      left_join(
        Z %>%
          rename(BED_NO=ORI_BED_NO) %>%
          `colnames<-`(
            colnames(.) %>%
              str_replace_all('TRANS','BED_DIS')
          ) %>%
          select(-NEW_BED_NO)
        ,by=c('HOSP','CHR_NO','FEE_NO','BED_NO')
      ) %>%
      mutate(
        BED_DIS_DATE=
          ifelse(
            is.na(BED_DIS_DATE)
            ,CPD_DATE
            ,BED_DIS_DATE
          )
        ,BED_DIS_TIME=
          ifelse(
            is.na(BED_DIS_TIME)
            ,CPD_TIME
            ,BED_DIS_TIME
          )
      ) %>%
      filter(!duplicated(.))
  }) %>%
  .[[1]] %>%
  mutate(
    IPD_TIME=
      ifelse(
        !is.na(IPD_DATE) & is.na(IPD_TIME)
        ,'0000'
        ,IPD_TIME
      )
    ,BED_ADM_TIME=
      ifelse(
        !is.na(BED_ADM_DATE) & is.na(BED_ADM_TIME)
        ,'0000'
        ,BED_ADM_TIME
      )
    ,BED_DIS_TIME=
      ifelse(
        !is.na(BED_DIS_DATE) & is.na(BED_DIS_TIME)
        ,'0000'
        ,BED_DIS_TIME
      )
    ,CPD_TIME=
      ifelse(
        !is.na(CPD_DATE) & is.na(CPD_TIME)
        ,'0000'
        ,CPD_TIME
      )
  ) %>%
  mutate_at(
    c('IPD_DATE','BED_ADM_DATE','BED_DIS_DATE','CPD_DATE')
    ,\(x)
    as.numeric(x)+(2023-112)*10000
  ) %>%
  mutate_at(
    c('IPD_DATE','BED_ADM_DATE','BED_DIS_DATE','CPD_DATE')
    ,\(x)
    paste0(
      str_sub(x,1,4)
      ,'-'
      ,str_sub(x,5,6)
      ,'-'
      ,str_sub(x,7,8)
    )
  ) %>%
  mutate_at(
    c('IPD_TIME','BED_ADM_TIME','BED_DIS_TIME','CPD_TIME')
    ,\(x)
    paste0(
      str_sub(x,1,2)
      ,':'
      ,str_sub(x,3,4)
    )
  ) %>%
  unite(IPD,IPD_DATE,IPD_TIME,sep=' ') %>%
  unite(BED_ADM,BED_ADM_DATE,BED_ADM_TIME,sep=' ') %>%
  unite(BED_DIS,BED_DIS_DATE,BED_DIS_TIME,sep=' ') %>%
  unite(CPD,CPD_DATE,CPD_TIME,sep=' ') %>%
  mutate_at(
    c('IPD','BED_ADM','BED_DIS','CPD')
    ,\(x)
    ifelse(
      str_count(x)==16
      & str_count(x,'-')==2
      & str_count(x,' ')==1
      & str_count(x,'\\:')==1
      ,x
      ,NA
    )
  ) %>%
  mutate_at(c('IPD','BED_ADM','BED_DIS','CPD'),ymd_hm) %>%
  lapply(
    X=seq(nrow(.))
    ,Y=.
    ,\(X,Y){
      Z=Y %>%
        slice(X)
      if(!is.na(Z$BED_DIS) & Z$BED_DIS<Z$BED_ADM){
        K=Z %>%
          mutate(
            BED_ADM=BED_DIS
            ,BED_DIS=as_date(NA)
          ) %>%
          rbind(
            Z %>%
              mutate(
                BED_DIS=CPD
              )
          )
      }else{
        K=Z
      }
      K %>%
        filter(BED_ADM<=BED_DIS)
    }
  ) %>%
  do.call(rbind,.) %>%
  select(-IPD,-CPD) %>%
  mutate(merged=1)

icu_upd_nrow=
  icu_upd %>%
  nrow()

iter=0

while(iter<1){
  cat('iter',iter,'nrow',icu_upd_nrow,'\n')

  icu_upd=
    icu_upd %>%
    group_by(HOSP,CHR_NO,FEE_NO) %>%
    mutate(seq=seq(n())) %>%
    ungroup() %>%
    left_join(
      select(.,HOSP,CHR_NO,FEE_NO,seq,BED_DIS) %>%
        mutate(seq=seq+1) %>%
        rename(prev_BED_DIS=BED_DIS)
      ,by=c('HOSP','CHR_NO','FEE_NO','seq')
    ) %>%
    mutate(dist=as.duration(BED_ADM-prev_BED_DIS)/ddays(1)) %>%
    mutate(dist=ifelse(is.na(dist),0,dist)) %>%
    group_by(HOSP,CHR_NO,FEE_NO) %>%
    mutate(unmerged=dist>1) %>%
    mutate(seq2=cumsum(unmerged)+1) %>%
    ungroup() %>%
    select(-seq,-prev_BED_DIS,-dist,-unmerged) %>%
    rename(seq=seq2) %>%
    group_by(HOSP,CHR_NO,FEE_NO,seq) %>%
    mutate(
      BED_NO=paste0(sort(unique(BED_NO)),collapse=' & ')
      ,BED_ADM=min(BED_ADM)
      ,BED_DIS=max(BED_DIS)
      ,merged=sum(merged)
    ) %>%
    slice(1) %>%
    ungroup() %>%
    select(-seq)

  if(icu_upd_nrow>nrow(icu_upd)){
    iter=0
  }else{
    iter=iter+1
  }

  icu_upd_nrow=
    icu_upd %>%
    nrow()
}

rm(iter,icu_upd_nrow)
```

```{r Create ICU stay identifier, include=FALSE}
if(all(c(1,2,3)%in%comp_req)){
  icu_identifier=
    uri_cath_d$prediction %>%
    left_join(
      icu_upd %>%
        select(-merged)
      ,by=c('HOSP','CHR_NO','FEE_NO')
    ) %>%
    filter(BED_ADM<=pred_day) %>%
    mutate(
      ICU_STAY=
        ifelse(
          is.na(BED_DESC)
          ,0
          ,ifelse(
            BED_ADM>pred_day
            ,0
            ,ifelse(
              is.na(BED_DIS)
              ,NA
              ,ifelse(
                BED_DIS>=pred_day
                ,as.duration(pred_day-BED_ADM)/ddays(1)
                ,as.duration(BED_DIS-BED_ADM)/ddays(1)
              )
            )
          )
        )
    ) %>%
    group_by_at(colnames(uri_cath_d$prediction)) %>%
    summarize(
      ICU_STAY_D=sum(ICU_STAY,na.rm=T)
      ,ICU_STAY_N=sum(!is.na(BED_DESC))
      ,.groups='drop'
    )
  
  saveRDS(icu_identifier,'data/icu_identifier.rds')
}else{
  icu_identifier=readRDS('data/icu_identifier.rds')
}

icu_identifier=
  uri_cath_d$prediction %>%
  left_join(
    icu_identifier
    ,by=colnames(uri_cath_d$prediction)
  ) %>%
  mutate_at(c('ICU_STAY_D','ICU_STAY_N'),\(x)ifelse(is.na(x),0,x))
```

```{r Check ICU stay missingness and outliers, eval=FALSE, include=FALSE}
icu_identifier %>%
  group_by(HOSP) %>%
  mutate(
    min=min(ICU_STAY_D,na.rm=T)
    ,q1=quantile(ICU_STAY_D,0.25,na.rm=T)
    ,q2=quantile(ICU_STAY_D,0.5,na.rm=T)
    ,q3=quantile(ICU_STAY_D,0.75,na.rm=T)
    ,max=max(ICU_STAY_D,na.rm=T)
    ,n=n()
    ,missing=sum(is.na(ICU_STAY_D))
  ) %>%
  ungroup() %>%
  mutate(
    outlier=
      ICU_STAY_D<(q1-1.5*(q3-q1))
      | ICU_STAY_D>(q3+1.5*(q3-q1))
  ) %>%
  group_by(HOSP,ICU_STAY_N,min,q1,q2,q3,max,n,missing) %>%
  summarize(outliers=sum(outlier,na.rm=T),.groups='drop')
```


```{r Create ICU-stay 10+ day identifier, include=FALSE}
icu_10d_identifier=
  icu_identifier %>%
  mutate(ICU_STAY_10D=ICU_STAY_D>=10) %>%
  select(-ICU_STAY_D,-ICU_STAY_N)
```

```{r Check ICU-stay 10+ day distribution, eval=FALSE, include=FALSE}
icu_10d_identifier %>%
  group_by(HOSP,ICU_STAY_10D) %>%
  summarize(n=n(),.groups='drop') %>%
  group_by(HOSP) %>%
  mutate(
    total=sum(n)
    ,p=round(n/total*100,2)
  ) %>%
  ungroup()
```

```{r Create catheter duration identifier, include=FALSE}
cath_d_identifier=
  uri_cath_d$prediction %>%
  mutate(
    CATH_D=as.duration(pred_day-START)/ddays(1)
    ,CATH_D=ifelse(CATH_D>=duration,duration,CATH_D)
  )
```

```{r Check catheter duration missingness and outliers, eval=FALSE, include=FALSE}
cath_d_identifier %>%
  group_by(HOSP) %>%
  mutate(
    min=min(CATH_D,na.rm=T)
    ,q1=quantile(CATH_D,0.25,na.rm=T)
    ,q2=quantile(CATH_D,0.5,na.rm=T)
    ,q3=quantile(CATH_D,0.75,na.rm=T)
    ,max=max(CATH_D,na.rm=T)
    ,n=n()
    ,missing=sum(is.na(CATH_D))
  ) %>%
  ungroup() %>%
  mutate(
    outlier=
      CATH_D<(q1-1.5*(q3-q1))
      | CATH_D>(q3+1.5*(q3-q1))
  ) %>%
  group_by(HOSP,min,q1,q2,q3,max,n,missing) %>%
  summarize(outliers=sum(outlier,na.rm=T),.groups='drop')
```

```{r Create catheter duration 6+ day identifier, include=FALSE}
cath_d_6d_identifier=
  cath_d_identifier %>%
  mutate(CATH_D=CATH_D>=6) %>%
  rename(CATH_D_6D=CATH_D)
```

```{r Check catheter duration 6+ day distribution, eval=FALSE, include=FALSE}
cath_d_6d_identifier %>%
  group_by(HOSP,CATH_D_6D) %>%
  summarize(n=n(),.groups='drop') %>%
  group_by(HOSP) %>%
  mutate(
    total=sum(n)
    ,p=round(n/total*100,2)
  ) %>%
  ungroup()
```

```{r Create hospital stay identifier, include=FALSE}
los_identifier=
  uri_cath_d$prediction %>%
  left_join(los_upd,by=c('HOSP','CHR_NO','FEE_NO')) %>%
  mutate(LOS=as.duration(pred_day-IPD)/ddays(1)) %>%
  mutate(
    IPD=as_datetime(ifelse(LOS>3500,IPD+years(200),IPD))
    ,IPD=as_datetime(ifelse(IPD>=START,START,IPD))
  ) %>%
  mutate(LOS=as.duration(pred_day-IPD)/ddays(1)) %>%
  select(-IPD,-CPD)
```

```{r Check ICU stay missingness and outliers, eval=FALSE, include=FALSE}
los_identifier %>%
  group_by(HOSP) %>%
  mutate(
    min=min(LOS,na.rm=T)
    ,q1=quantile(LOS,0.25,na.rm=T)
    ,q2=quantile(LOS,0.5,na.rm=T)
    ,q3=quantile(LOS,0.75,na.rm=T)
    ,max=max(LOS,na.rm=T)
    ,n=n()
    ,missing=sum(is.na(LOS))
  ) %>%
  ungroup() %>%
  mutate(
    outlier=
      LOS<(q1-1.5*(q3-q1))
      | LOS>(q3+1.5*(q3-q1))
  ) %>%
  group_by(HOSP,min,q1,q2,q3,max,n,missing) %>%
  summarize(outliers=sum(outlier,na.rm=T),.groups='drop')
```

```{r Create hospital stay 4+ day identifier, include=FALSE}
los_4d_identifier=
  los_identifier %>%
  mutate(LOS=LOS>=4) %>%
  rename(LOS_4D=LOS)
```

```{r Check hospital stay 4+ day distribution, eval=FALSE, include=FALSE}
los_4d_identifier %>%
  group_by(HOSP,LOS_4D) %>%
  summarize(n=n(),.groups='drop') %>%
  group_by(HOSP) %>%
  mutate(
    total=sum(n)
    ,p=round(n/total*100,2)
  ) %>%
  ungroup()
```

```{r Create prev. cath. identifier, include=FALSE}
if(all(c(1,2,3)%in%comp_req)){ # 25m 50s
  cl=detectCores()-2
  start=T; source('R/parallel_computing-codes.R')
  
  prev_cath_identifier=
    uri_cath_d$prediction %>%
    cbind(
      uri_cath_d$prediction %>%
        pbsapply(
          cl=cl
          ,X=seq(nrow(.))
          ,Y=.
          ,\(X,Y){
            Y %>%
              filter(HOSP==Y$HOSP[X] & CHR_NO==Y$CHR_NO[X] & DC<Y$START[X]) %>%
              nrow()
        }) %>%
        data.frame(CATH_PREV=.)
    )
  
  saveRDS(prev_cath_identifier,'data/prev_cath_identifier.rds')
  start=F; source('R/parallel_computing-codes.R')
}else{
  prev_cath_identifier=readRDS('data/prev_cath_identifier.rds')
}
```

```{r Check prev.cath. missingness and outliers, eval=FALSE, include=FALSE}
prev_cath_identifier %>%
  group_by(HOSP) %>%
  mutate(
    min=min(CATH_PREV,na.rm=T)
    ,q1=quantile(CATH_PREV,0.25,na.rm=T)
    ,q2=quantile(CATH_PREV,0.5,na.rm=T)
    ,q3=quantile(CATH_PREV,0.75,na.rm=T)
    ,max=max(CATH_PREV,na.rm=T)
    ,n=n()
    ,missing=sum(is.na(CATH_PREV))
  ) %>%
  ungroup() %>%
  mutate(
    outlier=
      CATH_PREV<(q1-1.5*(q3-q1))
      | CATH_PREV>(q3+1.5*(q3-q1))
  ) %>%
  group_by(HOSP,min,q1,q2,q3,max,n,missing) %>%
  summarize(outliers=sum(outlier,na.rm=T),.groups='drop')
```

```{r Create sex identifier, include=FALSE}
sex_identifier=
  uri_cath_d$prediction %>%
  left_join(
    raw_data1b %>%
      .[str_detect(names(.),'^v_chr_basic')] %>%
      lapply(\(x)
        x %>%
          select_at(
            colnames(.) %>%
              .[str_detect(.,'^CHR_NO|^SEX')]
          )
      ) %>%
      lapply(
        X=names(.)
        ,Y=.
        ,\(X,Y)
        Y[[X]] %>%
          mutate(
            HOSP=
              str_sub(X,str_count(X),str_count(X))
          )
      ) %>%
      do.call(rbind,.) %>%
      mutate(
        SEX_TYPE=
          ifelse(SEX_TYPE==1,'M','F') %>%
          factor(c('F','M'))
      )
    ,by=c('HOSP','CHR_NO')
  )
```

```{r Check sex distribution, eval=FALSE, include=FALSE}
sex_identifier %>%
  group_by(HOSP,SEX_TYPE) %>%
  summarize(n=n(),.groups='drop') %>%
  group_by(HOSP) %>%
  mutate(
    total=sum(n)
    ,p=round(n/total*100,2)
  ) %>%
  ungroup()
```

```{r Extract tables of ICD descriptors, include=FALSE}
icd_basic=
  raw_data %>%
  .[str_detect(names(.),'^v_icd')] %>%
  lapply(\(x)
    x %>%
      select_at(
        colnames(.) %>%
          .[str_detect(.,'^ICD[:digit:]|_SIMP_DESC$')]
      ) %>%
      mutate(
        ICD_TYPE=
          colnames(.) %>%
          .[str_detect(.,'^ICD[:digit:]')] %>%
          .[1] %>%
          str_remove_all('_CODE')
      ) %>%
      `colnames<-`(
        colnames(.) %>%
          str_remove_all('[:digit:]')
      )
  ) %>%
  lapply(
    X=names(.)
    ,Y=.
    ,\(X,Y)
    Y[[X]] %>%
      mutate(
        HOSP=
          str_sub(X,str_count(X),str_count(X))
      )
  ) %>%
  do.call(rbind,.) %>%
  mutate_all(as.character) %>%
  mutate(n=1) %>%
  spread(HOSP,n,fill=0) %>%
  select(ICD_TYPE,ICD_CODE,ENG_SIMP_DESC,everything()) %>%
  arrange(ICD_TYPE,ICD_CODE)
```

```{r Extract tables of previous DM diagnosis updates, include=FALSE}
prev_DM_upd=
  uri_cath_d$prediction %>%
  left_join(
    diag_upd %>%
      select(-FEE_NO)
    ,by=c('HOSP','CHR_NO')
  ) %>%
  filter(HOSPIN<pred_day) %>%
  group_by_at(colnames(uri_cath_d$prediction)) %>%
  summarize(
    all_na=
      all(is.na(SDIAG_CODE))
    ,SDIAG_CODE=
      any(str_sub(SDIAG_CODE,1,3)%in%c('E11','250'))
    ,.groups='drop'
  ) %>%
  mutate(SDIAG_CODE=ifelse(all_na,NA,SDIAG_CODE)) %>%
  select(-all_na)
```

```{r Extract tables of previous discharged DM diagnosis, include=FALSE}
prev_DM_discharge=
  uri_cath_d$prediction %>%
  left_join(
     diag_discharge %>%
      left_join(
        los_upd
        ,by=c('HOSP','CHR_NO','FEE_NO')
      ) %>%
      select(-TYPE,-FEE_NO)
    ,by=c('HOSP','CHR_NO')
  ) %>%
  filter(CPD<pred_day) %>%
  group_by_at(colnames(uri_cath_d$prediction)) %>%
  summarize(
    all_na=
      all(is.na(CODE))
    ,CODE=
      any(str_sub(CODE,1,3)%in%c('E11','250'))
    ,.groups='drop'
  ) %>%
  mutate(CODE=ifelse(all_na,NA,CODE)) %>%
  select(-all_na)
```

```{r Create previous DM diagnosis identifier, include=FALSE}
prev_DMdiag_identifier=
  uri_cath_d$prediction %>%
  left_join(
    prev_DM_upd
    ,by=colnames(uri_cath_d$prediction)
  ) %>%
  left_join(
    prev_DM_discharge
    ,by=colnames(uri_cath_d$prediction)
  ) %>%
  gather(
    CRITERIA_TYPE,CRITERIA_VALUE
    ,-HOSP,-CHR_NO,-TYPE,-FEE_NO
    ,-FEE_DATE,-FEE_TIME,-FEE_CODE,-SEQ_NO,-SEQ_NO2
    ,-START,-DC,-duration,-merged,-pred_day
  ) %>%
  group_by_at(colnames(uri_cath_d$prediction)) %>%
  summarize(
    all_na=
      all(is.na(CRITERIA_VALUE))
    ,prev_DMdiag=
      sum(CRITERIA_VALUE,na.rm=T)>0
    ,.groups='drop'
  ) %>%
  mutate(prev_DMdiag=ifelse(all_na,NA,prev_DMdiag)) %>%
  select(-all_na)
```

```{r Check previous DM diagnosis distribution, eval=FALSE, include=FALSE}
prev_DMdiag_identifier %>%
  group_by(HOSP,prev_DMdiag) %>%
  summarize(n=n(),.groups='drop') %>%
  group_by(HOSP) %>%
  mutate(
    total=sum(n)
    ,p=round(n/total*100,2)
  ) %>%
  ungroup()
```

```{r Identify MED_CODE for anti-diabetic drugs, eval=FALSE, include=FALSE}
raw_data1b %>%
  .[str_detect(names(.),'^v_med_basic')] %>%
  lapply(\(x)
    x %>%
      select_at(
        colnames(.) %>%
          .[str_detect(.,'^MED_|DESC')]
      )
  ) %>%
  lapply(
    X=names(.)
    ,Y=.
    ,\(X,Y)
    Y[[X]] %>%
      mutate(
        HOSP=
          str_sub(X,str_count(X),str_count(X))
      )
  ) %>%
  do.call(rbind,.) %>%
  mutate(
    ANTIDIAB=
      ALISE_DESC %>%
      str_to_lower() %>%
      str_replace_all('/',' ') %>%
      str_remove_all('[:digit:]|[:punct:]|庫|針頭')
  ) %>%
  select(HOSP,MED_CODE,MED_TYPE,ANTIDIAB,everything()) %>%
  lapply(X=1,Y=.,\(X,Y){
    Z=Y %>%
      filter(
        str_detect(
          str_to_lower(MED_CODE)
          ,filter(.,str_detect(str_to_lower(MED_TYPE),'^0908')) %>%
            pull(MED_CODE) %>%
            str_to_lower() %>%
            unique() %>%
            paste0(collapse='|')
        )
      )
    
    print(
      Z %>%
        filter(ANTIDIAB%in%c(''))
    )
    
    print(
      Z %>%
        group_by(HOSP,MED_TYPE,ANTIDIAB,MED_CODE) %>%
        summarize(n=n(),.groups='drop') %>%
        group_by(HOSP,MED_TYPE,ANTIDIAB) %>%
        summarize(
          MED_CODES=paste0(MED_CODE,collapse='|')
          ,n=sum(n)
          ,.groups='drop'
        ) %>%
        spread(HOSP,n,fill=0) %>%
        arrange(MED_TYPE,MED_CODES,w,t,s)
    )
    
    Y
  }) %>%
  .[[1]] %>%
  filter(str_detect(str_to_lower(MED_TYPE),'^0908')) %>%
  group_by(HOSP,MED_TYPE,ANTIDIAB,MED_CODE) %>%
  summarize(n=n(),.groups='drop') %>%
  group_by(HOSP,MED_TYPE,ANTIDIAB) %>%
  summarize(
    MED_CODES=paste0(MED_CODE,collapse='|')
    ,n=sum(n)
    ,.groups='drop'
  ) %>%
  spread(HOSP,n,fill=0) %>%
  arrange(MED_TYPE,MED_CODES,w,t,s)
```

```{r Extract tables of medication orders, include=FALSE}
med_order=
  raw_data1b %>%
  .[str_detect(names(.),'^v_ud_order')] %>%
  lapply(\(x)
    x %>%
      select_at(
        colnames(.) %>%
          .[str_detect(.,'^FEE_NO|^UD_SEQ|^MED_CODE|^BEGIN_')]
      )
  ) %>%
  lapply(
    X=names(.)
    ,Y=.
    ,\(X,Y)
    Y[[X]] %>%
      mutate(
        HOSP=
          str_sub(X,str_count(X),str_count(X))
      )
  ) %>%
  do.call(rbind,.) %>%
  left_join(
    raw_data1b %>%
      .[str_detect(names(.),'^v_med_basic')] %>%
      lapply(\(x)
        x %>%
          select_at(
            colnames(.) %>%
              .[str_detect(.,'^MED_CODE|^MED_TYPE|^UNIT_DESC')]
          )
      ) %>%
      lapply(
        X=names(.)
        ,Y=.
        ,\(X,Y)
        Y[[X]] %>%
          mutate(
            HOSP=
              str_sub(X,str_count(X),str_count(X))
          )
      ) %>%
      do.call(rbind,.)
    ,by=c('HOSP','MED_CODE')
  ) %>%
  select(HOSP,FEE_NO,everything()) %>%
  mutate(
    BEGIN_TIME=
      ifelse(
        !is.na(BEGIN_DATE) & is.na(BEGIN_TIME)
        ,'0000'
        ,BEGIN_TIME
      )
  ) %>%
  mutate(BEGIN_DATE=as.numeric(BEGIN_DATE)+(2023-112)*10000) %>%
  mutate(
    BEGIN_DATE=
      paste0(
        str_sub(BEGIN_DATE,1,4)
        ,'-'
        ,str_sub(BEGIN_DATE,5,6)
        ,'-'
        ,str_sub(BEGIN_DATE,7,8)
      )
  ) %>%
  mutate(
    BEGIN_TIME=
      paste0(
        str_sub(BEGIN_TIME,1,2)
        ,':'
        ,str_sub(BEGIN_TIME,3,4)
      )
  ) %>%
  unite(BEGIN,BEGIN_DATE,BEGIN_TIME,sep=' ') %>%
  mutate(
    BEGIN=
      ifelse(
        str_count(BEGIN)==16
        & str_count(BEGIN,'-')==2
        & str_count(BEGIN,' ')==1
        & str_count(BEGIN,'\\:')==1
        ,BEGIN
        ,NA
      )
  ) %>%
  mutate(BEGIN=ymd_hm(BEGIN))
```

```{r Extract tables of previous DM medication orders, include=FALSE}
prev_DM_med=
  uri_cath_d$prediction %>%
  left_join(
    med_order %>%
      select(-UD_SEQ,-UD_SEQ_OLD,-MED_CODE)
    ,by=c('HOSP','FEE_NO')
  ) %>%
  filter(BEGIN<pred_day) %>%
  group_by_at(colnames(uri_cath_d$prediction)) %>%
  summarize(
    all_na=
      all(is.na(MED_TYPE))
    ,MED_TYPE=
      any(str_detect(str_to_lower(MED_TYPE),'^0908'))
    ,.groups='drop'
  ) %>%
  mutate(MED_TYPE=ifelse(all_na,NA,MED_TYPE)) %>%
  select(-all_na)
```

```{r Create previous DM medication identifier, include=FALSE}
prev_DMmed_identifier=
  uri_cath_d$prediction %>%
  left_join(
    prev_DM_med
    ,by=colnames(uri_cath_d$prediction)
  ) %>%
  gather(
    CRITERIA_TYPE,CRITERIA_VALUE
    ,-HOSP,-CHR_NO,-TYPE,-FEE_NO
    ,-FEE_DATE,-FEE_TIME,-FEE_CODE,-SEQ_NO,-SEQ_NO2
    ,-START,-DC,-duration,-merged,-pred_day
  ) %>%
  group_by_at(colnames(uri_cath_d$prediction)) %>%
  summarize(
    all_na=
      all(is.na(CRITERIA_VALUE))
    ,prev_DMmed=
      sum(CRITERIA_VALUE,na.rm=T)>0
    ,.groups='drop'
  ) %>%
  mutate(prev_DMmed=ifelse(all_na,NA,prev_DMmed)) %>%
  select(-all_na)
```

```{r Check previous DM medication distribution, eval=FALSE, include=FALSE}
prev_DMmed_identifier %>%
  group_by(HOSP,prev_DMmed) %>%
  summarize(n=n(),.groups='drop') %>%
  group_by(HOSP) %>%
  mutate(
    total=sum(n)
    ,p=round(n/total*100,2)
  ) %>%
  ungroup()
```

```{r Create previous DM diagnosis/medication identifier, include=FALSE}
prev_DM_identifier=
  prev_DMdiag_identifier %>%
  left_join(
    prev_DMmed_identifier
    ,by=colnames(uri_cath_d$prediction)
  ) %>%
  mutate(prev_DM=(prev_DMdiag+prev_DMmed)>0) %>%
  select(-prev_DMdiag,-prev_DMmed)
```

```{r Check previous DM diag./med. distribution, eval=FALSE, include=FALSE}
prev_DM_identifier %>%
  group_by(HOSP,prev_DM) %>%
  summarize(n=n(),.groups='drop') %>%
  group_by(HOSP) %>%
  mutate(
    total=sum(n)
    ,p=round(n/total*100,2)
  ) %>%
  ungroup()
```

```{r Determine FEE_CODE for immobilization, include=FALSE}
immob=
  raw_data %>%
  .[str_detect(names(.),'^v_fee_basic')] %>%
  lapply(select,FEE_CODE,FEE_DESC) %>%
  lapply(
    X=names(.)
    ,Y=.
    ,\(X,Y)
    Y[[X]] %>%
      mutate(
        HOSP=
          str_sub(X,str_count(X),str_count(X))
      )
  ) %>%
  do.call(rbind,.) %>%
  filter(
    str_detect(
      str_to_lower(FEE_CODE)
      ,filter(.,str_detect(str_to_lower(FEE_DESC),'保護性約束')) %>%
        pull(FEE_CODE) %>%
        str_sub(1,str_count(.)-1) %>%
        str_to_lower() %>%
        unique() %>%
        paste0(collapse='|')
    )
  ) %>%
  mutate(exist='yes') %>%
  spread(HOSP,exist,fill='no') %>%
  arrange(FEE_CODE,w,t,s) %>%
  filter(str_detect(str_to_lower(FEE_CODE),'f47093b'))

immob %>%
  knitr::kable()
```

```{r Extract tables of immob. orders, include=FALSE}
immob_order=
  raw_data1b %>%
  .[str_detect(names(.),'^v_ipd_fee')] %>%
  lapply(filter,FEE_CODE%in%immob$FEE_CODE) %>%
  lapply(\(x)
    x %>%
      select_at(
        colnames(.) %>%
          .[str_detect(
            .
            ,paste0(
              c(
                '^CHR_NO'
                ,'^FEE_NO'
                ,'^FEE_DATE'
                ,'^FEE_TIME'
                ,'^FEE_CODE'
                ,'^SEQ_NO'
                ,'^START'
                ,'^DC'
              )
              ,collapse='|'
            )
          )]
      )
  ) %>%
  lapply(
    X=names(.)
    ,Y=.
    ,\(X,Y)
    Y[[X]] %>%
      mutate(
        HOSP=
          str_sub(X,str_count(X),str_count(X))
        ,TYPE=
          str_sub(X,3,5)
      )
  ) %>%
  do.call(rbind,.) %>%
  select_at(c(
    intersect(colnames(uri_cath_d$prediction),colnames(.))
    ,setdiff(colnames(.),colnames(uri_cath_d$prediction))
  )) %>%
  mutate(
    START_TIME=
      ifelse(
        !is.na(START_DATE) & is.na(START_TIME)
        ,'0000'
        ,START_TIME
      )
    ,DC_TIME=
      ifelse(
        !is.na(DC_DATE) & is.na(DC_TIME)
        ,'0000'
        ,DC_TIME
      )
  ) %>%
  mutate_at(
    c('START_DATE','DC_DATE')
    ,\(x)
    as.numeric(x)+(2023-112)*10000
  ) %>%
  mutate_at(
    c('START_DATE','DC_DATE')
    ,\(x)
    paste0(
      str_sub(x,1,4)
      ,'-'
      ,str_sub(x,5,6)
      ,'-'
      ,str_sub(x,7,8)
    )
  ) %>%
  mutate_at(
    c('START_TIME','DC_TIME')
    ,\(x)
    paste0(
      str_sub(x,1,2)
      ,':'
      ,str_sub(x,3,4)
    )
  ) %>%
  unite(START,START_DATE,START_TIME,sep=' ') %>%
  unite(DC,DC_DATE,DC_TIME,sep=' ') %>%
  mutate_at(
    c('START','DC')
    ,\(x)
    ifelse(
      str_count(x)==16
      & str_count(x,'-')==2
      & str_count(x,' ')==1
      & str_count(x,'\\:')==1
      ,x
      ,NA
    )
  ) %>%
  mutate_at(c('START','DC'),ymd_hm) %>%
  arrange(HOSP,CHR_NO,TYPE,FEE_NO,START,DC) %>%
  select(HOSP,CHR_NO,FEE_CODE,START,DC) %>%
  rename(
    IMMOB_FEE_CODE=FEE_CODE
    ,IMMOB_START=START
    ,IMMOB_DC=DC
  )
```

```{r Create immob. identifier, include=FALSE}
immob_identifier=
  uri_cath_d$prediction %>%
  left_join(
    left_join(
        .
        ,immob_order
        ,by=c('HOSP','CHR_NO')
      ) %>%
      filter(IMMOB_START<pred_day) %>%
      select(-IMMOB_START,-IMMOB_DC)
    ,by=colnames(uri_cath_d$prediction)
  ) %>%
  mutate(IMMOB_FEE_CODE=!is.na(IMMOB_FEE_CODE)) %>%
  group_by_at(colnames(uri_cath_d$prediction)) %>%
  summarize(
    immob=
      any(IMMOB_FEE_CODE)
    ,.groups='drop'
  )
```

```{r Check immob. distribution, eval=FALSE, include=FALSE}
immob_identifier %>%
  group_by(HOSP,immob) %>%
  summarize(n=n(),.groups='drop') %>%
  group_by(HOSP) %>%
  mutate(
    total=sum(n)
    ,p=round(n/total*100,2)
  ) %>%
  ungroup()
```

```{r Extract tables of dept. descriptors, include=FALSE}
dept_basic=
  raw_data1b %>%
  .[str_detect(names(.),'^v_ipd_basic')] %>%
  lapply(\(x)
    x %>%
      select_at(
        colnames(.) %>%
          .[str_detect(
            .
            ,paste0(
              c(
                '^CHR_NO'
                ,'^FEE_NO'
                ,'^GEN_DEPT_CODE'
              )
              ,collapse='|'
            )
          )]
      )
  ) %>%
  lapply(
    X=names(.)
    ,Y=.
    ,\(X,Y)
    Y[[X]] %>%
      mutate(
        HOSP=
          str_sub(X,str_count(X),str_count(X))
        ,TYPE=
          str_sub(X,3,5)
      )
  ) %>%
  do.call(rbind,.) %>%
  group_by(HOSP,GEN_DEPT_CODE) %>%
  summarize(n=n(),.groups='drop') %>%
  rename(DEPT_CODE=GEN_DEPT_CODE) %>%
  left_join(
    raw_data %>%
      .[str_detect(names(.),'^v_dept_basic')] %>%
      lapply(\(x)
        x %>%
          select_at(
            colnames(.) %>%
              .[str_detect(
                .
                ,paste0(
                  c(
                    '^DEPT_CODE'
                    ,'_DESC$'
                  )
                  ,collapse='|'
                )
              )]
          )
      ) %>%
      lapply(
        X=names(.)
        ,Y=.
        ,\(X,Y)
        Y[[X]] %>%
          mutate(
            HOSP=
              str_sub(X,str_count(X),str_count(X))
          )
      ) %>%
      do.call(rbind,.)
    ,by=c('HOSP','DEPT_CODE')
  ) %>%
  filter(!duplicated(.))
```

```{r Extract tables of op./surgery, include=FALSE}
indication_op=
  raw_data1b %>%
  .[str_detect(names(.),'^v_op_basic')] %>%
  lapply(\(x)
    x %>%
      select_at(
        colnames(.) %>%
          .[str_detect(
            .
            ,paste0(
              c(
                '^CHR_NO'
                ,'^FEE_NO'
                ,'^IN_'
                ,'^OUT_'
              )
              ,collapse='|'
            )
          )]
      )
  ) %>%
  lapply(
    X=names(.)
    ,Y=.
    ,\(X,Y)
    Y[[X]] %>%
      mutate(
        HOSP=
          str_sub(X,str_count(X),str_count(X))
      )
  ) %>%
  do.call(rbind,.) %>%
  select(HOSP,CHR_NO,FEE_NO,everything()) %>%
  mutate_at(
    c('IN_DATE','OUT_DATE')
    ,\(x)
    ifelse(x=='',NA,x)
  ) %>%
  mutate(
    IN_TIME=
      ifelse(
        !is.na(IN_DATE) & is.na(IN_TIME)
        ,'0000'
        ,IN_TIME
      )
    ,OUT_TIME=
      ifelse(
        !is.na(OUT_DATE) & is.na(OUT_TIME)
        ,'0000'
        ,OUT_TIME
      )
  ) %>%
  mutate_at(
    c('IN_DATE','OUT_DATE')
    ,\(x)
    as.numeric(x)+(2023-112)*10000
  ) %>%
  mutate_at(
    c('IN_DATE','OUT_DATE')
    ,\(x)
    paste0(
      str_sub(x,1,4)
      ,'-'
      ,str_sub(x,5,6)
      ,'-'
      ,str_sub(x,7,8)
    )
  ) %>%
  mutate_at(
    c('IN_TIME','OUT_TIME')
    ,\(x)
    paste0(
      str_sub(x,1,2)
      ,':'
      ,str_sub(x,3,4)
    )
  ) %>%
  unite(IN,IN_DATE,IN_TIME,sep=' ') %>%
  unite(OUT,OUT_DATE,OUT_TIME,sep=' ') %>%
  mutate_at(
    c('IN','OUT')
    ,\(x)
    ifelse(
      str_count(x)==16
      & str_count(x,'-')==2
      & str_count(x,' ')==1
      & str_count(x,'\\:')==1
      ,x
      ,NA
    )
  ) %>%
  mutate_at(c('IN','OUT'),ymd_hm)
```

```{r Create indication identifier, include=FALSE}
indication_identifier=
  uri_cath_d$prediction %>%
  left_join(
    left_join(
        .
        ,indication_op
        ,by=c('HOSP','CHR_NO','FEE_NO')
      ) %>%
      filter(is.na(IN) | (IN>=START & IN<pred_day)) %>%
      mutate(
        op=1
        ,int_d=as.duration(IN-START)/ddays(1)
        ,missing=is.na(int_d)
      ) %>%
      select(-IN,-OUT)
    ,by=colnames(uri_cath_d$prediction)
  ) %>%
  group_by_at(colnames(uri_cath_d$prediction)) %>%
  arrange(int_d) %>%
  slice(1) %>%
  summarize(
    missing=
      sum(missing,na.rm=T)>0
    ,indication=
      sum(op,na.rm=T)>0
    ,.groups='drop'
  ) %>%
  mutate(
    indication=ifelse(missing,NA,indication)
    ,indication=
      ifelse(indication,'Surgery','Medical') %>%
      factor(c('Surgery','Medical'))
  ) %>%
  select(-missing)
```

```{r Check indication distribution, eval=FALSE, include=FALSEs}
indication_identifier %>%
  group_by(HOSP,indication) %>%
  summarize(n=n(),.groups='drop') %>%
  group_by(HOSP) %>%
  mutate(
    total=sum(n)
    ,p=round(n/total*100,2)
  ) %>%
  ungroup()
```

```{r Extract tables of hypertension diagnosis updates, include=FALSE}
prev_HYP_upd=
  uri_cath_d$prediction %>%
  left_join(
    diag_upd %>%
      select(-FEE_NO)
    ,by=c('HOSP','CHR_NO')
  ) %>%
  filter(HOSPIN<pred_day) %>%
  group_by_at(colnames(uri_cath_d$prediction)) %>%
  summarize(
    all_na=
      all(is.na(SDIAG_CODE))
    ,SDIAG_CODE=
      any(str_sub(SDIAG_CODE,1,3)%in%paste0('I',10:15))
    ,.groups='drop'
  ) %>%
  mutate(SDIAG_CODE=ifelse(all_na,NA,SDIAG_CODE)) %>%
  select(-all_na)
```

```{r Extract tables of discharged hypertension diagnosis, include=FALSE}
prev_HYP_discharge=
  uri_cath_d$prediction %>%
  left_join(
     diag_discharge %>%
      left_join(
        los_upd
        ,by=c('HOSP','CHR_NO','FEE_NO')
      ) %>%
      select(-TYPE,-FEE_NO)
    ,by=c('HOSP','CHR_NO')
  ) %>%
  filter(CPD<pred_day) %>%
  group_by_at(colnames(uri_cath_d$prediction)) %>%
  summarize(
    all_na=
      all(is.na(CODE))
    ,CODE=
      any(str_sub(CODE,1,3)%in%paste0('I',10:15))
    ,.groups='drop'
  ) %>%
  mutate(CODE=ifelse(all_na,NA,CODE)) %>%
  select(-all_na)
```

```{r Create hypertension identifier, include=FALSE}
prev_HYP_identifier=
  uri_cath_d$prediction %>%
  left_join(
    prev_HYP_upd
    ,by=colnames(uri_cath_d$prediction)
  ) %>%
  left_join(
    prev_HYP_discharge
    ,by=colnames(uri_cath_d$prediction)
  ) %>%
  gather(
    CRITERIA_TYPE,CRITERIA_VALUE
    ,-HOSP,-CHR_NO,-TYPE,-FEE_NO
    ,-FEE_DATE,-FEE_TIME,-FEE_CODE,-SEQ_NO,-SEQ_NO2
    ,-START,-DC,-duration,-merged,-pred_day
  ) %>%
  group_by_at(colnames(uri_cath_d$prediction)) %>%
  summarize(
    all_na=
      all(is.na(CRITERIA_VALUE))
    ,prev_HYP=
      sum(CRITERIA_VALUE,na.rm=T)>0
    ,.groups='drop'
  ) %>%
  mutate(prev_HYP=ifelse(all_na,NA,prev_HYP)) %>%
  select(-all_na)
```

```{r Check hypertension distribution, eval=FALSE, include=FALSE}
prev_HYP_identifier %>%
  group_by(HOSP,prev_HYP) %>%
  summarize(n=n(),.groups='drop') %>%
  group_by(HOSP) %>%
  mutate(
    total=sum(n)
    ,p=round(n/total*100,2)
  ) %>%
  ungroup()
```

```{r Extract tables of previous DM insulin orders, include=FALSE}
prev_DM_insulin=
  uri_cath_d$prediction %>%
  left_join(
    med_order %>%
      select(-UD_SEQ,-UD_SEQ_OLD,-MED_CODE)
    ,by=c('HOSP','FEE_NO')
  ) %>%
  filter(BEGIN<pred_day) %>%
  group_by_at(colnames(uri_cath_d$prediction)) %>%
  summarize(
    all_na=
      all(is.na(MED_TYPE))
    ,MED_TYPE=
      any(str_detect(str_to_lower(MED_TYPE),'^090801'))
    ,.groups='drop'
  ) %>%
  mutate(MED_TYPE=ifelse(all_na,NA,MED_TYPE)) %>%
  select(-all_na)
```

```{r Create previous DM insulin identifier, include=FALSE}
prev_DMinsulin_identifier=
  uri_cath_d$prediction %>%
  left_join(
    prev_DM_insulin
    ,by=colnames(uri_cath_d$prediction)
  ) %>%
  gather(
    CRITERIA_TYPE,CRITERIA_VALUE
    ,-HOSP,-CHR_NO,-TYPE,-FEE_NO
    ,-FEE_DATE,-FEE_TIME,-FEE_CODE,-SEQ_NO,-SEQ_NO2
    ,-START,-DC,-duration,-merged,-pred_day
  ) %>%
  group_by_at(colnames(uri_cath_d$prediction)) %>%
  summarize(
    all_na=
      all(is.na(CRITERIA_VALUE))
    ,prev_DMinsulin=
      sum(CRITERIA_VALUE,na.rm=T)>0
    ,.groups='drop'
  ) %>%
  mutate(prev_DMinsulin=ifelse(all_na,NA,prev_DMinsulin)) %>%
  select(-all_na)
```

```{r Check previous DM insulin distribution, eval=FALSE, include=FALSE}
prev_DMinsulin_identifier %>%
  group_by(HOSP,prev_DMinsulin) %>%
  summarize(n=n(),.groups='drop') %>%
  group_by(HOSP) %>%
  mutate(
    total=sum(n)
    ,p=round(n/total*100,2)
  ) %>%
  ungroup()
```

```{r Extract tables of BMI components from BIO_INF, include=FALSE}
bmi_bio_inf=
  raw_data %>%
  .[str_detect(names(.),'^v_bio_inf')] %>%
  lapply(\(x)
    x %>%
      select_at(
        colnames(.) %>%
          .[str_detect(
            .
            ,paste0(
              c(
                '^CHR_NO'
                ,'^FEE_NO'
                ,'EIGHT$'
                ,'_DATE$'
                ,'_TIME$'
              )
              ,collapse='|'
            )
          )]
      )
  ) %>%
  lapply(
    X=names(.)
    ,Y=.
    ,\(X,Y)
    Y[[X]] %>%
      mutate(
        HOSP=
          str_sub(X,str_count(X),str_count(X))
      )
  ) %>%
  do.call(rbind,.) %>%
  mutate(source='bio_inf') %>%
  mutate_at(c('HEIGHT','WEIGHT'),as.character) %>%
  gather(variable,value,-source,-HOSP,-CHR_NO,-FEE_NO,-UPD_DATE,-UPD_TIME) %>%
  mutate(
    UPD_TIME=
      ifelse(
        !is.na(UPD_DATE) & is.na(UPD_TIME)
        ,'0000'
        ,UPD_TIME
      )
  ) %>%
  mutate(UPD_DATE=as.numeric(UPD_DATE)+(2023-112)*10000) %>%
  mutate(
    UPD_DATE=
      paste0(
        str_sub(UPD_DATE,1,4)
        ,'-'
        ,str_sub(UPD_DATE,5,6)
        ,'-'
        ,str_sub(UPD_DATE,7,8)
      )
  ) %>%
  mutate(
    UPD_TIME=
      paste0(
        str_sub(UPD_TIME,1,2)
        ,':'
        ,str_sub(UPD_TIME,3,4)
      )
  ) %>%
  unite(UPD,UPD_DATE,UPD_TIME,sep=' ') %>%
  mutate(
    UPD=
      ifelse(
        str_count(UPD)==16
        & str_count(UPD,'-')==2
        & str_count(UPD,' ')==1
        & str_count(UPD,'\\:')==1
        ,UPD
        ,NA
      )
  ) %>%
  mutate(UPD=ymd_hm(UPD)) %>%
  rename(CREATE=UPD) %>%
  left_join(
    c('',''
      ,'-',''
      ,'.',''
      ,'..',''
      ,'//',''
      ,'155+','155'
      ,'160+','160'
      ,'164,0','164'
      ,'NA',''
      ,'np',''
      ,'VD',''
      ,'53.5.','53.5'
      ,'53.5.0','53.5'
      ,'55+','55'
      ,'60+','60'
      ,'72.0.','72'
      ,'不知',''
      ) %>%
      matrix(ncol=2,byrow=T,dimnames=list(NULL,c('value','value2'))) %>%
      as.data.frame()
    ,by='value'
  ) %>%
  mutate(value=ifelse(is.na(value2),value,value2)) %>%
  select(-value2) %>%
  mutate(value=ifelse(value=='',NA,value)) %>%
  mutate(value=as.numeric(value)) %>%
  filter(!is.na(value)) %>%
  filter(value>0) %>%
  select(HOSP,everything())
```

```{r Extract tables of BMI components from NIS_TPR, include=FALSE}
bmi_nis_tpr=
  raw_data %>%
  .[str_detect(names(.),'^v_nis_tpr')] %>%
  lapply(\(x)
    x %>%
      select_at(
        colnames(.) %>%
          .[str_detect(
            .
            ,paste0(
              c(
                '^FEE_NO'
                ,'^ITEM_NO'
                ,'^POSITION'
                ,'^RECORD'
                ,'^CREATE'
              )
              ,collapse='|'
            )
          )]
      )
  ) %>%
  lapply(
    X=names(.)
    ,Y=.
    ,\(X,Y)
    Y[[X]] %>%
      mutate(
        HOSP=
          str_sub(X,str_count(X),str_count(X))
      )
  ) %>%
  do.call(rbind,.) %>%
  filter(ITEM_NO%in%c('bh','bw')) %>%
  left_join(
    raw_data %>%
      .[str_detect(names(.),'^v_ipd_basic')] %>%
      lapply(\(x)
        x %>%
          select_at(
            colnames(.) %>%
              .[str_detect(
                .
                ,paste0(
                  c(
                    '^CHR_NO'
                    ,'^FEE_NO'
                  )
                  ,collapse='|'
                )
              )]
          )
      ) %>%
      lapply(
        X=names(.)
        ,Y=.
        ,\(X,Y)
        Y[[X]] %>%
          mutate(
            HOSP=
              str_sub(X,str_count(X),str_count(X))
          )
      ) %>%
      do.call(rbind,.)
    ,by=c('HOSP','FEE_NO')
  ) %>%
  mutate(source='nis_tpr') %>%
  mutate_at(c('CREATE_DATE','CREATE_TIME'),as.character) %>%
  mutate(
    CREATE_TIME=
      ifelse(
        !is.na(CREATE_DATE) & is.na(CREATE_TIME)
        ,'00:00:00'
        ,CREATE_TIME
      )
  ) %>%
  separate(CREATE_TIME,c('H','M','S'),sep='\\:') %>%
  select(-S) %>%
  unite(CREATE_TIME,H,M,sep=':') %>%
  unite(CREATE,CREATE_DATE,CREATE_TIME,sep=' ') %>%
  mutate(
    CREATE=
      ifelse(
        str_count(CREATE)==16
        & str_count(CREATE,'-')==2
        & str_count(CREATE,' ')==1
        & str_count(CREATE,'\\:')==1
        ,CREATE
        ,NA
      )
  ) %>%
  mutate(CREATE=ymd_hm(CREATE)) %>%
  select(-POSITION) %>%
  rename(variable=ITEM_NO,value=RECORD) %>%
  mutate(
    variable=
      case_when(
        variable=='bh'~'HEIGHT'
        ,variable=='bw'~'WEIGHT'
      )
  ) %>%
  mutate(
    value=
      ifelse(
        str_detect(value,'\\|')
        ,value
        ,paste0(value,'|')
      ) %>%
      str_remove_all('\\#+')
  ) %>%
  separate(value,c('value','unit'),sep='\\|') %>%
  mutate(
    unit=
      ifelse(
        unit=='請選擇'
        ,'Kg'
        ,unit
      )
    ,unit=
      ifelse(
        variable=='WEIGHT' & unit==''
        ,'Kg'
        ,unit
      )
  ) %>%
  left_join(
    c('',''
      ,'`',''
      ,'158`','158'
      ,'164.5`','164.5'
      ,'javascript:void(0);',''
      ,'病人躁動',''
      ,'-',''
      ,'48..7',''
      ,'59..6',''
      ,'６1',''
      ,'拒',''
      ,'病人拒量',''
      ,'病人躁動',''
      ) %>%
      matrix(ncol=2,byrow=T,dimnames=list(NULL,c('value','value2'))) %>%
      as.data.frame()
    ,by='value'
  ) %>%
  mutate(value=ifelse(is.na(value2),value,value2)) %>%
  select(-value2) %>%
  mutate(value=ifelse(value=='',NA,value)) %>%
  mutate(value=as.numeric(value)) %>%
  mutate(
    value=
      ifelse(
        variable=='WEIGHT' & unit=='g'
        ,value/1000
        ,value
      )
  ) %>%
  select(-unit) %>%
  filter(!is.na(value)) %>%
  filter(value>0) %>%
  select_at(colnames(bmi_bio_inf))
```

```{r Extract tables of BMI components from CHR_FIGURE, include=FALSE}
bmi_chr_figure=
  bmi_bio_inf %>%
  rbind(bmi_nis_tpr) %>%
  arrange(HOSP,CREATE)
```

```{r Create BMI identifier, include=FALSE}
bmi_identifier=
  uri_cath_d$prediction %>%
  left_join(
    left_join(
        .
        ,bmi_chr_figure %>%
          select(-FEE_NO)
        ,by=c('HOSP','CHR_NO')
      ) %>%
      filter(CREATE<pred_day) %>%
      mutate(int_d=as.duration(pred_day-CREATE)/ddays(1)) %>%
      group_by_at(c(colnames(uri_cath_d$prediction),'variable')) %>%
      arrange(int_d) %>%
      slice(1) %>%
      ungroup() %>%
      select(-source,-CREATE,-int_d) %>%
      spread(variable,value) %>%
      mutate(BMI=WEIGHT/((HEIGHT/100)^2))
    ,by=colnames(uri_cath_d$prediction)
  )
```

```{r Check BMI missingness and outliers, eval=FALSE, include=FALSE}
bmi_identifier %>%
  group_by(HOSP) %>%
  mutate(
    min=min(BMI,na.rm=T)
    ,q1=quantile(BMI,0.25,na.rm=T)
    ,q2=quantile(BMI,0.5,na.rm=T)
    ,q3=quantile(BMI,0.75,na.rm=T)
    ,max=max(BMI,na.rm=T)
    ,n=n()
    ,missing=sum(is.na(BMI))
  ) %>%
  ungroup() %>%
  mutate(
    outlier=
      BMI<(q1-1.5*(q3-q1))
      | BMI>(q3+1.5*(q3-q1))
  ) %>%
  group_by(HOSP,min,q1,q2,q3,max,n,missing) %>%
  summarize(outliers=sum(outlier,na.rm=T),.groups='drop')
```

```{r Create BMI >30 identifier, include=FALSE}
bmi_gt30_identifier=
  bmi_identifier %>%
  mutate(BMI=BMI>30) %>%
  rename(BMI_GT30=BMI) %>%
  select(-HEIGHT,-WEIGHT)
```

```{r Check BMI >30 distribution, eval=FALSE, include=FALSE}
bmi_gt30_identifier %>%
  group_by(HOSP,BMI_GT30) %>%
  summarize(n=n(),.groups='drop') %>%
  group_by(HOSP) %>%
  mutate(
    total=sum(n)
    ,p=round(n/total*100,2)
  ) %>%
  ungroup()
```

```{r Extract tables of previous DM nephropathy updates, include=FALSE}
prev_DMneph_upd=
  uri_cath_d$prediction %>%
  left_join(
    diag_upd %>%
      select(-FEE_NO)
    ,by=c('HOSP','CHR_NO')
  ) %>%
  filter(HOSPIN<pred_day) %>%
  group_by_at(colnames(uri_cath_d$prediction)) %>%
  summarize(
    all_na=
      all(is.na(SDIAG_CODE))
    ,SDIAG_CODE=
      any(SDIAG_CODE%in%c('E11.21'))
    ,.groups='drop'
  ) %>%
  mutate(SDIAG_CODE=ifelse(all_na,NA,SDIAG_CODE)) %>%
  select(-all_na)
```

```{r Extract tables of previous discharged DM diagnosis, include=FALSE}
prev_DMneph_discharge=
  uri_cath_d$prediction %>%
  left_join(
     diag_discharge %>%
      left_join(
        los_upd
        ,by=c('HOSP','CHR_NO','FEE_NO')
      ) %>%
      select(-TYPE,-FEE_NO)
    ,by=c('HOSP','CHR_NO')
  ) %>%
  filter(CPD<pred_day) %>%
  group_by_at(colnames(uri_cath_d$prediction)) %>%
  summarize(
    all_na=
      all(is.na(CODE))
    ,CODE=
      any(CODE%in%c('E11.21'))
    ,.groups='drop'
  ) %>%
  mutate(CODE=ifelse(all_na,NA,CODE)) %>%
  select(-all_na)
```

```{r Create previous DM nephropathy identifier, include=FALSE}
prev_DMneph_identifier=
  uri_cath_d$prediction %>%
  left_join(
    prev_DMneph_upd
    ,by=colnames(uri_cath_d$prediction)
  ) %>%
  left_join(
    prev_DMneph_discharge
    ,by=colnames(uri_cath_d$prediction)
  ) %>%
  gather(
    CRITERIA_TYPE,CRITERIA_VALUE
    ,-HOSP,-CHR_NO,-TYPE,-FEE_NO
    ,-FEE_DATE,-FEE_TIME,-FEE_CODE,-SEQ_NO,-SEQ_NO2
    ,-START,-DC,-duration,-merged,-pred_day
  ) %>%
  group_by_at(colnames(uri_cath_d$prediction)) %>%
  summarize(
    all_na=
      all(is.na(CRITERIA_VALUE))
    ,prev_DMneph=
      sum(CRITERIA_VALUE,na.rm=T)>0
    ,.groups='drop'
  ) %>%
  mutate(prev_DMneph=ifelse(all_na,NA,prev_DMneph)) %>%
  select(-all_na)
```

```{r Check previous DM nephropathy distribution, eval=FALSE, include=FALSE}
prev_DMneph_identifier %>%
  group_by(HOSP,prev_DMneph) %>%
  summarize(n=n(),.groups='drop') %>%
  group_by(HOSP) %>%
  mutate(
    total=sum(n)
    ,p=round(n/total*100,2)
  ) %>%
  ungroup()
```

```{r Create previous DM-related factors identifier, include=FALSE}
prev_DMrel_identifier=
  prev_DM_identifier %>%
  left_join(
    prev_HYP_identifier
    ,by=colnames(uri_cath_d$prediction)
  ) %>%
  left_join(
    prev_DMinsulin_identifier
    ,by=colnames(uri_cath_d$prediction)
  ) %>%
  left_join(
    bmi_gt30_identifier
    ,by=colnames(uri_cath_d$prediction)
  ) %>%
  left_join(
    prev_DMneph_identifier
    ,by=colnames(uri_cath_d$prediction)
  ) %>%
  mutate(
    prev_DMrel=
      prev_DM
      & (prev_HYP+prev_DMinsulin+BMI_GT30+prev_DMneph)>0
  ) %>%
  select(-prev_DM,-prev_HYP,-prev_DMinsulin,-BMI_GT30,-prev_DMneph)
```

```{r Check previous DM-related factors distribution, eval=FALSE, include=FALSE}
prev_DMrel_identifier %>%
  group_by(HOSP,prev_DMrel) %>%
  summarize(n=n(),.groups='drop') %>%
  group_by(HOSP) %>%
  mutate(
    total=sum(n)
    ,p=round(n/total*100,2)
  ) %>%
  ungroup()
```

```{r Determine FEE_CODE for albumin, include=FALSE}
albumin=
  raw_data %>%
  .[str_detect(names(.),'^v_fee_basic')] %>%
  lapply(select,FEE_CODE,FEE_DESC) %>%
  lapply(
    X=names(.)
    ,Y=.
    ,\(X,Y)
    Y[[X]] %>%
      mutate(
        HOSP=
          str_sub(X,str_count(X),str_count(X))
      )
  ) %>%
  do.call(rbind,.) %>%
  filter(
    str_detect(
      str_to_lower(FEE_CODE)
      ,filter(.,str_detect(str_to_lower(FEE_DESC),'albumin')) %>%
        pull(FEE_CODE) %>%
        str_sub(1,str_count(.)-1) %>%
        str_to_lower() %>%
        unique() %>%
        paste0(collapse='|')
    )
  ) %>%
  mutate(exist='yes') %>%
  spread(HOSP,exist,fill='no') %>%
  arrange(FEE_CODE,w,t,s) %>%
  filter(str_detect(str_to_lower(FEE_CODE),'f090380|f09038c'))
```

```{r Extract tables of albumin orders and results, include=FALSE}
albumin_order=
  raw_data1b %>%
  .[str_detect(names(.),'^v_opd_exper|^v_exper_order')] %>%
  lapply(
    X=names(.)
    ,Y=.
    ,\(X,Y){
    Z=Y[[X]] %>%
      left_join(
        raw_data1b[[paste0(
            'v_ipd_fee_'
            ,str_sub(X,str_count(X),str_count(X))
          )]] %>%
          filter(FEE_CODE%in%albumin$FEE_CODE) %>%
          select(FEE_NO,FEE_CODE) %>%
          rename(ALBUMIN=FEE_CODE)
        ,by='FEE_NO'
      ) %>%
      filter(!is.na(ALBUMIN))
    
    if(str_detect(X,'_s$|_t$')){
      Z=Z %>%
        select(
          CHR_NO,FEE_NO
          ,ALBUMIN
          ,TUBE_NO,ITEM_NO
        ) %>%
        left_join(
          raw_data1b[[paste0(
              'v_labresult_'
              ,str_sub(X,str_count(X),str_count(X))
            )]] %>%
            select(
              FEE_NO,TUBE_NO,O_ITEM
              ,VALUE
              ,B_DATE,B_TIME
            ) %>%
            rename(ITEM_NO=O_ITEM) %>%
            filter(ITEM_NO%in%c('0103','11D1'))
          ,by=c('FEE_NO','TUBE_NO','ITEM_NO')
        ) %>%
        rename(TAKE_DATE=B_DATE,TAKE_TIME=B_TIME)
    }else{
      Z=Z %>%
        select(
          CHR_NO,FEE_NO
          ,ALBUMIN
          ,TUBE_NUMBER,GROUP_CODE
        ) %>%
        left_join(
          raw_data1b[[paste0(
              'v_exper_sign_'
              ,str_sub(X,str_count(X),str_count(X))
            )]] %>%
            select(
              FEE_NO,TUBE_NUMBER,GROUP_CODE
              ,EXPER_DATA2
              ,TAKE_DATE,TAKE_TIME
            ) %>%
            filter(GROUP_CODE%in%albumin$FEE_CODE)
          ,by=c('FEE_NO','TUBE_NUMBER','GROUP_CODE')
        ) %>%
        rename(TUBE_NO=TUBE_NUMBER,ITEM_NO=GROUP_CODE,VALUE=EXPER_DATA2)
    }
    
    Z %>%
      mutate(
        VALUE=
          ifelse(
            str_detect(VALUE,'\\s+')
            ,VALUE
            ,paste0(VALUE,' ')
          )
      ) %>%
      separate(VALUE,c('VALUE','UNIT'),sep='\\s+') %>%
      select(-UNIT) %>%
      mutate(
        VALUE=ifelse(str_detect(VALUE,'\\<|\\>'),NA,VALUE)
        ,VALUE=as.numeric(VALUE)
      ) %>%
      filter(!is.na(VALUE) & VALUE!='') %>%
      filter(!duplicated(.)) %>%
      mutate(
        HOSP=
          str_sub(X,str_count(X),str_count(X))
      )
  }) %>%
  do.call(rbind,.) %>%
  mutate(
    TAKE_TIME=
      ifelse(
        !is.na(TAKE_DATE) & is.na(TAKE_TIME)
        ,'0000'
        ,TAKE_TIME
      )
  ) %>%
  mutate(TAKE_DATE=as.numeric(TAKE_DATE)+(2023-112)*10000) %>%
  mutate(
    TAKE_DATE=
      paste0(
        str_sub(TAKE_DATE,1,4)
        ,'-'
        ,str_sub(TAKE_DATE,5,6)
        ,'-'
        ,str_sub(TAKE_DATE,7,8)
      )
  ) %>%
  mutate(
    TAKE_TIME=
      paste0(
        str_sub(TAKE_TIME,1,2)
        ,':'
        ,str_sub(TAKE_TIME,3,4)
      )
  ) %>%
  unite(TAKE,TAKE_DATE,TAKE_TIME,sep=' ') %>%
  mutate(
    TAKE=
      ifelse(
        str_count(TAKE)==16
        & str_count(TAKE,'-')==2
        & str_count(TAKE,' ')==1
        & str_count(TAKE,'\\:')==1
        ,TAKE
        ,NA
      )
  ) %>%
  mutate(TAKE=ymd_hm(TAKE))
```

```{r Create albumin identifier, include=FALSE}
albumin_identifier=
  uri_cath_d$prediction %>%
  left_join(
    left_join(
        .
        ,albumin_order %>%
          select(-FEE_NO)
        ,by=c('HOSP','CHR_NO')
      ) %>%
      filter(TAKE<pred_day) %>%
      mutate(int_d=as.duration(pred_day-TAKE)/ddays(1)) %>%
      group_by_at(colnames(uri_cath_d$prediction)) %>%
      arrange(int_d) %>%
      slice(1) %>%
      ungroup() %>%
      select(-ALBUMIN,-TUBE_NO,-ITEM_NO,-TAKE,-int_d) %>%
      rename(ALBUMIN=VALUE)
    ,by=colnames(uri_cath_d$prediction)
  )
```

```{r Check albumin missingness and outliers, eval=FALSE, include=FALSE}
albumin_identifier %>%
  group_by(HOSP) %>%
  mutate(
    min=min(ALBUMIN,na.rm=T)
    ,q1=quantile(ALBUMIN,0.25,na.rm=T)
    ,q2=quantile(ALBUMIN,0.5,na.rm=T)
    ,q3=quantile(ALBUMIN,0.75,na.rm=T)
    ,max=max(ALBUMIN,na.rm=T)
    ,n=n()
    ,missing=sum(is.na(ALBUMIN))
  ) %>%
  ungroup() %>%
  mutate(
    outlier=
      ALBUMIN<(q1-1.5*(q3-q1))
      | ALBUMIN>(q3+1.5*(q3-q1))
  ) %>%
  group_by(HOSP,min,q1,q2,q3,max,n,missing) %>%
  summarize(outliers=sum(outlier,na.rm=T),.groups='drop')
```

```{r Create albumin <3.5 identifier, include=FALSE}
albumin_lt3.5_identifier=
  albumin_identifier %>%
  mutate(ALBUMIN=ALBUMIN<3.5) %>%
  rename(ALBUMIN_LT3.5=ALBUMIN)
```

```{r Check albumin <3.5 distribution, eval=FALSE, include=FALSE}
albumin_lt3.5_identifier %>%
  group_by(HOSP,ALBUMIN_LT3.5) %>%
  summarize(n=n(),.groups='drop') %>%
  group_by(HOSP) %>%
  mutate(
    total=sum(n)
    ,p=round(n/total*100,2)
  ) %>%
  ungroup()
```

```{r Determine FEE_CODE for creatinine, include=FALSE}
creatinine=
  raw_data %>%
  .[str_detect(names(.),'^v_fee_basic')] %>%
  lapply(select,FEE_CODE,FEE_DESC) %>%
  lapply(
    X=names(.)
    ,Y=.
    ,\(X,Y)
    Y[[X]] %>%
      mutate(
        HOSP=
          str_sub(X,str_count(X),str_count(X))
      )
  ) %>%
  do.call(rbind,.) %>%
  filter(
    str_detect(
      str_to_lower(FEE_CODE)
      ,filter(.,str_detect(str_to_lower(FEE_DESC),'creatinine')) %>%
        pull(FEE_CODE) %>%
        str_sub(1,str_count(.)-1) %>%
        str_to_lower() %>%
        unique() %>%
        paste0(collapse='|')
    )
  ) %>%
  mutate(exist='yes') %>%
  spread(HOSP,exist,fill='no') %>%
  arrange(FEE_CODE,w,t,s) %>%
  filter(str_detect(str_to_lower(FEE_CODE),'f090150|f090159|f09015b|f09015c$'))
```

```{r Extract tables of albumin orders and results, include=FALSE}
creatinine_order=
  raw_data1b %>%
  .[str_detect(names(.),'^v_opd_exper|^v_exper_order')] %>%
  lapply(
    X=names(.)
    ,Y=.
    ,\(X,Y){
    Z=Y[[X]] %>%
      left_join(
        raw_data1b[[paste0(
            'v_ipd_fee_'
            ,str_sub(X,str_count(X),str_count(X))
          )]] %>%
          filter(FEE_CODE%in%creatinine$FEE_CODE) %>%
          select(FEE_NO,FEE_CODE) %>%
          rename(CREATININE_EGFR=FEE_CODE)
        ,by='FEE_NO'
      ) %>%
      filter(!is.na(CREATININE_EGFR))
    
    if(str_detect(X,'_s$|_t$')){
      Z=Z %>%
        select(
          CHR_NO,FEE_NO
          ,CREATININE_EGFR
          ,TUBE_NO,ITEM_NO
        ) %>%
        left_join(
          raw_data1b[[paste0(
              'v_labresult_'
              ,str_sub(X,str_count(X),str_count(X))
            )]] %>%
            select(
              FEE_NO,TUBE_NO,O_ITEM
              ,VALUE
              ,B_DATE,B_TIME
              ,R_ITEM
            ) %>%
            rename(ITEM_NO=O_ITEM) %>%
            filter(ITEM_NO%in%c('0108','11A2')) %>%
            filter(R_ITEM%in%c('010801','11A201','010802','11A202'))
          ,by=c('FEE_NO','TUBE_NO','ITEM_NO')
        ) %>%
        rename(TAKE_DATE=B_DATE,TAKE_TIME=B_TIME)
    }else{
      Z=Z %>%
        select(
          CHR_NO,FEE_NO
          ,CREATININE_EGFR
          ,TUBE_NUMBER,GROUP_CODE
        ) %>%
        left_join(
          raw_data1b[[paste0(
              'v_exper_sign_'
              ,str_sub(X,str_count(X),str_count(X))
            )]] %>%
            select(
              FEE_NO,TUBE_NUMBER,GROUP_CODE
              ,EXPER_DATA2
              ,TAKE_DATE,TAKE_TIME
              ,EXPER_CLASS,EXPER_TYPE,EXPER_CODE
            ) %>%
            unite(R_ITEM,EXPER_CLASS,EXPER_TYPE,EXPER_CODE,sep='|') %>%
            filter(GROUP_CODE%in%creatinine$FEE_CODE) %>%
            filter(R_ITEM%in%c('01|A|CREB','01|A|EGFR'))
          ,by=c('FEE_NO','TUBE_NUMBER','GROUP_CODE')
        ) %>%
        rename(TUBE_NO=TUBE_NUMBER,ITEM_NO=GROUP_CODE,VALUE=EXPER_DATA2)
    }
    
    Z %>%
      mutate(
        VALUE=
          ifelse(
            str_detect(VALUE,'\\s+')
            ,VALUE
            ,paste0(VALUE,' ')
          )
      ) %>%
      mutate(VALUE=str_replace_all(VALUE,'1.73 m\\^2','1.73M2')) %>%
      separate(VALUE,c('VALUE','UNIT'),sep='\\s+') %>%
      select(-UNIT) %>%
      mutate(
        VALUE=ifelse(str_detect(VALUE,'\\<|\\>|\\*|無法計算'),NA,VALUE)
        ,VALUE=as.numeric(VALUE)
      ) %>%
      filter(!is.na(VALUE) & VALUE!='') %>%
      filter(!duplicated(.)) %>%
      mutate(
        R_ITEM=
          ifelse(
            R_ITEM%in%c('010801','11A201','01|A|CREB')
            ,'CREATININE'
            ,'EGFR'
          )
      ) %>%
      spread(R_ITEM,VALUE) %>%
      filter(!is.na(CREATININE)) %>%
      mutate(
        HOSP=
          str_sub(X,str_count(X),str_count(X))
      )
  }) %>%
  do.call(rbind,.) %>%
  mutate(
    TAKE_TIME=
      ifelse(
        !is.na(TAKE_DATE) & is.na(TAKE_TIME)
        ,'0000'
        ,TAKE_TIME
      )
  ) %>%
  mutate(TAKE_DATE=as.numeric(TAKE_DATE)+(2023-112)*10000) %>%
  mutate(
    TAKE_DATE=
      paste0(
        str_sub(TAKE_DATE,1,4)
        ,'-'
        ,str_sub(TAKE_DATE,5,6)
        ,'-'
        ,str_sub(TAKE_DATE,7,8)
      )
  ) %>%
  mutate(
    TAKE_TIME=
      paste0(
        str_sub(TAKE_TIME,1,2)
        ,':'
        ,str_sub(TAKE_TIME,3,4)
      )
  ) %>%
  unite(TAKE,TAKE_DATE,TAKE_TIME,sep=' ') %>%
  mutate(
    TAKE=
      ifelse(
        str_count(TAKE)==16
        & str_count(TAKE,'-')==2
        & str_count(TAKE,' ')==1
        & str_count(TAKE,'\\:')==1
        ,TAKE
        ,NA
      )
  ) %>%
  mutate(TAKE=ymd_hm(TAKE))
```

```{r Create creatinine identifier, include=FALSE}
creatinine_identifier=
  uri_cath_d$prediction %>%
  left_join(
    left_join(
        .
        ,creatinine_order %>%
          select(-FEE_NO)
        ,by=c('HOSP','CHR_NO')
      ) %>%
      filter(TAKE<pred_day) %>%
      mutate(int_d=as.duration(pred_day-TAKE)/ddays(1)) %>%
      group_by_at(colnames(uri_cath_d$prediction)) %>%
      arrange(int_d) %>%
      slice(1) %>%
      ungroup() %>%
      select(-CREATININE_EGFR,-TUBE_NO,-ITEM_NO,-TAKE,-int_d)
    ,by=colnames(uri_cath_d$prediction)
  )
```

```{r Check creatinine missingness and outliers, eval=FALSE, include=FALSE}
creatinine_identifier %>%
  group_by(HOSP) %>%
  mutate(
    min=min(CREATININE,na.rm=T)
    ,q1=quantile(CREATININE,0.25,na.rm=T)
    ,q2=quantile(CREATININE,0.5,na.rm=T)
    ,q3=quantile(CREATININE,0.75,na.rm=T)
    ,max=max(CREATININE,na.rm=T)
    ,n=n()
    ,missing=sum(is.na(CREATININE))
  ) %>%
  ungroup() %>%
  mutate(
    outlier=
      CREATININE<(q1-1.5*(q3-q1))
      | CREATININE>(q3+1.5*(q3-q1))
  ) %>%
  group_by(HOSP,min,q1,q2,q3,max,n,missing) %>%
  summarize(outliers=sum(outlier,na.rm=T),.groups='drop')

creatinine_identifier %>%
  group_by(HOSP) %>%
  mutate(
    min=min(EGFR,na.rm=T)
    ,q1=quantile(EGFR,0.25,na.rm=T)
    ,q2=quantile(EGFR,0.5,na.rm=T)
    ,q3=quantile(EGFR,0.75,na.rm=T)
    ,max=max(EGFR,na.rm=T)
    ,n=n()
    ,missing=sum(is.na(EGFR))
  ) %>%
  ungroup() %>%
  mutate(
    outlier=
      EGFR<(q1-1.5*(q3-q1))
      | EGFR>(q3+1.5*(q3-q1))
  ) %>%
  group_by(HOSP,min,q1,q2,q3,max,n,missing) %>%
  summarize(outliers=sum(outlier,na.rm=T),.groups='drop')
```

```{r Create creatinine <0.5 identifier, include=FALSE}
creatinine_lt0.5_identifier=
  creatinine_identifier %>%
  mutate(CREATININE=CREATININE<0.5 & EGFR>=105) %>%
  rename(CREATININE_LT0.5=CREATININE) %>%
  select(-EGFR)
```

```{r Check creatinine <0.5 distribution, eval=FALSE, include=FALSE}
creatinine_lt0.5_identifier %>%
  group_by(HOSP,CREATININE_LT0.5) %>%
  summarize(n=n(),.groups='drop') %>%
  group_by(HOSP) %>%
  mutate(
    total=sum(n)
    ,p=round(n/total*100,2)
  ) %>%
  ungroup()
```

```{r Create poor nutrition identifier, include=FALSE}
poor_nutr_identifier=
  albumin_lt3.5_identifier %>%
  left_join(
    creatinine_lt0.5_identifier
    ,by=colnames(uri_cath_d$prediction)
  ) %>%
  mutate(poor_nutr=(ALBUMIN_LT3.5+CREATININE_LT0.5)>0) %>%
  select(-ALBUMIN_LT3.5,-CREATININE_LT0.5)
```

```{r Check poor nutrition distribution, eval=FALSE, include=FALSE}
poor_nutr_identifier %>%
  group_by(HOSP,poor_nutr) %>%
  summarize(n=n(),.groups='drop') %>%
  group_by(HOSP) %>%
  mutate(
    total=sum(n)
    ,p=round(n/total*100,2)
  ) %>%
  ungroup()
```

```{r Identify MED_CODE for FI-AD drugs, eval=FALSE, include=FALSE}
raw_data1b %>%
  .[str_detect(names(.),'^v_med_basic')] %>%
  lapply(\(x)
    x %>%
      select_at(
        colnames(.) %>%
          .[str_detect(.,'^MED_|DESC')]
      )
  ) %>%
  lapply(
    X=names(.)
    ,Y=.
    ,\(X,Y)
    Y[[X]] %>%
      mutate(
        HOSP=
          str_sub(X,str_count(X),str_count(X))
      )
  ) %>%
  do.call(rbind,.) %>%
  mutate(
    ANTIDIAR=
      ALISE_DESC %>%
      str_to_lower() %>%
      str_replace_all('/',' ') %>%
      str_remove_all('[:digit:]|[:punct:]|庫|針頭')
  ) %>%
  select(HOSP,MED_CODE,MED_TYPE,ANTIDIAR,everything()) %>%
  lapply(X=1,Y=.,\(X,Y){
    Z=Y %>%
      filter(
        str_detect(
          str_to_lower(MED_CODE)
          ,filter(.,str_detect(str_to_lower(MED_TYPE),'^0708')) %>%
            pull(MED_CODE) %>%
            str_to_lower() %>%
            unique() %>%
            paste0(collapse='|')
        )
      )
    
    print(
      Z %>%
        filter(ANTIDIAR%in%c(''))
    )
    
    print(
      Z %>%
        group_by(HOSP,MED_TYPE,ANTIDIAR,MED_CODE) %>%
        summarize(n=n(),.groups='drop') %>%
        group_by(HOSP,MED_TYPE,ANTIDIAR) %>%
        summarize(
          MED_CODES=paste0(MED_CODE,collapse='|')
          ,n=sum(n)
          ,.groups='drop'
        ) %>%
        spread(HOSP,n,fill=0) %>%
        arrange(MED_TYPE,MED_CODES,w,t,s)
    )
    
    Y
  }) %>%
  .[[1]] %>%
  filter(str_detect(str_to_lower(MED_TYPE),'^0708')) %>%
  group_by(HOSP,MED_TYPE,ANTIDIAR,MED_CODE) %>%
  summarize(n=n(),.groups='drop') %>%
  group_by(HOSP,MED_TYPE,ANTIDIAR) %>%
  summarize(
    MED_CODES=paste0(MED_CODE,collapse='|')
    ,n=sum(n)
    ,.groups='drop'
  ) %>%
  spread(HOSP,n,fill=0) %>%
  arrange(MED_TYPE,MED_CODES,w,t,s)
```

```{r Extract tables of FI-AD medication orders, include=FALSE}
prev_FIAD_med=
  uri_cath_d$prediction %>%
  left_join(
    med_order %>%
      select(-UD_SEQ,-UD_SEQ_OLD,-MED_CODE)
    ,by=c('HOSP','FEE_NO')
  ) %>%
  filter(BEGIN<pred_day) %>%
  group_by_at(colnames(uri_cath_d$prediction)) %>%
  summarize(
    all_na=
      all(is.na(MED_TYPE))
    ,MED_TYPE=
      any(str_detect(str_to_lower(MED_TYPE),'^0708'))
    ,.groups='drop'
  ) %>%
  mutate(MED_TYPE=ifelse(all_na,NA,MED_TYPE)) %>%
  select(-all_na)
```

```{r Create FI-AD identifier, include=FALSE}
prev_FIAD_identifier=
  uri_cath_d$prediction %>%
  left_join(
    prev_FIAD_med
    ,by=colnames(uri_cath_d$prediction)
  ) %>%
  group_by_at(colnames(uri_cath_d$prediction)) %>%
  summarize(
    all_na=
      all(is.na(MED_TYPE))
    ,prev_FIAD=
      sum(MED_TYPE,na.rm=T)>0
    ,.groups='drop'
  ) %>%
  mutate(prev_FIAD=ifelse(all_na,NA,prev_FIAD)) %>%
  select(-all_na)
```

```{r Check FI-AD distribution, eval=FALSE, include=FALSE}
prev_FIAD_identifier %>%
  group_by(HOSP,prev_FIAD) %>%
  summarize(n=n(),.groups='drop') %>%
  group_by(HOSP) %>%
  mutate(
    total=sum(n)
    ,p=round(n/total*100,2)
  ) %>%
  ungroup()
```

```{r Identify MED_CODE for FI-LX laxative drugs, eval=FALSE, include=FALSE}
raw_data1b %>%
  .[str_detect(names(.),'^v_med_basic')] %>%
  lapply(\(x)
    x %>%
      select_at(
        colnames(.) %>%
          .[str_detect(.,'^MED_|DESC')]
      )
  ) %>%
  lapply(
    X=names(.)
    ,Y=.
    ,\(X,Y)
    Y[[X]] %>%
      mutate(
        HOSP=
          str_sub(X,str_count(X),str_count(X))
      )
  ) %>%
  do.call(rbind,.) %>%
  mutate(
    LAXATIVE=
      ALISE_DESC %>%
      str_to_lower() %>%
      str_replace_all('/',' ') %>%
      str_remove_all('[:digit:]|[:punct:]|庫|針頭')
  ) %>%
  select(HOSP,MED_CODE,MED_TYPE,LAXATIVE,everything()) %>%
  lapply(X=1,Y=.,\(X,Y){
    Z=Y %>%
      filter(
        str_detect(
          str_to_lower(MED_CODE)
          ,filter(.,str_detect(str_to_lower(MED_TYPE),'^0709')) %>%
            pull(MED_CODE) %>%
            str_to_lower() %>%
            unique() %>%
            paste0(collapse='|')
        )
      )
    
    print(
      Z %>%
        filter(LAXATIVE%in%c(''))
    )
    
    print(
      Z %>%
        group_by(HOSP,MED_TYPE,LAXATIVE,MED_CODE) %>%
        summarize(n=n(),.groups='drop') %>%
        group_by(HOSP,MED_TYPE,LAXATIVE) %>%
        summarize(
          MED_CODES=paste0(MED_CODE,collapse='|')
          ,n=sum(n)
          ,.groups='drop'
        ) %>%
        spread(HOSP,n,fill=0) %>%
        arrange(MED_TYPE,MED_CODES,w,t,s)
    )
    
    Y
  }) %>%
  .[[1]] %>%
  filter(str_detect(str_to_lower(MED_TYPE),'^0709')) %>%
  group_by(HOSP,MED_TYPE,LAXATIVE,MED_CODE) %>%
  summarize(n=n(),.groups='drop') %>%
  group_by(HOSP,MED_TYPE,LAXATIVE) %>%
  summarize(
    MED_CODES=paste0(MED_CODE,collapse='|')
    ,n=sum(n)
    ,.groups='drop'
  ) %>%
  spread(HOSP,n,fill=0) %>%
  arrange(MED_TYPE,MED_CODES,w,t,s)
```

```{r Extract tables of FI-LX medication orders, include=FALSE}
prev_FILX_med=
  uri_cath_d$prediction %>%
  left_join(
    med_order %>%
      select(-UD_SEQ,-UD_SEQ_OLD,-MED_CODE)
    ,by=c('HOSP','FEE_NO')
  ) %>%
  filter(BEGIN<pred_day) %>%
  group_by_at(colnames(uri_cath_d$prediction)) %>%
  summarize(
    all_na=
      all(is.na(MED_TYPE))
    ,MED_TYPE=
      any(str_detect(str_to_lower(MED_TYPE),'^0709'))
    ,.groups='drop'
  ) %>%
  mutate(MED_TYPE=ifelse(all_na,NA,MED_TYPE)) %>%
  select(-all_na)
```

```{r Create FI-LX identifier, include=FALSE}
prev_FILX_identifier=
  uri_cath_d$prediction %>%
  left_join(
    prev_FILX_med
    ,by=colnames(uri_cath_d$prediction)
  ) %>%
  group_by_at(colnames(uri_cath_d$prediction)) %>%
  summarize(
    all_na=
      all(is.na(MED_TYPE))
    ,prev_FILX=
      sum(MED_TYPE,na.rm=T)>0
    ,.groups='drop'
  ) %>%
  mutate(prev_FILX=ifelse(all_na,NA,prev_FILX)) %>%
  select(-all_na)
```

```{r Check FI-LX distribution, eval=FALSE, include=FALSE}
prev_FILX_identifier %>%
  group_by(HOSP,prev_FILX) %>%
  summarize(n=n(),.groups='drop') %>%
  group_by(HOSP) %>%
  mutate(
    total=sum(n)
    ,p=round(n/total*100,2)
  ) %>%
  ungroup()
```

```{r Create previous FI identifier, include=FALSE}
prev_FI_identifier=
  prev_FIAD_identifier %>%
  left_join(
    prev_FILX_identifier
    ,by=colnames(uri_cath_d$prediction)
  ) %>%
  mutate(prev_FI=(prev_FIAD+prev_FILX)>0) %>%
  select(-prev_FIAD,-prev_FILX)
```

```{r Check previous FI distribution, eval=FALSE, include=FALSE}
prev_FI_identifier %>%
  group_by(HOSP,prev_FI) %>%
  summarize(n=n(),.groups='drop') %>%
  group_by(HOSP) %>%
  mutate(
    total=sum(n)
    ,p=round(n/total*100,2)
  ) %>%
  ungroup()
```

```{r Identify MED_CODE for IC-CS drugs, eval=FALSE, include=FALSE}
raw_data1b %>%
  .[str_detect(names(.),'^v_med_basic')] %>%
  lapply(\(x)
    x %>%
      select_at(
        colnames(.) %>%
          .[str_detect(.,'^MED_|DESC')]
      )
  ) %>%
  lapply(
    X=names(.)
    ,Y=.
    ,\(X,Y)
    Y[[X]] %>%
      mutate(
        HOSP=
          str_sub(X,str_count(X),str_count(X))
      )
  ) %>%
  do.call(rbind,.) %>%
  mutate(
    CORTICOSTEROID=
      ALISE_DESC %>%
      str_to_lower() %>%
      str_replace_all('/',' ') %>%
      str_remove_all('[:digit:]|[:punct:]|庫|針頭')
  ) %>%
  select(HOSP,MED_CODE,MED_TYPE,CORTICOSTEROID,everything()) %>%
  lapply(X=1,Y=.,\(X,Y){
    Z=Y %>%
      filter(
        str_detect(
          str_to_lower(MED_CODE)
          ,filter(.,str_detect(str_to_lower(MED_TYPE),'^0906')) %>%
            pull(MED_CODE) %>%
            str_to_lower() %>%
            unique() %>%
            paste0(collapse='|')
        )
      )
    
    print(
      Z %>%
        filter(CORTICOSTEROID%in%c(''))
    )
    
    print(
      Z %>%
        group_by(HOSP,MED_TYPE,CORTICOSTEROID,MED_CODE) %>%
        summarize(n=n(),.groups='drop') %>%
        group_by(HOSP,MED_TYPE,CORTICOSTEROID) %>%
        summarize(
          MED_CODES=paste0(MED_CODE,collapse='|')
          ,n=sum(n)
          ,.groups='drop'
        ) %>%
        spread(HOSP,n,fill=0) %>%
        arrange(MED_TYPE,MED_CODES,w,t,s)
    )
    
    Y
  }) %>%
  .[[1]] %>%
  filter(
    str_detect(str_to_lower(MED_TYPE),'^0906')
    & str_to_lower(UNIT_DESC)%in%c('amp','cap','ml','tab','vial')
  ) %>%
  group_by(HOSP,MED_TYPE,CORTICOSTEROID,MED_CODE) %>%
  summarize(n=n(),.groups='drop') %>%
  group_by(HOSP,MED_TYPE,CORTICOSTEROID) %>%
  summarize(
    MED_CODES=paste0(MED_CODE,collapse='|')
    ,n=sum(n)
    ,.groups='drop'
  ) %>%
  spread(HOSP,n,fill=0) %>%
  arrange(MED_TYPE,MED_CODES,w,t,s)
```

```{r Extract tables of IC-CS medication orders, include=FALSE}
prev_ICCS_med=
  uri_cath_d$prediction %>%
  left_join(
    med_order %>%
      select(-UD_SEQ,-UD_SEQ_OLD,-MED_CODE)
    ,by=c('HOSP','FEE_NO')
  ) %>%
  filter(BEGIN<pred_day) %>%
  group_by_at(colnames(uri_cath_d$prediction)) %>%
  summarize(
    all_na=
      all(is.na(MED_TYPE))
    ,MED_TYPE=
      any(
        str_detect(str_to_lower(MED_TYPE),'^0709')
        & str_to_lower(UNIT_DESC)%in%c('amp','cap','ml','tab','vial')
      )
    ,.groups='drop'
  ) %>%
  mutate(MED_TYPE=ifelse(all_na,NA,MED_TYPE)) %>%
  select(-all_na)
```

```{r Create IC-CS identifier, include=FALSE}
prev_ICCS_identifier=
  uri_cath_d$prediction %>%
  left_join(
    prev_ICCS_med
    ,by=colnames(uri_cath_d$prediction)
  ) %>%
  group_by_at(colnames(uri_cath_d$prediction)) %>%
  summarize(
    all_na=
      all(is.na(MED_TYPE))
    ,prev_ICCS=
      sum(MED_TYPE,na.rm=T)>0
    ,.groups='drop'
  ) %>%
  mutate(prev_ICCS=ifelse(all_na,NA,prev_ICCS)) %>%
  select(-all_na)
```

```{r Check IC-CS distribution, eval=FALSE, include=FALSE}
prev_ICCS_identifier %>%
  group_by(HOSP,prev_ICCS) %>%
  summarize(n=n(),.groups='drop') %>%
  group_by(HOSP) %>%
  mutate(
    total=sum(n)
    ,p=round(n/total*100,2)
  ) %>%
  ungroup()
```

```{r Extract tables of IC-HIV diagnosis updates, include=FALSE}
prev_ICHIV_upd=
  uri_cath_d$prediction %>%
  left_join(
    diag_upd %>%
      select(-FEE_NO)
    ,by=c('HOSP','CHR_NO')
  ) %>%
  filter(HOSPIN<pred_day) %>%
  group_by_at(colnames(uri_cath_d$prediction)) %>%
  summarize(
    all_na=
      all(is.na(SDIAG_CODE))
    ,SDIAG_CODE=
      any(str_sub(SDIAG_CODE,1,3)%in%paste0('B',20:24))
    ,.groups='drop'
  ) %>%
  mutate(SDIAG_CODE=ifelse(all_na,NA,SDIAG_CODE)) %>%
  select(-all_na)
```

```{r Extract tables of discharged IC-HIV diagnosis, include=FALSE}
prev_ICHIV_discharge=
  uri_cath_d$prediction %>%
  left_join(
     diag_discharge %>%
      left_join(
        los_upd
        ,by=c('HOSP','CHR_NO','FEE_NO')
      ) %>%
      select(-TYPE,-FEE_NO)
    ,by=c('HOSP','CHR_NO')
  ) %>%
  filter(CPD<pred_day) %>%
  group_by_at(colnames(uri_cath_d$prediction)) %>%
  summarize(
    all_na=
      all(is.na(CODE))
    ,CODE=
      any(str_sub(CODE,1,3)%in%paste0('B',20:24))
    ,.groups='drop'
  ) %>%
  mutate(CODE=ifelse(all_na,NA,CODE)) %>%
  select(-all_na)
```

```{r Create IC-HIV identifier, include=FALSE}
prev_ICHIV_identifier=
  uri_cath_d$prediction %>%
  left_join(
    prev_ICHIV_upd
    ,by=colnames(uri_cath_d$prediction)
  ) %>%
  left_join(
    prev_ICHIV_discharge
    ,by=colnames(uri_cath_d$prediction)
  ) %>%
  gather(
    CRITERIA_TYPE,CRITERIA_VALUE
    ,-HOSP,-CHR_NO,-TYPE,-FEE_NO
    ,-FEE_DATE,-FEE_TIME,-FEE_CODE,-SEQ_NO,-SEQ_NO2
    ,-START,-DC,-duration,-merged,-pred_day
  ) %>%
  group_by_at(colnames(uri_cath_d$prediction)) %>%
  summarize(
    all_na=
      all(is.na(CRITERIA_VALUE))
    ,prev_ICHIV=
      sum(CRITERIA_VALUE,na.rm=T)>0
    ,.groups='drop'
  ) %>%
  mutate(prev_ICHIV=ifelse(all_na,NA,prev_ICHIV)) %>%
  select(-all_na)
```

```{r Check IC-HIV distribution, eval=FALSE, include=FALSE}
prev_ICHIV_identifier %>%
  group_by(HOSP,prev_ICHIV) %>%
  summarize(n=n(),.groups='drop') %>%
  group_by(HOSP) %>%
  mutate(
    total=sum(n)
    ,p=round(n/total*100,2)
  ) %>%
  ungroup()
```

```{r Extract tables of IC-NEO diagnosis updates, include=FALSE}
prev_ICNEO_upd=
  uri_cath_d$prediction %>%
  left_join(
    diag_upd %>%
      select(-FEE_NO)
    ,by=c('HOSP','CHR_NO')
  ) %>%
  filter(HOSPIN<pred_day) %>%
  group_by_at(colnames(uri_cath_d$prediction)) %>%
  summarize(
    all_na=
      all(is.na(SDIAG_CODE))
    ,SDIAG_CODE=
      any(str_sub(SDIAG_CODE,1,3)%in%paste0('C',str_pad(0:97,2,'left','0')))
    ,.groups='drop'
  ) %>%
  mutate(SDIAG_CODE=ifelse(all_na,NA,SDIAG_CODE)) %>%
  select(-all_na)
```

```{r Extract tables of discharged IC-NEO diagnosis, include=FALSE}
prev_ICNEO_discharge=
  uri_cath_d$prediction %>%
  left_join(
     diag_discharge %>%
      left_join(
        los_upd
        ,by=c('HOSP','CHR_NO','FEE_NO')
      ) %>%
      select(-TYPE,-FEE_NO)
    ,by=c('HOSP','CHR_NO')
  ) %>%
  filter(CPD<pred_day) %>%
  group_by_at(colnames(uri_cath_d$prediction)) %>%
  summarize(
    all_na=
      all(is.na(CODE))
    ,CODE=
      any(str_sub(CODE,1,3)%in%paste0('C',str_pad(0:97,2,'left','0')))
    ,.groups='drop'
  ) %>%
  mutate(CODE=ifelse(all_na,NA,CODE)) %>%
  select(-all_na)
```

```{r Create IC-NEO identifier, include=FALSE}
prev_ICNEO_identifier=
  uri_cath_d$prediction %>%
  left_join(
    prev_ICNEO_upd
    ,by=colnames(uri_cath_d$prediction)
  ) %>%
  left_join(
    prev_ICNEO_discharge
    ,by=colnames(uri_cath_d$prediction)
  ) %>%
  gather(
    CRITERIA_TYPE,CRITERIA_VALUE
    ,-HOSP,-CHR_NO,-TYPE,-FEE_NO
    ,-FEE_DATE,-FEE_TIME,-FEE_CODE,-SEQ_NO,-SEQ_NO2
    ,-START,-DC,-duration,-merged,-pred_day
  ) %>%
  group_by_at(colnames(uri_cath_d$prediction)) %>%
  summarize(
    all_na=
      all(is.na(CRITERIA_VALUE))
    ,prev_ICNEO=
      sum(CRITERIA_VALUE,na.rm=T)>0
    ,.groups='drop'
  ) %>%
  mutate(prev_ICNEO=ifelse(all_na,NA,prev_ICNEO)) %>%
  select(-all_na)
```

```{r Check IC-NEO distribution, eval=FALSE, include=FALSE}
prev_ICNEO_identifier %>%
  group_by(HOSP,prev_ICNEO) %>%
  summarize(n=n(),.groups='drop') %>%
  group_by(HOSP) %>%
  mutate(
    total=sum(n)
    ,p=round(n/total*100,2)
  ) %>%
  ungroup()
```

```{r Create previous IC identifier, include=FALSE}
prev_IC_identifier=
  prev_ICCS_identifier %>%
  left_join(
    prev_ICHIV_identifier
    ,by=colnames(uri_cath_d$prediction)
  ) %>%
  left_join(
    prev_ICNEO_identifier
    ,by=colnames(uri_cath_d$prediction)
  ) %>%
  mutate(prev_IC=(prev_ICCS+prev_ICHIV+prev_ICNEO)>0) %>%
  select(-prev_ICCS,-prev_ICHIV,-prev_ICNEO)
```

```{r Check previous IC distribution, eval=FALSE, include=FALSE}
prev_IC_identifier %>%
  group_by(HOSP,prev_IC) %>%
  summarize(n=n(),.groups='drop') %>%
  group_by(HOSP) %>%
  mutate(
    total=sum(n)
    ,p=round(n/total*100,2)
  ) %>%
  ungroup()
```

```{r Create creatinine >2 identifier, include=FALSE}
creatinine_gt2_identifier=
  creatinine_identifier %>%
  mutate(CREATININE=CREATININE>2) %>%
  rename(CREATININE_GT2=CREATININE) %>%
  select(-EGFR)
```

```{r Check creatinine >2 distribution, eval=FALSE, include=FALSE}
creatinine_gt2_identifier %>%
  group_by(HOSP,CREATININE_GT2) %>%
  summarize(n=n(),.groups='drop') %>%
  group_by(HOSP) %>%
  mutate(
    total=sum(n)
    ,p=round(n/total*100,2)
  ) %>%
  ungroup()
```

```{r Identify MED_CODE for SGLT-2 drugs, eval=FALSE, include=FALSE}
raw_data1b %>%
  .[str_detect(names(.),'^v_med_basic')] %>%
  lapply(\(x)
    x %>%
      select_at(
        colnames(.) %>%
          .[str_detect(.,'^MED_|DESC')]
      )
  ) %>%
  lapply(
    X=names(.)
    ,Y=.
    ,\(X,Y)
    Y[[X]] %>%
      mutate(
        HOSP=
          str_sub(X,str_count(X),str_count(X))
      )
  ) %>%
  do.call(rbind,.) %>%
  mutate(
    SGLT2=
      ALISE_DESC %>%
      str_to_lower() %>%
      str_replace_all('/',' ') %>%
      str_remove_all('[:digit:]|[:punct:]|庫|針頭')
  ) %>%
  select(HOSP,MED_CODE,MED_TYPE,SGLT2,everything()) %>%
  lapply(X=1,Y=.,\(X,Y){
    Z=Y %>%
      filter(
        str_detect(
          str_to_lower(MED_CODE)
          ,filter(.,str_detect(str_to_lower(MED_TYPE),'^090808')) %>%
            pull(MED_CODE) %>%
            str_to_lower() %>%
            unique() %>%
            paste0(collapse='|')
        )
      )
    
    print(
      Z %>%
        filter(SGLT2%in%c(''))
    )
    
    print(
      Z %>%
        group_by(HOSP,MED_TYPE,SGLT2,MED_CODE) %>%
        summarize(n=n(),.groups='drop') %>%
        group_by(HOSP,MED_TYPE,SGLT2) %>%
        summarize(
          MED_CODES=paste0(MED_CODE,collapse='|')
          ,n=sum(n)
          ,.groups='drop'
        ) %>%
        spread(HOSP,n,fill=0) %>%
        arrange(MED_TYPE,MED_CODES,w,t,s)
    )
    
    Y
  }) %>%
  .[[1]] %>%
  filter(str_detect(str_to_lower(MED_TYPE),'^090808')) %>%
  group_by(HOSP,MED_TYPE,SGLT2,MED_CODE) %>%
  summarize(n=n(),.groups='drop') %>%
  group_by(HOSP,MED_TYPE,SGLT2) %>%
  summarize(
    MED_CODES=paste0(MED_CODE,collapse='|')
    ,n=sum(n)
    ,.groups='drop'
  ) %>%
  spread(HOSP,n,fill=0) %>%
  arrange(MED_TYPE,MED_CODES,s)
```

```{r Extract tables of SGLT-2 medication orders, include=FALSE}
prev_SGLT2_med=
  uri_cath_d$prediction %>%
  left_join(
    med_order %>%
      select(-UD_SEQ,-UD_SEQ_OLD,-MED_CODE)
    ,by=c('HOSP','FEE_NO')
  ) %>%
  filter(BEGIN<pred_day) %>%
  group_by_at(colnames(uri_cath_d$prediction)) %>%
  summarize(
    all_na=
      all(is.na(MED_TYPE))
    ,MED_TYPE=
      any(str_detect(str_to_lower(MED_TYPE),'^090808'))
    ,.groups='drop'
  ) %>%
  mutate(MED_TYPE=ifelse(all_na,NA,MED_TYPE)) %>%
  select(-all_na)
```

```{r Create SGLT-2 identifier, include=FALSE}
prev_SGLT2_identifier=
  uri_cath_d$prediction %>%
  left_join(
    prev_SGLT2_med
    ,by=colnames(uri_cath_d$prediction)
  ) %>%
  group_by_at(colnames(uri_cath_d$prediction)) %>%
  summarize(
    all_na=
      all(is.na(MED_TYPE))
    ,prev_SGLT2=
      sum(MED_TYPE,na.rm=T)>0
    ,.groups='drop'
  ) %>%
  mutate(prev_SGLT2=ifelse(all_na,NA,prev_SGLT2)) %>%
  select(-all_na)
```

```{r Check SGLT-2 distribution, eval=FALSE, include=FALSE}
prev_SGLT2_identifier %>%
  group_by(HOSP,prev_SGLT2) %>%
  summarize(n=n(),.groups='drop') %>%
  group_by(HOSP) %>%
  mutate(
    total=sum(n)
    ,p=round(n/total*100,2)
  ) %>%
  ungroup()
```

```{r Determine FEE_CODE for double-J, include=FALSE}
doublej=
  raw_data %>%
  .[str_detect(names(.),'^v_fee_basic')] %>%
  lapply(select,FEE_CODE,FEE_DESC) %>%
  lapply(
    X=names(.)
    ,Y=.
    ,\(X,Y)
    Y[[X]] %>%
      mutate(
        HOSP=
          str_sub(X,str_count(X),str_count(X))
      )
  ) %>%
  do.call(rbind,.) %>%
  filter(
    str_detect(
      str_to_lower(FEE_CODE)
      ,filter(
          .
          ,str_detect(
            str_to_lower(FEE_DESC)
            ,'雙丁輸尿管導管置入術|經膀胱鏡逆行尿管導管'
          )
        ) %>%
        pull(FEE_CODE) %>%
        str_sub(1,str_count(.)-1) %>%
        str_to_lower() %>%
        unique() %>%
        paste0(collapse='|')
    )
  ) %>%
  mutate(exist='yes') %>%
  spread(HOSP,exist,fill='no') %>%
  arrange(FEE_CODE,w,t,s) %>%
  filter(str_detect(str_to_lower(FEE_CODE),'f50019c|f50010c'))

doublej %>%
  knitr::kable()
```

```{r Extract tables of double-J orders, include=FALSE}
doublej_order=
  raw_data1b %>%
  .[str_detect(names(.),'^v_ipd_fee')] %>%
  lapply(filter,FEE_CODE%in%doublej$FEE_CODE) %>%
  lapply(\(x)
    x %>%
      select_at(
        colnames(.) %>%
          .[str_detect(
            .
            ,paste0(
              c(
                '^CHR_NO'
                ,'^FEE_NO'
                ,'^FEE_DATE'
                ,'^FEE_TIME'
                ,'^FEE_CODE'
                ,'^SEQ_NO'
                ,'^START'
                ,'^DC'
              )
              ,collapse='|'
            )
          )]
      )
  ) %>%
  lapply(
    X=names(.)
    ,Y=.
    ,\(X,Y)
    Y[[X]] %>%
      mutate(
        HOSP=
          str_sub(X,str_count(X),str_count(X))
        ,TYPE=
          str_sub(X,3,5)
      )
  ) %>%
  do.call(rbind,.) %>%
  select_at(c(
    intersect(colnames(uri_cath_d$prediction),colnames(.))
    ,setdiff(colnames(.),colnames(uri_cath_d$prediction))
  )) %>%
  mutate(
    START_TIME=
      ifelse(
        !is.na(START_DATE) & is.na(START_TIME)
        ,'0000'
        ,START_TIME
      )
    ,DC_TIME=
      ifelse(
        !is.na(DC_DATE) & is.na(DC_TIME)
        ,'0000'
        ,DC_TIME
      )
  ) %>%
  mutate_at(
    c('START_DATE','DC_DATE')
    ,\(x)
    as.numeric(x)+(2023-112)*10000
  ) %>%
  mutate_at(
    c('START_DATE','DC_DATE')
    ,\(x)
    paste0(
      str_sub(x,1,4)
      ,'-'
      ,str_sub(x,5,6)
      ,'-'
      ,str_sub(x,7,8)
    )
  ) %>%
  mutate_at(
    c('START_TIME','DC_TIME')
    ,\(x)
    paste0(
      str_sub(x,1,2)
      ,':'
      ,str_sub(x,3,4)
    )
  ) %>%
  unite(START,START_DATE,START_TIME,sep=' ') %>%
  unite(DC,DC_DATE,DC_TIME,sep=' ') %>%
  mutate_at(
    c('START','DC')
    ,\(x)
    ifelse(
      str_count(x)==16
      & str_count(x,'-')==2
      & str_count(x,' ')==1
      & str_count(x,'\\:')==1
      ,x
      ,NA
    )
  ) %>%
  mutate_at(c('START','DC'),ymd_hm) %>%
  arrange(HOSP,CHR_NO,TYPE,FEE_NO,START,DC) %>%
  select(HOSP,CHR_NO,FEE_CODE,START,DC) %>%
  rename(
    DOUBLEJ_FEE_CODE=FEE_CODE
    ,DOUBLEJ_START=START
    ,DOUBLEJ_DC=DC
  )
```

```{r Create double-J identifier, include=FALSE}
doublej_identifier=
  uri_cath_d$prediction %>%
  left_join(
    left_join(
        .
        ,doublej_order
        ,by=c('HOSP','CHR_NO')
      ) %>%
      filter(DOUBLEJ_START<pred_day) %>%
      select(-DOUBLEJ_START,-DOUBLEJ_DC)
    ,by=colnames(uri_cath_d$prediction)
  ) %>%
  mutate(DOUBLEJ_FEE_CODE=!is.na(DOUBLEJ_FEE_CODE)) %>%
  group_by_at(colnames(uri_cath_d$prediction)) %>%
  summarize(
    doublej=
      any(DOUBLEJ_FEE_CODE)
    ,.groups='drop'
  )
```

```{r Check double-J distribution, eval=FALSE, include=FALSE}
doublej_identifier %>%
  group_by(HOSP,doublej) %>%
  summarize(n=n(),.groups='drop') %>%
  group_by(HOSP) %>%
  mutate(
    total=sum(n)
    ,p=round(n/total*100,2)
  ) %>%
  ungroup()
```

```{r Extract tables of urological diagnosis updates, include=FALSE}
prev_urodiag_upd=
  uri_cath_d$prediction %>%
  left_join(
    diag_upd %>%
      select(-FEE_NO)
    ,by=c('HOSP','CHR_NO')
  ) %>%
  filter(HOSPIN<pred_day) %>%
  group_by_at(colnames(uri_cath_d$prediction)) %>%
  summarize(
    all_na=
      all(is.na(SDIAG_CODE))
    ,SDIAG_CODE=
      any(str_sub(SDIAG_CODE,1,3)%in%c(paste0('N',c(20:23,40,13,32)),'R31'))
    ,.groups='drop'
  ) %>%
  mutate(SDIAG_CODE=ifelse(all_na,NA,SDIAG_CODE)) %>%
  select(-all_na)
```

```{r Extract tables of discharged urological diagnosis, include=FALSE}
prev_urodiag_discharge=
  uri_cath_d$prediction %>%
  left_join(
     diag_discharge %>%
      left_join(
        los_upd
        ,by=c('HOSP','CHR_NO','FEE_NO')
      ) %>%
      select(-TYPE,-FEE_NO)
    ,by=c('HOSP','CHR_NO')
  ) %>%
  filter(CPD<pred_day) %>%
  group_by_at(colnames(uri_cath_d$prediction)) %>%
  summarize(
    all_na=
      all(is.na(CODE))
    ,CODE=
      any(str_sub(CODE,1,3)%in%c(paste0('N',c(20:23,40,13,32)),'R31'))
    ,.groups='drop'
  ) %>%
  mutate(CODE=ifelse(all_na,NA,CODE)) %>%
  select(-all_na)
```

```{r Create urological diagnosis identifier, include=FALSE}
prev_urodiag_identifier=
  uri_cath_d$prediction %>%
  left_join(
    prev_urodiag_upd
    ,by=colnames(uri_cath_d$prediction)
  ) %>%
  left_join(
    prev_urodiag_discharge
    ,by=colnames(uri_cath_d$prediction)
  ) %>%
  gather(
    CRITERIA_TYPE,CRITERIA_VALUE
    ,-HOSP,-CHR_NO,-TYPE,-FEE_NO
    ,-FEE_DATE,-FEE_TIME,-FEE_CODE,-SEQ_NO,-SEQ_NO2
    ,-START,-DC,-duration,-merged,-pred_day
  ) %>%
  group_by_at(colnames(uri_cath_d$prediction)) %>%
  summarize(
    all_na=
      all(is.na(CRITERIA_VALUE))
    ,prev_urodiag=
      sum(CRITERIA_VALUE,na.rm=T)>0
    ,.groups='drop'
  ) %>%
  mutate(prev_urodiag=ifelse(all_na,NA,prev_urodiag)) %>%
  select(-all_na)
```

```{r Check urological diagnosis distribution, eval=FALSE, include=FALSE}
prev_urodiag_identifier %>%
  group_by(HOSP,prev_urodiag) %>%
  summarize(n=n(),.groups='drop') %>%
  group_by(HOSP) %>%
  mutate(
    total=sum(n)
    ,p=round(n/total*100,2)
  ) %>%
  ungroup()
```

```{r Determine FEE_CODE for urodynamic exam, include=FALSE}
urodyn=
  raw_data %>%
  .[str_detect(names(.),'^v_fee_basic')] %>%
  lapply(select,FEE_CODE,FEE_DESC) %>%
  lapply(
    X=names(.)
    ,Y=.
    ,\(X,Y)
    Y[[X]] %>%
      mutate(
        HOSP=
          str_sub(X,str_count(X),str_count(X))
      )
  ) %>%
  do.call(rbind,.) %>%
  filter(
    str_detect(
      str_to_lower(FEE_CODE)
      ,filter(
          .
          ,str_detect(
            str_to_lower(FEE_DESC)
            ,paste0(
              c('壓力尿流速圖'
                ,'外括約肌肌電圖'
                ,'尿道壓力測量'
                ,'尿流量圖'
                ,'膀胱超音波尿量測量'
                ,'應力尿道壓力測試'
                ,'錄影尿動力學')
              ,collapse='|'
            )
          )
        ) %>%
        pull(FEE_CODE) %>%
        str_sub(1,str_count(.)-1) %>%
        str_to_lower() %>%
        unique() %>%
        paste0(collapse='|')
    )
  ) %>%
  mutate(exist='yes') %>%
  spread(HOSP,exist,fill='no') %>%
  arrange(FEE_CODE,w,t,s) %>%
  filter(
    str_detect(
      str_to_lower(FEE_CODE)
      ,'21010c|21011c|21012c|21003c|21004c|21005c|21006a|21006b'
    )
  )

urodyn %>%
  knitr::kable()
```

```{r Extract tables of urodynamic exam orders, include=FALSE}
urodyn_order=
  raw_data1b %>%
  .[str_detect(names(.),'^v_ipd_fee')] %>%
  lapply(filter,FEE_CODE%in%urodyn$FEE_CODE) %>%
  lapply(\(x)
    x %>%
      select_at(
        colnames(.) %>%
          .[str_detect(
            .
            ,paste0(
              c(
                '^CHR_NO'
                ,'^FEE_NO'
                ,'^FEE_DATE'
                ,'^FEE_TIME'
                ,'^FEE_CODE'
                ,'^SEQ_NO'
                ,'^START'
                ,'^DC'
              )
              ,collapse='|'
            )
          )]
      )
  ) %>%
  lapply(
    X=names(.)
    ,Y=.
    ,\(X,Y)
    Y[[X]] %>%
      mutate(
        HOSP=
          str_sub(X,str_count(X),str_count(X))
        ,TYPE=
          str_sub(X,3,5)
      )
  ) %>%
  do.call(rbind,.) %>%
  select_at(c(
    intersect(colnames(uri_cath_d$prediction),colnames(.))
    ,setdiff(colnames(.),colnames(uri_cath_d$prediction))
  )) %>%
  mutate(
    START_TIME=
      ifelse(
        !is.na(START_DATE) & is.na(START_TIME)
        ,'0000'
        ,START_TIME
      )
    ,DC_TIME=
      ifelse(
        !is.na(DC_DATE) & is.na(DC_TIME)
        ,'0000'
        ,DC_TIME
      )
  ) %>%
  mutate_at(
    c('START_DATE','DC_DATE')
    ,\(x)
    as.numeric(x)+(2023-112)*10000
  ) %>%
  mutate_at(
    c('START_DATE','DC_DATE')
    ,\(x)
    paste0(
      str_sub(x,1,4)
      ,'-'
      ,str_sub(x,5,6)
      ,'-'
      ,str_sub(x,7,8)
    )
  ) %>%
  mutate_at(
    c('START_TIME','DC_TIME')
    ,\(x)
    paste0(
      str_sub(x,1,2)
      ,':'
      ,str_sub(x,3,4)
    )
  ) %>%
  unite(START,START_DATE,START_TIME,sep=' ') %>%
  unite(DC,DC_DATE,DC_TIME,sep=' ') %>%
  mutate_at(
    c('START','DC')
    ,\(x)
    ifelse(
      str_count(x)==16
      & str_count(x,'-')==2
      & str_count(x,' ')==1
      & str_count(x,'\\:')==1
      ,x
      ,NA
    )
  ) %>%
  mutate_at(c('START','DC'),ymd_hm) %>%
  arrange(HOSP,CHR_NO,TYPE,FEE_NO,START,DC) %>%
  select(HOSP,CHR_NO,FEE_CODE,START,DC) %>%
  rename(
    URODYN_FEE_CODE=FEE_CODE
    ,URODYN_START=START
    ,URODYN_DC=DC
  )
```

```{r Create urodynamic exam identifier, include=FALSE}
urodyn_identifier=
  uri_cath_d$prediction %>%
  left_join(
    left_join(
        .
        ,urodyn_order
        ,by=c('HOSP','CHR_NO')
      ) %>%
      filter(URODYN_START<pred_day) %>%
      select(-URODYN_START,-URODYN_DC)
    ,by=colnames(uri_cath_d$prediction)
  ) %>%
  mutate(URODYN_FEE_CODE=!is.na(URODYN_FEE_CODE)) %>%
  group_by_at(colnames(uri_cath_d$prediction)) %>%
  summarize(
    urodyn=
      any(URODYN_FEE_CODE)
    ,.groups='drop'
  )
```

```{r Check urodynamic exam distribution, eval=FALSE, include=FALSE}
urodyn_identifier %>%
  group_by(HOSP,urodyn) %>%
  summarize(n=n(),.groups='drop') %>%
  group_by(HOSP) %>%
  mutate(
    total=sum(n)
    ,p=round(n/total*100,2)
  ) %>%
  ungroup()
```

```{r Create urological issue identifier, include=FALSE}
prev_uro_identifier=
  doublej_identifier %>%
  left_join(
    prev_urodiag_identifier
    ,by=colnames(uri_cath_d$prediction)
  ) %>%
  left_join(
    urodyn_identifier
    ,by=colnames(uri_cath_d$prediction)
  ) %>%
  mutate(prev_uro=(doublej+prev_urodiag+urodyn)>0) %>%
  select(-doublej,-prev_urodiag,-urodyn)
```

```{r Check urological issue distribution, eval=FALSE, include=FALSE}
prev_uro_identifier %>%
  group_by(HOSP,prev_uro) %>%
  summarize(n=n(),.groups='drop') %>%
  group_by(HOSP) %>%
  mutate(
    total=sum(n)
    ,p=round(n/total*100,2)
  ) %>%
  ungroup()
```

```{r Extract tables of previous 6-mo UTI diagnosis updates, include=FALSE}
prev_utidiag6m_upd=
  uri_cath_d$prediction %>%
  left_join(
    diag_upd %>%
      rename(prev_FEE_NO=FEE_NO)
    ,by=c('HOSP','CHR_NO')
  ) %>%
  filter(HOSPIN>=(pred_day-months(6)) & HOSPIN<pred_day) %>%
  group_by_at(colnames(uri_cath_d$prediction)) %>%
  summarize(
    all_na=
      all(is.na(SDIAG_CODE))
    ,SDIAG_CODE=
      setdiff(
        ifelse(str_sub(SDIAG_CODE,1,3)%in%c('N39','599'),prev_FEE_NO,NA)
        ,FEE_NO
      ) %>%
      unique() %>%
      .[!is.na(.)] %>%
      paste0(collapse='|')
    ,.groups='drop'
  ) %>%
  mutate(SDIAG_CODE=ifelse(all_na,NA,SDIAG_CODE)) %>%
  select(-all_na)
```

```{r Extract tables of discharged previous 6-mo UTI diagnosis, include=FALSE}
prev_utidiag6m_discharge=
  uri_cath_d$prediction %>%
  left_join(
    diag_discharge %>%
      left_join(
        los_upd
        ,by=c('HOSP','CHR_NO','FEE_NO')
      ) %>%
      select(-TYPE) %>%
      rename(prev_FEE_NO=FEE_NO)
    ,by=c('HOSP','CHR_NO')
  ) %>%
  filter(CPD>=(pred_day-months(6)) & CPD<pred_day) %>%
  group_by_at(colnames(uri_cath_d$prediction)) %>%
  summarize(
    all_na=
      all(is.na(CODE))
    ,CODE=
      setdiff(
        ifelse(str_sub(CODE,1,3)%in%c('N39','599'),prev_FEE_NO,NA)
        ,FEE_NO
      ) %>%
      unique() %>%
      .[!is.na(.)] %>%
      paste0(collapse='|')
    ,.groups='drop'
  ) %>%
  mutate(CODE=ifelse(all_na,NA,CODE)) %>%
  select(-all_na)
```

```{r Create previous 6-mo UTI identifier, include=FALSE}
prev_utidiag6m_identifier=
  uri_cath_d$prediction %>%
  left_join(
    prev_utidiag6m_upd
    ,by=colnames(uri_cath_d$prediction)
  ) %>%
  left_join(
    prev_utidiag6m_discharge
    ,by=colnames(uri_cath_d$prediction)
  ) %>%
  gather(
    CRITERIA_TYPE,CRITERIA_VALUE
    ,-HOSP,-CHR_NO,-TYPE,-FEE_NO
    ,-FEE_DATE,-FEE_TIME,-FEE_CODE,-SEQ_NO,-SEQ_NO2
    ,-START,-DC,-duration,-merged,-pred_day
  ) %>%
  group_by_at(colnames(uri_cath_d$prediction)) %>%
  summarize(
    all_na=
      all(is.na(CRITERIA_VALUE))
    ,prev_utidiag6m=
      CRITERIA_VALUE %>%
      paste0(collapse='|') %>%
      str_split('\\|') %>%
      .[[1]] %>%
      unique() %>%
      .[!is.na(.) & .!=''] %>%
      length()
    ,.groups='drop'
  ) %>%
  mutate(prev_utidiag6m=ifelse(all_na,NA,prev_utidiag6m)) %>%
  select(-all_na)
```

```{r Check prev. 6-mo UTI missingness and outliers, eval=FALSE, include=FALSE}
prev_utidiag6m_identifier %>%
  group_by(HOSP) %>%
  mutate(
    min=min(prev_utidiag6m,na.rm=T)
    ,q1=quantile(prev_utidiag6m,0.25,na.rm=T)
    ,q2=quantile(prev_utidiag6m,0.5,na.rm=T)
    ,q3=quantile(prev_utidiag6m,0.75,na.rm=T)
    ,max=max(prev_utidiag6m,na.rm=T)
    ,n=n()
    ,missing=sum(is.na(prev_utidiag6m))
  ) %>%
  ungroup() %>%
  mutate(
    outlier=
      prev_utidiag6m<(q1-1.5*(q3-q1))
      | prev_utidiag6m>(q3+1.5*(q3-q1))
  ) %>%
  group_by(HOSP,min,q1,q2,q3,max,n,missing) %>%
  summarize(outliers=sum(outlier,na.rm=T),.groups='drop')
```

```{r Create prev. 6-m UTI >2 identifier, include=FALSE}
prev_utidiag_6mgt2_identifier=
  prev_utidiag6m_identifier %>%
  mutate(prev_utidiag_6mgt2=prev_utidiag6m>2) %>%
  select(-prev_utidiag6m)
```

```{r Check prev. 6-m UTI >2 distribution, eval=FALSE, include=FALSE}
prev_utidiag_6mgt2_identifier %>%
  group_by(HOSP,prev_utidiag_6mgt2) %>%
  summarize(n=n(),.groups='drop') %>%
  group_by(HOSP) %>%
  mutate(
    total=sum(n)
    ,p=round(n/total*100,2)
  ) %>%
  ungroup()
```

```{r Extract tables of previous 1-y UTI diagnosis updates, include=FALSE}
prev_utidiag1y_upd=
  uri_cath_d$prediction %>%
  left_join(
    diag_upd %>%
      rename(prev_FEE_NO=FEE_NO)
    ,by=c('HOSP','CHR_NO')
  ) %>%
  filter(HOSPIN>=(pred_day-years(1)) & HOSPIN<pred_day) %>%
  group_by_at(colnames(uri_cath_d$prediction)) %>%
  summarize(
    all_na=
      all(is.na(SDIAG_CODE))
    ,SDIAG_CODE=
      setdiff(
        ifelse(str_sub(SDIAG_CODE,1,3)%in%c('N39','599'),prev_FEE_NO,NA)
        ,FEE_NO
      ) %>%
      unique() %>%
      .[!is.na(.)] %>%
      paste0(collapse='|')
    ,.groups='drop'
  ) %>%
  mutate(SDIAG_CODE=ifelse(all_na,NA,SDIAG_CODE)) %>%
  select(-all_na)
```

```{r Extract tables of discharged previous 1-y UTI diagnosis, include=FALSE}
prev_utidiag1y_discharge=
  uri_cath_d$prediction %>%
  left_join(
    diag_discharge %>%
      left_join(
        los_upd
        ,by=c('HOSP','CHR_NO','FEE_NO')
      ) %>%
      select(-TYPE) %>%
      rename(prev_FEE_NO=FEE_NO)
    ,by=c('HOSP','CHR_NO')
  ) %>%
  filter(CPD>=(pred_day-years(1)) & CPD<pred_day) %>%
  group_by_at(colnames(uri_cath_d$prediction)) %>%
  summarize(
    all_na=
      all(is.na(CODE))
    ,CODE=
      setdiff(
        ifelse(str_sub(CODE,1,3)%in%c('N39','599'),prev_FEE_NO,NA)
        ,FEE_NO
      ) %>%
      unique() %>%
      .[!is.na(.)] %>%
      paste0(collapse='|')
    ,.groups='drop'
  ) %>%
  mutate(CODE=ifelse(all_na,NA,CODE)) %>%
  select(-all_na)
```

```{r Create previous 1-y UTI identifier, include=FALSE}
prev_utidiag1y_identifier=
  uri_cath_d$prediction %>%
  left_join(
    prev_utidiag1y_upd
    ,by=colnames(uri_cath_d$prediction)
  ) %>%
  left_join(
    prev_utidiag1y_discharge
    ,by=colnames(uri_cath_d$prediction)
  ) %>%
  gather(
    CRITERIA_TYPE,CRITERIA_VALUE
    ,-HOSP,-CHR_NO,-TYPE,-FEE_NO
    ,-FEE_DATE,-FEE_TIME,-FEE_CODE,-SEQ_NO,-SEQ_NO2
    ,-START,-DC,-duration,-merged,-pred_day
  ) %>%
  group_by_at(colnames(uri_cath_d$prediction)) %>%
  summarize(
    all_na=
      all(is.na(CRITERIA_VALUE))
    ,prev_utidiag1y=
      CRITERIA_VALUE %>%
      paste0(collapse='|') %>%
      str_split('\\|') %>%
      .[[1]] %>%
      unique() %>%
      .[!is.na(.) & .!=''] %>%
      length()
    ,.groups='drop'
  ) %>%
  mutate(prev_utidiag1y=ifelse(all_na,NA,prev_utidiag1y)) %>%
  select(-all_na)
```

```{r Check prev. 1-y UTI missingness and outliers, eval=FALSE, include=FALSE}
prev_utidiag1y_identifier %>%
  group_by(HOSP) %>%
  mutate(
    min=min(prev_utidiag1y,na.rm=T)
    ,q1=quantile(prev_utidiag1y,0.25,na.rm=T)
    ,q2=quantile(prev_utidiag1y,0.5,na.rm=T)
    ,q3=quantile(prev_utidiag1y,0.75,na.rm=T)
    ,max=max(prev_utidiag1y,na.rm=T)
    ,n=n()
    ,missing=sum(is.na(prev_utidiag1y))
  ) %>%
  ungroup() %>%
  mutate(
    outlier=
      prev_utidiag1y<(q1-1.5*(q3-q1))
      | prev_utidiag1y>(q3+1.5*(q3-q1))
  ) %>%
  group_by(HOSP,min,q1,q2,q3,max,n,missing) %>%
  summarize(outliers=sum(outlier,na.rm=T),.groups='drop')
```

```{r Create prev. 1-y UTI >3 identifier, include=FALSE}
prev_utidiag_1ygt3_identifier=
  prev_utidiag1y_identifier %>%
  mutate(prev_utidiag_1ygt3=prev_utidiag1y>3) %>%
  select(-prev_utidiag1y)
```

```{r Check prev. 1-y UTI >3 distribution, eval=FALSE, include=FALSE}
prev_utidiag_1ygt3_identifier %>%
  group_by(HOSP,prev_utidiag_1ygt3) %>%
  summarize(n=n(),.groups='drop') %>%
  group_by(HOSP) %>%
  mutate(
    total=sum(n)
    ,p=round(n/total*100,2)
  ) %>%
  ungroup()
```

```{r Create prev. 6-m/1-y UTI identifier, include=FALSE}
prev_utidiag_6mgt2_1ygt3_identifier=
  prev_utidiag_6mgt2_identifier %>%
  left_join(
    prev_utidiag_1ygt3_identifier
    ,by=colnames(uri_cath_d$prediction)
  ) %>%
  mutate(prev_utidiag_6mgt2_1ygt3=(prev_utidiag_6mgt2+prev_utidiag_1ygt3)>0) %>%
  select(-prev_utidiag_6mgt2,-prev_utidiag_1ygt3)
```

```{r Check prev. 6-m/1-y UTI distribution, eval=FALSE, include=FALSE}
prev_utidiag_6mgt2_1ygt3_identifier %>%
  group_by(HOSP,prev_utidiag_6mgt2_1ygt3) %>%
  summarize(n=n(),.groups='drop') %>%
  group_by(HOSP) %>%
  mutate(
    total=sum(n)
    ,p=round(n/total*100,2)
  ) %>%
  ungroup()
```

```{r Extract tables of neurological diagnosis updates, include=FALSE}
prev_neurodiag_upd=
  uri_cath_d$prediction %>%
  left_join(
    diag_upd %>%
      select(-FEE_NO)
    ,by=c('HOSP','CHR_NO')
  ) %>%
  filter(HOSPIN<pred_day) %>%
  group_by_at(colnames(uri_cath_d$prediction)) %>%
  summarize(
    all_na=
      all(is.na(SDIAG_CODE))
    ,SDIAG_CODE=
      any(
        str_sub(SDIAG_CODE,1,3)
        %in%c('N31','G95','G83','I67','I69','I61','G35')
      )
    ,.groups='drop'
  ) %>%
  mutate(SDIAG_CODE=ifelse(all_na,NA,SDIAG_CODE)) %>%
  select(-all_na)
```

```{r Extract tables of discharged neurological diagnosis, include=FALSE}
prev_neurodiag_discharge=
  uri_cath_d$prediction %>%
  left_join(
     diag_discharge %>%
      left_join(
        los_upd
        ,by=c('HOSP','CHR_NO','FEE_NO')
      ) %>%
      select(-TYPE,-FEE_NO)
    ,by=c('HOSP','CHR_NO')
  ) %>%
  filter(CPD<pred_day) %>%
  group_by_at(colnames(uri_cath_d$prediction)) %>%
  summarize(
    all_na=
      all(is.na(CODE))
    ,CODE=
      any(
        str_sub(CODE,1,3)
        %in%c('N31','G95','G83','I67','I69','I61','G35')
      )
    ,.groups='drop'
  ) %>%
  mutate(CODE=ifelse(all_na,NA,CODE)) %>%
  select(-all_na)
```

```{r Create neurological issue identifier, include=FALSE}
prev_neuro_identifier=
  uri_cath_d$prediction %>%
  left_join(
    prev_neurodiag_upd
    ,by=colnames(uri_cath_d$prediction)
  ) %>%
  left_join(
    prev_neurodiag_discharge
    ,by=colnames(uri_cath_d$prediction)
  ) %>%
  gather(
    CRITERIA_TYPE,CRITERIA_VALUE
    ,-HOSP,-CHR_NO,-TYPE,-FEE_NO
    ,-FEE_DATE,-FEE_TIME,-FEE_CODE,-SEQ_NO,-SEQ_NO2
    ,-START,-DC,-duration,-merged,-pred_day
  ) %>%
  group_by_at(colnames(uri_cath_d$prediction)) %>%
  summarize(
    all_na=
      all(is.na(CRITERIA_VALUE))
    ,prev_neuro=
      sum(CRITERIA_VALUE,na.rm=T)>0
    ,.groups='drop'
  ) %>%
  mutate(prev_neuro=ifelse(all_na,NA,prev_neuro)) %>%
  select(-all_na)
```

```{r Check neurological issue distribution, eval=FALSE, include=FALSE}
prev_neuro_identifier %>%
  group_by(HOSP,prev_neuro) %>%
  summarize(n=n(),.groups='drop') %>%
  group_by(HOSP) %>%
  mutate(
    total=sum(n)
    ,p=round(n/total*100,2)
  ) %>%
  ungroup()
```

```{r Identify MED_CODE for sys. antibiotic drugs, eval=FALSE, include=FALSE}
raw_data1b %>%
  .[str_detect(names(.),'^v_med_basic')] %>%
  lapply(\(x)
    x %>%
      select_at(
        colnames(.) %>%
          .[str_detect(.,'^MED_|DESC')]
      )
  ) %>%
  lapply(
    X=names(.)
    ,Y=.
    ,\(X,Y)
    Y[[X]] %>%
      mutate(
        HOSP=
          str_sub(X,str_count(X),str_count(X))
      )
  ) %>%
  do.call(rbind,.) %>%
  mutate(
    AB=
      ALISE_DESC %>%
      str_to_lower() %>%
      str_replace_all('/',' ') %>%
      str_remove_all('[:digit:]|[:punct:]|庫|針頭')
  ) %>%
  select(HOSP,MED_CODE,MED_TYPE,AB,everything()) %>%
  lapply(X=1,Y=.,\(X,Y){
    Z=Y %>%
      filter(
        str_detect(
          str_to_lower(MED_CODE)
          ,filter(.,str_detect(str_to_lower(MED_TYPE),'^1001')) %>%
            pull(MED_CODE) %>%
            str_to_lower() %>%
            unique() %>%
            paste0(collapse='|')
        )
      )
    
    print(
      Z %>%
        filter(AB%in%c(''))
    )
    
    print(
      Z %>%
        group_by(HOSP,MED_TYPE,AB,MED_CODE) %>%
        summarize(n=n(),.groups='drop') %>%
        group_by(HOSP,MED_TYPE,AB) %>%
        summarize(
          MED_CODES=paste0(MED_CODE,collapse='|')
          ,n=sum(n)
          ,.groups='drop'
        ) %>%
        spread(HOSP,n,fill=0) %>%
        arrange(MED_TYPE,MED_CODES,w,t,s)
    )
    
    Y
  }) %>%
  .[[1]] %>%
  filter(
    str_detect(str_to_lower(MED_TYPE),'^1001')
    & str_to_lower(UNIT_DESC)%in%c('amp','cap','ml','tab','vial')
  ) %>%
  group_by(HOSP,MED_TYPE,AB,MED_CODE) %>%
  summarize(n=n(),.groups='drop') %>%
  group_by(HOSP,MED_TYPE,AB) %>%
  summarize(
    MED_CODES=paste0(MED_CODE,collapse='|')
    ,n=sum(n)
    ,.groups='drop'
  ) %>%
  spread(HOSP,n,fill=0) %>%
  arrange(MED_TYPE,MED_CODES,s)
```

```{r Extract tables of sys. antibiotic medication orders, include=FALSE}
prev_AB_med=
  uri_cath_d$prediction %>%
  left_join(
    med_order %>%
      select(-UD_SEQ,-UD_SEQ_OLD,-MED_CODE)
    ,by=c('HOSP','FEE_NO')
  ) %>%
  filter(BEGIN>=START-days(7) & BEGIN<pred_day) %>%
  group_by_at(colnames(uri_cath_d$prediction)) %>%
  summarize(
    all_na=
      all(is.na(MED_TYPE))
    ,MED_TYPE=
      any(
        str_detect(str_to_lower(MED_TYPE),'^1001')
        & str_to_lower(UNIT_DESC)%in%c('amp','cap','ml','tab','vial')
      )
    ,.groups='drop'
  ) %>%
  mutate(MED_TYPE=ifelse(all_na,NA,MED_TYPE)) %>%
  select(-all_na)
```

```{r Create sys. antibiotic identifier, include=FALSE}
prev_AB_identifier=
  uri_cath_d$prediction %>%
  left_join(
    prev_AB_med
    ,by=colnames(uri_cath_d$prediction)
  ) %>%
  group_by_at(colnames(uri_cath_d$prediction)) %>%
  summarize(
    all_na=
      all(is.na(MED_TYPE))
    ,prev_AB=
      sum(MED_TYPE,na.rm=T)>0
    ,.groups='drop'
  ) %>%
  mutate(prev_AB=ifelse(all_na,NA,prev_AB)) %>%
  select(-all_na)
```

```{r Check sys. antibiotic distribution, eval=FALSE, include=FALSE}
prev_AB_identifier %>%
  group_by(HOSP,prev_AB) %>%
  summarize(n=n(),.groups='drop') %>%
  group_by(HOSP) %>%
  mutate(
    total=sum(n)
    ,p=round(n/total*100,2)
  ) %>%
  ungroup()
```

```{r Join all identifiers, include=FALSE}
identifiers=
  uri_cath_d$prediction %>%
  
  left_join(outcome_identifier,by=colnames(uri_cath_d$prediction)) %>%
  
  left_join(age_group_identifier,by=colnames(uri_cath_d$prediction)) %>%
  left_join(age_identifier,by=colnames(uri_cath_d$prediction)) %>%
  
  left_join(icu_10d_identifier,by=colnames(uri_cath_d$prediction)) %>%
  left_join(icu_identifier,by=colnames(uri_cath_d$prediction)) %>%
  
  left_join(cath_d_6d_identifier,by=colnames(uri_cath_d$prediction)) %>%
  left_join(cath_d_identifier,by=colnames(uri_cath_d$prediction)) %>%
  
  left_join(los_4d_identifier,by=colnames(uri_cath_d$prediction)) %>%
  left_join(los_identifier,by=colnames(uri_cath_d$prediction)) %>%
  
  left_join(prev_cath_identifier,by=colnames(uri_cath_d$prediction)) %>%
  
  left_join(sex_identifier,by=colnames(uri_cath_d$prediction)) %>%
  
  left_join(prev_DM_identifier,by=colnames(uri_cath_d$prediction)) %>%
  left_join(prev_DMdiag_identifier,by=colnames(uri_cath_d$prediction)) %>%
  left_join(prev_DMmed_identifier,by=colnames(uri_cath_d$prediction)) %>%
  
  left_join(immob_identifier,by=colnames(uri_cath_d$prediction)) %>%
  
  left_join(indication_identifier,by=colnames(uri_cath_d$prediction)) %>%
  
  left_join(prev_DMrel_identifier,by=colnames(uri_cath_d$prediction)) %>%
  left_join(prev_HYP_identifier,by=colnames(uri_cath_d$prediction)) %>%
  left_join(prev_DMinsulin_identifier,by=colnames(uri_cath_d$prediction)) %>%
  left_join(bmi_gt30_identifier,by=colnames(uri_cath_d$prediction)) %>%
  left_join(bmi_identifier,by=colnames(uri_cath_d$prediction)) %>%
  left_join(prev_DMneph_identifier,by=colnames(uri_cath_d$prediction)) %>%
  
  left_join(poor_nutr_identifier,by=colnames(uri_cath_d$prediction)) %>%
  left_join(albumin_lt3.5_identifier,by=colnames(uri_cath_d$prediction)) %>%
  left_join(albumin_identifier,by=colnames(uri_cath_d$prediction)) %>%
  left_join(creatinine_lt0.5_identifier,by=colnames(uri_cath_d$prediction)) %>%
  left_join(creatinine_identifier,by=colnames(uri_cath_d$prediction)) %>%
  
  left_join(prev_FI_identifier,by=colnames(uri_cath_d$prediction)) %>%
  left_join(prev_FIAD_identifier,by=colnames(uri_cath_d$prediction)) %>%
  left_join(prev_FILX_identifier,by=colnames(uri_cath_d$prediction)) %>%
  
  left_join(prev_IC_identifier,by=colnames(uri_cath_d$prediction)) %>%
  left_join(prev_ICCS_identifier,by=colnames(uri_cath_d$prediction)) %>%
  left_join(prev_ICHIV_identifier,by=colnames(uri_cath_d$prediction)) %>%
  left_join(prev_ICNEO_identifier,by=colnames(uri_cath_d$prediction)) %>%
  
  left_join(creatinine_gt2_identifier,by=colnames(uri_cath_d$prediction)) %>%
  
  left_join(prev_SGLT2_identifier,by=colnames(uri_cath_d$prediction)) %>%
  
  left_join(prev_uro_identifier,by=colnames(uri_cath_d$prediction)) %>%
  left_join(doublej_identifier,by=colnames(uri_cath_d$prediction)) %>%
  left_join(prev_urodiag_identifier,by=colnames(uri_cath_d$prediction)) %>%
  left_join(urodyn_identifier,by=colnames(uri_cath_d$prediction)) %>%
  
  left_join(prev_utidiag_6mgt2_1ygt3_identifier,by=colnames(uri_cath_d$prediction)) %>%
  left_join(prev_utidiag_6mgt2_identifier,by=colnames(uri_cath_d$prediction)) %>%
  left_join(prev_utidiag6m_identifier,by=colnames(uri_cath_d$prediction)) %>%
  left_join(prev_utidiag_1ygt3_identifier,by=colnames(uri_cath_d$prediction)) %>%
  left_join(prev_utidiag1y_identifier,by=colnames(uri_cath_d$prediction)) %>%
  
  left_join(prev_neuro_identifier,by=colnames(uri_cath_d$prediction)) %>%
  
  left_join(prev_AB_identifier,by=colnames(uri_cath_d$prediction))
```

```{r Incorporate identifiers to each selection scenario, include=FALSE}
whole_data_d3=
  list(
    prediction=
      identifiers %>%
      filter(duration>2)
    ,order=
      identifiers %>%
      filter(duration>2) %>%
      group_by_at(colnames(uri_cath_d3$order)) %>%
      filter(pred_day==max(pred_day)) %>%
      ungroup()
    ,visit=
      identifiers %>%
      filter(duration>2) %>%
      group_by_at(colnames(uri_cath_d3$visit)) %>%
      filter(pred_day==max(pred_day)) %>%
      ungroup()
    ,patient=
      identifiers %>%
      filter(duration>2) %>%
      group_by_at(colnames(uri_cath_d3$patient)) %>%
      filter(pred_day==max(pred_day)) %>%
      ungroup()
  )

whole_data_d=
  list(
    prediction=
      identifiers
    ,order=
      identifiers %>%
      group_by_at(colnames(uri_cath_d$order)) %>%
      filter(pred_day==max(pred_day)) %>%
      ungroup()
    ,visit=
      identifiers %>%
      group_by_at(colnames(uri_cath_d$visit)) %>%
      filter(pred_day==max(pred_day)) %>%
      ungroup()
    ,patient=
      identifiers %>%
      group_by_at(colnames(uri_cath_d$patient)) %>%
      filter(pred_day==max(pred_day)) %>%
      ungroup()
  )
```

```{r eval=FALSE, include=FALSE}
# unified_id=
#   raw_data %>%
#   .[str_detect(names(.),'^v_chr_basic')] %>%
#   lapply(\(x)
#     x %>%
#       select_at(
#         colnames(.) %>%
#           .[str_detect(
#             .
#             ,paste0(
#               c(
#                 '^ID_NO'
#                 ,'^CHR_NO'
#               )
#               ,collapse='|'
#             )
#           )]
#       )
#   ) %>%
#   lapply(
#     X=names(.)
#     ,Y=.
#     ,\(X,Y)
#     Y[[X]] %>%
#       mutate(
#         HOSP=
#           str_sub(X,str_count(X),str_count(X))
#       )
#   ) %>%
#   do.call(rbind,.) %>%
#   group_by(ID_NO) %>%
#   mutate(
#     EV_HOSP=
#       HOSP %>%
#       unique() %>%
#       length()
#     ,WHICH_HOSP=
#       HOSP %>%
#       unique() %>%
#       sort() %>%
#       paste0(collapse='')
#   ) %>%
#   ungroup() %>%
#   select(HOSP,EV_HOSP,WHICH_HOSP,everything())
```

```{r eval=FALSE, include=FALSE}
# unified_id %>%
#   group_by(HOSP,ID_NO) %>%
#   summarize(n=n(),.groups='drop') %>%
#   spread(HOSP,n,fill=0) %>%
#   mutate(EVER_VISIT_HOSPs=s+t+w) %>%
#   arrange(desc(EVER_VISIT_HOSPs),desc(s),desc(t),desc(w)) %>%
#   group_by(EVER_VISIT_HOSPs) %>%
#   summarize(ID_NOs=n())
```

```{r eval=FALSE, include=FALSE}
# whole_data_d3$prediction %>%
#   left_join(
#     unified_id
#     ,by=c('HOSP','CHR_NO')
#   ) %>%
#   group_by(EV_HOSP) %>%
#   summarize(n=n())
# 
# whole_data_d$prediction %>%
#   left_join(
#     unified_id
#     ,by=c('HOSP','CHR_NO')
#   ) %>%
#   group_by(EV_HOSP) %>%
#   summarize(n=n())
```

```{r eval=FALSE, include=FALSE}
# partition_d3=list()
# 
# set.seed(seed); partition_d3$training=
#   which(
#     whole_data_d3$prediction$HOSP%in%c('t')
#     & left_join(
#         whole_data_d3$prediction
#         ,unified_id
#         ,by=c('HOSP','CHR_NO')
#       )$EV_HOSP%in%c(1)
#   ) %>%
#   sample(
#     0.8*sum(whole_data_d3$prediction$HOSP%in%c('t'))-sum(
#       left_join(
#         whole_data_d3$prediction
#         ,unified_id
#         ,by=c('HOSP','CHR_NO')
#       )$EV_HOSP%in%c(2,3)
#     )
#     ,F
#   ) %>%
#   c(which(
#     left_join(
#       whole_data_d3$prediction
#       ,unified_id
#       ,by=c('HOSP','CHR_NO')
#     )$EV_HOSP%in%c(2,3)
#   )) %>%
#   sort()
# 
# partition_d3$validation=
#   which(whole_data_d3$prediction$HOSP%in%c('t')) %>%
#   setdiff(partition_d3$training)
# 
# partition_d3$test=
#   which(whole_data_d3$prediction$HOSP%in%c('s','w'))
# 
# partition_d=list()
# 
# set.seed(seed); partition_d$training=
#   which(
#     whole_data_d$prediction$HOSP%in%c('s','t')
#     & left_join(
#         whole_data_d$prediction
#         ,unified_id
#         ,by=c('HOSP','CHR_NO')
#       )$EV_HOSP%in%c(1)
#   ) %>%
#   sample(
#     0.8*sum(whole_data_d$prediction$HOSP%in%c('s','t'))-sum(
#       left_join(
#         whole_data_d$prediction
#         ,unified_id
#         ,by=c('HOSP','CHR_NO')
#       )$EV_HOSP%in%c(2,3)
#     )
#     ,F
#   ) %>%
#   c(which(
#     left_join(
#       whole_data_d$prediction
#       ,unified_id
#       ,by=c('HOSP','CHR_NO')
#     )$EV_HOSP%in%c(2,3)
#   )) %>%
#   sort()
# 
# partition_d$validation=
#   which(whole_data_d$prediction$HOSP%in%c('s','t')) %>%
#   setdiff(partition_d$training)
# 
# partition_d$test=
#   which(whole_data_d$prediction$HOSP%in%c('w'))
```

```{r eval=FALSE, include=FALSE}
# whole_data_d3$prediction %>%
#   mutate(
#     set=
#       case_when(
#         seq(nrow(.))%in%partition_d3$training~'Training'
#         ,seq(nrow(.))%in%partition_d3$validation~'Validation'
#         ,seq(nrow(.))%in%partition_d3$test~'Test'
#       )
#   ) %>%
#   left_join(
#     unified_id
#     ,by=c('HOSP','CHR_NO')
#   ) %>%
#   group_by(set,EV_HOSP,WHICH_HOSP,outcome) %>%
#   summarize(n=n(),.groups='drop') %>%
#   spread(outcome,n,fill=0) %>%
#   lapply(X=1:2,Y=.,\(X,Y){
#     if(X==1){
#       filter(Y,set!='Test')
#     }else{
#       filter(Y,set=='Test')
#     }
#   }) %>%
#   lapply(
#     mutate
#     ,subtotal=
#       `FALSE`+`TRUE`#+`<NA>`
#     ,total=
#       sum(subtotal)
#     ,p=
#       subtotal/total
#   ) %>%
#   do.call(rbind,.) %>%
#   group_by(set) %>%
#   mutate(
#     FALSE_set=sum(`FALSE`)
#     ,TRUE_set=sum(`TRUE`)
#     # ,`<NA>_set`=sum(`<NA>`)
#     ,subtotal_set=sum(subtotal)
#     ,p_set=sum(p)
#   ) %>%
#   ungroup() %>%
#   mutate_at(c('p','p_set'),\(x)round(x*100,2))
# 
# whole_data_d$prediction %>%
#   mutate(
#     set=
#       case_when(
#         seq(nrow(.))%in%partition_d$training~'Training'
#         ,seq(nrow(.))%in%partition_d$validation~'Validation'
#         ,seq(nrow(.))%in%partition_d$test~'Test'
#       )
#   ) %>%
#   left_join(
#     unified_id
#     ,by=c('HOSP','CHR_NO')
#   ) %>%
#   group_by(set,EV_HOSP,WHICH_HOSP,outcome) %>%
#   summarize(n=n(),.groups='drop') %>%
#   spread(outcome,n,fill=0) %>%
#   lapply(X=1:2,Y=.,\(X,Y){
#     if(X==1){
#       filter(Y,set!='Test')
#     }else{
#       filter(Y,set=='Test')
#     }
#   }) %>%
#   lapply(
#     mutate
#     ,subtotal=
#       `FALSE`+`TRUE`+`<NA>`
#     ,total=
#       sum(subtotal)
#     ,p=
#       subtotal/total
#   ) %>%
#   do.call(rbind,.) %>%
#   group_by(set) %>%
#   mutate(
#     FALSE_set=sum(`FALSE`)
#     ,TRUE_set=sum(`TRUE`)
#     ,`<NA>_set`=sum(`<NA>`)
#     ,subtotal_set=sum(subtotal)
#     ,p_set=sum(p)
#   ) %>%
#   ungroup() %>%
#   mutate_at(c('p','p_set'),\(x)round(x*100,2))
```

```{r Description of variables, include=FALSE}
variable_description=
  read_csv('data/variable_description.csv',show_col_types=F)
  # c('outcome','CA-UTI'
  #   ,'UTI','UTI diagnosis'
  #   ,'URICULT','Urine culture order'
  #   ,'PNEU','Pneumonia diagnosis'
  #   ,'AGE_GROUP','Age group'
  #   ,'AGE','Age (years)'
  #   ,'ICU_STAY_10D','ICU stay >=10 days'
  #   ,'ICU_STAY_D','ICU stay (days)'
  #   ,'CATH_D_6D','Duration of catheterization >=6 days'
  #   ,'CATH_D','Duration of catheterization (days)'
  #   ,'LOS_4D','Hospital stay >=4 days'
  #   ,'LOS','Hospital stay (days)'
  #   ,'CATH_PREV','Previous catheterization (n)'
  #   ,'SEX_TYPE','Sex (F/M)'
  #   ,'prev_DM','T2DM diagnosis/DM medication'
  #   ,'prev_DMdiag','T2DM diagnosis'
  #   ,'prev_DMmed','DM medication'
  #   ,'immob','Immobilization (protective restraint)'
  #   ,'indication','Indication of cathetherization'
  #   ,'prev_DMrel','DM-related factors'
  #   ,'prev_HYP','Hypertension diagnosis'
  #   ,'prev_DMinsulin','Exogenous insulin'
  #   ,'BMI_GT30','BMI >30 kg/m^2'
  #   ,'BMI','BMI (kg/m^2)'
  #   ,'prev_DMneph','DM with nephropathy'
  #   ,'poor_nutr','Poor nutrition (serum albumin/creatinine)'
  #   ,'ALBUMIN_LT3.5','Serum albumin <3.5 g/dL'
  #   ,'ALBUMIN','Serum albumin (g/dL)'
  #   ,'CREATININE_LT0.5'
  #         ,'Serum creatinine <0.5 mg/dL & eGFR >=105 mL/min/1.73 m^2'
  #   ,'CREATININE','Serum creatinine (mg/dL)'
  #   ,'EGFR','eGFR (mL/min/1.73 m^2)'
  #   ,'prev_FI','FI medication (antidiarrheal/laxative)'
  #   ,'prev_FIAD','Antidiarrheal drugs'
  #   ,'prev_FILX','Laxative drugs'
  #   ,'prev_IC','Impaired immune function'
  #   ,'prev_ICCS','Corticosteroid drugs'
  #   ,'prev_ICHIV','HIV'
  #   ,'prev_ICNEO','Malignant neoplasms'
  #   ,'CREATININE_GT2','Serum creatinine >2 mg/dL'
  #   ,'prev_SGLT2','Sodium-glucose co-transporter (SGLT)-2 inhibitors'
  #   ,'prev_uro','Urological issues (double-J/diagnosis/urodynamics)'
  #   ,'doublej','Double-J ureteral stent insertion'
  #   ,'prev_urodiag','Urological diagnosis'
  #   ,'urodyn','Urodynamic examination'
  #   ,'prev_utidiag_6mgt2_1ygt3'
  #           ,'Previous UTI diagnosis >2x/6 mo or >3/1 y'
  #   ,'prev_utidiag_6mgt2','Previous UTI diagnosis >2x/6 mo'
  #   ,'prev_utidiag6m','Previous UTI diagnosis last 6 mo (n)'
  #   ,'prev_utidiag_1ygt3','Previous UTI diagnosis >3/1 y'
  #   ,'prev_utidiag1y','Previous UTI diagnosis last 1 y (n)'
  #   ,'prev_neuro','Neurological issues (diagnosis)'
  #   ,'prev_AB','Antibiotic drugs last 7 d'
  # ) %>%
  # matrix(
  #   ncol=2
  #   ,byrow=T
  #   ,dimnames=list(NULL,c('variable','description'))
  # ) %>%
  # as.data.frame()
```

```{r Create data partition identifier, include=FALSE}
partition_d3=list()

set.seed(seed); partition_d3$training=
  which(whole_data_d3$prediction$HOSP%in%c('t')) %>%
  sample(0.8*length(.),F) %>%
  sort()

partition_d3$validation=
  which(whole_data_d3$prediction$HOSP%in%c('t')) %>%
  setdiff(partition_d3$training)

partition_d3$test=
  which(whole_data_d3$prediction$HOSP%in%c('s','w'))

partition_d=list()

set.seed(seed); partition_d$training=
  which(whole_data_d$prediction$HOSP%in%c('s','t')) %>%
  sample(0.8*length(.),F) %>%
  sort()

partition_d$validation=
  which(whole_data_d$prediction$HOSP%in%c('s','t')) %>%
  setdiff(partition_d$training)

partition_d$test=
  which(whole_data_d$prediction$HOSP%in%c('w'))
```

```{r Show the sample size in each data partition, eval=FALSE, include=FALSE}
whole_data_d3$prediction %>%
  mutate(
    set=
      case_when(
        seq(nrow(.))%in%partition_d3$training~'Training'
        ,seq(nrow(.))%in%partition_d3$validation~'Validation'
        ,seq(nrow(.))%in%partition_d3$test~'Test'
      ) %>%
      factor(c('Training','Validation','Test'))
  ) %>%
  group_by(set,outcome) %>%
  summarize(n=n(),.groups='drop') %>%
  group_by(set) %>%
  mutate(subtotal=sum(n)) %>%
  ungroup() %>%
  mutate(
    outcome=
      ifelse(
        is.na(outcome)
        ,'3-Missing'
        ,ifelse(
          outcome==T
          ,'2-Yes'
          ,'1-No'
        )
      )
  ) %>%
  spread(outcome,n,fill=0) %>%
  left_join(
    rbind(
        filter(.,set%in%c('Training','Validation')) %>%
          mutate(
            total=sum(subtotal)
            ,proportion=round(subtotal/total*100,2)
          )
        ,filter(.,set%in%c('Test')) %>%
          mutate(
            total=sum(subtotal)
            ,proportion=round(subtotal/total*100,2)
          )
      ) %>%
      select(set,total,proportion)
    ,by='set'
  ) %>%
  select(set,total,subtotal,proportion,everything()) %>%
  mutate(prevalence=round(`2-Yes`/subtotal*100,2))

whole_data_d$prediction %>%
  mutate(
    set=
      case_when(
        seq(nrow(.))%in%partition_d$training~'Training'
        ,seq(nrow(.))%in%partition_d$validation~'Validation'
        ,seq(nrow(.))%in%partition_d$test~'Test'
      ) %>%
      factor(c('Training','Validation','Test'))
  ) %>%
  group_by(set,outcome) %>%
  summarize(n=n(),.groups='drop') %>%
  group_by(set) %>%
  mutate(subtotal=sum(n)) %>%
  ungroup() %>%
  mutate(
    outcome=
      ifelse(
        is.na(outcome)
        ,'3-Missing'
        ,ifelse(
          outcome==T
          ,'2-Yes'
          ,'1-No'
        )
      )
  ) %>%
  spread(outcome,n,fill=0) %>%
  left_join(
    rbind(
        filter(.,set%in%c('Training','Validation')) %>%
          mutate(
            total=sum(subtotal)
            ,proportion=round(subtotal/total*100,2)
          )
        ,filter(.,set%in%c('Test')) %>%
          mutate(
            total=sum(subtotal)
            ,proportion=round(subtotal/total*100,2)
          )
      ) %>%
      select(set,total,proportion)
    ,by='set'
  ) %>%
  select(set,total,subtotal,proportion,everything()) %>%
  mutate(prevalence=round(`2-Yes`/subtotal*100,2))
```

```{r Function for descriptive analysis, include=FALSE}
descriptive_analysis=
  \(whole_data_d_prediction){
    whole_data_d_prediction %>%
      colnames() %>%
      .[!.%in%c(
        colnames(uri_cath_d$prediction)
        ,'outcome'
        ,'ICU_STAY_N'
        ,'HEIGHT'
        ,'WEIGHT'
      )] %>%
      `names<-`(as.character(.)) %>%
      lapply(\(x){
        y=whole_data_d_prediction %>%
          select_at(c('HOSP','outcome',x)) %>%
          rename_at(x,\(x)'variable')
        if(class(y$variable)%in%c('logical','factor')){
          z=y %>%
            group_by(HOSP,outcome,variable) %>%
            summarize(n=n(),.groups='drop') %>%
            group_by(HOSP,outcome) %>%
            mutate(
              total=sum(n)
              ,p=round(n/total*100,2)
            ) %>%
            ungroup() %>%
            mutate_at(
              c('n','total')
              ,\(x)ifelse(str_count(x)>4,format(x,big.mark=','),x)
            )
          
          if(class(y$variable)=='logical'){
            z=z %>%
              mutate_at(
                c('outcome','variable')
                ,\(x){
                  x=ifelse(x,'2-Yes','1-No')
                  x=ifelse(is.na(x),'3-Missing',x)
              })
          }else{
            z=z %>%
              mutate_at(
                c('outcome')
                ,\(x){
                  x=ifelse(x,'2-Yes','1-No')
                  x=ifelse(is.na(x),'3-Missing',x)
              }) %>%
              mutate(
                variable=
                  ifelse(
                    is.na(variable)
                    ,paste0(
                      length(levels(variable))+1
                      ,'-Missing'
                    )
                    ,paste0(
                      as.numeric(variable)
                      ,'-'
                      ,as.character(variable)
                    )
                  )
              )
          }
          
          z
          # %>%
          #   mutate(
          #     n=paste0('(',n,')')
          #     ,total=paste0('(n=',total,')')
          #   ) %>%
          #   unite(HOSP,HOSP,outcome,total,sep=' ') %>%
          #   unite(p,p,n,sep=' ') %>%
          #   spread(HOSP,p,fill='0.00 (0)') %>%
          #   rename(unit=variable) %>%
          #   mutate(unit=paste0(unit,', % (n)')) %>%
          #   mutate(variable=x) %>%
          #   select(variable,everything())
        }else{
          z=suppressWarnings(
            y  %>%
              group_by(HOSP) %>%
              mutate(
                min=min(variable,na.rm=T)
                ,q1=quantile(variable,0.25,na.rm=T)
                ,q2=quantile(variable,0.5,na.rm=T)
                ,q3=quantile(variable,0.75,na.rm=T)
                ,max=max(variable,na.rm=T)
              ) %>%
              ungroup() %>%
              group_by(HOSP,outcome) %>%
              mutate(
                n=n()
                ,missing=sum(is.na(variable))
              ) %>%
              ungroup()
          )
          
          z %>%
            mutate(
              outlier=
                variable<(q1-1.5*(q3-q1))
                | variable>(q3+1.5*(q3-q1))
            ) %>%
            group_by(HOSP,outcome,n,missing) %>%
            summarize(
              outliers=sum(outlier,na.rm=T)
              ,avg=round(mean(ifelse(outlier,NA,variable),na.rm=T),2)
              ,std=round(sd(ifelse(outlier,NA,variable),na.rm=T),2)
              ,.groups='drop'
            ) %>%
            mutate_at(c('avg','std'),\(x)ifelse(is.nan(x),NA,x)) %>%
            rename(total=n) %>%
            mutate(
              avg_std=total-(missing+outliers)
            ) %>%
            gather(unit,value,-HOSP,-outcome,-avg,-std,-total) %>%
            mutate(p=round(value/total*100,2)) %>%
            mutate_at(
              c('value','total','avg','std')
              ,\(x)ifelse(str_count(x)>4,format(x,big.mark=','),x)
            ) %>%
            mutate_at(
              c('outcome')
              ,\(x){
                x=ifelse(x,'2-Yes','1-No')
                x=ifelse(is.na(x),'3-Missing',x)
            })
          
          # %>%
          #   mutate(
          #     value=paste0('(',value,')')
          #     ,total=paste0('(n=',total,')')
          #   ) %>%
          #   unite(HOSP,HOSP,outcome,total,sep=' ') %>%
          #   mutate(std=paste0('(',std,')')) %>%
          #   unite(avg_std,avg,std,sep=' ') %>%
          #   mutate(avg_std=ifelse(str_detect(avg_std,'NA'),'-',avg_std)) %>%
          #   unite(p,p,value,sep=' ') %>%
          #   lapply(X=1,Y=.,\(X,Y){
          #     Y %>%
          #       filter(unit=='avg_std') %>%
          #       select(-p) %>%
          #       mutate(
          #         unit='1-Neither missing/outliers, avg. (SD)'
          #       ) %>%
          #       spread(HOSP,avg_std,fill='-') %>%
          #       rbind(
          #         Y %>%
          #           mutate(
          #             unit=
          #               case_when(
          #                 unit=='avg_std'~'1-Neither missing/outliers, % (n)'
          #                 ,unit=='outliers'~'2-Outliers, % (n)'
          #                 ,unit=='missing'~'3-Missing, % (n)'
          #               )
          #           ) %>%
          #           select(-avg_std) %>%
          #           spread(HOSP,p,fill='0.00 (0)')
          #       ) %>%
          #       mutate(variable=x) %>%
          #       select(variable,everything())
          #   }) %>%
          #   .[[1]]
        }
      })
    
    # %>%
    #   do.call(rbind,.) %>%
    #   left_join(
    #     variable_description
    #     ,by='variable'
    #   ) %>%
    #   mutate(description=ifelse(duplicated(variable),'',description)) %>%
    #   mutate(variable=description) %>%
    #   select(-description) %>%
    #   mutate(unit=str_sub(unit,3,str_count(unit)))
  }
```

```{r Function for reporting descriptive analysis, include=FALSE}
report_descriptive_analysis=
  \(whole_data_d_prediction,descriptive_analysis_results){
    descriptive_analysis_results %>%
      names() %>%
      lapply(\(x){
        y=whole_data_d_prediction %>%
          select_at(c('HOSP','outcome',x)) %>%
          rename_at(x,\(x)'variable')
        if(class(y$variable)%in%c('logical','factor')){
          descriptive_analysis_results[[x]] %>%
            mutate(
              n=paste0('(',n,')')
              ,total=paste0('(n=',total,')')
            ) %>%
            unite(HOSP,HOSP,outcome,total,sep=' ') %>%
            unite(p,p,n,sep=' ') %>%
            spread(HOSP,p,fill='0.00 (0)') %>%
            rename(unit=variable) %>%
            mutate(unit=paste0(unit,', % (n)')) %>%
            mutate(variable=x) %>%
            select(variable,everything())
        }else{
          descriptive_analysis_results[[x]] %>%
            mutate(
              value=paste0('(',value,')')
              ,total=paste0('(n=',total,')')
            ) %>%
            unite(HOSP,HOSP,outcome,total,sep=' ') %>%
            mutate(std=paste0('(',std,')')) %>%
            unite(avg_std,avg,std,sep=' ') %>%
            mutate(avg_std=ifelse(str_detect(avg_std,'NA'),'-',avg_std)) %>%
            unite(p,p,value,sep=' ') %>%
            lapply(X=1,Y=.,\(X,Y){
              Y %>%
                filter(unit=='avg_std') %>%
                select(-p) %>%
                mutate(
                  unit='1-Neither missing/outliers, avg. (SD)'
                ) %>%
                spread(HOSP,avg_std,fill='-') %>%
                rbind(
                  Y %>%
                    mutate(
                      unit=
                        case_when(
                          unit=='avg_std'~'1-Neither missing/outliers, % (n)'
                          ,unit=='outliers'~'2-Outliers, % (n)'
                          ,unit=='missing'~'3-Missing, % (n)'
                        )
                    ) %>%
                    select(-avg_std) %>%
                    spread(HOSP,p,fill='0.00 (0)')
                ) %>%
                mutate(variable=x) %>%
                select(variable,everything())
            }) %>%
            .[[1]]
        }
      }) %>%
      do.call(rbind,.) %>%
      left_join(
        variable_description %>%
          select(variable,description)
        ,by='variable'
      ) %>%
      mutate(description=ifelse(duplicated(variable),'',description)) %>%
      mutate(variable=description) %>%
      select(-description) %>%
      mutate(unit=str_sub(unit,3,str_count(unit)))
  }
```

```{r Conduct descriptive analyses, include=FALSE}
descriptive_analysis_d3=
  whole_data_d3$prediction %>%
  mutate(
    HOSP=
      case_when(
        seq(n())%in%partition_d3$training~'training'
        ,seq(n())%in%partition_d3$validation~'validation'
        ,seq(n())%in%partition_d3$test~'test'
        ,TRUE~'NA'
      )
    ,HOSP=ifelse(HOSP=='NA',NA,HOSP)
  ) %>%
  descriptive_analysis()

descriptive_analysis_d=
  whole_data_d$prediction %>%
  mutate(
    HOSP=
      case_when(
        seq(n())%in%partition_d$training~'training'
        ,seq(n())%in%partition_d$validation~'validation'
        ,seq(n())%in%partition_d$test~'test'
        ,TRUE~'NA'
      )
    ,HOSP=ifelse(HOSP=='NA',NA,HOSP)
  ) %>%
  descriptive_analysis()
```

```{r Report descriptive analyses, eval=FALSE, include=FALSE}
whole_data_d3$prediction %>%
  mutate(
    HOSP=
      case_when(
        seq(n())%in%partition_d3$training~'training'
        ,seq(n())%in%partition_d3$validation~'validation'
        ,seq(n())%in%partition_d3$test~'test'
        ,TRUE~'NA'
      )
    ,HOSP=ifelse(HOSP=='NA',NA,HOSP)
  ) %>%
  report_descriptive_analysis(descriptive_analysis_d3) %>%
  write_csv('data/desc_whole_data_d3_prediction.csv')

whole_data_d$prediction %>%
  mutate(
    HOSP=
      case_when(
        seq(n())%in%partition_d$training~'training'
        ,seq(n())%in%partition_d$validation~'validation'
        ,seq(n())%in%partition_d$test~'test'
        ,TRUE~'NA'
      )
    ,HOSP=ifelse(HOSP=='NA',NA,HOSP)
  ) %>%
  report_descriptive_analysis(descriptive_analysis_d) %>%
  write_csv('data/desc_whole_data_d_prediction.csv')
```

```{r Function for missing analysis, include=FALSE}
missing_analysis=function(whole_data_d_prediction){
  whole_data_d_prediction %>%
    colnames(.) %>%
    .[!.%in%c(
      colnames(uri_cath_d$prediction)
      ,'outcome'
      ,'UTI'
      ,'URICULT'
      ,'PNEU'
      ,'ICU_STAY_N'
      ,'HEIGHT'
      ,'WEIGHT'
    )] %>%
    lapply(c,'outcome') %>%
    lapply(rev) %>%
    lapply(paste0,collapse='~') %>%
    lapply(as.formula) %>%
    lapply(
      \(x){
        y=whole_data_d_prediction %>%
          select_at(
            colnames(.) %>%
              .[!.%in%c(
                colnames(uri_cath_d$prediction)
                ,'outcome'
                ,'UTI'
                ,'URICULT'
                ,'PNEU'
                ,'ICU_STAY_N'
                ,'HEIGHT'
                ,'WEIGHT'
              )]
          ) %>%
          lapply(\(x)ifelse(is.na(x),'1-missing','0-non-missing')) %>%
          lapply(factor) %>%
          as.data.frame()
        
        whole_data_d_prediction %>%
          mutate_at(
            c('outcome')
            ,\(x){
              x=ifelse(x,'2-Yes','1-No')
              x=ifelse(is.na(x),'3-Missing',x)
          }) %>%
          pull(outcome) %>%
          unique() %>%
          lapply(\(z){
            k=whole_data_d_prediction %>%
              select(outcome) %>%
              mutate_at(
                c('outcome')
                ,\(x){
                  x=ifelse(x,'2-Yes','1-No')
                  x=ifelse(is.na(x),'3-Missing',x)
              }) %>%
              mutate(
                outcome=
                  ifelse(
                    outcome==z
                    ,paste0('1-outcome==',z)
                    ,paste0('0-outcome!=',z)
                  ) %>%
                  factor()
              ) %>%
              cbind(y)
            
            l=k %>%
              group_by_at(as.character(x)[2:3]) %>%
              summarize(n=n(),.groups='drop')
            
            if(nrow(l)>=4){
              x %>%
                glm(family=binomial(),data=k) %>%
                broom::tidy() %>%
                mutate(
                  outcome=z
                  ,variable=
                    x %>%
                    as.character() %>%
                    .[3]
                ) %>%
                select(outcome,variable,everything()) %>%
                filter(term!='(Intercept)')
            }else{
              data.frame(
                outcome=z
                ,variable=
                  x %>%
                  as.character() %>%
                  .[3]
                ,term='1-missing'
                ,estimate=NA
                ,std.error=NA
                ,statistic=NA
                ,p.value=NA
              )
            }
          }) %>%
          do.call(rbind,.)
    }) %>%
    do.call(rbind,.) %>%
    mutate(
      term=str_remove_all(term,variable)
      ,OR=round(exp(estimate),2)
      ,LB=round(exp(estimate-std.error),2)
      ,UB=round(exp(estimate+std.error),2)
      ,FDR=p.adjust(p.value,method='BH')
    ) %>%
    select(outcome,variable,OR,LB,UB,FDR)
}
```

```{r Function for reporting missing analysis, include=FALSE}
report_missing_analysis=function(missing_analysis_results){
  missing_analysis_results %>%
    mutate(
      FDR=
        ifelse(
          FDR<0.001
          ,'p<0.001'
          ,ifelse(
            FDR<=0.05
            ,paste0('p=',round(FDR,3))
            ,'p>0.05'
          )
        )
    ) %>%
    unite(CI,LB,UB,sep=' to ') %>%
    unite(CI_FDR,CI,FDR,sep='; ') %>%
    mutate(CI_FDR=paste0('(',CI_FDR,')')) %>%
    unite(OR_CI_FDR,OR,CI_FDR,sep=' ') %>%
    mutate(OR_CI_FDR=ifelse(OR_CI_FDR=='NA (NA to NA; NA)','-',OR_CI_FDR)) %>%
    mutate(variable=factor(variable,unique(variable))) %>%
    spread(outcome,OR_CI_FDR,fill='-') %>%
    left_join(
      variable_description %>%
        select(variable,description)
      ,by='variable'
    ) %>%
    mutate(variable=description) %>%
    select(-description)
}
```

```{r Conduct missing analyses, include=FALSE}
missing_analysis_d3=
  whole_data_d3$prediction %>%
  mutate(
    HOSP=
      case_when(
        seq(n())%in%partition_d3$training~'training'
        ,seq(n())%in%partition_d3$validation~'validation'
        ,seq(n())%in%partition_d3$test~'test'
        ,TRUE~'NA'
      )
    ,HOSP=ifelse(HOSP=='NA',NA,HOSP)
  ) %>%
  filter(HOSP%in%c('training')) %>%
  missing_analysis()

missing_analysis_d=
  whole_data_d$prediction %>%
  mutate(
    HOSP=
      case_when(
        seq(n())%in%partition_d$training~'training'
        ,seq(n())%in%partition_d$validation~'validation'
        ,seq(n())%in%partition_d$test~'test'
        ,TRUE~'NA'
      )
    ,HOSP=ifelse(HOSP=='NA',NA,HOSP)
  ) %>%
  filter(HOSP%in%c('training')) %>%
  missing_analysis()
```

```{r Report missing analyses, eval=FALSE, include=FALSEE}
missing_analysis_d3 %>%
  report_missing_analysis() %>%
  write_csv('data/missing_whole_data_d3_prediction.csv')

missing_analysis_d %>%
  report_missing_analysis() %>%
  write_csv('data/missing_whole_data_d_prediction.csv')
```

```{r Function for outlier analysis, include=FALSE}
outlier_analysis=function(whole_data_d_prediction){
  whole_data_d_prediction %>%
    .[,sapply(.,is.numeric)] %>%
    colnames(.) %>%
    .[!.%in%c(
      colnames(uri_cath_d$prediction)
      ,'outcome'
      ,'UTI'
      ,'URICULT'
      ,'PNEU'
      ,'ICU_STAY_N'
      ,'HEIGHT'
      ,'WEIGHT'
    )] %>%
    lapply(c,'outcome') %>%
    lapply(rev) %>%
    lapply(paste0,collapse='~') %>%
    lapply(as.formula) %>%
    lapply(
      \(x){
        y=whole_data_d_prediction %>%
          .[,sapply(.,is.numeric)] %>%
          select_at(
            colnames(.) %>%
              .[!.%in%c(
                colnames(uri_cath_d$prediction)
                ,'outcome'
                ,'UTI'
                ,'URICULT'
                ,'PNEU'
                ,'ICU_STAY_N'
                ,'HEIGHT'
                ,'WEIGHT'
              )]
          ) %>%
          lapply(\(x){
            y=suppressWarnings(
              data.frame(variable=x) %>%
                summarize(
                  q1=quantile(variable,0.25,na.rm=T)
                  ,q3=quantile(variable,0.75,na.rm=T)
                ) %>%
                mutate(
                  lb=q1-1.5*(q3-q1)
                  ,ub=q3+1.5*(q3-q1)
                )
            )
            ifelse(x<y$lb | x>y$ub | is.na(x),'1-outlier','0-non-outlier')
          }) %>%
          lapply(factor) %>%
          as.data.frame()
        
        whole_data_d_prediction %>%
          mutate_at(
            c('outcome')
            ,\(x){
              x=ifelse(x,'2-Yes','1-No')
              x=ifelse(is.na(x),'3-Missing',x)
          }) %>%
          pull(outcome) %>%
          unique() %>%
          lapply(\(z){
            k=whole_data_d_prediction %>%
              select(outcome) %>%
              mutate_at(
                c('outcome')
                ,\(x){
                  x=ifelse(x,'2-Yes','1-No')
                  x=ifelse(is.na(x),'3-Missing',x)
              }) %>%
              mutate(
                outcome=
                  ifelse(
                    outcome==z
                    ,paste0('1-outcome==',z)
                    ,paste0('0-outcome!=',z)
                  ) %>%
                  factor()
              ) %>%
              cbind(y)
            
            l=k %>%
              group_by_at(as.character(x)[2:3]) %>%
              summarize(n=n(),.groups='drop')
            
            if(nrow(l)>=4){
              x %>%
                glm(family=binomial(),data=k) %>%
                broom::tidy() %>%
                mutate(
                  outcome=z
                  ,variable=
                    x %>%
                    as.character() %>%
                    .[3]
                ) %>%
                select(outcome,variable,everything()) %>%
                filter(term!='(Intercept)')
            }else{
              data.frame(
                outcome=z
                ,variable=
                  x %>%
                  as.character() %>%
                  .[3]
                ,term='1-outlier'
                ,estimate=NA
                ,std.error=NA
                ,statistic=NA
                ,p.value=NA
              )
            }
          }) %>%
          do.call(rbind,.)
    }) %>%
    do.call(rbind,.) %>%
    mutate(
      term=str_remove_all(term,variable)
      ,OR=round(exp(estimate),2)
      ,LB=round(exp(estimate-std.error),2)
      ,UB=round(exp(estimate+std.error),2)
      ,FDR=p.adjust(p.value,method='BH')
    ) %>%
    select(outcome,variable,OR,LB,UB,FDR)
}
```

```{r Function for reporting outlier analysis, include=FALSE}
report_outlier_analysis=function(outlier_analysis_results){
  outlier_analysis_results %>%
    mutate(
      FDR=
        ifelse(
          FDR<0.001
          ,'p<0.001'
          ,ifelse(
            FDR<=0.05
            ,paste0('p=',round(FDR,3))
            ,'p>0.05'
          )
        )
    ) %>%
    unite(CI,LB,UB,sep=' to ') %>%
    unite(CI_FDR,CI,FDR,sep='; ') %>%
    mutate(CI_FDR=paste0('(',CI_FDR,')')) %>%
    unite(OR_CI_FDR,OR,CI_FDR,sep=' ') %>%
    mutate(OR_CI_FDR=ifelse(OR_CI_FDR=='NA (NA to NA; NA)','-',OR_CI_FDR)) %>%
    mutate(variable=factor(variable,unique(variable))) %>%
    spread(outcome,OR_CI_FDR,fill='-') %>%
    left_join(
      variable_description %>%
        select(variable,description)
      ,by='variable'
    ) %>%
    mutate(variable=description) %>%
    select(-description)
}
```

```{r Conduct outlier analyses, include=FALSE}
outlier_analysis_d3=
  whole_data_d3$prediction %>%
  mutate(
    HOSP=
      case_when(
        seq(n())%in%partition_d3$training~'training'
        ,seq(n())%in%partition_d3$validation~'validation'
        ,seq(n())%in%partition_d3$test~'test'
        ,TRUE~'NA'
      )
    ,HOSP=ifelse(HOSP=='NA',NA,HOSP)
  ) %>%
  filter(HOSP%in%c('training')) %>%
  outlier_analysis()

outlier_analysis_d=
  whole_data_d$prediction %>%
  mutate(
    HOSP=
      case_when(
        seq(n())%in%partition_d$training~'training'
        ,seq(n())%in%partition_d$validation~'validation'
        ,seq(n())%in%partition_d$test~'test'
        ,TRUE~'NA'
      )
    ,HOSP=ifelse(HOSP=='NA',NA,HOSP)
  ) %>%
  filter(HOSP%in%c('training')) %>%
  outlier_analysis()
```

```{r Report outlier analyses, eval=FALSE, include=FALSE}
outlier_analysis_d3 %>%
  report_outlier_analysis() %>%
  write_csv('data/outlier_whole_data_d3_prediction.csv')

outlier_analysis_d %>%
  report_outlier_analysis() %>%
  write_csv('data/outlier_whole_data_d_prediction.csv')
```

```{r Function for determining candidate predictor eligibility, include=FALSE}
candidate_predictor_eligibility=
  function(
    descriptive_analysis_results
    ,var_desc
    ,missing_analysis_results
    ,outlier_analysis_results
  ){
    cat_results=
      descriptive_analysis_results %>%
      lapply(X=c('avg','variable'),Y=.,\(X,Y)
        Y %>%
          .[lapply(.,colnames) %>%
              sapply(\(x)X%in%x)
          ] %>%
          lapply(X=names(.),Y=.,\(X,Y)
            Y[[X]] %>%
              mutate(variable_name=X)
          ) %>%
          `names<-`(
            Y %>%
              .[lapply(.,colnames) %>%
                  sapply(\(x)X%in%x)
              ] %>%
              names()
          ) %>%
          lapply(mutate,scale=ifelse(X=='avg','numeric','categoric'))
      ) %>%
      `names<-`(c('numeric','categoric'))
    
    pf=
      cat_results %>%
      lapply(X=1,Y=.,\(X,Y)
        rep('N/A',length(Y$numeric)) %>%
          `names<-`(names(Y$numeric)) %>%
          c(Y$categoric %>%
              sapply(\(x)
                (c('1-No','2-Yes') %>%
                    expand.grid(
                      x$variable %>%
                        .[!str_detect(.,'Missing')] %>%
                        unique()
                    ) %>%
                    `names<-`(c('outcome','variable')) %>%
                    left_join(x,by=c('outcome','variable')) %>%
                    pull(n) %>%
                    is.na() %>%
                    any()
                )|(
                 any(
                   filter(
                     x
                     ,!str_detect(outcome,'Missing')
                      & !str_detect(variable,'Missing')
                   )$p==100
                  )
                )
              ) %>%
              `names<-`(names(Y$categoric))
          )
      ) %>%
      .[[1]] %>%
      data.frame(pf_var='pf',value=.) %>%
      rownames_to_column(var='variable')
    
    m_pf=
      cat_results %>%
      lapply(X=1,Y=.,\(X,Y)
        Y$numeric %>%
          lapply(filter,unit=='missing') %>%
          lapply(filter,!str_detect(outcome,'Missing')) %>%
          sapply(\(x)
            x %>%
              lapply(X=1,Y=.,\(X,Y)
                ifelse(
                  all(Y$value==0)
                  ,'N/A'
                  ,ifelse(
                    any(Y$value==0)
                    ,'yes'
                    ,ifelse(
                      all(Y$value>0)
                      ,'no'
                      ,NA
                    )
                  )
                )
              ) %>%
              .[[1]]
          ) %>%
          c(Y$categoric %>%
              sapply(\(x)
                c('1-No','2-Yes') %>%
                  expand.grid('3-Missing') %>%
                  `names<-`(c('outcome','variable')) %>%
                  left_join(x,by=c('outcome','variable')) %>%
                  mutate(
                    n=n %>%
                      str_remove_all(',') %>%
                      as.numeric()
                  ) %>%
                  mutate(n=ifelse(is.na(n),0,n)) %>%
                  lapply(X=1,Y=.,\(X,Y)
                    ifelse(
                      all(Y$n==0)
                      ,'N/A'
                      ,ifelse(
                        any(Y$n==0)
                        ,'yes'
                        ,ifelse(
                          all(Y$n>0)
                          ,'no'
                          ,NA
                        )
                      )
                    )
                  ) %>%
                  .[[1]]
              )
          )
      ) %>%
      .[[1]] %>%
      data.frame(pf_var='m_pf',value=.) %>%
      rownames_to_column(var='variable')
    
    om_pf=
      cat_results %>%
      lapply(X=1,Y=.,\(X,Y)
        Y$numeric %>%
          lapply(filter,unit%in%c('missing','outliers')) %>%
          lapply(filter,!str_detect(outcome,'Missing')) %>%
          sapply(\(x)
            x %>%
              mutate(
                value=
                  value %>%
                  str_remove_all(',') %>%
                  as.numeric()
              ) %>%
              group_by(outcome) %>%
              summarize(value=sum(value)) %>%
              lapply(X=1,Y=.,\(X,Y)
                ifelse(
                  all(Y$value==0)
                  ,'N/A'
                  ,ifelse(
                    any(Y$value==0)
                    ,'yes'
                    ,ifelse(
                      all(Y$value>0)
                      ,'no'
                      ,NA
                    )
                  )
                )
              ) %>%
              .[[1]]
          ) %>%
          c(Y$categoric %>%
              sapply(\(x)
                c('1-No','2-Yes') %>%
                  expand.grid('3-Missing') %>%
                  `names<-`(c('outcome','variable')) %>%
                  left_join(x,by=c('outcome','variable')) %>%
                  mutate(
                    n=n %>%
                      str_remove_all(',') %>%
                      as.numeric()
                  ) %>%
                  mutate(n=ifelse(is.na(n),0,n)) %>%
                  lapply(X=1,Y=.,\(X,Y)
                    ifelse(
                      all(Y$n==0)
                      ,'N/A'
                      ,ifelse(
                        any(Y$n==0)
                        ,'yes'
                        ,ifelse(
                          all(Y$n>0)
                          ,'no'
                          ,NA
                          
                        )
                      )
                    )
                  ) %>%
                  .[[1]]
              )
          )
      ) %>%
      .[[1]] %>%
      data.frame(pf_var='om_pf',value=.) %>%
      rownames_to_column(var='variable')
    
    pf %>%
      rbind(m_pf) %>%
      rbind(om_pf) %>%
      mutate(
        value=
          case_when(
            value=='TRUE'|value=='yes'~'yes'
            ,value=='FALSE'|value=='no'~'no'
            ,value=='N/A'~'N/A'
            ,TRUE~'NA'
          )
        ,value=ifelse(value=='NA',NA,value)
      ) %>%
      mutate(
        pf_var=
          pf_var %>%
          factor(unique(.))
      ) %>%
      spread(pf_var,value) %>%
      mutate(available='yes') %>%
      right_join(var_desc,by='variable') %>%
      mutate(
        available=ifelse(is.na(available),'no',available)
        ,available=ifelse(variable=='outcome','yes',available)
      ) %>%
      mutate(
        pf=ifelse(variable=='outcome','N/A',pf)
        ,m_pf=ifelse(variable=='outcome','N/A',m_pf)
        ,om_pf=ifelse(variable=='outcome','N/A',om_pf)
      ) %>%
      left_join(
        cat_results$numeric %>%
          lapply(select,variable=variable_name,scale) %>%
          c(cat_results$categoric %>%
              lapply(select,variable=variable_name,scale)
          ) %>%
          do.call(rbind,.) %>%
          filter(!duplicated(.))
        ,by='variable'
      ) %>%
      mutate(
        scale=ifelse(variable=='outcome','categoric',scale)
      ) %>%
      left_join(
        missing_analysis_results %>%
          filter(outcome=='2-Yes') %>%
          mutate(m_mnar=ifelse(FDR<=0.05,'yes','no')) %>%
          select(variable,m_mnar)
        ,by='variable'
      ) %>%
      mutate(m_mnar=ifelse(m_pf=='N/A','N/A',m_mnar)) %>%
      left_join(
        outlier_analysis_results %>%
          filter(outcome=='2-Yes') %>%
          mutate(om_mnar=ifelse(FDR<=0.05,'yes','no')) %>%
          select(variable,om_mnar)
        ,by='variable'
      ) %>%
      mutate(om_mnar=ifelse(om_pf=='N/A'|scale=='categoric','N/A',om_mnar)) %>%
      select_at(
        c(colnames(var_desc)
          ,c('scale','available','pf','m_pf','m_mnar','om_pf','om_mnar')
        )
      ) %>%
      arrange(factor(variable,var_desc$variable))
  }
```

```{r Determine eligible candidate predictors, include=FALSE}
candidate_predictor_eligible_d3=
  whole_data_d3$prediction %>%
  mutate(
    HOSP=
      case_when(
        seq(n())%in%partition_d3$training~'training'
        ,seq(n())%in%partition_d3$validation~'validation'
        ,seq(n())%in%partition_d3$test~'test'
        ,TRUE~'NA'
      )
    ,HOSP=ifelse(HOSP=='NA',NA,HOSP)
  ) %>%
  descriptive_analysis() %>%
  lapply(filter,HOSP=='training') %>%
  candidate_predictor_eligibility(
    variable_description
    ,missing_analysis_d3
    ,outlier_analysis_d3
  )

candidate_predictor_eligible_d=
  whole_data_d$prediction %>%
  mutate(
    HOSP=
      case_when(
        seq(n())%in%partition_d$training~'training'
        ,seq(n())%in%partition_d$validation~'validation'
        ,seq(n())%in%partition_d$test~'test'
        ,TRUE~'NA'
      )
    ,HOSP=ifelse(HOSP=='NA',NA,HOSP)
  ) %>%
  descriptive_analysis() %>%
  lapply(filter,HOSP=='training') %>%
  candidate_predictor_eligibility(
    variable_description
    ,missing_analysis_d
    ,outlier_analysis_d
  )
```

```{r Function for reporting candidate predictor eligibility, include=FALSE}
report_candidate_predictor_eligibility=
  function(
    candidate_predictor_eligibility_results
    ,var_desc
    ,candidate_predictor_eligible
  ){
    candidate_predictor_eligibility_results=
      candidate_predictor_eligibility_results %>%
      lapply(
        X=var_desc %>%
          filter(variable_level=='yes') %>%
          pull(variable)
        ,Y=.
        ,\(X,Y)
          ifelse(
            rep(
              nrow(filter(Y,variable==X))>0
                # & nrow(filter(Y,indicator_level==X))==nrow(filter(
                #   candidate_predictor_eligible %>%
                #     filter(available%in%c('yes'))
                #   ,indicator_level==X
                # ))
              ,2
            )
            ,list(
              filter(Y,variable==X)
              ,filter(Y,indicator_level==X)
            )
            ,list(
              filter(Y,indicator_level==X)
              ,filter(Y,indicator_level==X)
            )
          )
      )
    
    candidate_predictor_eligibility_variables=
      candidate_predictor_eligibility_results %>%
      lapply(\(x)x[[1]]) %>%
      do.call(rbind,.) %>%
      filter(type=='predictor') %>%
      select(variable,variable_level,scale)
    
    candidate_predictor_eligibility_indicators=
      candidate_predictor_eligibility_results %>%
      lapply(\(x)x[[2]]) %>%
      do.call(rbind,.) %>%
      filter(type=='predictor') %>%
      select(variable,variable_level,scale)
    
    candidate_predictor_eligibility_summary=
      candidate_predictor_eligibility_variables %>%
      group_by(variable_level,scale) %>%
      summarize(n=n(),.groups='drop') %>%
      rename(level=variable_level) %>%
      mutate(
        level=
          ifelse(level=='yes','variable','indicator') %>%
          factor(c('variable','indicator'))
      ) %>%
      arrange(level)
    
    list(
      variable=candidate_predictor_eligibility_variables
      ,indicator=candidate_predictor_eligibility_indicators
      ,summary=candidate_predictor_eligibility_summary
    )
  }
```

```{r Report candidate predictor eligibility, include=FALSE}
report_candidate_predictor_eligible_d3=
  candidate_predictor_eligible_d3 %>%
  list(initial=.) %>%
  c(.$initial %>%
      filter(available%in%c('yes')) %>%
      list(by_available=.)
  ) %>%
  c(.$by_available %>%
      filter(pf%in%c('no','N/A')) %>%
      list(by_pf=.)
  ) %>%
  c(.$by_pf %>%
      filter(
        # m_pf%in%c('no','N/A')
        # &
        (
          m_mnar%in%c('no','N/A')
          |
          is.na(m_mnar)
        )
      ) %>%
      list(by_m=.)
  ) %>%
  c(.$by_m %>%
      filter(
        # om_pf%in%c('no','N/A')
        # &
        (
          om_mnar%in%c('no','N/A')
          |
          is.na(om_mnar)
        )
      ) %>%
      list(by_om=.)
  ) %>%
  lapply(
    report_candidate_predictor_eligibility
    ,variable_description
    ,candidate_predictor_eligible_d3
  )

report_candidate_predictor_eligible_d=
  candidate_predictor_eligible_d %>%
  list(initial=.) %>%
  c(.$initial %>%
      filter(available%in%c('yes')) %>%
      list(by_available=.)
  ) %>%
  c(.$by_available %>%
      filter(pf%in%c('no','N/A')) %>%
      list(by_pf=.)
  ) %>%
  c(.$by_pf %>%
      filter(
        # m_pf%in%c('no','N/A')
        # &
        (
          m_mnar%in%c('no','N/A')
          |
          is.na(m_mnar)
        )
      ) %>%
      list(by_m=.)
  ) %>%
  c(.$by_m %>%
      filter(
        # om_pf%in%c('no','N/A')
        # &
        (
          om_mnar%in%c('no','N/A')
          |
          is.na(om_mnar)
        )
      ) %>%
      list(by_om=.)
  ) %>%
  lapply(
    report_candidate_predictor_eligibility
    ,variable_description
    ,candidate_predictor_eligible_d
  )
```

```{r Select MCAR candidate predictors with and without outliers, include=FALSE}
cand_predictors_d3=
  report_candidate_predictor_eligible_d3 %>%
  .$by_om %>%
  .$variable %>%
  .$variable
  # c('AGE'
  #   ,'ICU_STAY_D'
  #   ,'CATH_D'
  #   ,'LOS_4D'
  #   ,'SEX_TYPE'
  #   ,'prev_DM'
  #   ,'prev_HYP'
  #   ,'prev_DMinsulin'
  #   ,'BMI'
  #   ,'CREATININE_LT0.5'
  #   ,'prev_FILX'
  #   ,'prev_ICCS'
  #   ,'prev_ICNEO'
  #   ,'CREATININE_GT2'
  #   ,'prev_utidiag6m'
  #   ,'prev_utidiag1y'
  #   ,'prev_neuro'
  #   ,'prev_AB'
  # )

cand_predictors_d=
  report_candidate_predictor_eligible_d %>%
  .$by_om %>%
  .$variable %>%
  .$variable
  # c('AGE_GROUP'
  #   ,'ICU_STAY_10D'
  #   ,'CATH_D'
  #   ,'LOS_4D'
  #   ,'SEX_TYPE'
  #   ,'prev_DMdiag'
  #   ,'immob'
  #   ,'prev_HYP'
  #   ,'BMI_GT30'
  #   ,'prev_DMneph'
  #   ,'prev_ICHIV'
  #   ,'prev_ICNEO'
  #   ,'prev_uro'
  #   ,'prev_utidiag_6mgt2_1ygt3'
  #   ,'prev_neuro'
  # )
```

```{r Function for turning outlier to missing, include=FALSE}
outliers_to_missing=
  function(data){
    data %>%
      mutate_at(
        sapply(.,is.numeric) %>%
          .[.] %>%
          names()
        ,\(x)
          suppressWarnings(
            data.frame(variable=x) %>%
              summarize(
                q1=quantile(variable,0.25,na.rm=T)
                ,q3=quantile(variable,0.75,na.rm=T)
              ) %>%
              mutate(
                lb=q1-1.5*(q3-q1)
                ,ub=q3+1.5*(q3-q1)
              ) %>%
              cbind(data.frame(variable=x)) %>%
              mutate(
                variable=
                  ifelse(
                    variable<lb | variable>ub | is.na(variable)
                    ,NA
                    ,variable
                  )
              ) %>%
              pull(variable)
          )
      )
  }
```

```{r Impute 3+-day duration, include=FALSE}
if(all(c(2,3)%in%comp_req)){ # 10s
  impute_model_d3=
    whole_data_d3$prediction %>%
    left_join(outcome_onset_identifier,by=colnames(uri_cath_d3$prediction)) %>%
    .[partition_d3$training,cand_predictors_d3] %>%
    outliers_to_missing() %>%
    mutate(seq=seq(n())) %>%
    left_join(
      whole_data_d3$prediction %>%
        left_join(
          outcome_onset_identifier
          ,by=colnames(uri_cath_d3$prediction)
        ) %>%
        .[partition_d3$training,c('outcome','outcome_onset'),drop=F] %>%
        mutate(outcome_onset=ifelse(outcome_onset<0,NA,outcome_onset)) %>%
        mutate(seq=seq(n()))
      ,by='seq'
    ) %>%
    select(-seq) %>%
    select(outcome,outcome_onset,everything()) %>%
    mice(m=10,method='pmm',seed=seed)
  
  imputed_d3=
    partition_d3 %>%
    lapply(\(x)
      whole_data_d3$prediction %>%
        left_join(
          outcome_onset_identifier
          ,by=colnames(uri_cath_d3$prediction)
        ) %>%
        .[x,c('outcome','outcome_onset',cand_predictors_d3)]
    ) %>%
    `names<-`(names(partition_d3)) %>%
    lapply(outliers_to_missing) %>%
    lapply(\(x)mice.mids(impute_model_d3,newdata=x)) %>%
    lapply(complete) %>%
    lapply(select,-outcome,-outcome_onset) %>%
    lapply(mutate,seq=seq(n())) %>%
    lapply(X=names(.),Y=.,Z=partition_d3,\(X,Y,Z)
      Y[[X]] %>%
        left_join(
          whole_data_d3$prediction %>%
            left_join(
              outcome_onset_identifier
              ,by=colnames(uri_cath_d3$prediction)
            ) %>%
            .[Z[[X]],c('outcome','outcome_onset'),drop=F] %>%
            mutate(outcome_onset=ifelse(outcome_onset<0,NA,outcome_onset)) %>%
            mutate(seq=seq(n()))
          ,by='seq'
        ) %>%
        select(-seq) %>%
        select(outcome,outcome_onset,everything())
    ) %>%
    `names<-`(names(partition_d3))
  
  saveRDS(impute_model_d3,'data/impute_model_d3.rds')
  saveRDS(imputed_d3,'data/imputed_d3.rds')
}else{
  impute_model_d3=readRDS('data/impute_model_d3.rds')
  imputed_d3=readRDS('data/imputed_d3.rds')
}
```

```{r Impute any-day duration, include=FALSE}
if(all(c(2,3)%in%comp_req)){ # 20m 13s
  impute_model_d=
    whole_data_d$prediction %>%
    left_join(outcome_onset_identifier,by=colnames(uri_cath_d$prediction)) %>%
    .[partition_d$training,cand_predictors_d] %>%
    outliers_to_missing() %>%
    mutate(seq=seq(n())) %>%
    left_join(
      whole_data_d$prediction %>%
        left_join(
          outcome_onset_identifier
          ,by=colnames(uri_cath_d$prediction)
        ) %>%
        .[partition_d$training,c('outcome','outcome_onset'),drop=F] %>%
        mutate(outcome_onset=ifelse(outcome_onset<0,NA,outcome_onset)) %>%
        mutate(seq=seq(n()))
      ,by='seq'
    ) %>%
    select(-seq) %>%
    select(outcome,outcome_onset,everything()) %>%
    mice(m=10,method='pmm',seed=seed)
  
  imputed_d=
    partition_d %>%
    lapply(\(x)
      whole_data_d$prediction %>%
        left_join(
          outcome_onset_identifier
          ,by=colnames(uri_cath_d$prediction)
        ) %>%
        .[x,c('outcome','outcome_onset',cand_predictors_d)]
    ) %>%
    `names<-`(names(partition_d)) %>%
    lapply(outliers_to_missing) %>%
    lapply(\(x)mice.mids(impute_model_d,newdata=x)) %>%
    lapply(complete) %>%
    lapply(select,-outcome,-outcome_onset) %>%
    lapply(mutate,seq=seq(n())) %>%
    lapply(X=names(.),Y=.,Z=partition_d,\(X,Y,Z)
      Y[[X]] %>%
        left_join(
          whole_data_d$prediction %>%
            left_join(
              outcome_onset_identifier
              ,by=colnames(uri_cath_d$prediction)
            ) %>%
            .[Z[[X]],c('outcome','outcome_onset'),drop=F] %>%
            mutate(outcome_onset=ifelse(outcome_onset<0,NA,outcome_onset)) %>%
            mutate(seq=seq(n()))
          ,by='seq'
        ) %>%
        select(-seq) %>%
        select(outcome,outcome_onset,everything())
    ) %>%
    `names<-`(names(partition_d))
  
  saveRDS(impute_model_d,'data/impute_model_d.rds')
  saveRDS(imputed_d,'data/imputed_d.rds')
}else{
  impute_model_d=readRDS('data/impute_model_d.rds')
  imputed_d=readRDS('data/imputed_d.rds')
}
```

```{r Function for combining 1-365 d ranges and 1-3-7 dspans, include=FALSE}
outcome_onset_combn=
  function(data){
    data %>%
      pull(outcome_onset) %>%
      max(na.rm=T) %>%
      ceiling() %>%
      seq() %>%
      .[.<=90] %>%
      expand.grid(.,c(1,3,7)) %>%
      `colnames<-`(c('latest_onset','denominator'))
  }
```

```{r Ranges and spans of outcome onset, eval=FALSE, include=FALSE}
if(all(c(2)%in%comp_req)){ # 45s
  onset_range_span_d3=
    imputed_d3$training %>%
    pblapply(
      X=outcome_onset_combn(.) %>%
        nrow() %>%
        seq()
      ,Y=.
      ,Z=outcome_onset_combn(.)
      ,\(X,Y,Z)
        Y %>%
          filter(outcome_onset<=Z$latest_onset[X]) %>%
          mutate(outcome_onset=floor(outcome_onset/Z$denominator[X])) %>%
          group_by(outcome_onset) %>%
          summarize(n=n()) %>%
          pull(n) %>%
          min() %>%
          data.frame(min_n=.) %>%
          mutate(
            latest_onset=Z$latest_onset[X]
            ,denominator=Z$denominator[X]
          )
    ) %>%
    do.call(rbind,.)
  
  onset_range_span_d=
    imputed_d$training %>%
    pblapply(
      X=outcome_onset_combn(.) %>%
        nrow() %>%
        seq()
      ,Y=.
      ,Z=outcome_onset_combn(.)
      ,\(X,Y,Z)
        Y %>%
          filter(outcome_onset<=Z$latest_onset[X]) %>%
          mutate(outcome_onset=floor(outcome_onset/Z$denominator[X])) %>%
          group_by(outcome_onset) %>%
          summarize(n=n()) %>%
          pull(n) %>%
          min() %>%
          data.frame(min_n=.) %>%
          mutate(
            latest_onset=Z$latest_onset[X]
            ,denominator=Z$denominator[X]
          )
    ) %>%
    do.call(rbind,.)
  
  saveRDS(onset_range_span_d3,'data/onset_range_span_d3.rds')
  saveRDS(onset_range_span_d,'data/onset_range_span_d.rds')
}else{
  onset_range_span_d3=readRDS('data/onset_range_span_d3.rds')
  onset_range_span_d=readRDS('data/onset_range_span_d.rds')
}
```

```{r Function for numerizing any variable scale, include=FALSE}
numerize_var=
  function(data){
    data %>%
      mutate_at(
        sapply(.,\(x)!is.numeric(x)) %>%
          .[.] %>%
          names()
        ,\(x)as.numeric(factor(x))-1
      ) %>%
      mutate(seq=seq(n())) %>%
      gather(variable,value,-seq) %>%
      left_join(
        data %>%
          sapply(class) %>%
          data.frame(class=.) %>%
          rownames_to_column(var='variable')
        ,by='variable'
      ) %>%
      group_by(variable) %>%
      mutate(levels=length(unique(value))) %>%
      mutate(
        variable=
          ifelse(
            class%in%c('character','logical','factor')
            & levels>2
            ,paste0(variable,'_',value)
            ,variable
          )
        ,value=
          ifelse(
            class%in%c('character','logical','factor')
            & levels>2
            ,1
            ,value
          )
      ) %>%
      ungroup() %>%
      select(-class,-levels) %>%
      mutate(
        variable=
          variable %>%
          factor(unique(.))
      ) %>%
      spread(variable,value,fill=0) %>%
      arrange(seq) %>%
      select(-seq)
  }
```

```{r Function for obtaining avg and std for scaling, include=FALSE}
scaler=
  function(data){
    numeric_data=
      data %>%
      .[,sapply(.,is.numeric),drop=F]
    
    if(ncol(numeric_data)==0){
      data.frame(variable='XXX',avg=NA,std=NA)
    }else{
      numeric_data %>%
        mutate(seq=seq(n())) %>%
        gather(variable,value,-seq) %>%
        group_by(variable) %>%
        mutate(
          q1=quantile(value,0.25,na.rm=T)
          ,q3=quantile(value,0.75,na.rm=T)
        ) %>%
        mutate(
          lb=q1-1.5*(q3-q1)
          ,ub=q3+1.5*(q3-q1)
        ) %>%
        mutate(outlier=value<lb | value>ub) %>%
        summarize(
          avg=mean(ifelse(outlier,NA,value),na.rm=T)
          ,std=sd(ifelse(outlier,NA,value),na.rm=T)
        )
    }
  }
```

```{r Obtain avg and std for scaling 3+-day duration, include=FALSE}
if(all(c(2,3)%in%comp_req)){ # 04s
  cl=detectCores()-2
  start=T; source('R/parallel_computing-codes.R')
  
  scaler_d3=
    imputed_d3$training %>%
    pblapply(
      cl=cl
      ,X=
        outcome_onset_combn(.) %>%
        nrow() %>%
        seq()
      ,Y=.
      ,Z=outcome_onset_combn(.)
      ,K=numerize_var
      ,L=scaler
      ,\(X,Y,Z,K,L)
        Y %>%
          filter(outcome_onset<=Z$latest_onset[X]) %>%
          mutate(outcome_onset=floor(outcome_onset/Z$denominator[X])) %>%
          select(-outcome,-outcome_onset) %>%
          # K() %>%
          L() %>%
          mutate(
            latest_onset=Z$latest_onset[X]
            ,denominator=Z$denominator[X]
          )
    ) %>%
    do.call(rbind,.) %>%
    select(
      latest_onset,denominator
      ,everything()
    )
  
  saveRDS(scaler_d3,'data/scaler_d3.rds')
  start=F; source('R/parallel_computing-codes.R')
}else{
  scaler_d3=readRDS('data/scaler_d3.rds')
}
```

```{r Obtain avg and std for scaling any-day duration, include=FALSE}
if(all(c(2,3)%in%comp_req)){ # 20s
  cl=detectCores()-2
  start=T; source('R/parallel_computing-codes.R')
  
  scaler_d=
    imputed_d$training %>%
    pblapply(
      cl=cl
      ,X=
        outcome_onset_combn(.)%>%
        nrow() %>%
        seq()
      ,Y=.
      ,Z=outcome_onset_combn(.)
      ,K=numerize_var
      ,L=scaler
      ,\(X,Y,Z,K,L)
        Y %>%
          filter(outcome_onset<=Z$latest_onset[X]) %>%
          mutate(outcome_onset=floor(outcome_onset/Z$denominator[X])) %>%
          select(-outcome,-outcome_onset) %>%
          # K() %>%
          L() %>%
          mutate(
            latest_onset=Z$latest_onset[X]
            ,denominator=Z$denominator[X]
          )
    ) %>%
    do.call(rbind,.) %>%
    select(
      latest_onset,denominator
      ,everything()
    )
  
  saveRDS(scaler_d,'data/scaler_d.rds')
  start=F; source('R/parallel_computing-codes.R')
}else{
  scaler_d=readRDS('data/scaler_d.rds')
}
```

```{r CoxPH 3+-day duration, include=FALSE}
if(all(c(2,3)%in%comp_req)){ # 01m 07s
  cl=detectCores()-2
  start=T; source('R/parallel_computing-codes.R')
  
  coxph_d3=
    imputed_d3$training %>%
    pblapply(
      cl=cl
      ,X=
        outcome_onset_combn(.) %>%
        nrow() %>%
        seq()
      ,Y=.
      ,Z=outcome_onset_combn(.)
      ,K=cand_predictors_d3
      ,L=numerize_var
      ,M=scaler_d3
      ,\(X,Y,Z,K,L,M)
        Y %>%
          filter(outcome_onset<=Z$latest_onset[X]) %>%
          mutate(outcome_onset=floor(outcome_onset/Z$denominator[X])) %>%
          lapply(
            X=1
            ,Y=.
            ,\(X,Y)
              list(
                  non_standardized=
                    Y %>%
                    select_at(c('outcome','outcome_onset'))
                  ,standardized=
                    Y %>%
                    select_at(K)
                  # %>%
                  #   L()
                ) %>%
                `names<-`(NULL)
          ) %>%
          .[[1]] %>%
          do.call(cbind,.) %>%
          lapply(
            X=colnames(.)
            ,Y=.
            ,\(X,Y)
              Y %>%
                select_at(X) %>%
                mutate(seq=seq(n())) %>%
                gather(variable,value,-seq) %>%
                left_join(
                  M %>%
                    filter(
                      latest_onset==Z$latest_onset[X]
                      & denominator==Z$denominator[X]
                    ) %>%
                    select(-latest_onset,-denominator)
                  ,by='variable'
                ) %>%
                mutate(
                  value=
                    ifelse(
                      is.na(avg)
                      ,value
                      ,(value-avg)/std
                    )
                ) %>%
                select(-avg,-std) %>%
                lapply(X=1,Y=.,Z=Y[[X]],\(X,Y,Z)
                  list(
                    Y
                    ,Y %>%
                      mutate(value=factor(value,levels(Z)))
                  )
                ) %>%
                .[[1]] %>%
                .[[ifelse(class(.[[1]]$value)=='character',2,1)]] %>%
                spread(variable,value) %>%
                arrange(seq) %>%
                select(-seq)
          ) %>%
          do.call(cbind,.) %>%
          .[,sapply(.,\(x)!all(is.nan(x)|is.infinite(x)))] %>%
          mutate(km_outcome=Surv(outcome_onset,outcome)) %>%
          lapply(
            X=colnames(.) %>%
              .[!.%in%c('km_outcome','outcome','outcome_onset')]
            ,Y=.
            ,\(X,Y)
              select_at(Y,c('km_outcome',X))
          ) %>%
          lapply(\(x)suppressWarnings(x %>% coxph(km_outcome~.,data=.))) %>%
          lapply(broom::tidy) %>%
          do.call(rbind,.) %>%
          mutate(
            predictor=
              term %>%
              str_remove_all(
                paste0(
                  c('TRUE$'
                    ,'FALSE$'
                    ,'\\(numeric\\)'
                    ,'[<=>]+[:digit:]+\\s*t*o*\\s*[:digit:]*'
                    ,'[MF]$'
                  )
                  ,collapse='|'
                )
              )
            ,category=
              term %>%
              str_remove_all(predictor) %>%
              str_remove_all('_')
            ,category=ifelse(category=='','(numeric)',category)
          ) %>%
          select(-term) %>%
          select(predictor,everything()) %>%
          mutate(
            latest_onset=Z$latest_onset[X]
            ,denominator=Z$denominator[X]
          )
    ) %>%
    do.call(rbind,.) %>%
    mutate(
      OR=exp(estimate)
      ,L95=exp(estimate-qnorm(0.975)*std.error)
      ,U95=exp(estimate+qnorm(0.975)*std.error)
    ) %>%
    select(
      latest_onset,denominator
      ,predictor,category,OR,L95,U95,p.value
      ,everything()
    )
  
  saveRDS(coxph_d3,'data/coxph_d3.rds')
  start=F; source('R/parallel_computing-codes.R')
}else{
  coxph_d3=readRDS('data/coxph_d3.rds')
}
```

```{r CoxPH any-day duration, include=FALSE}
if(all(c(2,3)%in%comp_req)){ # 05m 47s
  cl=detectCores()-2
  start=T; source('R/parallel_computing-codes.R')
  
  coxph_d=
    imputed_d$training %>%
    pblapply(
      cl=cl
      ,X=
        outcome_onset_combn(.) %>%
        nrow() %>%
        seq()
      ,Y=.
      ,Z=outcome_onset_combn(.)
      ,K=cand_predictors_d
      ,L=numerize_var
      ,M=scaler_d
      ,\(X,Y,Z,K,L,M)
        Y %>%
          filter(outcome_onset<=Z$latest_onset[X]) %>%
          mutate(outcome_onset=floor(outcome_onset/Z$denominator[X])) %>%
          lapply(
            X=1
            ,Y=.
            ,\(X,Y)
              list(
                  non_standardized=
                    Y %>%
                    select_at(c('outcome','outcome_onset'))
                  ,standardized=
                    Y %>%
                    select_at(K)
                  # %>%
                  #   L()
                ) %>%
                `names<-`(NULL)
          ) %>%
          .[[1]] %>%
          do.call(cbind,.) %>%
          lapply(
            X=colnames(.)
            ,Y=.
            ,\(X,Y)
              Y %>%
                select_at(X) %>%
                mutate(seq=seq(n())) %>%
                gather(variable,value,-seq) %>%
                left_join(
                  M %>%
                    filter(
                      latest_onset==Z$latest_onset[X]
                      & denominator==Z$denominator[X]
                    ) %>%
                    select(-latest_onset,-denominator)
                  ,by='variable'
                ) %>%
                mutate(
                  value=
                    ifelse(
                      is.na(avg)
                      ,value
                      ,(value-avg)/std
                    )
                ) %>%
                select(-avg,-std) %>%
                lapply(X=1,Y=.,Z=Y[[X]],\(X,Y,Z)
                  list(
                    Y
                    ,Y %>%
                      mutate(value=factor(value,levels(Z)))
                  )
                ) %>%
                .[[1]] %>%
                .[[ifelse(class(.[[1]]$value)=='character',2,1)]] %>%
                spread(variable,value) %>%
                arrange(seq) %>%
                select(-seq)
          ) %>%
          do.call(cbind,.) %>%
          .[,sapply(.,\(x)!all(is.nan(x)|is.infinite(x)))] %>%
          mutate(km_outcome=Surv(outcome_onset,outcome)) %>%
          lapply(
            X=colnames(.) %>%
              .[!.%in%c('km_outcome','outcome','outcome_onset')]
            ,Y=.
            ,\(X,Y)
              select_at(Y,c('km_outcome',X))
          ) %>%
          lapply(\(x)suppressWarnings(x %>% coxph(km_outcome~.,data=.))) %>%
          lapply(broom::tidy) %>%
          do.call(rbind,.) %>%
          mutate(
            predictor=
              term %>%
              str_remove_all(
                paste0(
                  c('TRUE$'
                    ,'FALSE$'
                    ,'\\(numeric\\)'
                    ,'[<=>]+[:digit:]+\\s*t*o*\\s*[:digit:]*'
                    ,'[MF]$'
                  )
                  ,collapse='|'
                )
              )
            ,category=
              term %>%
              str_remove_all(predictor) %>%
              str_remove_all('_')
            ,category=ifelse(category=='','(numeric)',category)
          ) %>%
          select(-term) %>%
          select(predictor,everything()) %>%
          mutate(
            latest_onset=Z$latest_onset[X]
            ,denominator=Z$denominator[X]
          )
    ) %>%
    do.call(rbind,.) %>%
    mutate(
      OR=exp(estimate)
      ,L95=exp(estimate-qnorm(0.975)*std.error)
      ,U95=exp(estimate+qnorm(0.975)*std.error)
    ) %>%
    select(
      latest_onset,denominator
      ,predictor,category,OR,L95,U95,p.value
      ,everything()
    )
  
  saveRDS(coxph_d,'data/coxph_d.rds')
  start=F; source('R/parallel_computing-codes.R')
}else{
  coxph_d=readRDS('data/coxph_d.rds')
}
```


```{r Determine common onset range-span, eval=FALSE, include=FALSE}
coxph_d3 %>%
  left_join(
    onset_range_span_d3
    ,by=c('latest_onset','denominator')
  ) %>%
  # filter(denominator==1) %>%
  filter(latest_onset>=(5*denominator)) %>%
  filter(min_n>0) %>%
  mutate(FDR=p.adjust(p.value,method='BH')) %>%
  filter(
    paste0(latest_onset,':',denominator)
    %in%pull(
      filter(.,FDR<=0.05) %>%
        unite(latest_onset_denominator,latest_onset,denominator,sep=':')
      ,latest_onset_denominator
    )
  ) %>%
  arrange(desc(latest_onset)) %>%
  filter(min_n==max(min_n))

coxph_d %>%
  left_join(
    onset_range_span_d
    ,by=c('latest_onset','denominator')
  ) %>%
  # filter(denominator==1) %>%
  filter(latest_onset>=(5*denominator)) %>%
  filter(min_n>0) %>%
  mutate(FDR=p.adjust(p.value,method='BH')) %>%
  filter(
    paste0(latest_onset,':',denominator)
    %in%pull(
      filter(.,FDR<=0.05) %>%
        unite(latest_onset_denominator,latest_onset,denominator,sep=':')
      ,latest_onset_denominator
    )
  ) %>%
  arrange(desc(latest_onset)) %>%
  filter(min_n==max(min_n))
```

```{r Determine range and span of outcome onset, include=FALSE}
range_span_d3=list(r=24,s=3)
range_span_d=list(r=15,s=3)
```

```{r Function for numerizing and scaling predictors, include=FALSE}
numerize_scale=
  function(data,rs,cand_predictors,scaler_df){
    data %>%
      lapply(
        X=1
        ,Y=.
        ,Z=
          rs %>%
          as.data.frame() %>%
          rename(latest_onset=r,denominator=s)
        ,K=cand_predictors
        ,L=numerize_var
        ,M=scaler_d
        ,\(X,Y,Z,K,L,M)
          Y %>%
            lapply(
              X=1
              ,Y=.
              ,\(X,Y)
                list(
                    non_standardized=
                      Y %>%
                      select_at(c('outcome','outcome_onset'))
                    ,standardized=
                      Y %>%
                      select_at(K)
                    # %>%
                    #   L()
                  ) %>%
                  `names<-`(NULL)
            ) %>%
            .[[1]] %>%
            do.call(cbind,.) %>%
            lapply(
              X=colnames(.)
              ,Y=.
              ,\(X,Y)
                Y %>%
                  select_at(X) %>%
                  mutate(seq=seq(n())) %>%
                  gather(variable,value,-seq) %>%
                  left_join(
                    M %>%
                      filter(
                        latest_onset==Z$latest_onset[X]
                        & denominator==Z$denominator[X]
                      ) %>%
                      select(-latest_onset,-denominator)
                    ,by='variable'
                  ) %>%
                  mutate(
                    value=
                      ifelse(
                        is.na(avg)
                        ,value
                        ,(value-avg)/std
                      )
                  ) %>%
                  select(-avg,-std) %>%
                  lapply(X=1,Y=.,Z=Y[[X]],\(X,Y,Z)
                    list(
                      Y
                      ,Y %>%
                        mutate(value=factor(value,levels(Z)))
                    )
                  ) %>%
                  .[[1]] %>%
                  .[[ifelse(class(.[[1]]$value)=='character',2,1)]] %>%
                  spread(variable,value) %>%
                  arrange(seq) %>%
                  select(-seq)
            ) %>%
            do.call(cbind,.) %>%
            .[,sapply(.,\(x)!all(is.nan(x)|is.infinite(x)))]
      ) %>%
      do.call(rbind,.)
  }
```

```{r Selected range-span, include=FALSE}
null_surv_d3=
  imputed_d3$training %>%
  filter(outcome_onset<=range_span_d3$r) %>%
  mutate(outcome_onset=floor(outcome_onset/range_span_d3$s)) %>%
  numerize_scale(range_span_d3,cand_predictors_d3,scaler_d3) %>%
  ggsurvplot(
    fit=survfit(Surv(outcome_onset,outcome)~1,data=.)
    ,data=.
    ,risk.table=T
    ,pval=F
    ,conf.int=T
  ) %>%
  lapply(X=1,Y=.,\(X,Y)
    ggarrange(
      Y[[1]] +
        ylab("Event Rate") +
        scale_x_continuous(labels=\(x)x*range_span_d3$s) +
        scale_y_reverse(labels=\(x)1-x)
      ,Y[[2]]
      ,ncol=1,nrow=2,heights=c(3,1)
    )
  ) %>%
  .[[1]]

null_surv_d=
  imputed_d$training %>%
  filter(outcome_onset<=range_span_d$r) %>%
  mutate(outcome_onset=floor(outcome_onset/range_span_d$s)) %>%
  numerize_scale(range_span_d,cand_predictors_d,scaler_d) %>%
  ggsurvplot(
    fit=survfit(Surv(outcome_onset,outcome)~1,data=.)
    ,data=.
    ,risk.table=T
    ,pval=F
    ,conf.int=T
  ) %>%
  lapply(X=1,Y=.,\(X,Y)
    ggarrange(
      Y[[1]] +
        ylab("Event Rate") +
        scale_x_continuous(labels=\(x)x*range_span_d$s) +
        scale_y_reverse(labels=\(x)1-x)
      ,Y[[2]]
      ,ncol=1
      ,nrow=2
      ,heights=c(3,1)
    )
  ) %>%
  .[[1]]
```

```{r Plot selected range-span, eval=FALSE, fig.height=6, fig.width=12, include=FALSE}
ggarrange(
  null_surv_d3
  ,null_surv_d
  ,ncol=2
  ,nrow=1
  ,widths=c(1,1)
)
```

```{r Univariate analysis results, eval=FALSE, include=FALSE}
coxph_d3 %>%
  filter(latest_onset==range_span_d3$r & denominator==range_span_d3$s) %>%
  select(-latest_onset,-denominator) %>%
  mutate(FDR=p.adjust(p.value,method='BH')) %>%
  filter(FDR<=0.05) %>%
  filter(L95>=1|U95<=(1/1)) %>%
  select(-estimate,-std.error,-statistic) %>%
  mutate_at(
    .[,sapply(.,is.numeric)] %>%
      colnames()
    ,\(x)ifelse(x<0.001,'<0.001',round(x,3))
  )

coxph_d %>%
  filter(latest_onset==range_span_d$r & denominator==range_span_d$s) %>%
  select(-latest_onset,-denominator) %>%
  mutate(FDR=p.adjust(p.value,method='BH')) %>%
  filter(FDR<=0.05) %>%
  filter(L95>=1|U95<=(1/1)) %>%
  select(-estimate,-std.error,-statistic) %>%
  mutate_at(
    .[,sapply(.,is.numeric)] %>%
      colnames()
    ,\(x)ifelse(x<0.001,'<0.001',round(x,3))
  )
```

```{r Select candidate predictors based on univariate analysis, include=FALSE}
cand_predictors2_d3=
  cand_predictors_d3 %>%
  .[.%in%pull(
    coxph_d3 %>%
      filter(latest_onset==range_span_d3$r & denominator==range_span_d3$s) %>%
      mutate(FDR=p.adjust(p.value,method='BH')) %>%
      filter(FDR<=0.05) %>%
      filter(L95>=1|U95<=(1/1))
    ,predictor
  )]

cand_predictors2_d=
  cand_predictors_d %>%
  .[.%in%pull(
    coxph_d %>%
      filter(latest_onset==range_span_d$r & denominator==range_span_d$s) %>%
      mutate(FDR=p.adjust(p.value,method='BH')) %>%
      filter(FDR<=0.05) %>%
      filter(L95>=1|U95<=(1/1))
    ,predictor
  )]
```

```{r Function for interpredictor association testing, include=FALSE}
inter_predictor_association=
  function(imputed_training,cand_predictors){
    cand_predictors %>%
      combn(2) %>%
      split(col(.)) %>%
      # lapply(\(x)
      #   c(ifelse(
      #         str_remove_all(x[1],'_[:digit:]+')
      #         ==str_remove_all(x[2],'_[:digit:]+')
      #         ,NA
      #         ,x[1]
      #       )
      #       ,ifelse(
      #         str_remove_all(x[1],'_[:digit:]+')
      #         ==str_remove_all(x[2],'_[:digit:]+')
      #         ,NA
      #         ,x[2]
      #       )
      #     )
      # ) %>%
      # .[sapply(.,\(x)!any(is.na(x)))] %>%
      lapply(\(x)
        x %>%
          lapply(\(x)imputed_training[[x]]) %>%
          sapply(is.numeric) %>%
          `names<-`(x)
      ) %>%
      lapply(sort) %>%
      lapply(\(x)
        list(
          method=
            ifelse(
              all(x)
              ,\(formula,data,...) lm(formula,data,...)
              ,\(formula,data,...) glm(formula,data,family=binomial(),...)
            )
          ,formula=
            x %>%
            names() %>%
            paste0(collapse='~') %>%
            as.formula()
        )
      ) %>%
      pblapply(\(x)
        x$method(
            x$formula
            ,data=imputed_training
          ) %>%
          broom::tidy() %>%
          mutate(formula=paste0(as.character(x$formula)[c(2,1,3)],collapse=''))
      ) %>%
      do.call(rbind,.) %>%
      filter(term!='(Intercept)') %>%
      mutate(
        category=
          term %>%
          str_remove_all(
            paste0(
              c('TRUE$'
                ,'FALSE$'
                ,'\\(numeric\\)'
                ,'[<=>]+[:digit:]+\\s*t*o*\\s*[:digit:]*'
                ,'[MF]$'
              )
              ,collapse='|'
            )
          )
        ,target=
          formula %>%
          str_remove_all(category) %>%
          str_remove_all('~')
        ,term=
          term %>%
          str_remove_all(category) %>%
          str_remove_all('_')
        ,term=ifelse(term=='','(numeric)',term)
      ) %>%
      select(-formula) %>%
      mutate(
        OR=exp(estimate)
        ,L95=exp(estimate-qnorm(0.975)*std.error)
        ,U95=exp(estimate+qnorm(0.975)*std.error)
      ) %>%
      select(
        target,category,term,OR,L95,U95,p.value
        ,everything()
      )
  }
```

```{r Interpredictor association test, include=FALSE}
inter_predictor_assoc_d3=
  imputed_d3$training %>%
  filter(outcome_onset<=range_span_d3$r) %>%
  mutate(outcome_onset=floor(outcome_onset/range_span_d3$s)) %>%
  numerize_scale(range_span_d3,cand_predictors2_d3,scaler_d3) %>%
  inter_predictor_association(
    colnames(.) %>%
      .[!.%in%c('km_outcome','outcome','outcome_onset')]
  )
  
inter_predictor_assoc_d=
  imputed_d$training %>%
  filter(outcome_onset<=range_span_d$r) %>%
  mutate(outcome_onset=floor(outcome_onset/range_span_d$s))%>%
  numerize_scale(range_span_d,cand_predictors2_d,scaler_d) %>%
  inter_predictor_association(
    colnames(.) %>%
      .[!.%in%c('km_outcome','outcome','outcome_onset')]
  )
```

```{r Interpredictor association test results, eval=FALSE, include=FALSE}
inter_predictor_assoc_d3 %>%
  mutate(FDR=p.adjust(p.value,method='BH')) %>%
  filter(FDR<=0.05) %>%
  filter(L95>=1|U95<=(1/1)) %>%
  select(-estimate,-std.error,-statistic) %>%
  mutate_at(
    .[,sapply(.,is.numeric)] %>%
      colnames()
    ,\(x)ifelse(x<0.001,'<0.001',round(x,3))
  )

inter_predictor_assoc_d %>%
  mutate(FDR=p.adjust(p.value,method='BH')) %>%
  filter(FDR<=0.05) %>%
  filter(L95>=1|U95<=(1/1)) %>%
  select(-estimate,-std.error,-statistic) %>%
  mutate_at(
    .[,sapply(.,is.numeric)] %>%
      colnames()
    ,\(x)ifelse(x<0.001,'<0.001',round(x,3))
  )
```

```{r Report interpredictor association test results, eval=FALSE, include=FALSE}
inter_predictor_assoc_d3 %>%
  mutate(FDR=p.adjust(p.value,method='BH')) %>%
  filter(FDR<=0.05) %>%
  filter(L95>=1|U95<=(1/1)) %>%
  select(-estimate,-std.error,-statistic) %>%
  mutate_at(
    .[,sapply(.,is.numeric)] %>%
      colnames()
    ,\(x)ifelse(x<0.001,'<0.001',round(x,3))
  ) %>%
  write_csv('data/sig_inter_predictor_assoc_d3.csv')

inter_predictor_assoc_d %>%
  mutate(FDR=p.adjust(p.value,method='BH')) %>%
  filter(FDR<=0.05) %>%
  filter(L95>=1|U95<=(1/1)) %>%
  select(-estimate,-std.error,-statistic) %>%
  mutate_at(
    .[,sapply(.,is.numeric)] %>%
      colnames()
    ,\(x)ifelse(x<0.001,'<0.001',round(x,3))
  ) %>%
  write_csv('data/sig_inter_predictor_assoc_d.csv')
```

```{r Function to identify adjusment variables, include=FALSE}
identify_adj_vars=
  function(data,inter_predictor_assoc,effect_size=1){
    data %>%
      colnames(.) %>%
      .[!.%in%c('km_outcome','outcome','outcome_onset')] %>%
      `names<-`(
        lapply(
            X=.
            ,Y=
              inter_predictor_assoc %>%
              mutate(FDR=p.adjust(p.value,method='BH')) %>%
              filter(FDR<=0.05) %>%
              filter(L95>=effect_size|U95<=(1/effect_size)) %>%
              select(target,category) %>%
              filter(!duplicated(.))
            ,\(X,Y)
              Y %>%
                filter(target==X|category==X) %>%
                unlist() %>%
                unique() %>%
                .[.!=X] %>%
                c(X) %>%
                .[c(length(.),seq(length(.)) %>% .[.!=length(.)])]
          )
        ,.
      )
  }
```

```{r Identify adjusment variables, include=FALSE}
adjustment_variable_d3=
  imputed_d3$training %>%
  filter(outcome_onset<=range_span_d3$r) %>%
  mutate(outcome_onset=floor(outcome_onset/range_span_d3$s)) %>%
  numerize_scale(range_span_d3,cand_predictors2_d3,scaler_d3) %>%
  mutate(km_outcome=Surv(outcome_onset,outcome)) %>%
  identify_adj_vars(inter_predictor_assoc_d3,effect_size=1) %>%
  lapply(\(x)x[-1]) %>%
  sapply(paste0,collapse='+') %>%
  data.frame(adjustment_variables=.) %>%
  rownames_to_column(var='predictor')

adjustment_variable_d=
  imputed_d$training %>%
  filter(outcome_onset<=range_span_d$r) %>%
  mutate(outcome_onset=floor(outcome_onset/range_span_d$s)) %>%
  numerize_scale(range_span_d,cand_predictors2_d,scaler_d) %>%
  mutate(km_outcome=Surv(outcome_onset,outcome)) %>%
  identify_adj_vars(inter_predictor_assoc_d,effect_size=1) %>%
  lapply(\(x)x[-1]) %>%
  sapply(paste0,collapse='+') %>%
  data.frame(adjustment_variables=.) %>%
  rownames_to_column(var='predictor')
```

```{r CoxPH-adjusted 3+-day duration, include=FALSE}
coxph_adj_d3=
  imputed_d3$training %>%
  filter(outcome_onset<=range_span_d3$r) %>%
  mutate(outcome_onset=floor(outcome_onset/range_span_d3$s)) %>%
  numerize_scale(range_span_d3,cand_predictors2_d3,scaler_d3) %>%
  mutate(km_outcome=Surv(outcome_onset,outcome)) %>%
  lapply(
    X=colnames(.) %>%
      .[!.%in%c('km_outcome','outcome','outcome_onset')]
    ,Y=.
    ,Z=identify_adj_vars(.,inter_predictor_assoc_d3)
    ,\(X,Y,Z)
      suppressWarnings(
        Y %>%
          select_at(c('km_outcome',Z[[X]])) %>%
          coxph(km_outcome~.,data=.) %>%
          broom::tidy() %>%
          slice(1) %>%
          mutate(
            predictor=
              term %>%
              str_remove_all(
                paste0(
                  c('TRUE$'
                    ,'FALSE$'
                    ,'\\(numeric\\)'
                    ,'[<=>]+[:digit:]+\\s*t*o*\\s*[:digit:]*'
                    ,'[MF]$'
                  )
                  ,collapse='|'
                )
              )
            ,category=
              term %>%
              str_remove_all(predictor) %>%
              str_remove_all('_')
            ,category=ifelse(category=='','(numeric)',category)
          ) %>%
          select(-term) %>%
          select(predictor,everything()) %>%
          filter(predictor==X)
      )
  ) %>%
  do.call(rbind,.) %>%
  mutate(
    OR=exp(estimate)
    ,L95=exp(estimate-qnorm(0.975)*std.error)
    ,U95=exp(estimate+qnorm(0.975)*std.error)
  ) %>%
  select(
    predictor,category,OR,L95,U95,p.value
    ,everything()
  )

coxph_adj_d=
  imputed_d$training %>%
  filter(outcome_onset<=range_span_d$r) %>%
  mutate(outcome_onset=floor(outcome_onset/range_span_d$s)) %>%
  numerize_scale(range_span_d,cand_predictors2_d,scaler_d) %>%
  mutate(km_outcome=Surv(outcome_onset,outcome)) %>%
  lapply(
    X=colnames(.) %>%
      .[!.%in%c('km_outcome','outcome','outcome_onset')]
    ,Y=.
    ,Z=identify_adj_vars(.,inter_predictor_assoc_d)
    ,\(X,Y,Z)
      suppressWarnings(
        Y %>%
          select_at(c('km_outcome',Z[[X]])) %>%
          coxph(km_outcome~.,data=.) %>%
          broom::tidy() %>%
          mutate(
            predictor=
              term %>%
              str_remove_all(
                paste0(
                  c('TRUE$'
                    ,'FALSE$'
                    ,'\\(numeric\\)'
                    ,'[<=>]+[:digit:]+\\s*t*o*\\s*[:digit:]*'
                    ,'[MF]$'
                  )
                  ,collapse='|'
                )
              )
            ,category=
              term %>%
              str_remove_all(predictor) %>%
              str_remove_all('_')
            ,category=ifelse(category=='','(numeric)',category)
          ) %>%
          select(-term) %>%
          select(predictor,everything()) %>%
          filter(predictor==X)
      )
  ) %>%
  do.call(rbind,.) %>%
  mutate(
    OR=exp(estimate)
    ,L95=exp(estimate-qnorm(0.975)*std.error)
    ,U95=exp(estimate+qnorm(0.975)*std.error)
  ) %>%
  select(
    predictor,category,OR,L95,U95,p.value
    ,everything()
  )
```

```{r Multivariate analysis results, eval=FALSE, include=FALSE}
coxph_adj_d3 %>%
  mutate(FDR=p.adjust(p.value,method='BH')) %>%
  filter(FDR<=0.05) %>%
  filter(L95>=1|U95<=(1/1)) %>%
  select(-estimate,-std.error,-statistic) %>%
  mutate_at(
    .[,sapply(.,is.numeric)] %>%
      colnames()
    ,\(x)ifelse(x<0.001,'<0.001',round(x,3))
  )

coxph_adj_d %>%
  mutate(FDR=p.adjust(p.value,method='BH')) %>%
  filter(FDR<=0.05) %>%
  filter(L95>=1|U95<=(1/1)) %>%
  select(-estimate,-std.error,-statistic) %>%
  mutate_at(
    .[,sapply(.,is.numeric)] %>%
      colnames()
    ,\(x)ifelse(x<0.001,'<0.001',round(x,3))
  )
```

```{r Select candidate predictors based on multivariate analysis, include=FALSE}
cand_predictors3_d3=
  cand_predictors2_d3 %>%
  .[.%in%pull(
    coxph_adj_d3 %>%
      mutate(FDR=p.adjust(p.value,method='BH')) %>%
      filter(FDR<=0.05)
    ,predictor
  )]

cand_predictors3_d=
  cand_predictors2_d %>%
  .[.%in%pull(
    coxph_adj_d %>%
      mutate(FDR=p.adjust(p.value,method='BH')) %>%
      filter(FDR<=0.05) %>%
      filter(L95>=1|U95<=(1/1))
    ,predictor
  )]
```

```{r Univar-KM sel. cand. predictors by multivariate analysis, include=FALSE}
univar_surv_d3=list()

univar_surv_d3$poor_nutr=
  imputed_d3$training %>%
  filter(outcome_onset<=range_span_d3$r) %>%
  mutate(outcome_onset=floor(outcome_onset/range_span_d3$s)) %>%
  numerize_scale(range_span_d3,cand_predictors3_d3,scaler_d3) %>%
  ggsurvplot(
    fit=survfit(Surv(outcome_onset,outcome)~poor_nutr,data=.)
    ,data=.
    ,risk.table=T
    ,pval=F
    ,conf.int=T
  ) %>%
  .[1:2]

univar_surv_d3=
  univar_surv_d3 %>%
  lapply(\(x)
    ggarrange(
      x[[1]] +
        ylab("Event Rate") +
        scale_x_continuous(labels=\(x)x*range_span_d3$s) +
        scale_y_reverse(labels=\(x)1-x)
      ,x[[2]]
      ,ncol=1
      ,nrow=2
      ,heights=c(3,1)
    )
  )

univar_surv_d=list()

univar_surv_d$AGE_GROUP=
  imputed_d$training %>%
  filter(outcome_onset<=range_span_d$r) %>%
  mutate(outcome_onset=floor(outcome_onset/range_span_d$s)) %>%
  numerize_scale(range_span_d,cand_predictors3_d,scaler_d) %>%
  ggsurvplot(
    fit=survfit(Surv(outcome_onset,outcome)~AGE_GROUP,data=.)
    ,data=.
    ,risk.table=T
    ,pval=F
    ,conf.int=T
  )

univar_surv_d$ICU_STAY_10D=
  imputed_d$training %>%
  filter(outcome_onset<=range_span_d$r) %>%
  mutate(outcome_onset=floor(outcome_onset/range_span_d$s)) %>%
  numerize_scale(range_span_d,cand_predictors3_d,scaler_d) %>%
  ggsurvplot(
    fit=survfit(Surv(outcome_onset,outcome)~ICU_STAY_10D,data=.)
    ,data=.
    ,risk.table=T
    ,pval=F
    ,conf.int=T
  )

univar_surv_d$LOS_4D=
  imputed_d$training %>%
  filter(outcome_onset<=range_span_d$r) %>%
  mutate(outcome_onset=floor(outcome_onset/range_span_d$s)) %>%
  numerize_scale(range_span_d,cand_predictors3_d,scaler_d) %>%
  ggsurvplot(
    fit=survfit(Surv(outcome_onset,outcome)~LOS_4D,data=.)
    ,data=.
    ,risk.table=T
    ,pval=F
    ,conf.int=T
  )

univar_surv_d$SEX_TYPE=
  imputed_d$training %>%
  filter(outcome_onset<=range_span_d$r) %>%
  mutate(outcome_onset=floor(outcome_onset/range_span_d$s)) %>%
  numerize_scale(range_span_d,cand_predictors3_d,scaler_d) %>%
  ggsurvplot(
    fit=survfit(Surv(outcome_onset,outcome)~SEX_TYPE,data=.)
    ,data=.
    ,risk.table=T
    ,pval=F
    ,conf.int=T
  )

univar_surv_d$prev_DMdiag=
  imputed_d$training %>%
  filter(outcome_onset<=range_span_d$r) %>%
  mutate(outcome_onset=floor(outcome_onset/range_span_d$s)) %>%
  numerize_scale(range_span_d,cand_predictors3_d,scaler_d) %>%
  ggsurvplot(
    fit=survfit(Surv(outcome_onset,outcome)~prev_DMdiag,data=.)
    ,data=.
    ,risk.table=T
    ,pval=F
    ,conf.int=T
  )

univar_surv_d$immob=
  imputed_d$training %>%
  filter(outcome_onset<=range_span_d$r) %>%
  mutate(outcome_onset=floor(outcome_onset/range_span_d$s)) %>%
  numerize_scale(range_span_d,cand_predictors3_d,scaler_d) %>%
  ggsurvplot(
    fit=survfit(Surv(outcome_onset,outcome)~immob,data=.)
    ,data=.
    ,risk.table=T
    ,pval=F
    ,conf.int=T
  )

univar_surv_d$prev_HYP=
  imputed_d$training %>%
  filter(outcome_onset<=range_span_d$r) %>%
  mutate(outcome_onset=floor(outcome_onset/range_span_d$s)) %>%
  numerize_scale(range_span_d,cand_predictors3_d,scaler_d) %>%
  ggsurvplot(
    fit=survfit(Surv(outcome_onset,outcome)~prev_HYP,data=.)
    ,data=.
    ,risk.table=T
    ,pval=F
    ,conf.int=T
  )

univar_surv_d$prev_DMneph=
  imputed_d$training %>%
  filter(outcome_onset<=range_span_d$r) %>%
  mutate(outcome_onset=floor(outcome_onset/range_span_d$s)) %>%
  numerize_scale(range_span_d,cand_predictors3_d,scaler_d) %>%
  ggsurvplot(
    fit=survfit(Surv(outcome_onset,outcome)~prev_DMneph,data=.)
    ,data=.
    ,risk.table=T
    ,pval=F
    ,conf.int=T
  )

univar_surv_d$prev_ICHIV=
  imputed_d$training %>%
  filter(outcome_onset<=range_span_d$r) %>%
  mutate(outcome_onset=floor(outcome_onset/range_span_d$s)) %>%
  numerize_scale(range_span_d,cand_predictors3_d,scaler_d) %>%
  ggsurvplot(
    fit=survfit(Surv(outcome_onset,outcome)~prev_ICHIV,data=.)
    ,data=.
    ,risk.table=T
    ,pval=F
    ,conf.int=T
  )

univar_surv_d$prev_ICNEO=
  imputed_d$training %>%
  filter(outcome_onset<=range_span_d$r) %>%
  mutate(outcome_onset=floor(outcome_onset/range_span_d$s)) %>%
  numerize_scale(range_span_d,cand_predictors3_d,scaler_d) %>%
  ggsurvplot(
    fit=survfit(Surv(outcome_onset,outcome)~prev_ICNEO,data=.)
    ,data=.
    ,risk.table=T
    ,pval=F
    ,conf.int=T
  )

univar_surv_d$prev_uro=
  imputed_d$training %>%
  filter(outcome_onset<=range_span_d$r) %>%
  mutate(outcome_onset=floor(outcome_onset/range_span_d$s)) %>%
  numerize_scale(range_span_d,cand_predictors3_d,scaler_d) %>%
  ggsurvplot(
    fit=survfit(Surv(outcome_onset,outcome)~prev_uro,data=.)
    ,data=.
    ,risk.table=T
    ,pval=F
    ,conf.int=T
  )

univar_surv_d$prev_utidiag_6mgt2_1ygt3=
  imputed_d$training %>%
  filter(outcome_onset<=range_span_d$r) %>%
  mutate(outcome_onset=floor(outcome_onset/range_span_d$s)) %>%
  numerize_scale(range_span_d,cand_predictors3_d,scaler_d) %>%
  ggsurvplot(
    fit=survfit(Surv(outcome_onset,outcome)~prev_utidiag_6mgt2_1ygt3,data=.)
    ,data=.
    ,risk.table=T
    ,pval=F
    ,conf.int=T
  )

univar_surv_d$prev_neuro=
  imputed_d$training %>%
  filter(outcome_onset<=range_span_d$r) %>%
  mutate(outcome_onset=floor(outcome_onset/range_span_d$s)) %>%
  numerize_scale(range_span_d,cand_predictors3_d,scaler_d) %>%
  ggsurvplot(
    fit=survfit(Surv(outcome_onset,outcome)~prev_neuro,data=.)
    ,data=.
    ,risk.table=T
    ,pval=F
    ,conf.int=T
  )

univar_surv_d=
  univar_surv_d %>%
  lapply(\(x)
    ggarrange(
      x[[1]] +
        ylab("Event Rate") +
        scale_x_continuous(labels=\(x)x*range_span_d$s) +
        scale_y_reverse(labels=\(x)1-x)
      ,x[[2]]
      ,ncol=1
      ,nrow=2
      ,heights=c(3,1)
    )
  )
```

```{r Plot KM sel. cand. predictors, eval=FALSE, fig.height=30, fig.width=18, include=FALSE}
ggarrange(
  null_surv_d3
  ,univar_surv_d3$poor_nutr
  ,null_surv_d
  
  ,univar_surv_d$AGE_GROUP
  ,univar_surv_d$ICU_STAY_10D
  ,univar_surv_d$LOS_4D
  
  ,univar_surv_d$SEX_TYPE
  ,univar_surv_d$prev_DMdiag
  ,univar_surv_d$immob
  
  ,univar_surv_d$prev_HYP
  ,univar_surv_d$prev_DMneph
  ,univar_surv_d$prev_ICHIV
  
  ,univar_surv_d$prev_ICNEO
  ,univar_surv_d$prev_uro
  ,univar_surv_d$prev_utidiag_6mgt2_1ygt3
  
  ,ncol=3
  ,nrow=5
  ,labels=letters[1:15]
)
```

```{r Plot KM sel. cand. predictors 2, eval=FALSE, fig.height=24, fig.width=24, include=FALSE}
ggarrange(
  null_surv_d
  ,univar_surv_d$AGE_GROUP
  ,univar_surv_d$ICU_STAY_10D
  ,univar_surv_d$LOS_4D
  
  ,univar_surv_d$SEX_TYPE
  ,univar_surv_d$prev_DMdiag
  ,univar_surv_d$immob
  ,univar_surv_d$prev_HYP
  
  ,univar_surv_d$prev_DMneph
  ,univar_surv_d$prev_ICHIV
  ,univar_surv_d$prev_ICNEO
  ,univar_surv_d$prev_uro
  
  ,univar_surv_d$prev_utidiag_6mgt2_1ygt3
  
  ,ncol=4
  ,nrow=4
  ,labels=letters[1:13]
)
```

```{r Function for preparing predictor selection results}
report_predictor_selection=
  function(coxph_unadj,coxph_adj,adjustment_variables,range_span){
    coxph_unadj %>%
      filter(latest_onset==range_span$r & denominator==range_span$s) %>%
      select(-latest_onset,-denominator) %>%
      mutate(FDR=p.adjust(p.value,method='BH')) %>%
      select(-estimate,-std.error,-statistic,-p.value) %>%
      mutate_at(
        .[,sapply(.,is.numeric)] %>%
          colnames()
        ,\(x)ifelse(x<0.001,'<0.001',round(x,3))
      ) %>%
      unite(CI95,L95,U95,sep=', ') %>%
      unite(CI95_FDR,CI95,FDR,sep='; p=') %>%
      unite(OR_CI95_FDR,OR,CI95_FDR,sep=' (') %>%
      mutate(
        OR_CI95_FDR=
          OR_CI95_FDR %>%
          str_replace_all('=<+','<') %>%
          paste0(')')
      ) %>%
      left_join(
        coxph_adj %>%
          mutate(FDR=p.adjust(p.value,method='BH')) %>%
          select(-estimate,-std.error,-statistic,-p.value) %>%
          mutate_at(
            .[,sapply(.,is.numeric)] %>%
              colnames()
            ,\(x)ifelse(x<0.001,'<0.001',round(x,3))
          ) %>%
          unite(CI95,L95,U95,sep=', ') %>%
          unite(CI95_FDR,CI95,FDR,sep='; p=') %>%
          unite(OR_CI95_FDR,OR,CI95_FDR,sep=' (') %>%
          mutate(
            OR_CI95_FDR=
              OR_CI95_FDR %>%
              str_replace_all('=<+','<') %>%
              paste0(')')
          )
        ,by=c('predictor','category')
      ) %>%
      rename(unadjusted_HR=OR_CI95_FDR.x,adjusted_HR=OR_CI95_FDR.y) %>%
      left_join(adjustment_variables,by='predictor') %>%
      left_join(
        variable_description %>%
          select(variable,description) %>%
          rename(predictor=variable)
        ,by='predictor'
      ) %>%
      mutate(predictor=description) %>%
      select(-description) %>%
      mutate_all(\(x)ifelse(is.na(x)|x=='NA (NA, NA; p=NA)','-',x)) %>%
      left_join(
        select(.,predictor,category,adjustment_variables) %>%
          lapply(X=seq(nrow(.)),Y=.,\(X,Y)
            Y %>%
              slice(X) %>%
              pull(adjustment_variables) %>%
              str_split('\\+') %>%
              .[[1]] %>%
              data.frame(adjustment_variables=.,value=1) %>%
              mutate(
                predictor=Y$predictor[X]
                ,category=Y$category[X]
              )
          ) %>%
          do.call(rbind,.) %>%
          filter(!adjustment_variables%in%c('','-')) %>%
          mutate(
            adjustment_variables=
              adjustment_variables %>%
              factor(unique(coxph_unadj$predictor))
          ) %>%
          spread(adjustment_variables,value,fill=0)
        ,by=c('predictor','category')
      ) %>%
      select(-adjustment_variables) %>%
      mutate_all(\(x)ifelse(is.na(x),'-',x))
  }
```

```{r Report predictor selection results, eval=FALSE, include=FALSE}
coxph_d3 %>%
  report_predictor_selection(
    coxph_adj_d3
    ,adjustment_variable_d3
    ,range_span_d3
  ) %>%
  write_csv('data/predictor_selection_d3.csv')

coxph_d %>%
  report_predictor_selection(
    coxph_adj_d
    ,adjustment_variable_d
    ,range_span_d
  ) %>%
  write_csv('data/predictor_selection_d.csv')
```

```{r Explore results for reporting, eval=FALSE, include=FALSE}
report_candidate_predictor_eligible_d3$initial$variable %>%
  left_join(
    report_candidate_predictor_eligible_d3$by_available$variable
    ,by='variable'
  )

report_candidate_predictor_eligible_d3$initial$indicator %>%
  left_join(
    report_candidate_predictor_eligible_d3$by_available$indicator
    ,by='variable'
  )

report_candidate_predictor_eligible_d3$by_available$variable %>%
  left_join(
    report_candidate_predictor_eligible_d3$by_pf$variable
    ,by='variable'
  )

report_candidate_predictor_eligible_d3$by_available$indicator %>%
  left_join(
    report_candidate_predictor_eligible_d3$by_pf$indicator
    ,by='variable'
  )

report_candidate_predictor_eligible_d3$by_pf$variable %>%
  left_join(
    report_candidate_predictor_eligible_d3$by_m$variable
    ,by='variable'
  )

report_candidate_predictor_eligible_d3$by_pf$indicator %>%
  left_join(
    report_candidate_predictor_eligible_d3$by_m$indicator
    ,by='variable'
  )

report_candidate_predictor_eligible_d3$by_m$variable %>%
  left_join(
    report_candidate_predictor_eligible_d3$by_om$variable
    ,by='variable'
  )

report_candidate_predictor_eligible_d3$by_m$indicator %>%
  left_join(
    report_candidate_predictor_eligible_d3$by_om$indicator
    ,by='variable'
  )

coxph_d3 %>%
  report_predictor_selection(
    coxph_adj_d3
    ,adjustment_variable_d3
    ,range_span_d3
  )

report_candidate_predictor_eligible_d$initial$variable %>%
  left_join(
    report_candidate_predictor_eligible_d$by_available$variable
    ,by='variable'
  )

report_candidate_predictor_eligible_d$initial$indicator %>%
  left_join(
    report_candidate_predictor_eligible_d$by_available$indicator
    ,by='variable'
  )

report_candidate_predictor_eligible_d$by_available$variable %>%
  left_join(
    report_candidate_predictor_eligible_d$by_pf$variable
    ,by='variable'
  )

report_candidate_predictor_eligible_d$by_available$indicator %>%
  left_join(
    report_candidate_predictor_eligible_d$by_pf$indicator
    ,by='variable'
  )

report_candidate_predictor_eligible_d$by_pf$variable %>%
  left_join(
    report_candidate_predictor_eligible_d$by_m$variable
    ,by='variable'
  )

report_candidate_predictor_eligible_d$by_pf$indicator %>%
  left_join(
    report_candidate_predictor_eligible_d$by_m$indicator
    ,by='variable'
  )

report_candidate_predictor_eligible_d$by_m$variable %>%
  left_join(
    report_candidate_predictor_eligible_d$by_om$variable
    ,by='variable'
  )

report_candidate_predictor_eligible_d$by_m$indicator %>%
  left_join(
    report_candidate_predictor_eligible_d$by_om$indicator
    ,by='variable'
  )

coxph_d %>%
  report_predictor_selection(
    coxph_adj_d
    ,adjustment_variable_d
    ,range_span_d
  )
```

```{r Check eligibility of actual cath duration, eval=FALSE, include=FALSE}
whole_data_d$prediction %>%
  left_join(
    outcome_onset_identifier
    ,by=colnames(uri_cath_d$prediction)
  ) %>%
  .[partition_d$training,c('duration','LOS'),drop=F] %>%
  mutate(duration=duration>2) %>%
  rename(duration_3=duration) %>%
  cbind(imputed_d$training) %>%
  mutate(HOSP='training') %>%
  select(HOSP,outcome,outcome_onset,duration_3,LOS) %>%
  lapply(X=1,Y=.,\(X,Y)
    Y %>%
      descriptive_analysis() %>%
      candidate_predictor_eligibility(
        variable_description %>%
          add_row(
            data.frame(
              variable='duration_3'
              ,description='Actual cath. duration'
              ,type='predictor'
              ,variable_level='yes'
              ,indicator_level='yes'
            )
          )
        ,missing_analysis(Y)
        ,outlier_analysis(Y)
      ) %>%
      filter(variable=='duration_3')
  ) %>%
  .[[1]] %>%
  lapply(X=1,Y=.,\(X,Y)
    Y %>%
      list(initial=.) %>%
      c(.$initial %>%
          filter(available%in%c('yes')) %>%
          list(by_available=.)
      ) %>%
      c(.$by_available %>%
          filter(pf%in%c('no','N/A')) %>%
          list(by_pf=.)
      ) %>%
      c(.$by_pf %>%
          filter(
            # m_pf%in%c('no','N/A')
            # &
            (
              m_mnar%in%c('no','N/A')
              |
              is.na(m_mnar)
            )
          ) %>%
          list(by_m=.)
      ) %>%
      c(.$by_m %>%
          filter(
            # om_pf%in%c('no','N/A')
            # &
            (
              om_mnar%in%c('no','N/A')
              |
              is.na(om_mnar)
            )
          ) %>%
          list(by_om=.)
      ) %>%
      lapply(
        report_candidate_predictor_eligibility
        ,variable_description %>%
          add_row(
            data.frame(
              variable='duration_3'
              ,description='Actual cath. duration'
              ,type='predictor'
              ,variable_level='yes'
              ,indicator_level='yes'
            )
          )
        ,Y
      )
  ) %>%
  .[[1]]
```

```{r CoxPH actual cath duration, eval=FALSE, fig.height=6, fig.width=6, include=FALSE}
whole_data_d$prediction %>%
  left_join(
    outcome_onset_identifier
    ,by=colnames(uri_cath_d$prediction)
  ) %>%
  .[partition_d$training,'duration',drop=F] %>%
  mutate(duration=duration>2) %>%
  rename(duration_3=duration) %>%
  cbind(imputed_d$training) %>%
  select(outcome,outcome_onset,duration_3) %>%
  filter(outcome_onset<=range_span_d$r) %>%
  mutate(outcome_onset=floor(outcome_onset/range_span_d$s)) %>%
  numerize_scale(range_span_d,'duration_3',scaler_d) %>%
  mutate(km_outcome=Surv(outcome_onset,outcome)) %>%
  lapply(
    X=colnames(.) %>%
      .[!.%in%c('km_outcome','outcome','outcome_onset')]
    ,Y=.
    ,Z=identify_adj_vars(.,inter_predictor_assoc_d)
    ,\(X,Y,Z)
      suppressWarnings(
        Y %>%
          select_at(c('km_outcome',Z[[X]])) %>%
          coxph(km_outcome~.,data=.) %>%
          broom::tidy() %>%
          mutate(
            predictor=
              term %>%
              str_remove_all(
                paste0(
                  c('TRUE$'
                    ,'FALSE$'
                    ,'\\(numeric\\)'
                    ,'[<=>]+[:digit:]+\\s*t*o*\\s*[:digit:]*'
                    ,'[MF]$'
                  )
                  ,collapse='|'
                )
              )
            ,category=
              term %>%
              str_remove_all(predictor) %>%
              str_remove_all('_')
            ,category=ifelse(category=='','(numeric)',category)
          ) %>%
          select(-term) %>%
          select(predictor,everything()) %>%
          filter(predictor==X)
      )
  ) %>%
  do.call(rbind,.) %>%
  mutate(
    OR=exp(estimate)
    ,L95=exp(estimate-qnorm(0.975)*std.error)
    ,U95=exp(estimate+qnorm(0.975)*std.error)
  ) %>%
  select(
    predictor,category,OR,L95,U95,p.value
    ,everything()
  )
```

```{r Plot KM actual cath duration, eval=FALSE, fig.height=6, fig.width=6, include=FALSE}
whole_data_d$prediction %>%
  left_join(
    outcome_onset_identifier
    ,by=colnames(uri_cath_d$prediction)
  ) %>%
  .[partition_d$training,'duration',drop=F] %>%
  mutate(duration=duration>2) %>%
  rename(duration_3=duration) %>%
  cbind(imputed_d$training) %>%
  select(outcome,outcome_onset,duration_3) %>%
  filter(outcome_onset<=range_span_d$r) %>%
  mutate(outcome_onset=floor(outcome_onset/range_span_d$s)) %>%
  numerize_scale(range_span_d,'duration_3',scaler_d) %>%
  ggsurvplot(
    fit=survfit(Surv(outcome_onset,outcome)~duration_3,data=.)
    ,data=.
    ,risk.table=T
    ,pval=F
    ,conf.int=T
  ) %>%
  list() %>%
  lapply(\(x)
    ggarrange(
      x[[1]] +
        ylab("Event Rate") +
        scale_x_continuous(labels=\(x)x*range_span_d$s) +
        scale_y_reverse(labels=\(x)1-x)
      ,x[[2]]
      ,ncol=1
      ,nrow=2
      ,heights=c(3,1)
    )
  )
```

```{r Summarize sample size per cumulative span, eval=FALSE, include=FALSE}
imputed_d %>%
  lapply(select_at,c('outcome','outcome_onset')) %>%
  lapply(\(x)
    x %>%
      filter(outcome_onset<=range_span_d$r) %>%
      mutate(
        outcome_onset=
          floor(outcome_onset/range_span_d$s)*range_span_d$s
      ) %>%
      pull(outcome_onset) %>%
      unique() %>%
      sort() %>%
      .[-1] %>%
      lapply(\(y)
        x %>%
          filter(outcome_onset<=y) %>%
          mutate(cutoff=y)
      ) %>%
      c(x %>%
          mutate(cutoff=Inf) %>%
          list()
      )
  ) %>%
  lapply(lapply,group_by,cutoff,outcome) %>%
  lapply(lapply,summarize,n=n(),.groups='drop') %>%
  lapply(lapply,\(x)
    x %>%
      rbind(
        filter(.,outcome) %>%
          mutate(
            outcome='EPV'
            ,n=floor(n/length(cand_predictors3_d))
          )
      )
  ) %>%
  lapply(\(x)x %>% do.call(rbind,.)) %>%
  lapply(spread,outcome,n,fill=0) %>%
  lapply(mutate,TOTAL=`FALSE`+`TRUE`+`<NA>`) %>%
  lapply(mutate,cutoff=ifelse(is.infinite(cutoff),'no',cutoff)) %>%
  lapply(knitr::kable)
```

```{r eval=FALSE, include=FALSE}
candidate_predictor_eligible_d %>%
  filter(type=='predictor' & variable_level=='yes') %>%
  pull(variable)
```

```{r eval=FALSE, include=FALSE}
candidate_predictor_eligible_d %>%
  filter(type=='predictor' & variable_level=='yes') %>%
  pull(variable) %>%
  setdiff(
    candidate_predictor_eligible_d %>%
      filter(type=='predictor' & variable_level=='yes') %>%
      filter(available%in%c('yes')) %>%
      pull(variable)
  )
```

```{r eval=FALSE, include=FALSE}
candidate_predictor_eligible_d %>%
  filter(type=='predictor' & variable_level=='yes') %>%
  filter(available%in%c('yes')) %>%
  pull(variable)
```

```{r eval=FALSE, include=FALSE}
candidate_predictor_eligible_d %>%
  filter(type=='predictor' & variable_level=='yes') %>%
  filter(available%in%c('yes')) %>%
  pull(variable) %>%
  setdiff(
    candidate_predictor_eligible_d %>%
      filter(type=='predictor' & variable_level=='yes') %>%
      filter(available%in%c('yes')) %>%
      filter(pf%in%c('no','N/A')) %>%
      pull(variable)
  )
```

```{r eval=FALSE, include=FALSE}
candidate_predictor_eligible_d %>%
  filter(type=='predictor' & variable_level=='yes') %>%
  filter(available%in%c('yes')) %>%
  filter(pf%in%c('no','N/A')) %>%
  pull(variable)
```

```{r eval=FALSE, include=FALSE}
candidate_predictor_eligible_d %>%
  filter(type=='predictor' & variable_level=='yes') %>%
  filter(available%in%c('yes')) %>%
  filter(pf%in%c('no','N/A')) %>%
  pull(variable) %>%
  setdiff(
    candidate_predictor_eligible_d %>%
      filter(type=='predictor' & variable_level=='yes') %>%
      filter(available%in%c('yes')) %>%
      filter(pf%in%c('no','N/A')) %>%
      filter(
        # m_pf%in%c('no','N/A')
        # &
        (
          m_mnar%in%c('no','N/A')
          |
          is.na(m_mnar)
        )
      ) %>%
      pull(variable)
  )
```

```{r eval=FALSE, include=FALSE}
candidate_predictor_eligible_d %>%
  filter(type=='predictor' & variable_level=='yes') %>%
  filter(available%in%c('yes')) %>%
  filter(pf%in%c('no','N/A')) %>%
  filter(
    # m_pf%in%c('no','N/A')
    # &
    (
      m_mnar%in%c('no','N/A')
      |
      is.na(m_mnar)
    )
  ) %>%
  pull(variable)
```

```{r eval=FALSE, include=FALSE}
candidate_predictor_eligible_d %>%
  filter(type=='predictor' & variable_level=='yes') %>%
  filter(available%in%c('yes')) %>%
  filter(pf%in%c('no','N/A')) %>%
  filter(
    # m_pf%in%c('no','N/A')
    # &
    (
      m_mnar%in%c('no','N/A')
      |
      is.na(m_mnar)
    )
  ) %>%
  pull(variable) %>%
  setdiff(
    candidate_predictor_eligible_d %>%
      filter(type=='predictor' & variable_level=='yes') %>%
      filter(available%in%c('yes')) %>%
      filter(pf%in%c('no','N/A')) %>%
      filter(
        # m_pf%in%c('no','N/A')
        # &
        (
          m_mnar%in%c('no','N/A')
          |
          is.na(m_mnar)
        )
      )%>%
      filter(
        # om_pf%in%c('no','N/A')
        # &
        (
          om_mnar%in%c('no','N/A')
          |
          is.na(om_mnar)
        )
      ) %>%
      pull(variable)
  )
```

```{r eval=FALSE, include=FALSE}
candidate_predictor_eligible_d %>%
  filter(type=='predictor' & variable_level=='yes') %>%
  filter(available%in%c('yes')) %>%
  filter(pf%in%c('no','N/A')) %>%
  filter(
    # m_pf%in%c('no','N/A')
    # &
    (
      m_mnar%in%c('no','N/A')
      |
      is.na(m_mnar)
    )
  )%>%
  filter(
    # om_pf%in%c('no','N/A')
    # &
    (
      om_mnar%in%c('no','N/A')
      |
      is.na(om_mnar)
    )
  ) %>%
  pull(variable)
```

```{r eval=FALSE, include=FALSE}
candidate_predictor_eligible_d %>%
  filter(type=='predictor' & variable_level=='no') %>%
  filter(available%in%c('yes')) %>%
  filter(pf%in%c('no','N/A')) %>%
  filter(
    # m_pf%in%c('no','N/A')
    # &
    (
      m_mnar%in%c('no','N/A')
      |
      is.na(m_mnar)
    )
  )%>%
  filter(
    # om_pf%in%c('no','N/A')
    # &
    (
      om_mnar%in%c('no','N/A')
      |
      is.na(om_mnar)
    )
  ) %>%
  pull(variable)
```


```{r eval=FALSE, include=FALSE}
variable_description %>%
  filter(type=='predictor' & variable_level=='yes') %>%
  pull(variable) %>%
  setdiff(cand_predictors_d)
```

```{r eval=FALSE, include=FALSE}
cand_predictors_d
```

```{r eval=FALSE, include=FALSE}
cand_predictors_d %>%
  setdiff(cand_predictors2_d)
```

```{r eval=FALSE, include=FALSE}
cand_predictors2_d
```

```{r eval=FALSE, include=FALSE}
cand_predictors2_d %>%
  setdiff(cand_predictors3_d)
```

```{r}
cand_predictors3_d
```

```{r include=FALSE}
unassessed_predictors_d=
  report_candidate_predictor_eligible_d %>%
  .$by_available %>%
  .$variable %>%
  .$variable %>%
  setdiff(cand_predictors3_d)
```

```{r Preprocess for predictive modeling, include=FALSE}
pred_data=
  imputed_d %>%
  lapply(select_at,c('outcome','outcome_onset',cand_predictors3_d)) %>%
  lapply(numerize_scale,range_span_d,cand_predictors3_d,scaler_d) %>%
  lapply(select,-outcome_onset) %>%
  lapply(numerize_var) %>%
  lapply(mutate,outcome_1=ifelse(outcome_NA==1,NA,outcome_1)) %>%
  lapply(select,-outcome_0,-outcome_NA) %>%
  lapply(rename,outcome=outcome_1) %>%
  lapply(select,-AGE_GROUP_0) %>%
  lapply(X=names(.),Y=.,Z=imputed_d,\(X,Y,Z)
    Y[[X]] %>%
      cbind(Z[[X]] %>% select(outcome_onset)) %>%
      left_join(
        Z[[X]] %>%
          group_by(outcome) %>%
          summarize(outcome_weight=n()) %>%
          mutate(
            outcome_weight=
              ifelse(
                is.na(outcome)
                ,NA
                ,1/(outcome_weight/sum(outcome_weight))*0.5
              )
          )
        ,by='outcome'
      ) %>%
      filter(!is.na(outcome)) %>%
      select(outcome,outcome_onset,outcome_weight,everything())
  ) %>%
  `names<-`(names(imputed_d))
```

```{r Preprocesss for predictive modeling per cumulative span, include=FALSE}
pred_data_cutoff=
  pred_data %>%
  lapply(\(x)
    x %>%
      filter(outcome_onset<=range_span_d$r) %>%
      mutate(
        outcome_onset=
          floor(outcome_onset/range_span_d$s)*range_span_d$s
      ) %>%
      pull(outcome_onset) %>%
      unique() %>%
      sort() %>%
      .[-1] %>%
      `names<-`(paste0('cutoff_',str_pad(.,str_count(max(.)),'left','0'))) %>%
      lapply(\(y)
        x %>%
          filter(outcome_onset<=y) %>%
          select(-outcome_onset)
      ) %>%
      c(x %>%
          select(-outcome_onset) %>%
          list() %>%
          `names<-`('cutoff_no')
      )
  )
```

```{r Write data input for scikit learn, eval=FALSE, include=FALSE}
pred_data %>%
  lapply(X=names(.),Y=.,\(X,Y)
    write_csv(Y[[X]],paste0('data/pred_data_',X,'.csv'))
  )

pred_data_cutoff$training %>%
  lapply(X=names(.),Y=.,\(X,Y)
    write_csv(Y[[X]],paste0('data/pred_data_training_',X,'.csv'))
  )
```

```{r}
pred_data_unassessed=
  partition_d %>%
  lapply(\(x)
    whole_data_d$prediction %>%
      left_join(outcome_onset_identifier,by=colnames(uri_cath_d$prediction)) %>%
      .[x,]
  ) %>%
  lapply(
    select_at
    ,c('outcome'
       ,'outcome_onset'
       ,unassessed_predictors_d
     )
  ) %>%
  lapply(
    numerize_scale
    ,range_span_d
    ,unassessed_predictors_d
    ,scaler_d
  ) %>%
  lapply(select,-outcome_onset) %>%
  lapply(numerize_var) %>%
  lapply(mutate,outcome_1=ifelse(outcome_NA==1,NA,outcome_1)) %>%
  lapply(select,-outcome_0,-outcome_NA) %>%
  lapply(rename,outcome=outcome_1) %>%
  lapply(\(x)
    x %>%
      select_at(
        colnames(.) %>%
          .[!str_detect(.,'_0+$')]
      )
  ) %>%
  lapply(\(x)
    x %>%
      select_at(
        colnames(.) %>%
          .[str_detect(.,'_[:digit:]+$|_NA$')]
      ) %>%
      lapply(
        X=colnames(.) %>%
          str_remove_all('_[:digit:]+$|_NA$') %>%
          unique()
        ,Y=.
        ,\(X,Y)
          Y %>%
            select_at(
              colnames(.) %>%
                .[str_detect(.,paste0('^',X))]
            ) %>%
            `colnames<-`(
              colnames(.) %>%
                str_replace_all(X,'variable')
            ) %>%
            mutate(
              variable=
                ifelse(
                  variable_NA==1
                  ,NA
                  ,variable_1
                )
            ) %>%
            select(variable) %>%
            `colnames<-`(X)
      ) %>%
      do.call(cbind,.) %>%
      cbind(
        x %>%
          select_at(
            colnames(.) %>%
              .[!str_detect(.,'_[:digit:]+$|_NA$')]
          )
      ) %>%
      select_at(
        x %>%
          colnames() %>%
          str_remove_all('_[:digit:]+$|_NA$') %>%
          unique()
      )
  ) %>%
  lapply(X=names(.),Y=.,Z=imputed_d,\(X,Y,Z)
    Y[[X]] %>%
      cbind(Z[[X]] %>% select(outcome_onset)) %>%
      left_join(
        Z[[X]] %>%
          group_by(outcome) %>%
          summarize(outcome_weight=n()) %>%
          mutate(
            outcome_weight=
              ifelse(
                is.na(outcome)
                ,NA
                ,1/(outcome_weight/sum(outcome_weight))*0.5
              )
          )
        ,by='outcome'
      ) %>%
      filter(!is.na(outcome)) %>%
      select(outcome,outcome_onset,outcome_weight,everything())
  ) %>%
  `names<-`(names(partition_d))
```

```{r}
pred_data_unassessed_cutoff=
  pred_data_unassessed %>%
  lapply(\(x)
    x %>%
      filter(outcome_onset<=range_span_d$r) %>%
      mutate(
        outcome_onset=
          floor(outcome_onset/range_span_d$s)*range_span_d$s
      ) %>%
      pull(outcome_onset) %>%
      unique() %>%
      sort() %>%
      .[-1] %>%
      `names<-`(paste0('cutoff_',str_pad(.,str_count(max(.)),'left','0'))) %>%
      lapply(\(y)
        x %>%
          filter(outcome_onset<=y) %>%
          select(-outcome_onset)
      ) %>%
      c(x %>%
          select(-outcome_onset) %>%
          list() %>%
          `names<-`('cutoff_no')
      )
  )
```

```{r eval=FALSE, include=FALSE}
pred_data_unassessed_cutoff$training %>%
  lapply(X=names(.),Y=.,\(X,Y)
    write_csv(Y[[X]],paste0('data/pred_data_unassessed_training_',X,'.csv'))
  )
```

```{r}
if(all(c(1,2,3)%in%comp_req)){ # 50m 21s
  # List of training file names
  training_files=
    c('data/pred_data_training_cutoff_03.csv'
      ,'data/pred_data_training_cutoff_06.csv'
      ,'data/pred_data_training_cutoff_09.csv'
      ,'data/pred_data_training_cutoff_12.csv'
      ,'data/pred_data_training_cutoff_no.csv'
    )
  
  # List of files to make predictions
  prediction_files=
    c('data/pred_data_training.csv'
      ,'data/pred_data_validation.csv'
      ,'data/pred_data_test.csv'
    )
  
  # Algorithms to be used
  algorithms=
    list(
      rr='glmnet'
      ,gb='xgbTree'
    )
  
  # Define parameter grids for each algorithm
  param_grids=
    list(
      rr=
        expand.grid(
          alpha=0
          ,lambda=1/c(0.01,0.1,1,10))
      ,gb=
        expand.grid(
          nrounds=c(50,100,200)
          ,eta=c(0.01,0.1,1)
          ,max_depth=c(3,4,5)
          ,subsample=c(0.8,1)
          ,colsample_bytree=c(0.8,1)
          ,gamma=0
          ,min_child_weight=1
        )
    )
  
  # Define cross-validation with random seed
  cv_control=
    trainControl(
      method='cv'
      ,number=10
      ,summaryFunction=twoClassSummary
      ,classProbs=T
      ,savePredictions=T
      ,seeds=set.seed(seed)
    )
  
  # Loop through each training file
  for(training_file in training_files){
    
    # Load the training dataset
    training_data=
      training_file %>%
      read_csv(show_col_types=F)
    
    # Extract features, labels, and sample weights from the training data
    X_train=
      training_data %>%
      select(-outcome,-outcome_weight)
    
    y_train=
      training_data %>%
      mutate(
        outcome=
          ifelse(outcome=='1','case','control') %>%
          factor(c('control','case'))
      ) %>%
      pull(outcome)
    
    sample_weights=
      training_data %>%
      pull(outcome_weight)
    
    # Loop through each algorithm
    for(algorithm_name in names(algorithms)){
      
      # Define the parameter grid
      param_grid=param_grids[[algorithm_name]]
      
      # Train the model with cross-validated grid search and sample weighting
      model=
        suppressWarnings(
          train(
            x=X_train
            ,y=y_train
            ,method=algorithms[[algorithm_name]]
            ,metric='ROC'
            ,trControl=cv_control
            ,tuneGrid=param_grid
            ,weights=sample_weights
            ,verbosity=0
          )
        )
      
      # Get the best model and best parameters from the grid search
      best_model=model$finalModel
      best_params=model$bestTune
      
      # Define the directory to save the models
      save_dir=
        file.path(
          'data/caret_models'
          ,algorithm_name
          ,sub('\\..*$','',basename(training_file))
        )
      
      # Create the directory if it doesn't exist
      if (!dir.exists(save_dir)) {
        dir.create(save_dir,recursive=T)
      }
      
      # Save the trained model to a file
      model_filename=file.path(save_dir,'model.rds')
      
      best_model %>%
        saveRDS(file=model_filename)
      
      # Save the best hyperparameters to a CSV file
      params_filename=file.path(save_dir,'best_params.csv')
      best_params %>%
        write_csv(file=params_filename)
      
      # Loop through each prediction file and make predictions
      for (prediction_file in prediction_files) {
        
        # Load the prediction dataset
        prediction_data=
          prediction_file %>%
          read_csv(show_col_types=F)
        
        # Extract features from the prediction data
        X_pred=
          prediction_data %>%
          select(-outcome,-outcome_onset,-outcome_weight)
        
        y_true=
          prediction_data %>%
          mutate(
            outcome=
              ifelse(outcome=='1','case','control') %>%
              factor(c('control','case'))
          ) %>%
          pull(outcome)
        
        # Make predictions on the prediction data
        if(algorithm_name=='rr'){
          y_pred_proba=
            best_model %>%
            predict(
              newx=as.matrix(X_pred)
              ,type='response'
              ,s=best_params$lambda
            ) %>%
            .[,1]
        }else if(algorithm_name=='gb'){
          y_pred_proba=
            best_model %>%
            predict(
              newdata=as.matrix(X_pred)
              ,type='prob'
            )
        }
        
        # Output model evaluation
        roc_auc=
          suppressMessages(roc(y_true,y_pred_proba)) %>%
          auc()
        
        cat(paste(
          'Training file:',training_file
          ,', Algorithm:',algorithm_name
          ,', Prediction file:',prediction_file
          ,'\n'
        ))
        
        cat(paste(
          'AUC-ROC:',roc_auc,'\n'
        ))
        
        # Write the predicted probabilities to CSV
        output_filename=
          file.path(
            save_dir
            ,paste0('prob_',basename(prediction_file))
          )
        
        data.frame(outcome=y_true,prob=y_pred_proba) %>%
          write_csv(file=output_filename)
      }
    }
  }
  
  rm(training_files,prediction_files,algorithms,param_grids,cv_control
     ,training_file,prediction_file,algorithm_name,param_grid
     ,training_data,X_train,y_train,sample_weights
     ,model,best_model,best_params,save_dir,model_filename,params_filename
     ,prediction_data,X_pred,y_true,y_pred_proba,roc_auc,output_filename
  )
}
```

```{r fig.height=10, fig.width=7}
divnn::TidySet.compile

ontology=
  divnn_cutoff_03 %>%
  notes() %>%
  .$ontology

ori_ontology=ontology
while(sum(str_detect(ontology$source,'ONT\\:'))>0){
  ontology=
    ontology %>%
    mutate(seq=seq(nrow(.)))
  for(X in seq(nrow(ontology))){
    Y=ontology %>%
      filter(seq==X)
    Z=ontology %>%
      filter(seq!=X)
    if(str_detect(Y$source[1],'ONT\\:')){
      K=ontology %>%
        filter(target==Y$source[1] & relation=='feature')
      if(nrow(K)>0) {
        Y=data.frame(
          source=K$source
          ,target=Y$target[1]
          ,similarity=Y$similarity[1]
          ,relation='feature'
          ,seq=Y$seq[1]
        )
      }
    }
    ontology=
      Y %>%
      rbind(Z) %>%
      arrange(seq)
  }
  rm(X,Y,Z,K)
  ontology=
    ontology %>%
    select(-seq) %>%
    filter(!duplicated(.))
}
```

```{r}
TidySet.compile=
  function (value, outcome, similarity, mapping, ontology, ranked = T, 
    dims = 7, decreasing = F, seed_num = 33) {
      pb = startpb(0, 7)
      on.exit(closepb(pb))
      setpb(pb, 0)
      rotate_2_col_mat = function(X, angle) {
          angle = (pi/180 * angle) * -1
          M = matrix(c(cos(angle), -sin(angle), sin(angle), cos(angle)), 
              2, 2)
          M = X %*% M
          dimnames(M) = dimnames(X)
          M
      }
      create_fmap = function(mapping, similarity, angle, ranked = ranked, 
          dims = dims) {
          data = data.frame(feature = rownames(similarity), dim1 = mapping[, 
              1], dim2 = mapping[, 2], dim3 = mapping[, 3])
          if (ranked) {
              data = data %>% arrange(dim1) %>% mutate(dim1 = seq(nrow(.))) %>% 
                  arrange(dim2) %>% mutate(dim2 = seq(nrow(.)))
          }
          data %>% arrange(dim1) %>% mutate(resize_x = seq(1, dims, 
              length.out = nrow(.)) %>% round()) %>% arrange(dim2) %>% 
              mutate(resize_y = seq(1, dims, length.out = nrow(.)) %>% 
                  round()) %>% cbind(data.frame(rot_x = .$resize_x, 
              rot_y = .$resize_y) %>% as.matrix() %>% rotate_2_col_mat(angle)) %>% 
              arrange(rot_x) %>% mutate(x = seq(1, dims, length.out = nrow(.)) %>% 
              round()) %>% arrange(rot_y) %>% mutate(y = seq(1, 
              dims, length.out = nrow(.)) %>% round()) %>% arrange(dim3) %>% 
              lapply(X = seq(nrow(select(., x, y) %>% .[!duplicated(.), 
                  ])), Y = select(., x, y) %>% .[!duplicated(.), 
                  ], Z = ., FUN = function(X, Y, Z) {
                  Z %>% filter(x == Y$x[X] & y == Y$y[X]) %>% mutate(z = seq(nrow(.)))
              }) %>% do.call(rbind, .) %>% `rownames<-`(NULL) %>% 
              column_to_rownames(var = "feature") %>% .[match(rownames(similarity), 
              rownames(.)), ] %>% select(x, y, z) %>% arrange(z, 
              y, x)
      }
      order_angle_by_channel = function(mapping, similarity, ranked = T, 
          dims = 7, decreasing = F) {
          lapply(1:360, FUN = create_fmap, mapping = mapping, similarity = similarity, 
              ranked = ranked, dims = dims) %>% sapply(function(x) max(x$z)) %>% 
              setNames(1:360) %>% .[order(., decreasing = decreasing)]
      }
      setpb(pb, 1)
      set.seed(seed_num)
      angle = order_angle_by_channel(mapping, similarity, ranked, 
          dims, decreasing) %>% lapply(X = 1, Y = ., function(X, 
          Y) as.integer(names(Y)[Y == min(Y)])) %>% .[[1]] %>% 
          .[sample(seq(length(.)), 1, F)]
      setpb(pb, 2)
      fmap = create_fmap(mapping, similarity, angle, ranked, dims)
      fval = value[, rownames(fmap)] %>% t() %>% as.data.frame()
      fboth = fmap %>% summarize_all(max) %>% as.list() %>% lapply(seq) %>% 
          expand.grid() %>% setNames(c("x", "y", "z")) %>% arrange(z, 
          y, x) %>% left_join(rownames_to_column(fmap, var = "feature"), 
          by = c("x", "y", "z")) %>% cbind(fval[.$feature, , drop = F]) %>% 
          mutate(x = paste0("x", x)) %>% unite(pos_id, x, y, sep = "y") %>% 
          unite(pos_id, pos_id, z, sep = "z")
      ori_ontology=ontology
      while(sum(str_detect(ontology$source,'ONT\\:'))>0){
        ontology=
          ontology %>%
          mutate(seq=seq(nrow(.)))
        for(X in seq(nrow(ontology))){
          Y=ontology %>%
            filter(seq==X)
          Z=ontology %>%
            filter(seq!=X)
          if(str_detect(Y$source[1],'ONT\\:')){
            K=ontology %>%
              filter(target==Y$source[1] & relation=='feature')
            if(nrow(K)>0) {
              Y=data.frame(
                source=K$source
                ,target=Y$target[1]
                ,similarity=Y$similarity[1]
                ,relation='feature'
                ,seq=Y$seq[1]
              )
            }
          }
          ontology=
            Y %>%
            rbind(Z) %>%
            arrange(seq)
        }
        rm(X,Y,Z,K)
        ontology=
          ontology %>%
          select(-seq) %>%
          filter(!duplicated(.))
      }
      setpb(pb, 3)
      adata = fboth %>% select(-feature) %>% `rownames<-`(NULL) %>% 
          column_to_rownames(var = "pos_id") %>% t() %>% t()
      adata[is.na(adata)] = 0
      pdata = value %>% .[, rownames(fmap)] %>% as.data.frame() %>% 
          mutate(outcome = as.integer(outcome)) %>% select(outcome, 
          everything()) %>% `rownames<-`(colnames(adata))
      fdata = fboth %>% select(pos_id, feature) %>% left_join(ontology %>% 
          select(source, target) %>% .[!duplicated(.), ] %>% mutate(included = 1) %>% 
          spread(target, included) %>% rename_all(str_replace_all, 
          "ONT\\:", "ONT") %>% rename(feature = source), by = "feature") %>% 
          column_to_rownames(var = "pos_id")
      setpb(pb, 4)
      ontomap = adata %>% t() %>% array(dim = c(dim(.)[1], colnames(.) %>% 
          lapply(str_split_fixed, "x|y|z", 4) %>% sapply(as.integer) %>% 
          t() %>% .[, 2:4] %>% colMaxs()), dimnames = list(rownames(.), 
          NULL, NULL, NULL))
      setpb(pb, 5)
      ontotype = fdata %>% lapply(X = seq(ncol(.) - 1), Y = ., 
          function(X, Y) {
              Z = Y %>% select(-feature) %>% .[, X, drop = F] %>% 
                  rownames_to_column(var = "pos_id") %>% setNames(c("pos_id", 
                  "ontotype")) %>% filter(ontotype == 1) %>% left_join(rownames_to_column(Y, 
                  var = "pos_id") %>% select(pos_id, feature), 
                  by = "pos_id")
              K = Z %>% pull(pos_id) %>% str_split_fixed("x|y|z", 
                  4) %>% .[, 2:4]
              matrix(as.integer(K), ncol = 3, byrow = F, dimnames = list(Z$feature, 
                  c("x", "y", "z")))
          }) %>% setNames(fdata %>% colnames(.) %>% .[. != "feature"]) %>% 
          c(list(root = fdata %>% rownames_to_column(var = "pos_id") %>% 
              select(pos_id, feature) %>% filter(!is.na(feature)) %>% 
              lapply(X = 1, Y = ., function(X, Y) {
                  Z = Y %>% pull(pos_id) %>% str_split_fixed("x|y|z", 
                    4) %>% .[, 2:4]
                  matrix(as.integer(Z), ncol = 3, byrow = F, dimnames = list(Y$feature, 
                    c("x", "y", "z")))
              }) %>% .[[1]]))
      setpb(pb, 6)
      output = ExpressionSet(assayData = assayData(ExpressionSet(adata)), 
          phenoData = AnnotatedDataFrame(pdata), featureData = AnnotatedDataFrame(fdata), 
          experimentData = MIAME(other = list(similarity = similarity %>% 
              .[match(rownames(fmap), rownames(.)), match(rownames(fmap), 
                  rownames(.))], ontomap = ontomap, ontotype = ontotype, 
              ontology = ori_ontology)))
      gc()
      setpb(pb, 7)
      output
  }
```

```{r}
if(all(c(1,2,3)%in%comp_req)){ # 50m 21s
  # List of training file names
  training_files=
    c('data/pred_data_training_cutoff_03.csv'
      ,'data/pred_data_training_cutoff_06.csv'
      ,'data/pred_data_training_cutoff_09.csv'
      ,'data/pred_data_training_cutoff_12.csv'
      ,'data/pred_data_training_cutoff_no.csv'
    )
  
  # List of files to make predictions
  prediction_files=
    c('data/pred_data_training.csv'
      ,'data/pred_data_validation.csv'
      ,'data/pred_data_test.csv'
    )
  
  # Loop through each training file
  for(training_file in training_files){
    
    # Load the training dataset
    training_data=
      training_file %>%
      read_csv(show_col_types=F)
  
    # Extract features, labels, and sample weights from the training data
    X_train=
      training_data %>%
      select(-outcome,-outcome_weight)
    
    y_train=
      training_data %>%
      pull(outcome)
    
    sample_weights=
      training_data %>%
      pull(outcome_weight)
    
    # Select features utilizing differential analysis
    # by moderated-t stats with Benjamini-Hochberg multiple testing correction.
    SGD1bit_fit=
      X_train %>%
      t() %>%
      normalize.quantiles() %>%
      `dimnames<-`(
        X_train %>%
          t() %>%
          dimnames()
      ) %>%
      lmFit(model.matrix(~outcome,data.frame(outcome=y_train))) %>%
      eBayes() %>%
      topTable(coef=2,nrow(.$coefficients),adjust.method='BH',sort.by='none') %>%
      filter(adj.P.Val<0.05)
    
    # Get the selected features as unnormalized ones.
    X_train_unnorm=
      X_train %>%
      .[,rownames(SGD1bit_fit)]
    
    # Normalize features quantile-to-quantile
    # using differential average of features as target.
    X_train_norm=
      X_train_unnorm %>%
      t() %>%
      normalize.quantiles.use.target(SGD1bit_fit$AveExpr) %>%
      t() %>%
      `dimnames<-`(dimnames(X_train_unnorm))
    
    # Transform features by 1-bit stochastic gradient descent (SGD)
    # using the differential average.
    cat('Transform features by 1-bit stochastic gradient descent (SGD)\n')
    predictor_v=
      X_train_norm %>%
      sweep(2,SGD1bit_fit$AveExpr,'-') %>%
      pbsapply(function(x){ifelse(x==0,0,ifelse(x>0,1,-1))}) %>%
      matrix(
        ncol=ncol(X_train_unnorm)
        ,byrow=F
        ,dimnames=dimnames(X_train_unnorm)
      ) %>%
      as.data.frame()
    
    # Get feature-wise mean of unnormalized features.
    predictor_m=
      X_train_unnorm %>%
      as.matrix() %>%
      colMeans2()
    
    # Get feature-wise standard deviation (SD) of unnormalized features.
    predictor_s=
      X_train_unnorm %>%
      as.matrix() %>%
      colSds()
    
    # Scale unnormalized features by the mean and SD.
    X_train_unnorm_scaled=
      X_train_unnorm %>%
      sweep(2,predictor_m,'-') %>%
      sweep(2,predictor_s,'/')
    
    # Compute feature-feature Pearson correlation matrix
    # of unnormalized features.
    cat('Compute feature-feature Pearson correlation matrix\n')
    predictor_p=
      colnames(X_train_unnorm) %>%
      lapply(X=seq(length(.)-1),Y=.,function(X,Y){
        data.frame(
          predictor1=Y[X]
          ,predictor2=Y[(X+1):length(.)]
        )
      }) %>%
      do.call(rbind,.) %>%
      mutate(
        pearson=
          pbsapply(X=seq(nrow(.)),Y=.,Z=X_train_unnorm_scaled,function(X,Y,Z){
            cor(
              Z[,Y$predictor1[X]]
              ,Z[,Y$predictor2[X]]
            )
          })
      ) %>%
      rbind(
        setNames(select(.,predictor2,predictor1,everything()),colnames(.))
        ,data.frame(
          predictor1=colnames(X_train_unnorm)
          ,predictor2=colnames(X_train_unnorm)
          ,pearson=1
        )
      ) %>%
      spread(predictor2,pearson) %>%
      column_to_rownames(var='predictor1') %>%
      as.matrix()
    
    # Conduct Barnes-Hut t-moderated stochastic neighbor embedding (t-SNE).
    cat('Conduct Barnes-Hut t-moderated stochastic neighbor embedding (t-SNE)\n')
    set.seed(seed)
    predictor_tsne=
      predictor_p %>%
      Rtsne(dims=3,verbose=T,is_distance=T,perplexity=floor((dim(.)[1]-1)/3))
    
    # Construct clique-extracted ontology (CliXO) (choose your own OS).
    predictor_c=
      predictor_p %>%
      clixo(os='windows') %>%
      mutate_at(c('source','target'),str_replace_all,'CliXO\\:','ONT:')
    
    # Compile input.
    input=list()
    
    input$value=
      predictor_v
    
    input$outcome=
      y_train %>%
      setNames(rownames(input$value))
    
    input$similarity=
      predictor_p
    
    input$mapping=
      predictor_tsne$Y %>%
      `rownames<-`(colnames(input$value))
    
    input$ontology=
      predictor_c
    
    input$fit=
      SGD1bit_fit
    
    # Define the directory to save TidySet
    save_dir=
      file.path(
        'data/divnn_models'
        ,sub('\\..*$','',basename(training_file))
      )
    
    # Create the directory if it doesn't exist
    if (!dir.exists(save_dir)) {
      dir.create(save_dir,recursive=T)
    }
    
    # Compile into a TidySet.
    cat('Compile into a TidySet and write the .ts.tar.gz\n')
    output=
      TidySet.compile(
        value=input$value
        ,outcome=input$outcome
        ,similarity=input$similarity
        ,mapping=input$mapping
        ,ontology=input$ontology
        ,ranked=T
        ,dims=7
        ,decreasing=F
        ,seed_num=seed
      )
    
    output %>%
      TidySet.write(save_dir)
    
    # Loop through each prediction file and make predictions
    for (prediction_file in prediction_files) {
      
      # Load the prediction dataset
      prediction_data=
        prediction_file %>%
        read_csv(show_col_types=F)
      
      # Extract features from the prediction data
      X_pred=
        prediction_data %>%
        select(-outcome,-outcome_onset,-outcome_weight)
      
      y_true=
        prediction_data %>%
        pull(outcome)
      
      # Filter the selected features.
      X_pred_unnorm=
        X_pred %>%
        .[,rownames(SGD1bit_fit)]
      
      # Normalize the selected features quantile-to-quantile
      # using the averages based on the training set.
      X_pred_norm=
        X_pred_unnorm %>%
        t() %>%
        normalize.quantiles.use.target(SGD1bit_fit$AveExpr) %>%
        t() %>%
        `dimnames<-`(dimnames(X_pred_unnorm))
      
      # Do 1-bit stochastic gradient descent transformation.
      cat('Transform features by 1-bit stochastic gradient descent (SGD)\n')
      X_pred_norm_SGD1bit=
        X_pred_norm %>%
        sweep(2,SGD1bit_fit$AveExpr,'-') %>%
        pbsapply(function(x){ifelse(x==0,0,ifelse(x>0,1,-1))}) %>%
        matrix(
          ncol=ncol(X_pred_unnorm)
          ,byrow=F
          ,dimnames=dimnames(X_pred_unnorm)
        ) %>%
        as.data.frame()
      
      # Define the directory to save the Tidyset
      pred_save_dir=
        file.path(
          'data/divnn_models'
          ,paste0(sub('\\..*$','',basename(training_file)),'_target')
          ,sub('\\..*$','',basename(prediction_file))
        )
      
      # Create the directory if it doesn't exist
      if (!dir.exists(pred_save_dir)) {
        dir.create(pred_save_dir,recursive=T)
      }
      
      # Compile into a TidySet.
      cat('Compile into a TidySet and write the .ts.tar.gz\n')
      TidySet.compile(
          value=X_pred_norm_SGD1bit
          ,outcome=y_true %>% setNames(rownames(X_pred_norm_SGD1bit))
          ,similarity=input$similarity
          ,mapping=input$mapping
          ,ontology=input$ontology
          ,ranked=T
          ,dims=7
          ,decreasing=F
          ,seed_num=seed
        ) %>%
        TidySet.write(pred_save_dir)
    }
  }
  
  rm(training_files,prediction_files
     ,training_file,prediction_file
     ,training_data,X_train,y_train,sample_weights
     ,X_train_unnorm,X_train_unnorm_scaled,X_train_norm
     ,SGD1bit_fit
     ,predictor_v,predictor_m,predictor_s
     ,predictor_p,predictor_tsne, predictor_c
     ,input,output
     ,save_dir
     ,prediction_data,X_pred,y_true
     ,X_pred_unnorm,X_pred_norm,X_pred_norm_SGD1bit
     ,pred_save_dir
  )
}
```

```{r}
viz.ontonet=
  function (tidy_set, feature = F, eval.results = NULL, eval.metric = "loss", 
    eval.pal = c("darkred", "darkgreen"), eval.gradient = 100) 
{
    edge = notes(tidy_set)$ontology %>% filter(!target %in% source) %>% 
        select(target) %>% filter(!duplicated(target)) %>% rename(source = target) %>% 
        mutate(target = "root", similarity = NA, relation = "is_a") %>% 
        rbind(notes(tidy_set)$ontology) %>% slice(c(2:nrow(.), 
        1))
    if (!feature) 
        edge = edge %>% filter(relation != "feature")
    if (is.null(eval.results)) {
        node = edge %>% graph_from_data_frame(directed = TRUE) %>% 
            V() %>% names() %>% data.frame(node = .) %>% mutate(avg = NA, 
            color = NA)
    }
    else {
        node = eval.results %>% sapply(unlist) %>% t() %>% as.data.frame() %>% 
            gather() %>% group_by(key) %>% summarize(avg = mean(value), 
            lb = mean(value) - qnorm(0.975) * sd(value)/sqrt(n()), 
            ub = mean(value) + qnorm(0.975) * sd(value)/sqrt(n()), 
            .groups = "drop") %>% mutate(node = case_when(str_detect(key, 
            "ONT") & !str_detect(key, "lr") ~ "ONT", str_detect(key, 
            "root") & !str_detect(key, "lr") ~ "root", str_detect(key, 
            "lr") ~ "lr", TRUE ~ "total") %>% paste0(str_remove_all(key, 
            "[:alpha:]|[:punct:]")), key = str_remove_all(key, 
            "root|val|ONT|[:digit:]|[:punct:]")) %>% group_by(key) %>% 
            mutate(norm.avg = (avg - min(avg))/(max(avg) - min(avg))) %>% 
            ungroup() %>% mutate(color = sapply(norm.avg, function(x) {
            data.frame(avg = cut(seq(0, 1, len = eval.gradient), 
                eval.gradient) %>% as.character() %>% str_remove_all("\\(|\\]"), 
                color = colorRampPalette(eval.pal)(eval.gradient)) %>% 
                separate(avg, c("from", "to"), ",") %>% mutate_at(c("from", 
                "to"), as.numeric) %>% filter(from < x & to >= 
                x) %>% pull(color)
        })) %>% mutate(node = str_replace_all(node, "ONT", "ONT:")) %>% 
            filter(key == eval.metric)
        node = edge %>% graph_from_data_frame(directed = TRUE) %>% 
            V() %>% names() %>% data.frame(node = .) %>% left_join(node, 
            by = "node")
    }
    output = list(node = node, edge = edge, feature = feature, 
        eval.results = eval.results, eval.metric = eval.metric, 
        eval.pal = eval.pal, eval.gradient = eval.gradient)
    class(output) = "viz.ontonet"
    output
  }

print.viz.ontonet=
  function(x) {
        cat(paste0("\n    Method: viz.ontonet\n\n    Ontonet node and edge tables for visualization purpose\n    \n    Total:\n      ", 
            nrow(x$node), " node", ifelse(nrow(x$node) == 1, 
                "", "s"), "\n      ", nrow(x$edge), " edge", 
            ifelse(nrow(x$edge) == 1, "", "s"), "\n    "))
  }

plot.viz.ontonet=
  function(x, 
        node.color = NA, node.fill = "black", node.shape = "circle", 
        node.size = 20, label = F, label.family = "sans", label.cex = 0.5, 
        label.color = "white", edge.color = "black", seed_num = 33, 
        ...) {
        node = x$node %>% mutate(color = ifelse(is.na(color), node.fill, 
            color))
        set.seed(seed_num)
        ontograph = x$edge %>% graph_from_data_frame(directed = TRUE)
        V(ontograph)$color = node$color
        V(ontograph)$shape = node.shape
        if (label) {
            V(ontograph)$label = ifelse(is.na(x$node$avg), names(V(ontograph)), 
                paste0(names(V(ontograph)), "\n", round(x$node$avg, 
                  3)))
            V(ontograph)$label.family = label.family
            V(ontograph)$label.cex = label.cex
            V(ontograph)$label.color = label.color
        }
        else {
            V(ontograph)$label = NA
        }
        ontograph %>% plot.igraph(layout = layout_as_tree(., 
            mode = "in"), vertex.frame.color = node.color, vertex.size = node.size, 
            edge.color = edge.color, ...)
    }
```

```{r}
divnn_cutoff_03=
  TidySet.read('data/divnn_models/pred_data_training_cutoff_03.ts.tar.gz')

divnn_cutoff_06=
  TidySet.read('data/divnn_models/pred_data_training_cutoff_06.ts.tar.gz')

divnn_cutoff_09=
  TidySet.read('data/divnn_models/pred_data_training_cutoff_09.ts.tar.gz')

divnn_cutoff_12=
  TidySet.read('data/divnn_models/pred_data_training_cutoff_12.ts.tar.gz')

divnn_cutoff_no=
  TidySet.read('data/divnn_models/pred_data_training_cutoff_no.ts.tar.gz')
```

```{r eval=FALSE, fig.height=10, fig.width=7, include=FALSE}
list(
    divnn_cutoff_03
    ,divnn_cutoff_06
    ,divnn_cutoff_09
    ,divnn_cutoff_12
    ,divnn_cutoff_no
  ) %>%
  lapply(\(x)
    list(
      x %>%
        viz.ontonet(feature=T) %>%
        plot(label=T)
      
      ,x %>%
        notes() %>%
        .$ontotype %>%
        lapply(as.data.frame) %>%
        lapply(rownames_to_column,var='feature') %>%
        lapply(X=names(.),Y=.,\(X,Y)mutate(Y[[X]],ontology=X)) %>%
        do.call(rbind,.) %>%
        mutate(
          feature_id=
            feature %>%
            factor(unique(.)) %>%
            as.numeric() %>%
            str_pad(2,'left',0)
          ,feature=
            paste0(feature_id,'_',feature)
        ) %>%
        ggplot(aes(x,y,fill=feature)) +
        geom_tile(color='white',alpha=0.2) +
        geom_text(aes(label=feature_id),check_overlap=T) +
        facet_wrap(~ontology,ncol=2) +
        coord_equal()
    )
  )
```

```{r}
divnn2_cutoff_03=
  TidySet.read('data/backup_divnnmodels2/pred_data_training_cutoff_03.ts.tar.gz')

divnn2_cutoff_06=
  TidySet.read('data/backup_divnnmodels2/pred_data_training_cutoff_06.ts.tar.gz')

divnn2_cutoff_09=
  TidySet.read('data/backup_divnnmodels2/pred_data_training_cutoff_09.ts.tar.gz')

divnn2_cutoff_12=
  TidySet.read('data/backup_divnnmodels2/pred_data_training_cutoff_12.ts.tar.gz')

divnn2_cutoff_no=
  TidySet.read('data/backup_divnnmodels2/pred_data_training_cutoff_no.ts.tar.gz')
```

```{r eval=FALSE, fig.height=10, fig.width=7, include=FALSE}
list(
    divnn2_cutoff_03
    ,divnn2_cutoff_06
    ,divnn2_cutoff_09
    ,divnn2_cutoff_12
    ,divnn2_cutoff_no
  ) %>%
  lapply(\(x)
    list(
      x %>%
        viz.ontonet(feature=T) %>%
        plot(label=T)
      
      ,x %>%
        notes() %>%
        .$ontotype %>%
        lapply(as.data.frame) %>%
        lapply(rownames_to_column,var='feature') %>%
        lapply(X=names(.),Y=.,\(X,Y)mutate(Y[[X]],ontology=X)) %>%
        do.call(rbind,.) %>%
        mutate(
          feature_id=
            feature %>%
            factor(unique(.)) %>%
            as.numeric() %>%
            str_pad(2,'left',0)
          ,feature=
            paste0(feature_id,'_',feature)
        ) %>%
        ggplot(aes(x,y,fill=feature)) +
        geom_tile(color='white',alpha=0.2) +
        geom_text(aes(label=feature_id),check_overlap=T) +
        facet_wrap(~ontology,ncol=2) +
        coord_equal()
    )
  )
```

```{r fig.height=5, fig.width=10}
divnn_iteration=
  list.files('data/divnn_models',full.names=T,recursive=T) %>%
  .[str_detect(.,'ontonet/')] %>%
  .[str_detect(.,'history\\.csv')] %>%
  `names<-`(as.character(.)) %>%
  lapply(read_csv,show_col_types=F) %>%
  lapply(X=names(.),Y=.,\(X,Y)
    Y[[X]] %>%
      mutate(path=X)
  ) %>%
  do.call(rbind,.)%>%
  mutate(
    model=
      path %>%
      str_replace_all('divnn_models','pytorch_models/divnn') %>%
      sapply(\(x)str_split(x,'/')) %>%
      sapply(\(x)paste0(x[3],':',x[2],':',x[4]))
  ) %>%
  separate(model,c('algorithm','platform','cutoff'),sep='\\:') %>%
  mutate_at('platform',str_remove_all,'_models') %>%
  mutate_at('cutoff',str_remove_all,'pred_data_training_cutoff_|_ontonet') %>%
  
  select(algorithm,cutoff,platform,everything())

divnn_iteration %>%
  select(-algorithm,-platform,-path,-tp,-fn,-fp,-tn) %>%
  gather(metric,value,-cutoff,-subset,-epoch) %>%
  filter(metric=='lr') %>%
  ggplot(aes(epoch,value,color=subset)) +
  geom_smooth(method='loess',formula=y~x) +
  facet_wrap(subset~cutoff,scales='free_y',ncol=5)
```

```{r eval=FALSE, include=FALSE}
divnn_iteration %>%
  filter(subset=='validation') %>%
  select(cutoff,epoch,lr,roc_auc) %>%
  left_join(
    select(.,cutoff,epoch,roc_auc) %>%
      mutate(epoch2=epoch) %>%
      mutate(epoch=epoch-1)
    ,by=c('cutoff','epoch')
  ) %>%
  rename(epoch.x=epoch) %>%
  rename(epoch.y=epoch2) %>%
  mutate(roc_auc_d=roc_auc.y-roc_auc.x) %>%
  filter(roc_auc_d<0.01) %>%
  group_by(cutoff) %>%
  slice(1:2)
```

```{r List modeling result files, include=FALSE}
modeling_results=
  list.files('data/sklearn_models',full.names=T,recursive=T) %>%
  c(list.files('data/caret_models',full.names=T,recursive=T)) %>%
  c(list.files('data/divnn_models',full.names=T,recursive=T)) %>%
  data.frame(path=.) %>%
  mutate(
    model=
      path %>%
      str_replace_all('divnn_models','pytorch_models/divnn') %>%
      sapply(\(x)str_split(x,'/')) %>%
      sapply(\(x)paste0(x[3],':',x[2]))
  ) %>%
  separate(model,c('algorithm','platform'),sep='\\:') %>%
  mutate_at('platform',str_remove_all,'_models') %>%
  select(algorithm,platform,everything()) %>%
  arrange(
    algorithm %>%
      factor(c('rr','dt','rf','gb','divnn'))
    ,platform %>%
      factor(c('sklearn','caret','pytorch'))
  )
```

```{r List the best hyperparameters, include=FALSE}
best_params=
  modeling_results %>%
  filter(str_detect(path,'best_params')) %>%
  pull(path) %>%
  `names<-`(as.character(.)) %>%
  lapply(read_csv,show_col_types=F) %>%
  lapply(gather,hyperparameter,value) %>%
  lapply(X=names(.),Y=.,\(X,Y)
    Y[[X]] %>%
      mutate(path=X)
  ) %>%
  do.call(rbind,.) %>%
  mutate(
    model=
      path %>%
      sapply(\(x)str_split(x,'/')) %>%
      sapply(\(x)paste0(x[3],':',x[2],':',x[4]))
  ) %>%
  separate(model,c('algorithm','platform','cutoff'),sep='\\:') %>%
  mutate_at('platform',str_remove_all,'_models') %>%
  mutate_at('cutoff',str_remove_all,'pred_data_training_cutoff_') %>%
  
  rbind(
    list.files('data/divnn_models',full.names=T,recursive=T) %>%
      .[str_detect(.,'ontonet_tuning')] %>%
      .[str_detect(.,'history\\.csv')] %>%
      `names<-`(
        str_remove_all(
          .
          ,'data/divnn_models/pred_data_training_|_ontonet_tuning|/history\\.csv'
        )
      ) %>%
      lapply(read_csv,show_col_types=F) %>%
      lapply(X=names(.),Y=.,\(X,Y)mutate(Y[[X]],file=X)) %>%
      do.call(rbind,.) %>%
      select(file,everything()) %>%
      separate(file,c('model','hyperparameter'),sep='/') %>%
      inner_join(
        list.files('data/divnn_models',full.names=T,recursive=T) %>%
          .[str_detect(.,'ontonet_tuning')] %>%
          .[str_detect(.,'\\.pt')] %>%
          data.frame(file=.) %>%
          mutate(
            file=
              file %>%
              str_remove_all(
                'data/divnn_models/pred_data_training_|_ontonet_tuning|/\\.pt'
              )
          ) %>%
          separate(file,c('model','hyperparameter','epoch'),sep='/') %>%
          filter(epoch!='null.pt') %>%
          mutate(
            epoch=
              epoch %>%
              str_remove_all('\\.pt') %>%
              as.numeric()
          ) %>%
          group_by(model,hyperparameter) %>%
          filter(epoch==max(epoch))
        ,by=c('model','hyperparameter','epoch')
      ) %>%
      filter(subset=='validation') %>%
      select(-subset) %>%
      group_by(model) %>%
      filter(roc_auc==max(roc_auc)) %>%
      ungroup() %>%
      rename(cutoff=model) %>%
      lapply(X=1,Y=.,\(X,Y)
        list(
            Y
            ,Y %>%
              mutate(
                training_tidy_set_file=
                  cutoff %>%
                  str_remove_all('cutoff_')
                ,training_tidy_set_file=
                  paste0(
                    'data/divnn_models/pred_data_training_cutoff_'
                    ,training_tidy_set_file
                    ,'.ts.tar.gz'
                  )
                ,l2_norm=
                  hyperparameter %>%
                  str_remove_all('l2_norm_') %>%
                  as.numeric()
              ) %>%
              select(training_tidy_set_file,l2_norm) %>%
              write_csv('data/divnn_models/best_l2_norm.csv')
          ) %>%
          .[[1]]
      ) %>%
      .[[1]] %>%
      mutate(
        cutoff=
          cutoff %>%
          str_remove_all('cutoff_')
      ) %>%
      left_join(
        list.files('data/divnn_models',full.names=T,recursive=T) %>%
          .[str_detect(.,'ontonet_tuning')] %>%
          .[str_detect(.,'history\\.csv')] %>%
          data.frame(path=.) %>%
          mutate(
            cutoff=
              path %>%
              str_remove_all(
                paste0(
                  c('data/divnn_models/pred_data_training_cutoff_'
                    ,'_ontonet_tuning/l2_norm_'
                    ,'[:digit:]*\\.*[:digit:]*\\/[:alnum:]*\\.[:alpha:]+'
                  )
                  ,collapse='|'
                )
              )
            ,hyperparameter=
              path %>%
              str_remove_all(
                paste0(
                  c('data/divnn_models/pred_data_training_cutoff_'
                    ,'[:alnum:]*_ontonet_tuning/'
                    ,'\\/[:alnum:]*\\.[:alpha:]+'
                  )
                  ,collapse='|'
                )
              )
          )
        ,by=c('cutoff','hyperparameter')
      ) %>%
      rename(l2_norm=hyperparameter) %>%
      mutate(
        l2_norm=
          l2_norm %>%
          str_remove_all('l2_norm_') %>%
          as.numeric()
      ) %>%
      select(-total_loss,-root_loss,-roc_auc,-tp,-fn,-fp,-tn) %>%
      rename(tuning_epoch=epoch) %>%
      left_join(
        list.files('data/divnn_models',full.names=T,recursive=T) %>%
          .[str_detect(.,'ontonet/')] %>%
          .[str_detect(.,'history\\.csv')] %>%
          `names<-`(
            str_remove_all(
              .
              ,'data/divnn_models/pred_data_training_|_ontonet|/history\\.csv'
            )
          ) %>%
          lapply(read_csv,show_col_types=F) %>%
          lapply(X=names(.),Y=.,\(X,Y)mutate(Y[[X]],file=X)) %>%
          do.call(rbind,.) %>%
          select(file,everything()) %>%
          rename(model=file) %>%
          group_by(model,subset) %>%
          filter(roc_auc==max(roc_auc)) %>%
          ungroup() %>%
            
          filter(subset=='validation') %>%
          select(-subset) %>%
          rename(cutoff=model) %>%
          mutate(
            cutoff=
              cutoff %>%
              str_remove_all('cutoff_')
          ) %>%
          select(cutoff,epoch)
        ,by='cutoff'
      ) %>%
      gather(hyperparameter,value,-cutoff,-path) %>%
      mutate(algorithm='divnn',platform='pytorch')
  ) %>%
  
  select(algorithm,cutoff,platform,everything()) %>%
  arrange(
    algorithm %>%
      factor(c('rr','dt','rf','gb','divnn'))
    ,cutoff %>%
      factor()
    ,platform %>%
      factor(c('sklearn','caret','pytorch'))
  )
```

```{r}
best_models=
  modeling_results %>%
  filter(str_detect(path,'prob_pred')) %>%
  pull(path) %>%
  `names<-`(as.character(.)) %>%
  pblapply(read_csv,show_col_types=F) %>%
  pblapply(X=names(.),Y=.,\(X,Y)
    data.frame(path=X) %>%
      mutate(
        model=
          path %>%
          str_replace_all('divnn_models','pytorch_models/divnn') %>%
          sapply(\(x)str_split(x,'/')) %>%
          sapply(\(x)paste0(x[3],':',x[2],':',x[4],':',x[5]))
      ) %>%
      separate(model,c('algorithm','platform','cutoff','data'),sep='\\:') %>%
      mutate_at('platform',str_remove_all,'_models') %>%
      mutate_at(
        'cutoff'
        ,str_remove_all
        ,'pred_data_training_cutoff_|_ontonet'
      ) %>%
      mutate_at('data',str_remove_all,'prob_pred_data_|\\.csv') %>%
      select(algorithm,cutoff,data,platform,everything()) %>%
      cbind(
        list(
            Y[[X]]
            ,Y[[X]] %>%
              mutate(ontology='') %>%
              select(ontology,everything())
          ) %>%
          .[[ifelse(str_detect(X,'divnn_models'),1,2)]]
      ) %>%
      mutate(
        algorithm=
          paste0(
            algorithm
            ,ifelse(algorithm=='divnn','_','')
            ,ontology
          )
      ) %>%
      select(-ontology)
  ) %>%
  do.call(rbind,.) %>%
  arrange(
    algorithm %>%
      factor(
        c('rr'
          ,'dt'
          ,'rf'
          ,'gb'
          ,unique(.) %>%
            .[str_detect(.,'divnn')]
        )
      )
    ,cutoff %>%
      factor()
    ,platform %>%
      factor(c('sklearn','caret','pytorch'))
  )
```

```{r}
calibration=
  function(
    eval_df
    ,boot=30
  ){
    eval_df_bin=
      eval_df %>%
      mutate(pred=round(pred,1))
    
    calib_plot_df=
      eval_df_bin %>%
      group_by(pred) %>%
      summarize(
        true=mean(obs==levels(obs)[2])
        ,se=qnorm(0.975)*sd(obs==levels(obs)[2])/sqrt(n())
        ,lb=true-se
        ,ub=true+se
      )
    
    calib_plot=
      calib_plot_df %>%
      ggplot(aes(pred,true)) +
      geom_abline(slope=1,intercept=0,lty=2) +
      geom_linerange(aes(ymin=lb,ymax=ub)) +
      geom_point() +
      geom_smooth(method='lm',formula=y~x,color='black',na.rm=T) +
      coord_equal() +
      scale_x_continuous(limits=0:1,breaks=seq(0,1,0.1)) +
      scale_y_continuous(limits=0:1,breaks=seq(0,1,0.1)) +
      theme_classic()
    
    calib_dist=
      eval_df_bin %>%
      group_by(obs,pred) %>%
      summarize(n=n(),.groups='drop') %>%
      ggplot(aes(pred,n)) +
      geom_col(width=0.075,) +
      facet_grid(obs~.,scales='free_y') +
      scale_x_continuous(limits=c(-0.1,1.1),breaks=seq(0,1,0.1)) +
      scale_y_continuous(trans='log10') +
      theme_classic()
    
    set.seed(1)
    calib_metrics=
      calib_plot_df %>%
      lm(true~pred,data=.) %>%
      tidy() %>%
      mutate(term=c('intercept','slope')) %>%
      mutate(ci=qnorm(0.975)*std.error) %>%
      select(-std.error,-statistic,-p.value) %>%
      rbind(
        eval_df %>%
        mutate(sqr_error=(pred-as.integer(obs==levels(obs)[2]))^2) %>%
        pull(sqr_error) %>%
        sapply(X=seq(boot),Y=.,function(X,Y)
          Y %>%
            .[sample(seq(length(.)),length(.),T)] %>%
            mean() %>%
            sqrt()
        ) %>%
        data.frame(term='rmse',rmse=.) %>%
        group_by(term) %>%
        summarize(
          estimate=mean(rmse)
          ,ci=qnorm(0.975)*sd(rmse)/sqrt(n())
          ,.groups='drop'
        )
      )
    
    list(
      plot=calib_plot
      ,dist=calib_dist
      ,metrics=calib_metrics
    )
  }
```

```{r}
compute_metrics=
  function(
    eval_df
    ,p=T
    ,tpr=T
    ,tnr=T
    ,ppv=T
    ,npv=T
    ,nb=T
    ,interp=F
  ){
    cm=
      eval_df %>%
      cbind(
        seq(0,1,0.01) %>%
          matrix(
            nrow=1
            ,byrow=T
            ,dimnames=list(NULL,str_pad(.,str_count(max(.)),'left','0'))
          ) %>%
          as.data.frame()
      ) %>%
      mutate(seq=seq(nrow(.))) %>%
      select(seq,everything()) %>%
      gather(th,value,-seq,-pred,-obs) %>%
      mutate(
        pred=
          factor(
            ifelse(pred>=value,levels(obs)[2],levels(obs)[1])
            ,levels(obs)
          )
      ) %>%
      group_by(th) %>%
      summarize(
        tp=sum(obs==levels(obs)[2] & pred==levels(obs)[2])
        ,fn=sum(obs==levels(obs)[2] & pred==levels(obs)[1])
        ,fp=sum(obs==levels(obs)[1] & pred==levels(obs)[2])
        ,tn=sum(obs==levels(obs)[1] & pred==levels(obs)[1])
        ,.groups='drop'
      ) %>%
      mutate(th=as.numeric(th))
    
    metrics=cm
    
    if(p){
      metrics=
        metrics %>%
        mutate(p=(tp+fn)/(tp+fn+fp+tn))
    }
    
    if(tpr){
      metrics=
        metrics %>%
        mutate(tpr=tp/(tp+fn))
    }
    
    if(tnr){
      metrics=
        metrics %>%
        mutate(tnr=tn/(fp+tn))
    }
    
    if(ppv){
      metrics=
        metrics %>%
        mutate(ppv=tp/(tp+fp))
    }
    
    if(npv){
      metrics=
        metrics %>%
        mutate(npv=tn/(tn+fn))
    }
    
    if(nb){
      metrics=
        metrics %>%
        mutate(nb=(tp-fp*th/(1-th))/(tp+fn+fp+tn))
    }
    
    metrics=
      metrics %>%
      select(-tp,-fn,-fp,-tn) %>%
      mutate_all(round,4)
    
    if(interp){
      for(colname in colnames(metrics)){
        metrics=
          metrics %>%
          full_join(
            select_at(.,colname) %>%
              setNames('metric') %>%
              filter(!is.na(metric)) %>%
              filter(!is.nan(metric)) %>%
              filter(metric==min(metric)| metric==max(metric)) %>%
              filter(!duplicated(.)) %>%
              arrange(metric) %>%
              pull(metric) %>%
              lapply(X=1,Y=.,function(X,Y)seq(Y[1],Y[2],0.0001)) %>%
              .[[1]] %>%
              data.frame(metric=.) %>%
              setNames(colname)
            ,by=colname
          )
        
        for(colname2 in colnames(metrics) %>% .[.!=colname]){
          metrics=
            metrics %>%
            arrange_at(c(colname,colname2)) %>%
            mutate_at(
              colname2
              ,function(x) approx(seq(length(x)),x,seq(length(x)))$y
            )
        }
        
        metrics=
          metrics %>%
          mutate_all(round,4)
      }
    }
    
    list(
      cm=cm
      ,metrics=metrics
    )
  }
```

```{r}
discrimination=
  function(
    eval_df
    ,boot=30
  ){
    source('R/compute_metrics-function.R')
    
    disc_plot=
      eval_df %>%
      compute_metrics(p=F,ppv=F,npv=F,nb=F,interp=F) %>%
      .$metrics %>%
      select(th,tpr,tnr) %>%
      ggplot(aes(tnr,tpr)) +
      geom_abline(slope=1,intercept=1,lty=2) +
      geom_path() +
      geom_point() +
      geom_text(
        aes(label=round(th,2))
        ,hjust=-0.1
        ,vjust=1.1
        ,size=3
        ,check_overlap=T
      ) +
      coord_equal() +
      scale_x_reverse(breaks=seq(0,1,0.1)) +
      scale_y_continuous(breaks=seq(0,1,0.1)) +
      theme_classic()
    
    set.seed(1)
    disc_metrics=
      seq(boot) %>%
      lapply(function(x){
        eval_df %>%
          .[sample(seq(nrow(.)),nrow(.),T),] %>%
          compute_metrics(p=F,ppv=F,npv=F,nb=F,interp=F) %>%
          .$metrics %>%
          mutate(boot=x)
      }) %>%
      do.call(rbind,.) %>%
      select(-th) %>%
      group_by(boot) %>%
      arrange(tnr,tpr) %>%
      mutate(seq=seq(n())) %>%
      ungroup() %>%
      rename(x=tnr,y=tpr) %>%
      left_join(
        slice(.,-1) %>%
          mutate(seq=seq-1) %>%
          rename(x2=x,y2=y)
        ,by=c('boot','seq')
      ) %>%
      mutate(
        auc=
          0.5*(x2-x)*(y-y2)+
          (x2-x)*y2
      ) %>%
      group_by(boot) %>%
      summarize(auc=sum(auc,na.rm=T),.groups='drop') %>%
      summarize(
        term='AUC-ROC'
        ,estimate=mean(auc)
        ,ci=qnorm(0.975)*sd(auc)/sqrt(n())
      )
    
    list(
      plot=disc_plot
      ,metrics=disc_metrics
    )
  }
```

```{r}
decision=
  function(
    eval_df
    ,boot=30
  ){
    source('R/compute_metrics-function.R')
    
    dec_plot=
      eval_df %>%
      compute_metrics(p=F,tpr=F,tnr=F,ppv=F,npv=F,interp=F) %>%
      .$metrics %>%
      select(th,nb) %>%
      # filter(th<=mean(eval_df$obs==levels(eval_df$obs)[2])*2) %>%
      ggplot(aes(th,nb)) +

      geom_hline(yintercept=0,lty=2) +
      annotate('text',0,0,label='treat none',hjust=0,vjust=-0.4,size=3) +
      geom_abline(
        slope=-1
        ,intercept=mean(eval_df$obs==levels(eval_df$obs)[2])
        ,lty=2
      ) +
      annotate(
        'text'
        ,0
        ,mean(eval_df$obs==levels(eval_df$obs)[2])
        ,angle=-50
        ,label='treat all'
        ,hjust=-0.4
        ,vjust=1.4
        ,size=3
      ) +
      geom_path() +
      geom_point() +
      scale_x_continuous(breaks=seq(0,1,0.01)) +
      scale_y_continuous(breaks=seq(0,1,0.01)) +
      theme_classic()
    
    set.seed(1)
    dec_metrics=
      seq(boot) %>%
      lapply(function(x){
        eval_df %>%
          .[sample(seq(nrow(.)),nrow(.),T),] %>%
          compute_metrics(tpr=F,tnr=F,ppv=F,npv=F,interp=F) %>%
          .$metrics %>%
          mutate(boot=x)
      }) %>%
      do.call(rbind,.) %>%
      group_by(boot,p) %>%
      arrange(th,nb) %>%
      mutate(seq=seq(n())) %>%
      ungroup() %>%
      rename(x=th,y=nb) %>%
      left_join(
        slice(.,-1) %>%
          mutate(seq=seq-1) %>%
          rename(x2=x,y2=y)
        ,by=c('boot','p','seq')
      ) %>%
      mutate(
        auc=
          0.5*(x2-x)*(y-y2)+
          (x2-x)*y2
      ) %>%
      group_by(boot,p) %>%
      summarize(auc=sum(auc,na.rm=T),.groups='drop') %>%
      mutate(auc=(auc-0.5*p^2)/p) %>%
      summarize(
        term='Net% AUC-DC'
        ,estimate=mean(auc)
        ,ci=qnorm(0.975)*sd(auc)/sqrt(n())
      )
    
    list(
      plot=dec_plot
      ,metrics=dec_metrics
    )
  }
```

```{r}
thresholding=
  function(
    eval_df
    ,standard=T
    ,optimal=T
    ,clinical=T
    ,custom_metric=NULL
    ,custom_ref=NULL
    ,boot=30
  ){
    source('R/compute_metrics-function.R')
    
    set.seed(1)
    cm_metrics=
      seq(boot) %>%
      lapply(function(x){
        eval_df %>%
          .[sample(seq(nrow(.)),nrow(.),T),] %>%
          compute_metrics(p=F,interp=T) %>%
          .$metrics
      }) %>%
      do.call(rbind,.)
    
    thresholds=list()
    
    if(standard){
      thresholds$standard=
        cm_metrics %>%
        filter(th==0.5) %>%
        gather(metric,value,-th) %>%
        mutate(ref_type='Threshold') %>%
        rename(ref_value=th) %>%
        select(ref_type,everything())
    }
    
    if(optimal){
      thresholds$optimal=
        cm_metrics %>%
        mutate(avg_acc=(tpr+tnr)/2) %>%
        filter(avg_acc==max(avg_acc)) %>%
        gather(metric,value,-avg_acc) %>%
        mutate(ref_type='(TPR+TNR)/2') %>%
        rename(ref_value=avg_acc) %>%
        select(ref_type,everything())
    }
    
    if(clinical){
      thresholds$clinical=
        cm_metrics %>%
        filter(tnr==0.9) %>%
        gather(metric,value,-tnr) %>%
        mutate(ref_type='TNR') %>%
        rename(ref_value=tnr) %>%
        select(ref_type,everything())
    }
    
    if(!is.null(custom_metric) & !is.null(custom_ref)){
      thresholds$custom=
        cm_metrics %>%
        rename_at(custom_metric,function(x)'custom_metric') %>%
        filter(custom_metric==custom_ref) %>%
        gather(metric,value,-custom_metric) %>%
        rename(ref_value=custom_metric) %>%
        mutate(ref_type=str_to_upper(custom_metric)) %>%
        select(ref_type,everything())
    }
    
    thresholds %>%
      do.call(rbind,.) %>%
      group_by(ref_type,ref_value,metric) %>%
      summarize(
        avg=mean(value)
        ,lb=mean(value)-qnorm(0.975)*sd(value)/sqrt(n())
        ,ub=mean(value)+qnorm(0.975)*sd(value)/sqrt(n())
        ,.groups='drop'
      ) %>%
      mutate(
        avg=
          ifelse(
            metric%in%c('th','nb')
            ,round(avg,2)
            ,round(avg*100,2)
          )
        ,lb=
          ifelse(
            metric%in%c('th','nb')
            ,round(lb,2)
            ,round(lb*100,2)
          )
        ,ub=
          ifelse(
            metric%in%c('th','nb')
            ,round(ub,2)
            ,round(ub*100,2)
          )
      )
  }
```

```{r}
causal_prob=
  function(
    inference_model
    ,threshold
    ,train_data
    ,outcome_name='outcome'
  ){
    outcome=
      train_data %>%
      pull(outcome_name)
    
    inference_data=
      inference_model %>%
      predict(train_data,type='response') %>%
      data.frame(pred=.) %>%
      mutate(
        pred=
          ifelse(
            pred>=threshold
            ,levels(outcome)[2]
            ,levels(outcome)[1]
          ) %>%
          factor(levels=levels(outcome))
      ) %>%
      cbind(train_data) %>%
      select_at(colnames(.) %>% .[.!=outcome_name]) %>%
      rename_at('pred',function(x)outcome_name)
    
    get_counterfactual=
      function(
        predictor_name
        ,outcome_name
        ,inference_data
      ){
        predictor=
          inference_data %>%
          pull(predictor_name)
        
        outcome=
          inference_data %>%
          pull(outcome_name)
        
        if(is.factor(predictor)){
          reference=levels(predictor)[1]
          interest=levels(predictor)[-1]
          
          inference=list()
          
          inference$sufficiency$factual=
            inference_data %>%
            filter_at(predictor_name,function(x)x==reference) %>%
            filter_at(outcome_name,function(x)x==levels(outcome)[1])
          
          inference$sufficiency$counterfactual=
            interest %>%
            lapply(function(x)
              inference$sufficiency$factual %>%
                mutate_at(
                  predictor_name
                  ,function(y)factor(x,levels=levels(predictor))
                ) %>%
                mutate_at(
                  outcome_name
                  ,function(y)NA
                ) %>%
                mutate(term=x)
            ) %>%
            do.call(rbind,.)
          
          inference$sufficiency$factual=
            interest %>%
            lapply(function(x)
              inference$sufficiency$factual %>%
                mutate(term=x)
            ) %>%
            do.call(rbind,.)
            inference_data %>%
            filter_at(predictor_name,function(x)x==reference) %>%
            filter_at(outcome_name,function(x)x==levels(outcome)[1]) %>%
            mutate(term=reference)
          
          inference$necessity$factual=
            interest %>%
            lapply(function(x)
              inference_data %>%
                filter_at(predictor_name,function(y)y==x) %>%
                filter_at(outcome_name,function(y)y==levels(outcome)[2]) %>%
                mutate(term=x)
            ) %>%
            do.call(rbind,.)
          
          inference$necessity$counterfactual=
            interest %>%
            lapply(function(x)
              inference$necessity$factual %>%
                filter_at(predictor_name,function(y)y==x) %>%
                mutate_at(
                  predictor_name
                  ,function(x)factor(reference,levels=levels(predictor))
                ) %>%
                mutate_at(
                  outcome_name
                  ,function(x)NA
                ) %>%
                mutate(term=x)
            ) %>%
            do.call(rbind,.)
        }else if(is.numeric(predictor)){
          predictor_scaler=
            inference_data %>%
            filter(outcome==levels(outcome)[1]) %>%
            mutate(seq=seq(nrow(.))) %>%
            select_at(c('seq',predictor_name)) %>%
            gather(variable,value,-seq) %>%
            group_by(variable) %>%
            summarize(
              q1=quantile(value,0.25)
              ,q3=quantile(value,0.75)
              ,iqr=q3-q1
              ,avg=mean(ifelse(value<(q1-1.5*iqr) | value>(q3+1.5*iqr),NA,value),na.rm=T)
              ,std=sd(ifelse(value<(q1-1.5*iqr) | value>(q3+1.5*iqr),NA,value),na.rm=T)
              ,lb=avg-qnorm(0.975)*std
              ,ub=avg+qnorm(0.975)*std
              ,lb=round(lb,2)
              ,ub=round(ub,2)
              ,.groups='drop'
            )
          
          predictor_factor=
            inference_data %>%
            filter(outcome==levels(outcome)[1]) %>%
            mutate(seq=seq(nrow(.))) %>%
            select_at(c('seq',predictor_name)) %>%
            gather(variable,value,-seq) %>%
            left_join(predictor_scaler,by='variable') %>%
            mutate(
              value2=
                factor(
                  ifelse(
                    value>=lb & value<=ub
                    ,'normal'#paste0('value>=',lb[1],' & value<=',ub[1],'')
                    ,'abnormal'#paste0('value<',lb[1],' & value>',ub[1],'')
                  )
                  ,levels=
                    c('normal'#paste0('value>=',lb[1],' & value<=',ub[1],'')
                      ,'abnormal'#paste0('value<',lb[1],' & value>',ub[1],'')
                      )
                )
            ) %>%
            select(seq,variable,value2) %>%
            spread(variable,value2) %>%
            select(-seq) %>%
            pull(1)
          
          reference=
            which(predictor_factor==levels(predictor_factor)[1]) %>%
            intersect(which(outcome==levels(outcome)[1]))
          interest=
            which(predictor_factor==levels(predictor_factor)[2]) %>%
            intersect(which(outcome==levels(outcome)[2]))
          
          inference=list()
          
          inference$sufficiency$factual=
            inference_data %>%
            slice(reference) %>%
            mutate(term=levels(predictor_factor)[2])
          
          inference$sufficiency$counterfactual=
            inference$sufficiency$factual %>%
            mutate_at(
              predictor_name
              ,function(y)y+ifelse(y>=0,1,-1)*qnorm(0.975)*predictor_scaler$std
            ) %>%
            mutate_at(
              outcome_name
              ,function(y)NA
            ) %>%
            mutate(term=levels(predictor_factor)[2])
          
          inference$necessity$factual=
            inference_data %>%
            slice(interest) %>%
            mutate(term=levels(predictor_factor)[2])
          
          inference$necessity$counterfactual=
            inference$necessity$factual %>%
            mutate_at(
              predictor_name
              ,function(y)y+ifelse(y>=0,-1,1)*qnorm(0.975)*predictor_scaler$std
            ) %>%
            mutate_at(
              outcome_name
              ,function(y)NA
            ) %>%
            mutate(term=levels(predictor_factor)[2])
        }
        
        inference %>%
          lapply(X=names(.),Y=.,function(X,Y)
            Y[[X]] %>%
              lapply(X=names(.),Y=.,Z=X,function(X,Y,Z)
                Y[[X]] %>%
                  mutate(
                    prob=Z
                    ,type=X
                  )
              ) %>%
              do.call(rbind,.)
          ) %>%
          do.call(rbind,.) %>%
          mutate(predictor_name=predictor_name) %>%
          select(predictor_name,prob,type,term,everything())
      }
    
    inference_results=
      inference_data %>%
      colnames() %>%
      .[.!=outcome_name] %>%
      lapply(get_counterfactual,outcome_name,inference_data) %>%
      do.call(rbind,.)
    
    counterfactuals=
      inference_results %>%
      pull(outcome) %>%
      is.na() %>%
      which()
    
    inference_results$outcome[counterfactuals]=
      inference_model %>%
      predict(
        inference_results[counterfactuals,]
        ,type='response'
      ) %>%
      data.frame(pred=.) %>%
      mutate(
        pred=
          ifelse(
            pred>=threshold
            ,levels(outcome)[2]
            ,levels(outcome)[1]
          ) %>%
          factor(levels=levels(outcome))
      ) %>%
      pull(pred)
    
    inference_results %>%
      group_by_at(c('predictor_name','prob','type','term',outcome_name)) %>%
      summarize(n=n(),.groups='drop') %>%
      spread(type,n,fill=0) %>%
      filter(factual!=0) %>%
      select_at(colnames(.) %>% .[.!=outcome_name]) %>%
      mutate(value=(factual-counterfactual)/factual) %>%
      unite(value_counterfactual_factual,value,counterfactual,factual,sep='|') %>%
      spread(prob,value_counterfactual_factual) %>%
      separate(
        necessity
        ,paste0('necessity_',c('prob','cf','f'))
        ,sep='\\|'
      ) %>%
      separate(
        sufficiency
        ,paste0('sufficiency_',c('prob','cf','f'))
        ,sep='\\|'
      ) %>%
      mutate_if(!colnames(.)%in%c('predictor_name','term'),as.numeric)
  }
```

```{r}
if(all(c(1,2,3)%in%comp_req)){ # 01h 19m 25s
  tmp=
    best_models %>%
    unite(model_eval,algorithm,cutoff,data,platform,sep='_') %>%
    pull(model_eval) %>%
    .[!duplicated(.)] %>%
    .[str_detect(.,'validation')] %>%
    pblapply(\(x)
      best_models %>%
        unite(model_eval,algorithm,cutoff,data,platform,sep='_') %>%
        filter(model_eval==x) %>%
        select(outcome,prob) %>%
        rename(obs=outcome,pred=prob) %>%
        mutate(
          obs=
            obs %>%
            factor()
        ) %>%
        list(pred_data=.) %>%
        c(list(name=x))
    ) %>%
    pblapply(\(x)
      list(
        list(
          pred_data=x$pred_data
          ,eval=calibration
          ,name=paste0(x$name,'_calibration')
        )
        ,list(
          pred_data=x$pred_data
          ,eval=discrimination
          ,name=paste0(x$name,'_discrimination')
        )
        ,list(
          pred_data=x$pred_data
          ,eval=decision
          ,name=paste0(x$name,'_decision')
        )
      )
    ) %>%
    do.call(c,.)
  
  cl=4#detectCores()-2
  start=T; source('R/parallel_computing-codes.R')
  
  if(!dir.exists('data/eval')) {
    dir.create('data/eval',recursive=T)
  }
  
  tmp %>%
    pblapply(
      cl=cl
      ,\(x)
      x$pred_data %>%
        x$eval() %>%
        saveRDS(paste0('data/eval/',x$name,'.rds'))
    )
  
  start=F; source('R/parallel_computing-codes.R')
  rm(tmp)
}
```

```{r}
eval=
  list.files('data/eval',full.names=T,recursive=T) %>%
  .[str_detect(.,'validation')] %>%
  `names<-`(as.character(.)) %>%
  lapply(readRDS) %>%
  lapply(
    X=names(.) %>%
      str_remove_all('_calibration|_discrimination|_decision|\\.rds') %>%
      .[!duplicated(.)]
    ,Y=.
    ,\(X,Y)
    Y %>%
      .[str_detect(names(.),X)] %>%
      `names<-`(
        names(.) %>%
          str_remove_all(X) %>%
          str_remove_all('_|\\.rds')
      )
  ) %>%
  `names<-`(
    list.files('data/eval',full.names=T,recursive=T) %>%
      .[str_detect(.,'validation')] %>%
      str_remove_all(
        'data/eval/|_calibration|_discrimination|_decision|\\.rds'
      ) %>%
      .[!duplicated(.)] %>%
      str_replace_all('_ONT',':ONT') %>%
      str_replace_all('_root',':root')
  )

eval_all=
  eval %>%
  lapply(X=names(.),Y=.,function(X,Y)
    Y[[X]]$calibration$metrics %>%
      rbind(Y[[X]]$discrimination$metrics) %>%
      rbind(Y[[X]]$decision$metrics) %>%
      mutate(model=X)
  ) %>%
  do.call(rbind,.) %>%
  mutate_at('model',str_remove_all,'_validation') %>%
  separate(model,c('algorithm','cutoff','platform'),sep='_') %>%
  mutate_at(
    'algorithm'
    ,\(x)
      x %>%
        factor(
          c('rr'
            ,'dt'
            ,'rf'
            ,'gb'
            ,unique(.) %>%
              .[str_detect(.,'divnn')]
          )
        )
  ) %>%
  mutate_at('cutoff',factor) %>%
  mutate_at('platform',factor,c('sklearn','caret','pytorch')) %>%
  arrange(algorithm,cutoff,platform) %>%
  mutate(data='validation') %>%
  unite(model,algorithm,cutoff,data,platform,sep='_')

eval=
  eval %>%
  .[eval_all$model %>%
      .[!duplicated(.)]
  ]
```

```{r eval=FALSE, include=FALSE}
eval_all %>%
  mutate_at('model',str_remove_all,'_validation') %>%
  separate(model,c('algorithm','cutoff','platform'),sep='_') %>%
  mutate_at(
    'algorithm'
    ,\(x)
      x %>%
        factor(
          rev(c('rr'
            ,'dt'
            ,'rf'
            ,'gb'
            ,unique(.) %>%
              .[str_detect(.,'divnn')]
          ))
        )
  ) %>%
  mutate_at('cutoff',factor) %>%
  mutate_at('platform',factor,c('sklearn','caret','pytorch')) %>%
  filter(
    !str_detect(algorithm,'divnn')
    | (str_detect(algorithm,'divnn') & str_detect(algorithm,'root'))
  ) %>%
  ggplot(aes(algorithm,estimate,color=platform)) +
  geom_hline(
    data=
      data.frame(
        term=factor(unique(eval_all$term))
        ,ref=c(0,1,0,0.5,0)
      )
    ,aes(yintercept=ref)
    ,lty=2
  ) +
  geom_hline(
    data=
      eval_all %>%
      filter(term%in%c('rmse','AUC-ROC','Net% AUC-DC')) %>%
      group_by(term) %>%
      summarize(
        ref1=min(estimate+ci)
        ,ref2=max(estimate-ci)
      ) %>%
      mutate(
        ref=
          ifelse(
            term=='rmse'
            ,ref1
            ,ref2
          )
      ) %>%
      select(-ref1,-ref2)
    ,aes(yintercept=ref)
    ,lty=2
  ) +
  geom_linerange(
    aes(ymin=estimate-ci,ymax=estimate+ci)
    ,alpha=0.5
    ,na.rm=T
  ) +
  geom_point(alpha=0.5,na.rm=T) +
  facet_grid(
    cutoff~factor(term,unique(eval_all$term))
    ,scales='free_x'
  ) +
  coord_flip()
```

```{r include=FALSE}
eval_report=
  eval %>%
  names() %>%
  str_remove_all('_[:alnum:]+_validation') %>%
  .[!duplicated(.)] %>%
  .[sapply(.,str_detect,'sklearn|pytorch')] %>%
  sapply(\(x)paste0('^',x,'$')) %>%
  .[!str_detect(.,'divnn')
    | (str_detect(.,'divnn') & str_detect(.,'root'))
  ] %>%
  sapply(\(x)str_replace_all(x,'\\:','\\\\:')) %>%
  lapply(\(x)str_split(x,'_')[[1]]) %>%
  lapply(\(x)
    eval %>%
      .[str_detect(names(.),x[1])] %>%
      .[str_detect(names(.),x[2])]
  )
```

```{r eval=FALSE, fig.height=30, fig.width=25, include=FALSE}
eval_report %>%
  lapply(\(x)
    x %>%
      lapply(\(x)
        ggarrange(
          x$calibration$plot +
            annotate(
              x=0.1
              ,y=0.9
              ,geom='label'
              ,label=
                paste0(
                  'intercept '
                  ,round(filter(x$calibration$metrics,term=='intercept')$estimate,3)
                  ,' ('
                  ,round(
                    filter(x$calibration$metrics,term=='intercept')$estimate
                    -filter(x$calibration$metrics,term=='intercept')$ci
                    ,3
                  )
                  ,', '
                  ,round(
                    filter(x$calibration$metrics,term=='intercept')$estimate
                    +filter(x$calibration$metrics,term=='intercept')$ci
                    ,3
                  )
                  ,')'
                  ,'\n'
                  ,'slope '
                  ,round(filter(x$calibration$metrics,term=='slope')$estimate,3)
                  ,' ('
                  ,round(
                    filter(x$calibration$metrics,term=='slope')$estimate
                    -filter(x$calibration$metrics,term=='slope')$ci
                    ,3
                  )
                  ,', '
                  ,round(
                    filter(x$calibration$metrics,term=='slope')$estimate
                    +filter(x$calibration$metrics,term=='slope')$ci
                    ,3
                  )
                  ,')'
                  ,'\n'
                  ,'Brier score '
                  ,round(filter(x$calibration$metrics,term=='rmse')$estimate,3)
                  ,' ('
                  ,round(
                    filter(x$calibration$metrics,term=='rmse')$estimate
                    -filter(x$calibration$metrics,term=='rmse')$ci
                    ,3
                  )
                  ,', '
                  ,round(
                    filter(x$calibration$metrics,term=='rmse')$estimate
                    +filter(x$calibration$metrics,term=='rmse')$ci
                    ,3
                  )
                  ,')'
                )
              ,hjust=0
              ,size=3
            )
          ,x$calibration$dist
          ,nrow=2
          ,ncol=1
          ,heights=c(4,2)
        )
      )
  ) %>%
  lapply(\(x)
    ggarrange(
      x[str_detect(names(x),'_03_')][[1]]
      ,x[str_detect(names(x),'_06_')][[1]]
      ,x[str_detect(names(x),'_09_')][[1]]
      ,x[str_detect(names(x),'_12_')][[1]]
      ,x[str_detect(names(x),'_no_')][[1]]
      ,nrow=1
      ,ncol=5
      ,widths=c(5,5,5,5,5)
      ,labels=
        paste(
          names(x) %>%
            str_remove_all('_[:alnum:]+_validation') %>%
            .[!duplicated(.)]
          ,c('3d','6d','9d','12d','any')
        )
    )
  ) %>%
  lapply(X=1,Y=.,\(X,Y)
    ggarrange(
      Y$rr_sklearn
      # ,Y$rr_caret
      ,Y$dt_sklearn
      ,Y$rf_sklearn
      ,Y$gb_sklearn
      # ,Y$gb_caret
      ,Y$`divnn:root_pytorch`#Y$divnn_pytorch
      ,nrow=5#6
      ,ncol=1
      ,heights=c(6,6,6,6,6)#,6,6)
    )
  ) %>%
  .[[1]]
```

```{r eval=FALSE, fig.height=25, fig.width=25, include=FALSE}
eval_report %>%
  lapply(\(x)
    x %>%
      lapply(\(x)
        x$decision$plot +
          scale_x_continuous(n.breaks=10,limits=c(0,0.3))# +
          # scale_y_continuous(limits=c(0,0.19))
      )
  ) %>%
  lapply(\(x)
    ggarrange(
      x[str_detect(names(x),'_03_')][[1]]
      ,x[str_detect(names(x),'_06_')][[1]]
      ,x[str_detect(names(x),'_09_')][[1]]
      ,x[str_detect(names(x),'_12_')][[1]]
      ,x[str_detect(names(x),'_no_')][[1]]
      ,nrow=1
      ,ncol=5
      ,widths=c(5,5,5,5,5)
      ,labels=
        paste(
          names(x) %>%
            str_remove_all('_[:alnum:]+_validation') %>%
            .[!duplicated(.)]
          ,c('3d','6d','9d','12d','any')
        )
    )
  ) %>%
  lapply(X=1,Y=.,\(X,Y)
    ggarrange(
      Y$rr_sklearn
      # ,Y$rr_caret
      ,Y$dt_sklearn
      ,Y$rf_sklearn
      ,Y$gb_sklearn
      # ,Y$gb_caret
      ,Y$`divnn:root_pytorch`#Y$divnn_pytorch
      ,nrow=5#6
      ,ncol=1
      ,heights=c(5,5,5,5,5)#,5,5)
    )
  ) %>%
  .[[1]]
```

```{r eval=FALSE, fig.height=25, fig.width=25, include=FALSE}
eval_report %>%
  lapply(\(x)
    x %>%
      lapply(\(x)
        x$discrimination$plot
      )
  ) %>%
  lapply(\(x)
    ggarrange(
      x[str_detect(names(x),'_03_')][[1]]
      ,x[str_detect(names(x),'_06_')][[1]]
      ,x[str_detect(names(x),'_09_')][[1]]
      ,x[str_detect(names(x),'_12_')][[1]]
      ,x[str_detect(names(x),'_no_')][[1]]
      ,nrow=1
      ,ncol=5
      ,widths=c(5,5,5,5,5)
      ,labels=
        paste(
          names(x) %>%
            str_remove_all('_[:alnum:]+_validation') %>%
            .[!duplicated(.)]
          ,c('3d','6d','9d','12d','any')
        )
    )
  ) %>%
  lapply(X=1,Y=.,\(X,Y)
    ggarrange(
      Y$rr_sklearn
      # ,Y$rr_caret
      ,Y$dt_sklearn
      ,Y$rf_sklearn
      ,Y$gb_sklearn
      # ,Y$gb_caret
      ,Y$`divnn:root_pytorch`#Y$divnn_pytorch
      ,nrow=5#6
      ,ncol=1
      ,heights=c(5,5,5,5,5)#,5,5)
    )
  ) %>%
  .[[1]]
```

```{r eval=FALSE, include=FALSE}
eval_all %>%
  mutate_at('model',str_remove_all,'_validation') %>%
  separate(model,c('algorithm','cutoff','platform'),sep='_') %>%
  mutate_at(
    'algorithm'
    ,\(x)
      x %>%
        factor(
          rev(c('rr'
            ,'dt'
            ,'rf'
            ,'gb'
            ,unique(.) %>%
              .[str_detect(.,'divnn')]
          ))
        )
  ) %>%
  mutate_at('cutoff',factor) %>%
  mutate_at('platform',factor,c('sklearn','caret','pytorch')) %>%
  arrange(algorithm,cutoff,platform) %>%
  filter(platform%in%c('sklearn','pytorch')) %>%
  filter(term=='AUC-ROC') %>%
  mutate(
    lb=estimate-ci
    ,ub=estimate+ci
  ) %>%
  mutate(algorithm=reorder(algorithm,lb)) %>%
  filter(
    !str_detect(algorithm,'divnn')
    | (str_detect(algorithm,'divnn') & str_detect(algorithm,'root'))
  ) %>%
  ggplot(aes(algorithm,estimate)) +
  geom_linerange(aes(ymin=lb,ymax=ub)) +
  geom_point() +
  facet_grid(cutoff~.) +
  coord_flip() +
  ylab('AUC-ROC (95% CI)') +
  xlab('Algorithm')
```

```{r eval=FALSE, fig.height=3.5, fig.width=9, include=FALSE}
eval_all %>%
  mutate_at('model',str_remove_all,'_validation') %>%
  separate(model,c('algorithm','cutoff','platform'),sep='_') %>%
  mutate_at(
    'algorithm'
    ,\(x)
      x %>%
        factor(
          rev(c('rr'
            ,'dt'
            ,'rf'
            ,'gb'
            ,unique(.) %>%
              .[str_detect(.,'divnn')]
          ))
        )
  ) %>%
  mutate_at('cutoff',factor) %>%
  mutate_at('platform',factor,c('sklearn','caret','pytorch')) %>%
  arrange(algorithm,cutoff,platform) %>%
  filter(term=='AUC-ROC') %>%
  filter(algorithm%in%c('rr','gb')) %>%
  mutate(
    lb=estimate-ci
    ,ub=estimate+ci
  ) %>%
  mutate(cutoff=reorder(cutoff,lb)) %>%
  ggplot(aes(cutoff,estimate,color=platform)) +
  geom_linerange(aes(ymin=lb,ymax=ub),alpha=0.5) +
  geom_point(alpha=0.5) +
  facet_wrap(~algorithm,scales='free_x',ncol=2) +
  coord_flip() +
  ylab('AUC-ROC (95% CI)') +
  xlab('Algorithm')
```

```{r}
validation_all=
  eval_all %>%
  mutate_at('model',str_remove_all,'_validation') %>%
  separate(model,c('algorithm','cutoff','platform'),sep='_') %>%
  mutate_at(
    'algorithm'
    ,\(x)
      x %>%
        factor(
          rev(c('rr'
            ,'dt'
            ,'rf'
            ,'gb'
            ,unique(.) %>%
              .[str_detect(.,'divnn')]
          ))
        )
  ) %>%
  mutate_at('cutoff',factor) %>%
  mutate_at('platform',factor,c('sklearn','caret','pytorch')) %>%
  arrange(algorithm,cutoff,platform) %>%
  filter(platform%in%c('sklearn','pytorch')) %>%
  filter(term=='AUC-ROC') %>%
  mutate(
    lb=estimate-ci
    ,ub=estimate+ci
  ) %>%
  mutate(
    result=
      paste0(
        round(estimate,3)
        ,' ('
        ,round(lb,3)
        ,', '
        ,round(ub,3)
        ,')'
      )
  ) %>%
  mutate(
    model=
      case_when(
        algorithm=='rr'~'Ridge Regression'
        ,algorithm=='dt'~'Decision Tree'
        ,algorithm=='rf'~'Random Forest'
        ,algorithm=='gb'~'XGBoost'
        # ,algorithm=='divnn'~'Deep-Insight Visible Neural Network'
        ,algorithm=='divnn:root'~'Deep-Insight Visible Neural Network (root)'
        ,algorithm=='divnn:ONT22'~'Deep-Insight Visible Neural Network (ONT:22)'
        ,algorithm=='divnn:ONT21'~'Deep-Insight Visible Neural Network (ONT:21)'
        ,algorithm=='divnn:ONT20'~'Deep-Insight Visible Neural Network (ONT:20)'
        ,algorithm=='divnn:ONT19'~'Deep-Insight Visible Neural Network (ONT:19)'
        ,algorithm=='divnn:ONT18'~'Deep-Insight Visible Neural Network (ONT:18)'
        ,algorithm=='divnn:ONT17'~'Deep-Insight Visible Neural Network (ONT:17)'
        ,algorithm=='divnn:ONT16'~'Deep-Insight Visible Neural Network (ONT:16)'
        ,algorithm=='divnn:ONT15'~'Deep-Insight Visible Neural Network (ONT:15)'
        ,algorithm=='divnn:ONT14'~'Deep-Insight Visible Neural Network (ONT:14)'
        ,algorithm=='divnn:ONT13'~'Deep-Insight Visible Neural Network (ONT:13)'
      )
  ) %>%
  select(model,cutoff,result) %>%
  spread(cutoff,result)

validation_all %>%
  filter(
    !str_detect(model,'root|ONT')
    | str_detect(model,'root')
  ) %>%
  knitr::kable() %>%
  kableExtra::kable_classic()
```

```{r}
# best_model_discrimination=
#   best_models %>%
#   filter(algorithm=='rf' & data=='test' & platform=='sklearn') %>%
#   lapply(X=c('03','06','09','12','no'),Y=.,\(X,Y)
#     Y %>%
#       filter(cutoff==X)
#   ) %>%
#   `names<-`(c('03','06','09','12','no')) %>%
#   lapply(select,outcome,prob) %>%
#   lapply(rename,obs=outcome,pred=prob) %>%
#   lapply(
#     mutate
#     ,obs=
#       obs %>%
#       factor()
#   ) %>%
#   pblapply(discrimination)
```

```{r}
# best_model_test=
#   best_model_discrimination %>%
#   lapply(X=names(.),Y=.,\(X,Y)
#     Y[[X]]$metrics %>%
#       mutate(cutoff=X)
#   ) %>%
#   do.call(rbind,.) %>%
#   mutate(
#     lb=estimate-ci
#     ,ub=estimate+ci
#   ) %>%
#   mutate(
#     result=
#       paste0(
#         round(estimate,3)
#         ,' ('
#         ,round(lb,3)
#         ,', '
#         ,round(ub,3)
#         ,')'
#       )
#   ) %>%
#   mutate(
#     model='Random Forest'
#   ) %>%
#   select(model,cutoff,result) %>%
#   spread(cutoff,result)
# 
# best_model_test %>%
#   knitr::kable()
```

```{r}
# divnn_model_discrimination=
#   best_models %>%
#   filter(algorithm=='divnn' & data=='test' & platform=='pytorch') %>%
#   lapply(X=c('03','06','09','12','no'),Y=.,\(X,Y)
#     Y %>%
#       filter(cutoff==X)
#   ) %>%
#   `names<-`(c('03','06','09','12','no')) %>%
#   lapply(select,outcome,prob) %>%
#   lapply(rename,obs=outcome,pred=prob) %>%
#   lapply(
#     mutate
#     ,obs=
#       obs %>%
#       factor()
#   ) %>%
#   pblapply(discrimination)
```

```{r}
# divnn_test=
#   divnn_model_discrimination %>%
#   lapply(X=names(.),Y=.,\(X,Y)
#     Y[[X]]$metrics %>%
#       mutate(cutoff=X)
#   ) %>%
#   do.call(rbind,.) %>%
#   mutate(
#     lb=estimate-ci
#     ,ub=estimate+ci
#   ) %>%
#   mutate(
#     result=
#       paste0(
#         round(estimate,3)
#         ,' ('
#         ,round(lb,3)
#         ,', '
#         ,round(ub,3)
#         ,')'
#       )
#   ) %>%
#   mutate(
#     model='Deep-Insight Visible Neural Network'
#   ) %>%
#   select(model,cutoff,result) %>%
#   spread(cutoff,result)
# 
# divnn_test %>%
#   knitr::kable()
```

```{r}
if(all(c(1,2,3)%in%comp_req)){ # 01h 23m 23s
  tmp=
    best_models %>%
    unite(model_eval,algorithm,cutoff,data,platform,sep='_') %>%
    pull(model_eval) %>%
    .[!duplicated(.)] %>%
    .[str_detect(.,'test')] %>%
    pblapply(\(x)
      best_models %>%
        unite(model_eval,algorithm,cutoff,data,platform,sep='_') %>%
        filter(model_eval==x) %>%
        select(outcome,prob) %>%
        rename(obs=outcome,pred=prob) %>%
        mutate(
          obs=
            obs %>%
            factor()
        ) %>%
        list(pred_data=.) %>%
        c(list(name=x))
    ) %>%
    pblapply(\(x)
      list(
        list(
          pred_data=x$pred_data
          ,eval=calibration
          ,name=paste0(x$name,'_calibration')
        )
        ,list(
          pred_data=x$pred_data
          ,eval=discrimination
          ,name=paste0(x$name,'_discrimination')
        )
        ,list(
          pred_data=x$pred_data
          ,eval=decision
          ,name=paste0(x$name,'_decision')
        )
      )
    ) %>%
    do.call(c,.)
  
  cl=4#detectCores()-2
  start=T; source('R/parallel_computing-codes.R')
  
  if(!dir.exists('data/eval_test')) {
    dir.create('data/eval_test',recursive=T)
  }
  
  tmp %>%
    pblapply(
      cl=cl
      ,\(x)
      x$pred_data %>%
        x$eval() %>%
        saveRDS(paste0('data/eval_test/',x$name,'.rds'))
    )
  
  start=F; source('R/parallel_computing-codes.R')
  rm(tmp)
}
```

```{r}
eval_test=
  list.files('data/eval_test',full.names=T,recursive=T) %>%
  .[str_detect(.,'test')] %>%
  `names<-`(as.character(.)) %>%
  lapply(readRDS) %>%
  lapply(
    X=names(.) %>%
      str_remove_all('_calibration|_discrimination|_decision|\\.rds') %>%
      .[!duplicated(.)]
    ,Y=.
    ,\(X,Y)
    Y %>%
      .[str_detect(names(.),X)] %>%
      `names<-`(
        names(.) %>%
          str_remove_all(X) %>%
          str_remove_all('_|\\.rds')
      )
  ) %>%
  `names<-`(
    list.files('data/eval_test',full.names=T,recursive=T) %>%
      .[str_detect(.,'test')] %>%
      str_remove_all(
        'data/eval_test/|_calibration|_discrimination|_decision|\\.rds'
      ) %>%
      .[!duplicated(.)] %>%
      str_replace_all('_ONT',':ONT') %>%
      str_replace_all('_root',':root')
  )

eval_test_all=
  eval_test %>%
  lapply(X=names(.),Y=.,function(X,Y)
    Y[[X]]$calibration$metrics %>%
      rbind(Y[[X]]$discrimination$metrics) %>%
      rbind(Y[[X]]$decision$metrics) %>%
      mutate(model=X)
  ) %>%
  do.call(rbind,.) %>%
  mutate_at('model',str_remove_all,'_test') %>%
  separate(model,c('algorithm','cutoff','platform'),sep='_') %>%
  mutate_at(
    'algorithm'
    ,\(x)
      x %>%
        factor(
          c('rr'
            ,'dt'
            ,'rf'
            ,'gb'
            ,unique(.) %>%
              .[str_detect(.,'divnn')]
          )
        )
  ) %>%
  mutate_at('cutoff',factor) %>%
  mutate_at('platform',factor,c('sklearn','caret','pytorch')) %>%
  arrange(algorithm,cutoff,platform) %>%
  mutate(data='test') %>%
  unite(model,algorithm,cutoff,data,platform,sep='_')

eval_test=
  eval_test %>%
  .[eval_test_all$model %>%
      .[!duplicated(.)]
  ]
```

```{r}
test_all=
  eval_test_all %>%
  mutate_at('model',str_remove_all,'_test') %>%
  separate(model,c('algorithm','cutoff','platform'),sep='_') %>%
  mutate_at(
    'algorithm'
    ,\(x)
      x %>%
        factor(
          c('rr'
            ,'dt'
            ,'rf'
            ,'gb'
            ,unique(.) %>%
              .[str_detect(.,'divnn')]
          )
        )
  ) %>%
  mutate_at('cutoff',factor) %>%
  mutate_at('platform',factor,c('sklearn','caret','pytorch')) %>%
  arrange(algorithm,cutoff,platform) %>%
  filter(platform%in%c('sklearn','pytorch')) %>%
  filter(term=='AUC-ROC') %>%
  mutate(
    lb=estimate-ci
    ,ub=estimate+ci
  ) %>%
  mutate(
    result=
      paste0(
        round(estimate,3)
        ,' ('
        ,round(lb,3)
        ,', '
        ,round(ub,3)
        ,')'
      )
  ) %>%
  mutate(
    model=
      case_when(
        algorithm=='rr'~'Ridge Regression'
        ,algorithm=='dt'~'Decision Tree'
        ,algorithm=='rf'~'Random Forest'
        ,algorithm=='gb'~'XGBoost'
        # ,algorithm=='divnn'~'Deep-Insight Visible Neural Network'
        ,algorithm=='divnn:root'~'Deep-Insight Visible Neural Network (root)'
        ,algorithm=='divnn:ONT22'~'Deep-Insight Visible Neural Network (ONT:22)'
        ,algorithm=='divnn:ONT21'~'Deep-Insight Visible Neural Network (ONT:21)'
        ,algorithm=='divnn:ONT20'~'Deep-Insight Visible Neural Network (ONT:20)'
        ,algorithm=='divnn:ONT19'~'Deep-Insight Visible Neural Network (ONT:19)'
        ,algorithm=='divnn:ONT18'~'Deep-Insight Visible Neural Network (ONT:18)'
        ,algorithm=='divnn:ONT17'~'Deep-Insight Visible Neural Network (ONT:17)'
        ,algorithm=='divnn:ONT16'~'Deep-Insight Visible Neural Network (ONT:16)'
        ,algorithm=='divnn:ONT15'~'Deep-Insight Visible Neural Network (ONT:15)'
        ,algorithm=='divnn:ONT14'~'Deep-Insight Visible Neural Network (ONT:14)'
        ,algorithm=='divnn:ONT13'~'Deep-Insight Visible Neural Network (ONT:13)'
      )
  ) %>%
  select(model,cutoff,result) %>%
  spread(cutoff,result)

test_all %>%
  filter(
    !str_detect(model,'root|ONT')
    | str_detect(model,'root')
  ) %>%
  knitr::kable() %>%
  kableExtra::kable_classic()
```

```{r}
if(all(c(1,2,3)%in%comp_req)){ # 04h 35m 35s
  tmp=
    best_models %>%
    unite(model_eval,algorithm,cutoff,data,platform,sep='_') %>%
    pull(model_eval) %>%
    .[!duplicated(.)] %>%
    .[str_detect(.,'training')] %>%
    pblapply(\(x)
      best_models %>%
        unite(model_eval,algorithm,cutoff,data,platform,sep='_') %>%
        filter(model_eval==x) %>%
        select(outcome,prob) %>%
        rename(obs=outcome,pred=prob) %>%
        mutate(
          obs=
            obs %>%
            factor()
        ) %>%
        list(pred_data=.) %>%
        c(list(name=x))
    ) %>%
    pblapply(\(x)
      list(
        list(
          pred_data=x$pred_data
          ,eval=calibration
          ,name=paste0(x$name,'_calibration')
        )
        ,list(
          pred_data=x$pred_data
          ,eval=discrimination
          ,name=paste0(x$name,'_discrimination')
        )
        ,list(
          pred_data=x$pred_data
          ,eval=decision
          ,name=paste0(x$name,'_decision')
        )
      )
    ) %>%
    do.call(c,.)
  
  cl=4#detectCores()-2
  start=T; source('R/parallel_computing-codes.R')
  
  if(!dir.exists('data/eval_training')) {
    dir.create('data/eval_training',recursive=T)
  }
  
  tmp %>%
    pblapply(
      cl=cl
      ,\(x)
      x$pred_data %>%
        x$eval() %>%
        saveRDS(paste0('data/eval_training/',x$name,'.rds'))
    )
  
  start=F; source('R/parallel_computing-codes.R')
  rm(tmp)
}
```

```{r}
if(all(c(1,2,3)%in%comp_req)){ # 31m 49s
  tmp=
    best_models %>%
    unite(model_eval,algorithm,cutoff,data,platform,sep='_') %>%
    pull(model_eval) %>%
    .[!duplicated(.)] %>%
    .[str_detect(.,'training')] %>%
    .[str_detect(.,'divnn')] %>%
    .[str_detect(.,'09')] %>%
    pblapply(\(x)
      best_models %>%
        unite(model_eval,algorithm,cutoff,data,platform,sep='_') %>%
        filter(model_eval==x) %>%
        select(outcome,prob) %>%
        rename(obs=outcome,pred=prob) %>%
        mutate(
          obs=
            obs %>%
            factor()
        ) %>%
        list(pred_data=.) %>%
        c(list(name=x))
    ) %>%
    pblapply(\(x)
      list(
        list(
          pred_data=x$pred_data
          ,eval=calibration
          ,name=paste0(x$name,'_calibration')
        )
        ,list(
          pred_data=x$pred_data
          ,eval=discrimination
          ,name=paste0(x$name,'_discrimination')
        )
        ,list(
          pred_data=x$pred_data
          ,eval=decision
          ,name=paste0(x$name,'_decision')
        )
      )
    ) %>%
    do.call(c,.)
  
  cl=4#detectCores()-2
  start=T; source('R/parallel_computing-codes.R')
  
  if(!dir.exists('data/eval_training')) {
    dir.create('data/eval_training',recursive=T)
  }
  
  tmp %>%
    pblapply(
      cl=cl
      ,\(x)
      x$pred_data %>%
        x$eval() %>%
        saveRDS(paste0('data/eval_training/',x$name,'.rds'))
    )
  
  start=F; source('R/parallel_computing-codes.R')
  rm(tmp)
}
```

```{r}
eval_training=
  list.files('data/eval_training',full.names=T,recursive=T) %>%
  .[str_detect(.,'training')] %>%
  `names<-`(as.character(.)) %>%
  lapply(readRDS) %>%
  lapply(
    X=names(.) %>%
      str_remove_all('_calibration|_discrimination|_decision|\\.rds') %>%
      .[!duplicated(.)]
    ,Y=.
    ,\(X,Y)
    Y %>%
      .[str_detect(names(.),X)] %>%
      `names<-`(
        names(.) %>%
          str_remove_all(X) %>%
          str_remove_all('_|\\.rds')
      )
  ) %>%
  `names<-`(
    list.files('data/eval_training',full.names=T,recursive=T) %>%
      .[str_detect(.,'training')] %>%
      str_remove_all(
        'data/eval_training/|_calibration|_discrimination|_decision|\\.rds'
      ) %>%
      .[!duplicated(.)] %>%
      str_replace_all('_ONT',':ONT') %>%
      str_replace_all('_root',':root')
  )

eval_training_all=
  eval_training %>%
  lapply(X=names(.),Y=.,function(X,Y)
    Y[[X]]$calibration$metrics %>%
      rbind(Y[[X]]$discrimination$metrics) %>%
      rbind(Y[[X]]$decision$metrics) %>%
      mutate(model=X)
  ) %>%
  do.call(rbind,.) %>%
  mutate_at('model',str_remove_all,'_training') %>%
  separate(model,c('algorithm','cutoff','platform'),sep='_') %>%
  mutate_at(
    'algorithm'
    ,\(x)
      x %>%
        factor(
          c('rr'
            ,'dt'
            ,'rf'
            ,'gb'
            ,unique(.) %>%
              .[str_detect(.,'divnn')]
          )
        )
  ) %>%
  mutate_at('cutoff',factor) %>%
  mutate_at('platform',factor,c('sklearn','caret','pytorch')) %>%
  arrange(algorithm,cutoff,platform) %>%
  mutate(data='training') %>%
  unite(model,algorithm,cutoff,data,platform,sep='_')

eval_training=
  eval_training %>%
  .[eval_training_all$model %>%
      .[!duplicated(.)]
  ]
```

```{r}
training_all=
  eval_training_all %>%
  mutate_at('model',str_remove_all,'_training') %>%
  separate(model,c('algorithm','cutoff','platform'),sep='_') %>%
  mutate_at(
    'algorithm'
    ,\(x)
      x %>%
        factor(
          c('rr'
            ,'dt'
            ,'rf'
            ,'gb'
            ,unique(.) %>%
              .[str_detect(.,'divnn')]
          )
        )
  ) %>%
  mutate_at('cutoff',factor) %>%
  mutate_at('platform',factor,c('sklearn','caret','pytorch')) %>%
  arrange(algorithm,cutoff,platform) %>%
  filter(platform%in%c('sklearn','pytorch')) %>%
  filter(term=='AUC-ROC') %>%
  mutate(
    lb=estimate-ci
    ,ub=estimate+ci
  ) %>%
  mutate(
    result=
      paste0(
        round(estimate,3)
        ,' ('
        ,round(lb,3)
        ,', '
        ,round(ub,3)
        ,')'
      )
  ) %>%
  mutate(
    model=
      case_when(
        algorithm=='rr'~'Ridge Regression'
        ,algorithm=='dt'~'Decision Tree'
        ,algorithm=='rf'~'Random Forest'
        ,algorithm=='gb'~'XGBoost'
        # ,algorithm=='divnn'~'Deep-Insight Visible Neural Network'
        ,algorithm=='divnn:root'~'Deep-Insight Visible Neural Network (root)'
        ,algorithm=='divnn:ONT22'~'Deep-Insight Visible Neural Network (ONT:22)'
        ,algorithm=='divnn:ONT21'~'Deep-Insight Visible Neural Network (ONT:21)'
        ,algorithm=='divnn:ONT20'~'Deep-Insight Visible Neural Network (ONT:20)'
        ,algorithm=='divnn:ONT19'~'Deep-Insight Visible Neural Network (ONT:19)'
        ,algorithm=='divnn:ONT18'~'Deep-Insight Visible Neural Network (ONT:18)'
        ,algorithm=='divnn:ONT17'~'Deep-Insight Visible Neural Network (ONT:17)'
        ,algorithm=='divnn:ONT16'~'Deep-Insight Visible Neural Network (ONT:16)'
        ,algorithm=='divnn:ONT15'~'Deep-Insight Visible Neural Network (ONT:15)'
        ,algorithm=='divnn:ONT14'~'Deep-Insight Visible Neural Network (ONT:14)'
        ,algorithm=='divnn:ONT13'~'Deep-Insight Visible Neural Network (ONT:13)'
      )
  ) %>%
  select(model,cutoff,result) %>%
  spread(cutoff,result)

training_all %>%
  filter(
    !str_detect(model,'root|ONT')
    | str_detect(model,'root')
  ) %>%
  knitr::kable() %>%
  kableExtra::kable_classic()
```

```{r fig.height=5, fig.width=7}
validation_all %>%
  filter(
    !str_detect(model,'root|ONT')
    | str_detect(model,'root')
  ) %>%
  left_join(
    test_all %>%
      rename_all(\(x)paste0(x,'_test')) %>%
      rename(model=model_test)
    ,by='model'
  ) %>%
  left_join(
    training_all %>%
      rename_all(\(x)paste0(x,'_training')) %>%
      rename(model=model_training)
    ,by='model'
  ) %>%
  filter(!is.na(`03_test`)) %>%
  gather(cutoff,auroc,-model) %>%
  mutate(
    set=
      case_when(
        str_detect(cutoff,'_test')~'test'
        ,str_detect(cutoff,'_training')~'training'
        ,TRUE~'validation'
      )
    ,cutoff=
      cutoff %>%
      str_remove_all('_test|_training')
  ) %>%
  mutate_at(c('auroc'),str_replace_all,', ','-') %>%
  separate(auroc,c('auroc_avg','auroc_ci'),sep=' ') %>%
  mutate_at(c('auroc_ci'),str_remove_all,'\\(|\\)') %>%
  separate(auroc_ci,c('auroc_lb','auroc_ub'),sep='-') %>%
  mutate_at(c('auroc_avg','auroc_lb','auroc_ub'),as.numeric) %>%
  mutate(model=reorder(model,auroc_avg)) %>%
  ggplot(aes(model,auroc_avg,color=set)) +
  geom_hline(yintercept=0.5,lty=2) +
  geom_errorbar(aes(ymin=auroc_lb,ymax=auroc_ub),alpha=0.5,width=0.2) +
  geom_point(alpha=0.5) +
  facet_grid(cutoff~.) +
  coord_flip() +
  ylab('AUC-ROC (95% CI)') +
  xlab('Algorithm') +
  scale_color_discrete('Set')
```

```{r eval=FALSE, fig.height=6, fig.width=15, include=FALSE}
eval_report$rf_sklearn %>%
  .[names(.)=='rf_06_validation_sklearn'] %>%
  lapply(\(x)
    ggarrange(
      ggarrange(
        x$calibration$plot +
          geom_vline(
            xintercept=round(0.14,1)
            ,lty=2
            ,na.rm=T
          ) +
          annotate(
            x=0.1
            ,y=0.9
            ,geom='label'
            ,label=
              paste0(
                'Intercept '
                ,round(filter(x$calibration$metrics,term=='intercept')$estimate,3)
                ,' ('
                ,round(
                  filter(x$calibration$metrics,term=='intercept')$estimate
                  -filter(x$calibration$metrics,term=='intercept')$ci
                  ,3
                )
                ,', '
                ,round(
                  filter(x$calibration$metrics,term=='intercept')$estimate
                  +filter(x$calibration$metrics,term=='intercept')$ci
                  ,3
                )
                ,')'
                ,'\n'
                ,'Slope '
                ,round(filter(x$calibration$metrics,term=='slope')$estimate,3)
                ,' ('
                ,round(
                  filter(x$calibration$metrics,term=='slope')$estimate
                  -filter(x$calibration$metrics,term=='slope')$ci
                  ,3
                )
                ,', '
                ,round(
                  filter(x$calibration$metrics,term=='slope')$estimate
                  +filter(x$calibration$metrics,term=='slope')$ci
                  ,3
                )
                ,')'
                ,'\n'
                ,'Brier score '
                ,round(filter(x$calibration$metrics,term=='rmse')$estimate,3)
                ,' ('
                ,round(
                  filter(x$calibration$metrics,term=='rmse')$estimate
                  -filter(x$calibration$metrics,term=='rmse')$ci
                  ,3
                )
                ,', '
                ,round(
                  filter(x$calibration$metrics,term=='rmse')$estimate
                  +filter(x$calibration$metrics,term=='rmse')$ci
                  ,3
                )
                ,')'
              )
            ,hjust=0
            ,size=3
          ) +
          xlab('Predicted probability') +
          ylab('True probability (95% CI)') +
          theme(
            axis.title.x=element_blank()
            ,axis.text.x=element_blank()
          )
        ,x$calibration$dist +
          geom_vline(
            xintercept=round(0.14,1)
            ,lty=2
            ,na.rm=T
          ) +
          xlab('Predicted probability') +
          ylab('Frequency')
        ,nrow=2
        ,ncol=1
        ,heights=c(3.7,2.3)
        )
      ,x$decision$plot +
        geom_vline(
          xintercept=0.14
          ,lty=2
          ,na.rm=T
        ) +
        scale_x_continuous(
          'Threshold'
          ,breaks=seq(0,0.18,0.02)
          ,limits=c(0,0.18)
        ) +
        scale_y_continuous(
          'Net benefit'
          ,breaks=seq(0,0.24,0.02)
          ,limits=c(-0.01,0.24)
        )
      ,x$discrimination$plot$data %>%
        ggplot(aes(tnr,tpr)) +
        geom_abline(slope=1,intercept=1,lty=2) +
        geom_vline(
          xintercept=
            filter(x$discrimination$plot$data,th==0.14)$tnr
          ,lty=2
          ,na.rm=T
        ) +
        geom_hline(
          yintercept=
            filter(x$discrimination$plot$data,th==0.14)$tpr
          ,lty=2
          ,na.rm=T
        ) +
        geom_path() +
        geom_point(
          aes(x=ifelse(th==0.14,tnr,NA))
          ,na.rm=T
        ) +
        geom_text(
          aes(label=ifelse(th==0.14,round(th,2),NA))
          ,hjust=-0.1
          ,vjust=1.1
          ,size=3
          ,check_overlap=T
          ,na.rm=T
        ) +
        coord_equal() +
        scale_x_reverse(breaks=seq(0,1,0.1)) +
        scale_y_continuous(breaks=seq(0,1,0.1)) +
        theme_classic() +
        xlab('Specificity') +
        ylab('Sensitivity')
      ,nrow=1
      ,ncol=3
      ,widths=c(5,4,6)
      ,labels=LETTERS[1:3]
    )
  ); ggsave('figure2.eps',height=6,width=15)
```

```{r}
# List of training file names
training_files=
  c('data/pred_data_training_cutoff_03.csv'
    ,'data/pred_data_training_cutoff_06.csv'
    ,'data/pred_data_training_cutoff_09.csv'
    ,'data/pred_data_training_cutoff_12.csv'
    ,'data/pred_data_training_cutoff_no.csv'
  )

# List of files to make predictions
prediction_files=
  c('data/pred_data_training.csv'
    ,'data/pred_data_validation.csv'
    ,'data/pred_data_test.csv'
  )

# Load the training dataset
training_data=
  training_files %>%
  `names<-`(as.character(.)) %>%
  lapply(read_csv,show_col_types=F)

# Load the prediction dataset
prediction_data=
  prediction_files %>%
  `names<-`(as.character(.)) %>%
  lapply(read_csv,show_col_types=F)

pca_models=
  training_data %>%
  lapply(select,-outcome,-outcome_weight) %>%
  lapply(cor) %>%
  lapply(prcomp)

prediction_data_pc=
  pca_models %>%
  lapply(\(x)
    prediction_data %>%
      lapply(\(y)
        y %>%
          select(-outcome,-outcome_onset,-outcome_weight) %>%
          as.matrix() %>%
          lapply(X=1,Y=.,\(X,Y)
            Y %*% x$rotation
          ) %>%
          .[[1]] %>%
          as.data.frame %>%
          cbind(y) %>%
          select(outcome,outcome_onset,outcome_weight,everything())
      ) %>%
      lapply(X=names(.),Y=.,\(X,Y)
        Y[[X]] %>%
          mutate(
            data=
              X %>%
              str_remove_all('data/pred_data_|\\.csv')
          ) %>%
          select(data,everything())
      ) %>%
      do.call(rbind,.)
  ) %>%
  lapply(X=names(.),Y=.,\(X,Y)
    Y[[X]] %>%
      mutate(
        cutoff=
          X %>%
          str_remove_all('data/pred_data_training_cutoff_|\\.csv')
      ) %>%
      select(cutoff,everything())
  ) %>%
  do.call(rbind,.)
```

```{r eval=FALSE, fig.height=12.5, fig.width=10, include=FALSE}
prediction_data_pc %>%
  mutate(
    data=
      data %>%
      factor(c('training','validation','test'))
  ) %>%
  ggplot(aes(PC1,PC2,color=factor(outcome))) +
  geom_point(alpha=0.5) +
  facet_grid(cutoff~data)
```

```{r eval=FALSE, fig.height=12.5, fig.width=10, include=FALSE}
pca_predictors=
  prediction_data_pc %>%
  mutate(
    data=
      data %>%
      factor(c('training','validation','test'))
  ) %>%
  filter(data=='validation' & cutoff=='no') %>%
  lapply(
    X=prediction_data_pc %>%
      colnames() %>%
      .[!.%in%c('cutoff','data','outcome','outcome_onset','outcome_weight')] %>%
      .[!str_detect(.,'^PC')]
    ,Y=.
    ,\(X,Y)
     Y %>%
       rename_at(X,\(x)'variable') %>%
       mutate_at('variable',\(x)
          ifelse(x==1,X,'-') %>%
            factor(c('-',X))
       ) %>%
       ggplot(aes(PC1,PC2,color=variable),show.legend=F) +
       geom_point(alpha=0.5,show.legend=F) +
       facet_grid(cutoff~data) +
       theme(
         strip.background=element_blank()
         ,strip.text=element_blank()
       )
  ) %>%
  `names<-`(
    prediction_data_pc %>%
      colnames() %>%
      .[!.%in%c('cutoff','data','outcome','outcome_onset','outcome_weight')] %>%
      .[!str_detect(.,'^PC')]
  )

ggarrange(
  ggarrange(
    pca_predictors$AGE_GROUP_1
    ,pca_predictors$AGE_GROUP_2
    ,pca_predictors$ICU_STAY_10D
    ,nrow=1,ncol=3,widths=c(3,3,3)
    ,labels=c('AGE_GROUP_1','AGE_GROUP_2','ICU_STAY_10D')
  )
  ,ggarrange(
    pca_predictors$LOS_4D
    ,pca_predictors$SEX_TYPE
    ,pca_predictors$prev_DMdiag
    ,nrow=1,ncol=3,widths=c(3,3,3)
    ,labels=c('LOS_4D','SEX_TYPE','prev_DMdiag')
  )
  ,ggarrange(
    pca_predictors$immob
    ,pca_predictors$prev_HYP
    ,pca_predictors$prev_DMneph
    ,nrow=1,ncol=3,widths=c(3,3,3)
    ,labels=c('immob','prev_HYP','prev_DMneph')
  )
  ,ggarrange(
    pca_predictors$prev_ICHIV
    ,pca_predictors$prev_ICNEO
    ,pca_predictors$prev_uro
    ,nrow=1,ncol=3,widths=c(3,3,3)
    ,labels=c('prev_ICHIV','prev_ICNEO','prev_uro')
  )
  ,ggarrange(
    pca_predictors$prev_utidiag_6mgt2_1ygt3
    ,pca_predictors$prev_neuro
    ,nrow=1,ncol=2,widths=c(3,3)
    ,labels=c('prev_utidiag_6mgt2_1ygt3','prev_neuro')
  )
  ,nrow=5,ncol=1,widths=c(2.5,2.5,2.5,2.5,2.5)
)
```

```{r eval=FALSE, include=FALSE}
pca_models %>%
  lapply(\(x)x$rotation) %>%
  lapply(as.data.frame) %>%
  lapply(rownames_to_column,var='predictor') %>%
  lapply(gather,pc,weight,-predictor) %>%
  lapply(
    mutate
    ,pc=
      pc %>%
      str_remove_all('PC') %>%
      as.numeric() %>%
      str_pad(str_count(max(.)),'left','0')
  ) %>%
  lapply(\(x)
    x %>%
      left_join(
        variable_description %>%
          select(predictor=variable,description) %>%
          rbind(
            data.frame(
              predictor=c('AGE_GROUP_1','AGE_GROUP_2')
              ,description=c('Age group >50-65','Age group >65')
            )
          )
        ,by='predictor'
      ) %>%
      mutate(predictor=description) %>%
      select(-description) %>%
      mutate(
        predictor=
          predictor %>%
          factor(rev(unique(.)))
      )
  ) %>%
  .[str_detect(names(.),'_no')] %>%
  .[[1]] %>%
  ggplot(aes(pc,predictor,fill=weight)) +
  geom_tile() +
  scale_fill_gradient2(low='red',mid='black',high='blue',midpoint=0)
```

```{r eval=FALSE, include=FALSE}
eval_all %>%
  mutate_at('model',str_remove_all,'_validation') %>%
  separate(model,c('algorithm','cutoff','platform'),sep='_') %>%
  mutate_at(
    'algorithm'
    ,\(x)
      x %>%
        factor(
          c('rr'
            ,'dt'
            ,'rf'
            ,'gb'
            ,unique(.) %>%
              .[str_detect(.,'divnn')]
          )
        )
  ) %>%
  mutate_at('cutoff',factor) %>%
  mutate_at('platform',factor,c('sklearn','caret')) %>%
  arrange(algorithm,cutoff,platform) %>%
  mutate(
    lb=estimate-ci
    ,ub=estimate+ci
  ) %>%
  filter(
    algorithm
    %in%pull(
      filter(.,term=='intercept' & (lb)<=0 & (ub)>=0)
      ,algorithm
    )
  ) %>%
  filter(
    algorithm
    %in%pull(
      filter(.,term=='slope' & (lb)<=1 & (ub)>=1)
      ,algorithm
    )
  ) %>%
  filter(!term%in%c('intercept','slope'))%>%
  filter(term%in%c('rmse','AUC-ROC','Net% AUC-DC')) %>%
  group_by(term) %>%
  mutate(
    ref=
      ifelse(
        term=='rmse'
        ,min(ub)
        ,max(lb)
      )
    ,best=
      pull(
        filter(
          .
          ,((ref==lb)+(ref==ub))>0
        )
        ,algorithm
      )==algorithm
  ) %>%
  ungroup() %>%
  filter(
    algorithm
    %in%pull(
      filter(.,term=='rmse' & (lb)<ref)
      ,algorithm
    )
  ) %>%
  filter(
    algorithm
    %in%pull(
      filter(.,term=='AUC-ROC' & (ub)>ref)
      ,algorithm
    )
  ) %>%
  filter(
    algorithm
    %in%pull(
      filter(.,term=='Net% AUC-DC' & (ub)>ref)
      ,algorithm
    )
  )
```

```{r}
best_set=set1
best_model=model$res1
eval$res1
```

```{r}
eval_best=
  list(
    calibration=calibration
    ,discrimination=discrimination
    ,decision=decision
  ) %>%
  lapply(function(x)
    best_model %>%
      predict(best_set$test,type='response') %>%
      data.frame(pred=.,obs=best_set$test$outcome) %>%
      x()
  )

eval_best$thresholding=
  best_model %>%
  predict(best_set$test,type='response') %>%
  data.frame(pred=.,obs=best_set$test$outcome) %>%
  thresholding(custom_metric='th',custom_ref=0.6)
```

```{r eval=FALSE, include=FALSE}
eval_best$calibration$plot +
  geom_vline(
    xintercept=
      eval_best$thresholding %>%
      filter(ref_type=='TH') %>%
      pull(ref_value) %>%
      .[1]
    ,lty=2
  )

eval_best$calibration$dist +
  geom_vline(
    xintercept=
      eval_best$thresholding %>%
      filter(ref_type=='TH') %>%
      pull(ref_value) %>%
      .[1]
    ,lty=2
  )

eval_best$discrimination$plot +
  geom_vline(
    xintercept=
      eval_best$thresholding %>%
      filter(ref_type=='TH' & metric=='tnr') %>%
      mutate(avg=avg/100) %>%
      pull(avg)
    ,lty=2
  )

eval_best$decision$plot
# +
#   geom_vline(
#     xintercept=
#       eval_best$thresholding %>%
#       filter(ref_type=='TH') %>%
#       pull(ref_value) %>%
#       .[1]
#     ,lty=2
#   )

eval_best$calibration$metrics %>%
  rbind(eval_best$discrimination$metrics) %>%
  rbind(eval_best$decision$metrics) %>%
  mutate(
    lb=estimate-ci
    ,ub=estimate+ci
  ) %>%
  mutate(
    value=
      paste0(
        round(estimate,4)
        ,' (95% CI '
        ,round(lb,4)
        ,' to '
        ,round(ub,4)
        ,')'
      )
  ) %>%
  select(term,value) %>%
  rename(metric=term) %>%
  rbind(
    eval_best$thresholding %>%
      filter(ref_type=='TH') %>%
      mutate(
        value=
          paste0(
            avg
            ,' (95% CI '
            ,lb
            ,' to '
            ,ub
            ,')'
          )
      ) %>%
      select(metric,value)
  )
```

```{r eval=FALSE, include=FALSE}
best_model %>%
  tidy() %>%
  mutate(
    OR=exp(estimate)
    ,LB=exp(estimate-qnorm(0.975)*std.error)
    ,UB=exp(estimate+qnorm(0.975)*std.error)
    ,FDR=p.adjust(p.value,method='BH')
  ) %>%
  select(-estimate,-std.error,-statistic,-p.value) %>%
  filter(FDR<=0.05 & (LB>=1.5 | UB<=1/1.5))
```

```{r}
set.seed(seed); boot_cp=
  seq(30) %>%
  lapply(function(x)
    set$train %>%
      nrow() %>%
      seq() %>%
      sample(length(.),T) %>%
      list() %>%
      c(list(x))
  ) %>%
  lapply(function(x)
    best_model %>%
      causal_prob(0.6,best_set$train[x[[1]],]) %>%
      mutate(boot=x[[2]])
  ) %>%
  do.call(rbind,.)
```

```{r eval=FALSE, include=FALSE}
boot_cp %>%
  gather(metric,value,-boot,-predictor_name,-term) %>%
  filter(str_detect(metric,'_prob')) %>%
  group_by(predictor_name,term,metric) %>%
  summarize(
    avg=mean(value)
    ,lb=mean(value)-qnorm(0.975)*sd(value)/sqrt(n())
    ,ub=mean(value)+qnorm(0.975)*sd(value)/sqrt(n())
    ,.groups='drop'
  ) %>%
  ggplot(aes(metric,avg)) +
  geom_linerange(aes(ymin=lb,ymax=ub)) +
  geom_point() +
  geom_point(
    data=
      best_model %>%
      causal_prob(0.6,best_set$train) %>%
      gather(metric,value,-predictor_name,-term) %>%
      filter(str_detect(metric,'_prob')) %>%
      rename(avg=value)
    ,color='red'
    ,shape=2
  ) +
  facet_wrap(~predictor_name+term) +
  coord_flip()
```

```{r eval=FALSE, include=FALSE}
# lr_model=
#   pred_data_cutoff$training %>%
#   pblapply(\(x)x %>% glm(outcome~.,data=.,family=binomial(link='logit')))
# 
# pred_data %>%
#   lapply(\(x)
#     lr_model %>%
#       lapply(X=names(.),Y=.,\(X,Y)
#         Y[[X]] %>%
#           predict(newdata=x,type='response') %>%
#           data.frame(prob=.) %>%
#           `colnames<-`(X)
#       ) %>%
#       do.call(cbind,.) %>%
#       cbind(x %>% select(outcome,outcome_onset))
#   )
```

```{r eval=FALSE, include=FALSE}
# baseline_model=
#   pred_data$training %>%
#   mutate(km_outcome=Surv(outcome_onset,outcome)) %>%
#   select(-outcome,-outcome_onset) %>%
#   coxph(km_outcome~.,data=.)
# 
# baseline_model %>%
#   tidy() %>%
#   mutate(
#     OR=round(exp(estimate),2)
#     ,LB=round(exp(estimate-std.error),2)
#     ,UB=round(exp(estimate+std.error),2)
#   )
```

```{r eval=FALSE, include=FALSE}
# baseline_model %>%
#   survfit(
#     newdata=
#       pred_data$training %>%
#       select(-outcome,-outcome_onset)
#   ) %>%
#   saveRDS('data/baseline_model_pred_training.rds')
# 
# gc()
# 
# baseline_model %>%
#   survfit(
#     newdata=
#       pred_data$validation %>%
#       select(-outcome,-outcome_onset)
#   ) %>%
#   saveRDS('data/baseline_model_pred_validation.rds')
# 
# gc()
# 
# baseline_model %>%
#   survfit(
#     newdata=
#       pred_data$test %>%
#       select(-outcome,-outcome_onset)
#   ) %>%
#   saveRDS('data/baseline_model_pred_test.rds')
# 
# gc()
```

```{r eval=FALSE, include=FALSE}
# baseline_model_pred=
#   paste0('data/baseline_model_pred_',names(pred_data),'.rds') %>%
#   `names<-`(names(pred_data)) %>%
#   readRDS()
```

```{r}
best_divnn_grad_cam=
  list.files('data/divnn_models',full.names=T,recursive=T) %>%
  .[str_detect(.,'_ontonet/')] %>%
  .[str_detect(.,'[:digit:]+\\.pt')] %>%
  lapply(
    X=str_remove_all(.,'[:digit:]+\\.pt') %>%
      unique()
    ,Y=.
    ,\(X,Y)
      Y %>%
        .[str_detect(.,X)]
  ) %>%
  setNames(
    lapply(.,str_remove_all,'[:digit:]+\\.pt') %>%
      sapply(unique) %>%
      str_remove_all('data/divnn_models/pred_data_training_|_ontonet/')
  ) %>%
  sapply(\(x)
    x %>%
      .[which.max(
          str_remove_all(
              .
              ,paste0(
                'data/divnn_models/'
                ,'pred_data_training_cutoff_[:alnum:]+_ontonet/'
                ,'|'
                ,'\\.pt'
              )
            ) %>%
            as.numeric()
        )
      ] %>%
      str_replace_all('\\.pt','.csv')
  ) %>%
  lapply(read_csv,show_col_types=F) %>%
  lapply(mutate_at,c('x','y','z'),\(x)x+1) %>%
  lapply(X=names(.),Y=.,\(X,Y)
    Y[[X]] %>%
      left_join(
        read_csv(
          paste0('data/divnn_models/pred_data_training_',X,'_ontotype.csv')
          ,show_col_type=F
        )
        ,by=c('ontology','x','y','z')
      ) %>%
      mutate(cutoff=X) %>%
      select(cutoff,everything())
  ) %>%
  lapply(X=1,Y=.,\(X,Y)
    Y %>%
      lapply(
        left_join
        ,Y %>%
          do.call(rbind,.) %>%
          pull(.,feature) %>%
          .[!is.na(.)] %>%
          unique() %>%
          data.frame(feature=.) %>%
          mutate(
            code=
              paste0(
                'F'
                ,str_pad(seq(n()),str_count(n()),'left','0')
              )
          )
        ,by='feature'
      ) %>%
      setNames(sapply(Y,\(x)x$cutoff[1]))
  ) %>%
  .[[1]] %>%
  lapply(select,-cutoff)
```

```{r}
best_divnn_grad_cam_plot=
  best_divnn_grad_cam %>%
  lapply(X=names(.),Y=.,\(X,Y)
    Y[[X]] %>%
      left_join(
        validation_all %>%
          gather(cutoff,auroc,-model) %>%
          filter(!is.na(auroc)) %>%
          filter(str_detect(model,'Deep-Insight Visible Neural Network')) %>%
          mutate(
            model=
              model %>%
              str_remove_all('Deep-Insight Visible Neural Network |[:punct:]')
          ) %>%
          rename(ontology=model) %>%
          filter(cutoff==str_remove_all(X,'cutoff_')) %>%
          select(-cutoff)
        ,by='ontology'
      ) %>%
      mutate(
        ontology=
          ontology %>%
          str_replace_all('ONT','ONT:')
      ) %>%
      unite(ontology,ontology,auroc,sep='\n') %>%
      mutate_at(c('feature','code'),\(x)ifelse(is.na(x),'',x)) %>%
      ggplot(aes(x,y,fill=value)) +
      geom_tile(color='#FFFFFF',show.legend=F) +
      geom_text(aes(label=code),color='#FFFFFF',size=3) +
      facet_wrap(~ontology,ncol=3) +
      coord_equal() +
      scale_fill_gradientn(
        colors=c('#0000FF','#00FFFF','#00FF00','#FFFF00','#FF0000')
        ,values=c(0,0.25,0.5,0.75,1)
      ) +
      theme_void() +
      ggtitle(X)
  )
```

```{r}
divnn_ontology=
  list.files('data/divnn_models',full.names=T,recursive=T) %>%
  .[str_detect(.,'_ontology')] %>%
  .[str_detect(.,'\\.csv')] %>%
  `names<-`(
    as.character(.) %>%
      str_remove_all('data/divnn_models/pred_data_training_|_ontology\\.csv')
  ) %>%
  lapply(read_csv,show_col_types=F) %>%
  lapply(filter,relation!='feature') %>%
  lapply(\(x)
    x %>%
      rbind(
        filter(.,!target%in%source) %>%
          mutate(
            source=target
            ,target='root'
            ,similarity=0
            ,relation='is_a'
          ) %>%
          filter(!duplicated(.))
      )
  )
```

```{r}
divnn_ontology_plot=
  divnn_ontology %>%
  lapply(graph_from_data_frame,directed=T) %>%
  lapply(\(x)
    x %>%
      ggnetwork(
        layout=
          layout_as_tree(
            .
            ,root=c('root')
            ,mode='in'
            ,circular=F
          )#[,2:1]
        ,arrow.gap=0.05
      )
  ) %>%
  lapply(X=names(.),Y=.,\(X,Y)
    Y[[X]] %>%
      ggplot(aes(x=x,y=y,xend=xend,yend=yend)) +
      geom_edges(
        arrow=arrow(length=unit(8,'pt'),type='closed')
        ,curvature=0.075
      ) +
      geom_nodelabel(
        aes(label=name)
        ,family='sans'
        ,size=unit(3,'pt')
      ) +
      theme_void() +
      ggtitle(X)
  )
```

```{r eval=FALSE, include=FALSE}
best_divnn_grad_cam %>%
  do.call(rbind,.) %>%
  select(code,feature) %>%
  filter(!is.na(feature)) %>%
  filter(!duplicated(.)) %>%
  knitr::kable() %>%
  kableExtra::kable_classic()
```

```{r eval=FALSE, fig.height=7, fig.width=7, include=FALSE}
best_divnn_grad_cam_plot
```

```{r eval=FALSE, fig.height=5, fig.width=3, include=FALSE}
divnn_ontology_plot
```

```{r}
shap_values=
  list.files('data/sklearn_models',full.names=T,recursive=T) %>%
  .[str_detect(.,'shap_values')] %>%
  .[str_detect(.,'\\.csv')] %>%
  `names<-`(
    as.character(.) %>%
      str_split('\\/') %>%
      sapply(\(x)
        paste0(
          x[3]
          ,'_'
          ,x[4] %>%
            str_remove_all('pred_data_training_cutoff_')
        )
      )
  ) %>%
  lapply(read_csv,show_col_types=F)
```

```{r}
shap_feature_values=
  shap_values %>%
  lapply(\(x)mutate(x,seq=seq(nrow(x)))) %>%
  lapply(gather,feature,shap_value,-seq) %>%
  pblapply(X=names(.),Y=.,\(X,Y)
    Y[[X]] %>%
      left_join(
        read_csv(
            paste0(
              'data/pred_data_training_cutoff_'
              ,str_split_fixed(X,'_',2)[[2]]
              ,'.csv'
            )
            ,show_col_types=F
          ) %>%
          select(-outcome,-outcome_weight) %>%
          mutate(seq=seq(nrow(.))) %>%
          gather(feature,feature_value,-seq)
        ,by=c('seq','feature')
      ) %>%
      left_join(
        read_csv(
            paste0(
              'data/sklearn_models/'
              ,str_split_fixed(X,'_',2)[[1]]
              ,'/pred_data_training_cutoff_'
              ,str_split_fixed(X,'_',2)[[2]]
              ,'/prob_pred_data_training_cutoff_'
              ,str_split_fixed(X,'_',2)[[2]]
              ,'.csv'
            )
            ,show_col_types=F
          ) %>%
          mutate(seq=seq(nrow(.)))
        ,by=c('seq')
      )
  ) %>%
  `names<-`(names(shap_values)) %>%
  pblapply(\(x)
    x %>%
      mutate(
        feature2=
          feature %>%
          str_remove_all('_[:digit:]+$')
      ) %>%
      left_join(
        variable_description %>%
          mutate(
            description=
              description %>%
              str_replace_all(
                '>='
                ,'\u2265'
              ) %>%
              str_replace_all(
                '\\(F/M\\)'
                ,'male'
              ) %>%
              str_replace_all(
                ' \\(protective restraint\\)'
                ,''
              ) %>%
              str_replace_all(
                'Hypertension diagnosis'
                ,'Hypertension'
              ) %>%
              str_replace_all(
                ' \\(double-J/diagnosis/urodynamics\\)'
                ,''
              ) %>%
              str_replace_all(
                ' diagnosis >2x/6 mo'
                ,' >2x/6 mo'
              ) %>%
              str_replace_all(
                '>3/1 y'
                ,'>3x/y'
              ) %>%
              str_replace_all(
                ' \\(diagnosis\\)'
                ,''
              )
          ) %>%
          select(variable,description) %>%
          rename(feature2=variable)
        ,by='feature2'
      ) %>%
      mutate(
        level=
          ifelse(
            sapply(str_extract_all(feature,'_[:digit:]+$'),\(x)length(x)==0)
            ,''
            ,paste0(
              ' '
              ,feature %>%
                str_extract_all('_[:digit:]+$') %>%
                unlist() %>%
                str_remove_all('_') %>%
                sapply(paste0,collapse='')
            )
          )
      ) %>%
      left_join(
        data.frame(
            level=c(0,1,2)
            ,category=c('<=50','>50 to 65','>65')
          ) %>%
          mutate_all(\(x)paste0(' ',x))
        ,by='level'
      ) %>%
      mutate(
        feature=
          paste0(
            description
            ,ifelse(
              description%in%c('Age group')
              ,category
              ,level
            )
          )
      ) %>%
      select(-feature2,-description,-level,-category)
  ) %>%
  pblapply(\(x)
    x %>%
      group_by(feature) %>%
      mutate(
        direction=mean(shap_value>=0)
        ,magnitude=max(shap_value)
      ) %>%
      ungroup() %>%
      mutate(
        magnitude=
          (magnitude-min(magnitude))/(max(magnitude)-min(magnitude))
        ,impact=
          0.5*direction+0.5*magnitude
      ) %>%
      mutate(feature=reorder(feature,magnitude)) %>%
      arrange(seq,feature)
  )
```

```{r}
set.seed(seed);shap_beeswarm_plots=
  shap_feature_values %>%
  lapply(\(x)
    x %>%
      filter(
        seq
        %in%sample(unique(seq),1000,F)
      )
  ) %>%
  lapply(\(x)
    x %>%
      mutate(shap_value_bin=round(shap_value*100,0)/100) %>%
      group_by(feature,shap_value_bin) %>% 
      mutate(freq=n()) %>% 
      ungroup() %>%
      mutate(
        jitter_width=freq/max(freq)*0.3
        ,feature_num=as.numeric(feature)
        ,jitter_feature=feature_num+runif(n(),-jitter_width,jitter_width)
      )
  ) %>%  
  lapply(\(x)
    x %>%
      ggplot(aes(jitter_feature,shap_value,color=feature_value)) +
      geom_hline(yintercept=0,color='grey',linewidth=1) +
      geom_point(
        position='identity'
        ,size=1.5
        # ,alpha=0.1
      ) +
      coord_flip() +
      scale_x_continuous(
        breaks=unique(x %>% select(feature,feature_num))$feature_num
        ,labels=
          paste0(
            unique(x %>% select(feature,feature_num))$feature
            ,' - '
            ,max(x$feature_num)
             -unique(x %>% select(feature,feature_num))$feature_num
             +1
          )
      ) +
      scale_color_gradient(
        'Feature value'
        ,low='#008AFB'
        ,high='#FF0053'
        ,breaks=c(min(x$feature_value),max(x$feature_value))
        ,labels=c('Low','High')
      ) +
      theme_minimal() +
      xlab('') +
      ylab('SHAP value (impact on model output)') +
      theme(
        panel.grid.major=element_blank()
        ,panel.grid.minor=element_blank()
        ,axis.ticks.x=element_line()
        ,axis.line.x=element_line()
        ,legend.position='right'
        ,legend.title=element_text(angle=90,hjust=0.5)
      ) +
      guides(
        color=
          guide_colorbar(
            barwidth=0.2
            ,barheight=10
            ,title.position='right'
            ,title.hjust=0.5
            ,label.hjust=0.5
            ,ticks=F
            ,draw.ulim=T
            ,draw.llim=T
          )
      )
  )
```

```{r}
rf_beeswarm=
  shap_beeswarm_plots %>%
  .[str_detect(names(.),'rf')] %>%
  `names<-`(
    names(.) %>%
    str_remove_all('rf_')
  ) %>%
  lapply(X=names(.),Y=.,\(X,Y)
    Y[[X]] +
      theme(
        axis.title.x=
          list(
            element_text()
            ,element_blank()
          ) %>%
          .[[ifelse(X=='no',1,2)]]
        ,legend.title=
          list(
            element_text()
            ,element_blank()
          ) %>%
          .[[ifelse(X=='09',1,2)]]
      )
  ) %>%
  `names<-`(
    shap_beeswarm_plots %>%
    .[str_detect(names(.),'rf')] %>%
    names() %>%
    str_remove_all('rf_')
  ) %>%
  lapply(X=1,Y=.,\(X,Y)
    ggarrange(
      ggarrange(Y$`03`,NULL,ncol=2,nrow=1,widths=c(9.875,0.125),heights=2.5)
      ,ggarrange(Y$`06`,NULL,ncol=2,nrow=1,widths=c(9.875,0.125),heights=2.5)
      ,Y$`09`
      ,ggarrange(Y$`12`,NULL,ncol=2,nrow=1,widths=c(9.875,0.125),heights=2.5)
      ,ggarrange(Y$`no`,NULL,ncol=2,nrow=1,widths=c(9.875,0.125),heights=2.5)
      ,nrow=5
      ,ncol=1
      ,widths=c(10)
      ,heights=rep(2.5,5)
      ,labels=letters[1:5]
    )
  ) %>%
  .[[1]]
```

```{r eval=FALSE, fig.height=12.5, fig.width=10, include=FALSE}
rf_beeswarm
```

```{r eval=FALSE, fig.height=3, fig.width=10, include=FALSE}
shap_beeswarm_plots$rf_06
```

```{r}
set.seed(seed);rf_06_test_th14=
  best_models %>%
  filter(
    platform=='sklearn'
    & algorithm=='rf'
    & cutoff=='06'
    & data=='test'
  ) %>%
  select(outcome,prob) %>%
  rename(obs=outcome,pred=prob) %>%
  mutate(
    obs=
      obs %>%
      factor()
  ) %>%
  thresholding(
    standard=F
    ,optimal=F
    ,clinical=F
    ,custom_metric='th'
    ,custom_ref=0.14
    ,boot=30
  )
```

```{r}
rf_06_test_th14 %>%
  unite(ci,lb,ub,sep=', ') %>%
  mutate_at('ci',\(x)paste0('(',x,')')) %>%
  unite(estimates,avg,ci,sep=' ') %>%
  mutate(ref_type='threshold') %>%
  spread(ref_type,ref_value) %>%
  spread(metric,estimates) %>%
  mutate(model='Random Forest') %>%
  select(model,everything()) %>%
  rename_at(1:2,str_to_sentence) %>%
  rename_at(3:ncol(.),str_to_upper) %>%
  knitr::kable() %>%
  kableExtra::kable_classic()
```

```{r}
set.seed(seed);rf_06_sampling_chr=
  shap_feature_values$rf_06 %>%
  left_join(
    select(.,seq,feature,feature_value) %>%
      spread(feature,feature_value) %>%
      arrange(seq) %>%
      column_to_rownames(var='seq') %>%
      as.matrix() %>%
      prcomp() %>%
      .$x %>%
      as.data.frame() %>%
      rownames_to_column(var='seq') %>%
      mutate_at('seq',as.integer) %>%
      select(seq,PC1,PC2) %>%
      left_join(
        column_to_rownames(.,var='seq') %>%
          as.matrix() %>%
          kmeans(centers=4,algorithm='Hartigan-Wong') %>%
          lapply(X=1,Y=.,\(X,Y)
            data.frame(cluster=Y$cluster) %>%
              left_join(
                Y$centers %>%
                  as.data.frame() %>%
                  rownames_to_column(var='cluster') %>%
                  mutate_at('cluster',as.integer) %>%
                  `colnames<-`(c('cluster','PC1_center','PC2_center'))
                ,by='cluster'
              )
          ) %>%
          .[[1]] %>%
          mutate(cluster=as.factor(cluster)) %>%
          rownames_to_column(var='seq') %>%
          mutate_at('seq',as.integer)
        ,by='seq'
      ) %>%
      mutate(
        distance=
          sqrt((PC1-PC1_center)^2+(PC2-PC2_center)^2)
      )
    ,by='seq'
  ) %>%
  left_join(
    select(.,seq,outcome,prob) %>%
      filter(!duplicated(.)) %>%
      mutate(
        pred=as.numeric(prob>=0.14)
        ,cm=
          case_when(
            outcome==1 & outcome==pred ~ 'TP'
            ,outcome==1 & outcome!=pred ~ 'FN'
            ,outcome==0 & outcome!=pred ~ 'FP'
            ,outcome==0 & outcome==pred ~ 'TN'
          ) %>%
          factor(c('TP','FN','FP','TN'))
      ) %>%
      select(seq,cm)
    ,by='seq'
  )
```

```{r}
rf_06_sampling_chr %>%
  select(seq,PC1,PC2,cluster,cm) %>%
  filter(!duplicated(.)) %>%
  ggplot(aes(PC1,PC2,color=cluster)) +
  geom_point() +
  facet_wrap(~cm)
```

```{r}
rf_06_samples=
  rf_06_sampling_chr %>%
  mutate(cluster=ifelse(cluster%in%c(1:2),'A','B')) %>%
  group_by(cluster,cm) %>%
  filter(distance==min(distance)) %>%
  filter(seq(n())%in%sample(seq(n()),1,F)) %>%
  ungroup() %>%
  select(seq,cluster,cm) %>%
  filter(!duplicated(.)) %>%
  arrange(cluster,cm)
```

```{r}
rf_06_waterfall=
  rf_06_samples$seq %>%
  `names<-`(paste0(rf_06_samples$cluster,'_',rf_06_samples$cm)) %>%
  lapply(\(x)
    shap_feature_values$rf_06 %>%
      filter(seq%in%x)
  ) %>%
  lapply(\(x)
    x %>%
      mutate(
        exp_prob=
          shap_feature_values$rf_06 %>%
          select(seq,prob) %>%
          filter(!duplicated(.)) %>%
          pull(prob) %>%
          mean()
        ,exp_obs=
          shap_feature_values$rf_06 %>%
          select(seq,obs=outcome) %>%
          filter(!duplicated(.)) %>%
          pull(obs) %>%
          mean()
      ) %>%
      arrange(abs(shap_value)) %>%
      mutate(
        feature=
          reorder(
            paste0(
              feature
              ,' (='
              ,ifelse(feature_value==0,'no','yes')
              ,')'
            )
            ,abs(shap_value)
          )
        ,shap_end=exp_prob+cumsum(shap_value)
        ,shap_direction=
          ifelse(
            shap_value>=0
            ,'Positive'
            ,'Negative'
          ) %>%
          factor(c('Negative','Positive'))
      ) %>%
      mutate(seq=seq(nrow(.))) %>%
      left_join(
        mutate(.,seq=seq+1) %>%
          select(seq,shap_start=shap_end)
        ,by='seq'
      ) %>%
      mutate(shap_start=ifelse(is.na(shap_start),exp_prob,shap_start))
  ) %>%
  lapply(\(x)
    x %>%
      ggplot(aes(feature)) +
      geom_hline(yintercept=0.14,color='grey',linewidth=1.5,lty=2) +
      # geom_hline(yintercept=x$exp_prob[1],color='grey',linewidth=1) +
      geom_hline(yintercept=x$exp_obs[1],color='grey',linewidth=1,lty=3) +
      geom_hline(yintercept=last(x$shap_end),color='grey',linewidth=1) +
      geom_segment(
        aes(xend=feature,y=shap_start,yend=shap_end,color=shap_direction)
        ,linewidth=9
      ) +
      geom_text(
        aes(
          label=sprintf('%+0.2f',shap_value)
          ,y=
            ifelse(
              ifelse(
                shap_start<=shap_end
                ,shap_start+(shap_end-shap_start)/2
                ,shap_end+(shap_start-shap_end)/2
              )>=ifelse(
                exp_prob[1]<=last(shap_end)
                ,exp_prob[1]+(last(shap_end)-exp_prob[1])/2
                ,last(shap_end)+(exp_prob[1]-last(shap_end))/2
              )
              ,ifelse(
                shap_start<=shap_end
                ,ifelse(
                  abs(shap_end-shap_start)>0.1
                  ,shap_end
                  ,shap_start
                )
                ,ifelse(
                  abs(shap_end-shap_start)>0.1
                  ,shap_start
                  ,shap_end
                )
              )
              ,ifelse(
                shap_start<=shap_end
                ,ifelse(
                  abs(shap_end-shap_start)>0.1
                  ,shap_start
                  ,shap_end
                )
                ,ifelse(
                  abs(shap_end-shap_start)>0.1
                  ,shap_end
                  ,shap_start
                )
              )
            )
        )
        ,hjust='inward'
        ,size=3
      ) +
      coord_flip() +
      scale_y_continuous(
        breaks=
          seq(0,1,0.1) %>%
          unique() %>%
          sort()
        ,limits=c(0.1,0.9)
      ) +
      scale_color_manual(values=c('#008AFB','#FF0053')) +
      theme_minimal() +
      xlab('') +
      ylab('Predicted probability (model output)') +
      theme(
        panel.grid.major=element_blank()
        ,panel.grid.minor=element_blank()
        ,axis.line.x=element_line()
        ,axis.ticks.x=element_line()
        ,axis.text.x=element_text(angle=90,vjust=0,hjust=0.5)
        ,legend.position='none'
      )
  )
```

```{r eval=FALSE, fig.height=14, fig.width=14, include=FALSE}
rf_06_waterfall %>%
  lapply(X=1,Y=.,\(X,Y)
    ggarrange(
      ggarrange(
        Y$A_TP,Y$B_TP
        ,ncol=2,nrow=1,widths=c(7,7),heights=c(3.5),labels=letters[c(1,5)]
      )
      ,ggarrange(
        Y$A_FN,NULL
        ,ncol=2,nrow=1,widths=c(7,7),heights=c(3.5),labels=letters[c(2)]
      )
      ,ggarrange(
        Y$A_FP,Y$B_FP
        ,ncol=2,nrow=1,widths=c(7,7),heights=c(3.5),labels=letters[c(3,6)]
      )
      ,ggarrange(
        Y$A_TN,Y$B_TN
        ,ncol=2,nrow=1,widths=c(7,7),heights=c(3.5),labels=letters[c(4,7)]
      )
      ,ncol=1
      ,nrow=4
      ,widths=c(14)
      ,heights=c(14)
    )
  ) %>%
  .[[1]]
```

```{r include=FALSE}
rf_06_waterfall_unassessed=
  rf_06_samples$seq %>%
  `names<-`(paste0(rf_06_samples$cluster,'_',rf_06_samples$cm)) %>%
  lapply(\(x)
    read_csv(
        'data/pred_data_unassessed_training_cutoff_06.csv'
        ,show_col_types=F
      ) %>%
      slice(x)
  )
```

```{r include=FALSE}
rf_06_waterfall_unassessed_list=
  rf_06_waterfall_unassessed %>%
  lapply(select,-outcome,-outcome_weight) %>%
  lapply(gather,feature,feature_value) %>%
  lapply(\(x)
    x %>%
      left_join(
        variable_description %>%
          mutate(
            description=
              description %>%
              str_replace_all(
                '>='
                ,'\u2265'
              ) %>%
              str_replace_all(
                'Sodium-glucose co-transporter \\(SGLT\\)'
                ,'SGLT'
              )
          ) %>%
          select(variable,description) %>%
          rename(feature=variable)
        ,by='feature'
      ) %>%
      mutate(feature=description) %>%
      select(-description) %>%
      mutate(
        feature=
          reorder(
            paste0(
              feature
              ,' (='
              ,ifelse(
                is.na(feature_value) | str_detect(feature,'\\(n\\)$')
                ,feature_value
                ,ifelse(feature_value==0,'no','yes')
              )
              ,')'
            )
            ,desc(feature_value)
          )
      ) %>%
      arrange(feature) %>%
      select(feature)
  )
```

```{r eval=FALSE, include=FALSE}
rf_06_waterfall_unassessed_list %>%
  lapply(\(x)
    x %>%
      knitr::kable() %>%
      kableExtra::kable_classic()
  )
```

```{r eval=FALSE, include=FALSE}
candidate_predictor_eligible_d
```

```{r eval=FALSE, fig.height=10.5, fig.width=14, include=FALSE}
ggarrange(
  ggarrange(
    shap_beeswarm_plots$rf_06
    ,ncol=1,nrow=1,widths=c(14),heights=c(3.5),labels=LETTERS[c(1)]
  )
  ,ggarrange(
    rf_06_waterfall$A_TP +
      annotate(
        geom='text'
        ,x=11
        ,y=0.42
        ,label=
          rf_06_waterfall_unassessed_list$A_TP$feature %>%
          .[!str_detect(.,'=no|=NA|=0')] %>%
          paste0(collapse='\n')
        ,hjust=0
        ,vjust=1
        ,size=3
        ,fontface='bold'
      ) +
      annotate(
        geom='text'
        ,x=4
        ,y=0.42
        ,label=
          rf_06_waterfall_unassessed_list$A_TP$feature %>%
          .[str_detect(.,'=no|=NA|=0')] %>%
          paste0(collapse='\n')
        ,hjust=0
        ,vjust=1
        ,size=3
      ) +
      scale_y_continuous(
        breaks=seq(0.1,0.9,0.1)
        ,limits=c(0.1,1)
      )
    ,rf_06_waterfall$A_FN +
      annotate(
        geom='text'
        ,x=11
        ,y=0.42
        ,label=
          rf_06_waterfall_unassessed_list$A_FN$feature %>%
          .[!str_detect(.,'=no|=NA|=0')] %>%
          paste0(collapse='\n')
        ,hjust=0
        ,vjust=1
        ,size=3
        ,fontface='bold'
      ) +
      annotate(
        geom='text'
        ,x=8
        ,y=0.42
        ,label=
          rf_06_waterfall_unassessed_list$A_FN$feature %>%
          .[str_detect(.,'=no|=NA|=0')] %>%
          paste0(collapse='\n')
        ,hjust=0
        ,vjust=1
        ,size=3
      ) +
      scale_y_continuous(
        breaks=seq(0.1,0.9,0.1)
        ,limits=c(0.1,1)
      )
    ,ncol=2,nrow=1,widths=c(7,7),heights=c(3.5),labels=LETTERS[c(2,3)]
  )
  ,ggarrange(
    rf_06_waterfall$A_FP +
      annotate(
        geom='text'
        ,x=11
        ,y=0.42
        ,label=
          rf_06_waterfall_unassessed_list$A_FP$feature %>%
          .[!str_detect(.,'=no|=NA|=0')] %>%
          paste0(collapse='\n')
        ,hjust=0
        ,vjust=1
        ,size=3
        ,fontface='bold'
      ) +
      annotate(
        geom='text'
        ,x=9
        ,y=0.42
        ,label=
          rf_06_waterfall_unassessed_list$A_FP$feature %>%
          .[str_detect(.,'=no|=NA|=0')] %>%
          paste0(collapse='\n')
        ,hjust=0
        ,vjust=1
        ,size=3
      ) +
      scale_y_continuous(
        breaks=seq(0.1,0.9,0.1)
        ,limits=c(0.1,1)
      )
    ,rf_06_waterfall$A_TN +
      annotate(
        geom='text'
        ,x=11
        ,y=0.42
        ,label=
          rf_06_waterfall_unassessed_list$A_TN$feature %>%
          .[!str_detect(.,'=no|=NA|=0')] %>%
          paste0(collapse='\n')
        ,hjust=0
        ,vjust=1
        ,size=3
        ,fontface='bold'
      ) +
      annotate(
        geom='text'
        ,x=9
        ,y=0.42
        ,label=
          rf_06_waterfall_unassessed_list$A_TN$feature %>%
          .[str_detect(.,'=no|=NA|=0')] %>%
          paste0(collapse='\n')
        ,hjust=0
        ,vjust=1
        ,size=3
      ) +
      scale_y_continuous(
        breaks=seq(0.1,0.9,0.1)
        ,limits=c(0.1,1)
      )
    ,ncol=2,nrow=1,widths=c(7,7),heights=c(3.5),labels=LETTERS[c(4,5)]
  )
  ,ncol=1
  ,nrow=3
  ,widths=c(14)
  ,heights=c(3.5,3.5,3.5)
)#; ggsave('figure3.eps',height=10.5,width=14)
```

```{r eval=FALSE, fig.height=7, fig.width=14, include=FALSE}
ggarrange(
  ggarrange(
    rf_06_waterfall$B_TP +
      annotate(
        geom='text'
        ,x=11
        ,y=0.42
        ,label=
          rf_06_waterfall_unassessed_list$B_TP$feature %>%
          .[!str_detect(.,'=no|=NA|=0')] %>%
          paste0(collapse='\n')
        ,hjust=0
        ,vjust=1
        ,size=3
        ,fontface='bold'
      ) +
      annotate(
        geom='text'
        ,x=4+3
        ,y=0.42
        ,label=
          rf_06_waterfall_unassessed_list$B_TP$feature %>%
          .[str_detect(.,'=no|=NA|=0')] %>%
          paste0(collapse='\n')
        ,hjust=0
        ,vjust=1
        ,size=3
      ) +
      scale_y_continuous(
        breaks=seq(0.1,0.9,0.1)
        ,limits=c(0.1,1)
      )
    ,NULL
    ,ncol=2,nrow=1,widths=c(7,7),heights=c(3.5),labels=c(LETTERS[1],'')
  )
  ,ggarrange(
    rf_06_waterfall$B_FP +
      annotate(
        geom='text'
        ,x=11
        ,y=0.42
        ,label=
          rf_06_waterfall_unassessed_list$B_FP$feature %>%
          .[!str_detect(.,'=no|=NA|=0')] %>%
          paste0(collapse='\n')
        ,hjust=0
        ,vjust=1
        ,size=3
        ,fontface='bold'
      ) +
      annotate(
        geom='text'
        ,x=9-1
        ,y=0.42
        ,label=
          rf_06_waterfall_unassessed_list$B_FP$feature %>%
          .[str_detect(.,'=no|=NA|=0')] %>%
          paste0(collapse='\n')
        ,hjust=0
        ,vjust=1
        ,size=3
      ) +
      scale_y_continuous(
        breaks=seq(0.1,0.9,0.1)
        ,limits=c(0.1,1)
      )
    ,rf_06_waterfall$B_TN +
      annotate(
        geom='text'
        ,x=11
        ,y=0.42
        ,label=
          rf_06_waterfall_unassessed_list$B_TN$feature %>%
          .[!str_detect(.,'=no|=NA|=0')] %>%
          paste0(collapse='\n')
        ,hjust=0
        ,vjust=1
        ,size=3
        ,fontface='bold'
      ) +
      annotate(
        geom='text'
        ,x=9-3
        ,y=0.42
        ,label=
          rf_06_waterfall_unassessed_list$B_TN$feature %>%
          .[str_detect(.,'=no|=NA|=0')] %>%
          paste0(collapse='\n')
        ,hjust=0
        ,vjust=1
        ,size=3
      ) +
      scale_y_continuous(
        breaks=seq(0.1,0.9,0.1)
        ,limits=c(0.1,1)
      )
    ,ncol=2,nrow=1,widths=c(7,7),heights=c(3.5),labels=LETTERS[c(2,3)]
  )
  ,ncol=1
  ,nrow=2
  ,widths=c(14)
  ,heights=c(3.5,3.5)
)
```

```{r include=FALSE}
pca_pred_data_training=
  pred_data$training %>%
  .[,colnames(.) %>% .[!.%in%c('outcome','outcome_onset','outcome_weight')]] %>%
  as.matrix() %>%
  prcomp(center=F,scale=F)
```

```{r eval=FALSE, include=FALSE}
pca_pred_data_training$sdev %>%
  data.frame(pc=seq(length(.)),sdev=.) %>%
  mutate(pve=sdev^2/sum(sdev^2)) %>%
  mutate(cpve=cumsum(pve)) %>%
  ggplot(aes(pc,pve)) +
  geom_col() +
  geom_text(aes(label=paste0(round(cpve*100,2),'%')),vjust=-0.2,size=3)
```

```{r eval=FALSE, include=FALSE}
pca_pred_data_training$x %>%
  as.data.frame() %>%
  cbind(
    best_models %>%
      filter(
        algorithm=='rf'
        & cutoff=='06'
        & data=='training'
        & platform=='sklearn'
      ) %>%
      select(outcome,prob)
  ) %>%
  ggplot(aes(PC1,color=prob>=0.14)) +
  geom_density()
```

```{r eval=FALSE, include=FALSE}
data.frame(
    outcome=as.numeric(NA)
    ,outcome_onset=as.numeric(NA)
    ,outcome_weight=as.numeric(NA)
  ) %>%
  cbind(
    pred_data$training %>%
      .[,colnames(.) %>% .[!.%in%c('outcome','outcome_onset','outcome_weight')]] %>%
      lapply(unique) %>%
      expand.grid()
  ) %>%
  write_csv('data/pred_data_nomogram.csv')
```

```{r include=FALSE}
nomogram_data=
  paste0(
    'data/sklearn_models/'
    ,'rf/pred_data_training_cutoff_06/'
    ,'prob_pred_data_nomogram.csv'
  ) %>%
  read_csv(show_col_types=F) %>%
  cbind(read_csv('data/pred_data_nomogram.csv',show_col_types=F))
```

```{r include=FALSE}
modified_variable_description=
  variable_description %>%
    mutate(
      description=
        description %>%
        str_replace_all(
          '>='
          ,'\u2265'
        ) %>%
        str_replace_all(
          '\\(F/M\\)'
          ,'male'
        ) %>%
        str_replace_all(
          ' \\(protective restraint\\)'
          ,''
        ) %>%
        str_replace_all(
          'Hypertension diagnosis'
          ,'Hypertension'
        ) %>%
        str_replace_all(
          ' \\(double-J/diagnosis/urodynamics\\)'
          ,''
        ) %>%
        str_replace_all(
          ' diagnosis >2x/6 mo'
          ,' >2x/6 mo'
        ) %>%
        str_replace_all(
          '>3/1 y'
          ,'>3x/y'
        ) %>%
        str_replace_all(
          ' \\(diagnosis\\)'
          ,''
        )
    ) %>%
    select(description,variable) %>%
    rbind(
      c('Age group >50 to 65','AGE_GROUP_1'
        ,'Age group >65','AGE_GROUP_2'
        ) %>%
        matrix(
          ncol=2
          ,byrow=T
          ,dimnames=list(NULL,c('description','variable'))
        )
    )
```

```{r eval=FALSE, include=FALSE}
nomogram_data %>%
  .[,colnames(.) %>% .[!.%in%c('outcome','outcome_onset','outcome_weight')]] %>%
  gather(variable,value,-prob) %>%
  left_join(
    shap_feature_values$rf_06$feature %>%
      levels() %>%
      rev() %>%
      data.frame(description=.) %>%
      left_join(
        modified_variable_description
        ,by='description'
      ) %>%
      mutate(
        description=
          description %>%
          factor(unique(.))
      )
    ,by='variable'
  ) %>%
  arrange(description,value,prob) %>%
  ggplot(aes(prob,color=factor(value))) +
  geom_density() +
  facet_wrap(~description)
```

```{r include=FALSE}
sorted_nomogram_data=
  nomogram_data %>%
  select_at(
    c('prob'
      ,shap_feature_values$rf_06$feature %>%
        levels() %>%
        rev() %>%
        data.frame(description=.) %>%
        left_join(
          modified_variable_description
          ,by='description'
        ) %>%
        mutate(
          description=
            description %>%
            factor(unique(.))
        ) %>%
        arrange(description) %>%
        pull(variable)
    )
  )
```


```{r eval=FALSE, include=FALSE}
sorted_nomogram_data
```

```{r include=FALSE}
cum_features_pred=
  sorted_nomogram_data %>%
  .[,colnames(.) %>% .[!.%in%c('outcome','outcome_onset','outcome_weight')]] %>%
  pblapply(X=seq(2,ncol(.)),Y=.,\(X,Y)
    Y %>%
      select_at(c(1,2:X)) %>%
      mutate(
        value=
          sapply(X=seq(n()),Y=.,\(X,Y)
            paste0(
              Y[X,-1,drop=T]
              ,collapse='/'
            )
          )
        ,variable=
          paste0(
            Y %>%
              colnames() %>%
              .[2:X]
            ,collapse='/'
          )
      ) %>%
      group_by(variable,value) %>%
      summarize(
        min=min(prob)
        ,max=max(prob)
        ,.groups='drop'
      )
  )
```
```{r include=FALSE}
pos_pred_features=list()

i=0
pb=txtProgressBar(min=i,max=ncol(sorted_nomogram_data)-1,style=3)
for(colseq in seq(2,ncol(sorted_nomogram_data))){
  pos_pred_features[[colseq-1]]=
    sorted_nomogram_data %>%
    select_at(c(1,2:colseq)) %>%
    mutate(
      value=
        sapply(X=seq(n()),Y=.,\(X,Y)
          paste0(
            Y[X,-1,drop=T]
            ,collapse='/'
          )
        )
      ,variable=
        paste0(
          colnames(.) %>%
            .[-1]
          ,collapse='/'
        )
    )
  
  if(colseq>2){
    pos_pred_features[[colseq-1]]=
      pos_pred_features[[colseq-1]] %>%
      filter(
        !str_detect(
          value
          ,paste0(
              '^'
              ,pos_pred_features[-(colseq-1)] %>%
                do.call(rbind,.) %>%
                pull(value)
            ) %>%
            paste0(collapse='|')
        )
      )
  }
  
  pos_pred_features[[colseq-1]]=
    pos_pred_features[[colseq-1]] %>%
    group_by(variable,value) %>%
    summarize(
      min=suppressWarnings(min(prob))
      ,med=suppressWarnings(median(prob))
      ,max=suppressWarnings(max(prob))
      ,.groups='drop'
    ) %>%
    filter(min>=0.14)
  
  i=i+1
  setTxtProgressBar(pb,i)
}

close(pb)
rm(i,pb,colseq)

pos_pred_features=
  pos_pred_features %>%
  do.call(rbind,.)
```

```{r include=FALSE}
neg_pred_features=list()

i=0
pb=txtProgressBar(min=i,max=ncol(sorted_nomogram_data)-1,style=3)
for(colseq in rev(seq(2,ncol(sorted_nomogram_data)))){
  neg_pred_features[[colseq-1]]=
    sorted_nomogram_data %>%
    select_at(c(1,2:colseq)) %>%
    mutate(
      value=
        sapply(X=seq(n()),Y=.,\(X,Y)
          paste0(
            Y[X,-1,drop=T]
            ,collapse='/'
          )
        )
      ,variable=
        paste0(
          colnames(.) %>%
            .[-1]
          ,collapse='/'
        )
    )
  
  if(colseq<ncol(sorted_nomogram_data)){
    neg_pred_features[[colseq-1]]=
      neg_pred_features[[colseq-1]] %>%
      filter(
        !str_detect(
          value
          ,paste0(
              '^'
              ,neg_pred_features[-(colseq-1)] %>%
                do.call(rbind,.) %>%
                pull(value)
            ) %>%
            paste0(collapse='|')
        )
      )
  }
  
  neg_pred_features[[colseq-1]]=
    neg_pred_features[[colseq-1]] %>%
    group_by(variable,value) %>%
    summarize(
      min=suppressWarnings(min(prob))
      ,med=suppressWarnings(median(prob))
      ,max=suppressWarnings(max(prob))
      ,.groups='drop'
    ) %>%
    filter(max<0.14)
  
  i=i+1
  setTxtProgressBar(pb,i)
}

close(pb)
rm(i,pb,colseq)

neg_pred_features=
  neg_pred_features %>%
  do.call(rbind,.)
```

```{r eval=FALSE, include=FALSE}
cum_features_pred %>%
  lapply(\(x)
    x %>%
      ggplot(aes(value)) +
      geom_hline(yintercept=0.14,lty=2) +
      geom_errorbar(aes(ymin=min,ymax=max)) +
      coord_flip()
  )
```

```{r eval=FALSE, fig.height=14, fig.width=7, include=FALSE}
pos_pred_features %>%
  rbind(neg_pred_features) %>%
  mutate(
    value=
      value %>%
      factor(rev(unique(.)))
  ) %>%
  ggplot(aes(value)) +
  geom_hline(yintercept=0.14,lty=2) +
  geom_errorbar(aes(ymin=min,ymax=max)) +
  coord_flip() +
  theme(
    axis.text.y=element_text(hjust=0)
  )
```

```{r include=FALSE}
feat_hie_comb_pred_data_training=
  pred_data$training %>%
  .[,colnames(.) %>% .[!.%in%c('outcome','outcome_onset','outcome_weight')]] %>%
  select_at(
    sorted_nomogram_data %>%
      colnames() %>%
      .[!.%in%c('prob','outcome','outcome_onset','outcome_weight')]
  ) %>%
  pblapply(X=seq(ncol(.)),Y=.,\(X,Y)
    Y %>%
      select_at(seq(X)) %>%
      mutate(
        value=
          sapply(X=seq(n()),Y=.,\(X,Y)
            paste0(
              Y[X,,drop=T]
              ,collapse='/'
            )
          )
        ,variable=
          paste0(
            Y %>%
              colnames() %>%
              .[seq(X)]
            ,collapse='/'
          )
      ) %>%
      group_by(variable,value) %>%
      summarize(
        n=n()
        ,.groups='drop'
      )
  ) %>%
  do.call(rbind,.)
```

```{r include=FALSE}
feat_hie_comb_pred_data_training %>%
  mutate(
    pred=
      case_when(
        str_detect(
          variable
          ,paste0('^',pos_pred_features$variable) %>%
            paste0(collapse='|')
        )
        & str_detect(
          value
          ,paste0('^',pos_pred_features$value) %>%
            str_replace_all('-','[01]') %>%
            paste0(collapse='|')
        )
        ~'positive'
        
        ,str_detect(
          variable
          ,paste0('^',neg_pred_features$variable) %>%
            paste0(collapse='|')
        )
        & str_detect(
          value
          ,paste0('^',neg_pred_features$value) %>%
            paste0(collapse='|')
        )
        ~'negative'
        
        ,TRUE~'uncertain'
      )
  ) %>%
  group_by(variable,pred) %>%
  summarize(n=sum(n),.groups='drop') %>%
  mutate(variable_num=str_count(variable,'/')+1) %>%
  spread(pred,n,fill=0) %>%
  mutate(
    p=(positive+negative)/(positive+negative+uncertain)
  ) %>%
  ggplot(aes(variable_num,p)) +
  geom_col() +
  geom_text(
    aes(label=paste0(round(p*100,2),'%'))
    ,size=3
    ,vjust=-0.2
  ) +
  scale_x_continuous('Number of predictors',breaks=seq(14)) +
  scale_y_continuous()
```

```{r include=FALSE}
set.seed(seed);pred_examples=
  sorted_nomogram_data %>%
  .[,colnames(.) %>% .[!.%in%c('outcome','outcome_onset','outcome_weight')]] %>%
  lapply(X=1,Y=.,\(X,Y)
    list(
        Y %>%
          filter(prob>=0.14) %>%
          slice(sample(seq(nrow(.)),1,F))
        ,Y %>%
          filter(prob<0.14) %>%
          slice(sample(seq(nrow(.)),1,F))
      ) %>%
      do.call(rbind,.)
  ) %>%
  .[[1]]
```

```{r include=FALSE}
nomogram=
  pos_pred_features %>%
  mutate(pred=1) %>%
  rbind(
    neg_pred_features %>%
      mutate(pred=0)
  ) %>%
  mutate(variable_num=str_count(variable,'/')+1) %>%
  group_by(pred) %>%
  mutate(position=seq(n())) %>%
  ungroup() %>%
  select(pred,variable_num,position,variable,value) %>%
  separate_rows(variable,value,sep='/') %>%
  left_join(
    pred_examples %>%
      filter(prob>=0.14) %>%
      select(-prob) %>%
      gather(variable,pos_feat)
    ,by='variable'
  ) %>%
  left_join(
    pred_examples %>%
      filter(prob<0.14) %>%
      select(-prob) %>%
      gather(variable,neg_feat)
    ,by='variable'
  ) %>%
  left_join(
    variable_description %>%
      mutate(
        description=
          description %>%
          str_replace_all(
            '>='
            ,'\u2265'
          ) %>%
          str_replace_all(
            '\\(F/M\\)'
            ,'male'
          ) %>%
          str_replace_all(
            ' \\(protective restraint\\)'
            ,''
          ) %>%
          str_replace_all(
            'Hypertension diagnosis'
            ,'Hypertension'
          ) %>%
          str_replace_all(
            ' \\(double-J/diagnosis/urodynamics\\)'
            ,''
          ) %>%
          str_replace_all(
            ' diagnosis >2x/6 mo'
            ,' >2x/6 mo'
          ) %>%
          str_replace_all(
            '>3/1 y'
            ,'>3x/y'
          ) %>%
          str_replace_all(
            ' \\(diagnosis\\)'
            ,''
          )
      ) %>%
      select(variable,description) %>%
      rbind(
        c('Age group >50 to 65','AGE_GROUP_1'
          ,'Age group >65','AGE_GROUP_2'
          ) %>%
          matrix(
            ncol=2
            ,byrow=T
            ,dimnames=list(NULL,c('description','variable'))
          )
      )
    ,by='variable'
  )  %>%
  mutate(variable=description) %>%
  mutate(
    value=
      value %>%
      factor()
    ,pred=
      case_when(
        pred==0~'Risk <0.14'
        ,pred==1~'Risk \u22650.14'
      ) %>%
      factor() %>%
      factor(rev(levels(.)))
  ) %>%
  lapply(X=seq(3),Y=.,\(X,Y)
    Y %>%
      mutate(seq=X) %>%
      mutate(
        variable=
          paste0(
            variable
            ,' =  '
            ,ifelse(
              seq==3
              ,neg_feat
              ,ifelse(
                seq==2
                ,pos_feat
                ,' '
              )
            )
            ,'  '
          ) %>%
          factor(rev(unique(.)))
      ) %>%
      ggplot(aes(position,variable)) +
      geom_tile(aes(fill=factor(value)),color='white',show.legend=F) +
      facet_wrap(~pred,scales='free_x',ncol=2) +
      scale_x_continuous('|--------- Assessment order --------->',breaks=-1) +
      scale_y_discrete('<--------- Assessment order ---------|') +
      theme(
        axis.ticks.x=element_blank()
        ,axis.text.x=element_blank()
        ,axis.title.x=element_text(hjust=0)
      )
  )
```

```{r eval=FALSE, fig.height=9, fig.width=15, include=FALSE}
ggarrange(
  nomogram[[1]]
  ,nomogram[[2]]
  ,nomogram[[3]]
  ,ncol=1
  ,nrow=3
  ,widths=c(15)
  ,heights=c(3,3,3)
  ,labels=LETTERS[1:3]
)
```






























